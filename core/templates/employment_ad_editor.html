{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">


    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">üìã ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§∏‡§Æ‡•ç‡§™‡§æ‡§¶‡§ï</h4>
                </div>
                <div class="card-body">
                    
                    <!-- Step Progress Indicator -->
                    <div class="progress mb-4" style="height: 8px;">
                        <div class="progress-bar" role="progressbar" style="width: 33.33%;" id="progressBar"></div>
                    </div>
                    
                    <!-- Step Navigation -->
                    <ul class="nav nav-pills mb-4" id="stepTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="step1-tab" data-bs-toggle="pill" data-bs-target="#step1" type="button" role="tab">
                                <span class="badge bg-primary me-2">1</span> OCR ‡§Ö‡§™‡§≤‡•ã‡§°
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="step2-tab" data-bs-toggle="pill" data-bs-target="#step2" type="button" role="tab">
                                <span class="badge bg-secondary me-2">2</span> ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§∞ ‡§™‡§¶‡§π‡§∞‡•Ç
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="step3-tab" data-bs-toggle="pill" data-bs-target="#step4" type="button" role="tab">
                                <span class="badge bg-secondary me-2">3</span> ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§µ‡§≤‡•ã‡§ï‡§®
                            </button>
                        </li>
                    </ul>

                    <!-- Step Content -->
                    <div class="tab-content" id="stepContent">
                        
                        <!-- Step 1: OCR Upload -->
                        <div class="tab-pane fade show active" id="step1" role="tabpanel">
                            <div class="row">
                                <div class="col-md-12">
                                    <h5 class="mb-1">üìÑ OCR ‡§Ö‡§™‡§≤‡•ã‡§° ‡§∞ ‡§™‡§æ‡§∞‡•ç‡§∏‡§ø‡§ô</h5>
                                    <p class="text-muted mb-2">‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§™‡§§‡•ç‡§∞ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç ‡§∞ OCR ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§∏‡•ç‡§µ‡§ö‡§æ‡§≤‡§ø‡§§ ‡§∞‡•Å‡§™‡§Æ‡§æ ‡§´‡§ø‡§≤‡•ç‡§°‡§π‡§∞‡•Ç ‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</p>
                                    
                                    <form method="post" enctype="multipart/form-data" id="ocrForm">
                                        {% csrf_token %}
                                        <input type="hidden" name="form_type" value="ocr">
                                        
                                        <div class="mb-2">
                                            <label for="id_document" class="form-label mb-1">‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§™‡§§‡•ç‡§∞ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</label>
                                            <input type="file" class="form-control" id="id_document" name="document" accept="image/*,.pdf" required>
                                            <div class="form-text">PNG, JPG, JPEG, PDF ‡§´‡§æ‡§á‡§≤‡§π‡§∞‡•Ç ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§õ‡§®‡•ç</div>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            üîç OCR ‡§ö‡§≤‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç
                                        </button>
                                        
                                        <!-- Client-side OCR (browser) preview + progress -->
                                        <div id="ocrClientBox" class="mt-2" style="display:none;">
                                          <label class="form-label mb-1">üîé Client-side OCR Preview</label>
                                          <progress id="ocrProgress" max="1" value="0" style="width:100%;height:10px;"></progress>
                                          <pre id="ocrPreview" style="white-space:pre-wrap;font-size:12px;max-height:220px;overflow:auto;margin-top:6px;"></pre>
                                          <small class="text-muted">‡§Ø‡•ã ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§∞‡§Æ‡•à OCR ‡§ó‡§∞‡•Ä ‡§®‡§ø‡§ï‡§æ‡§≤‡§ø‡§è‡§ï‡•ã ‡§π‡•ã (‡§∏‡§∞‡•ç‡§≠‡§∞‡§Æ‡§æ ‡§™‡§†‡§æ‡§á‡§è‡§ï‡•ã ‡§õ‡•à‡§®)‡•§</small>
                                        </div>
                                    </form>
                                </div>
                                

                            </div>
                            

                        </div>

                        <!-- Step 2: Main Information -->
                        <div class="tab-pane fade" id="step2" role="tabpanel">
                            <h5 class="mb-1">üè¢ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</h5>
                            <p class="text-muted mb-2">‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä ‡§∞ ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®‡§ï‡•ã ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</p>
                            
                            <form method="post" enctype="multipart/form-data" id="mainForm">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="edit">
                                
                                <!-- Company Information -->
                                <div class="card mb-2">
                                    <div class="card-header py-1">
                                        <h6 class="mb-0">üè¢ ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§ï‡•ã ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</h6>
                                    </div>
                                    <div class="card-body py-2">
                                                                                <div class="mb-2">
                                            <label for="{{ form.title.id_for_label }}" class="form-label">1. ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</label>
                                                    {{ form.title }}
                                                </div>
                                                
                                        <div class="mb-2">
                                            <label for="{{ form.country.id_for_label }}" class="form-label">2. ‡§¶‡•á‡§∂</label>
                                                    <select id="id_country" name="country" class="form-select" required>
                                                        <option value="">Select Country</option>
                                                        <option value="UAE">UAE</option>
                                                        <option value="Japan">Japan</option>
                                                        <option value="Kuwait">Kuwait</option>
                                                        <option value="Qatar">Qatar</option>
                                                        <option value="Saudi Arabia">Saudi Arabia</option>
                                                        <option value="Oman">Oman</option>
                                                        <option value="Bahrain">Bahrain</option>
                                                        <option value="Malaysia">Malaysia</option>
                                                        <option value="Singapore">Singapore</option>
                                                        <option value="South Korea">South Korea</option>
                                                        <option value="Other">Other</option>
                                                    </select>
                                                </div>
                                                
                                                <!-- Manual country input field (hidden by default) -->
                                        <div id="otherCountryField" class="mb-2" style="display: none;">
                                            <label for="id_other_country" class="form-label">Enter Country Name</label>
                                                    <input type="text" id="id_other_country" name="other_country" class="form-control" placeholder="Type country name here...">
                                                </div>
                                                
                                        <div class="mb-2">
                                            <label for="{{ form.company_name.id_for_label }}" class="form-label">3. ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§ï‡•ã ‡§®‡§æ‡§Æ</label>
                                            {{ form.company_name }}
                                        </div>
                                                
                                                                                <div class="mb-2">
                                            <label for="id_right_section_text" class="form-label">4. ‡§™‡•Å‡§® : ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® </label>
                                            <select id="id_right_section_text" name="right_section_text" class="form-select">
                                                <option value="">‡§π‡•à‡§®?</option>
                                                <option value="‡§™‡•Å‡§® : ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®" {% if ad.right_section_text == "‡§™‡•Å‡§® : ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®" %}selected{% endif %}>‡§π‡•ã?</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-2">
                                            <label for="{{ form.pre_approval_date.id_for_label }}" class="form-label">5. ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø ‡§Æ‡§ø‡§§‡§ø</label>
                                                    <div class="input-group">
                                                    {{ form.pre_approval_date }}
                                                        <button type="button" class="btn btn-outline-secondary" onclick="openDatePicker()">
                                                            üìÖ ‡§ï‡•ç‡§Ø‡§æ‡§≤‡•á‡§®‡•ç‡§°‡§∞
                                                        </button>
                                                    </div>
                                                <!-- Hidden date picker input for calendar -->
                                                <input type="date" id="hidden_date_picker" style="display: none;" onchange="updateApprovalDate(this.value)">
                                        </div>
                                                
                                        <div class="mb-2">
                                            <label for="{{ form.chalani_no.id_for_label }}" class="form-label">6. ‡§ö‡§≤‡§æ‡§®‡•Ä ‡§®‡§Ç.</label>
                                                    {{ form.chalani_no }}
                                            </div>
                                            
                                        <div class="mb-2">
                                            <label for="{{ form.lot_no.id_for_label }}" class="form-label">7. LOT ‡§®‡§Ç.</label>
                                                    {{ form.lot_no }}
                                                </div>
                                                
                                                <div class="mb-2">
                                            <label for="{{ form.city.id_for_label }}" class="form-label">8. ‡§∂‡§π‡§∞</label>
                                                    {{ form.city }}
                                        </div>
                                    </div>
                                                </div>
                                                
                                <!-- Job Positions Section -->
                                <div class="card mb-2">
                                    <div class="card-header py-1">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">üë• ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞‡§ï‡•ã ‡§™‡§¶‡§π‡§∞‡•Ç</h6>
                                            <button type="button" class="btn btn-success btn-sm" onclick="addPosition()">
                                                ‚ûï ‡§®‡§Ø‡§æ‡§Å ‡§™‡§¶ ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body py-2">
                                        <div id="positionsContainer">
                                            {{ formset.management_form }}
                                            {% for form in formset %}
                                            <div class="position-form border rounded p-3 mb-3" data-form-index="{{ forloop.counter0 }}">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="mb-0">‡§™‡§¶ #{{ forloop.counter }}</h6>
                                                    {% if forloop.counter > 1 %}
                                                    <button type="button" class="btn btn-danger btn-sm" onclick="removePosition(this)">
                                                        üóëÔ∏è ‡§π‡§ü‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç
                                                    </button>
                                                    {% endif %}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">1. ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞‡§ï‡•ã ‡§™‡§¶ </label>
                                                    {{ form.position }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">2. ‡§™‡•Å‡§∞‡•Å‡§∑</label>
                                                    {{ form.male_count }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">3. ‡§Æ‡§π‡§ø‡§≤‡§æ</label>
                                                    {{ form.female_count }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">4. ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§§‡§≤‡§¨</label>
                                                    {{ form.salary_amount }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">5. ‡§Æ‡•Å‡§¶‡•ç‡§∞‡§æ</label>
                                                    {{ form.salary_currency }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">6. ‡§®‡•á.‡§∞‡•Å.</label>
                                                    {{ form.salary_npr }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">7. ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞‡§ï‡§æ ‡§®‡•ç‡§Ø‡•Å‡§®‡§§‡§Æ ‡§Ø‡•ã‡§ó‡•ç‡§Ø‡§§‡§æ </label>
                                                    {{ form.min_qualification }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">8. ‡§ì‡§≠‡§∞ ‡§ü‡§æ‡§à‡§Æ ‡§∏‡•Å‡§¨‡§ø‡§ß‡§æ </label>
-                                                    {{ form.overtime }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">9. ‡§™‡•ç‡§∞‡§§‡§ø‡§¶‡§ø‡§® ‡§ï‡§æ‡§Æ ‡§ó‡§∞‡•ç‡§®‡•á ‡§ò‡§£‡•ç‡§ü‡§æ </label>
                                                    {{ form.hours_per_day }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">10. ‡§π‡§™‡•ç‡§§‡§æ‡§Æ‡§æ ‡§ï‡§æ‡§Æ ‡§ó‡§∞‡•ç‡§®‡•á ‡§¶‡§ø‡§® </label>
                                                    {{ form.days_per_week }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">11. ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§¨‡§ø‡§¶‡§æ </label>
                                                    {{ form.yearly_leave }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">12. ‡§ñ‡§æ‡§®‡•á ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ</label>
                                                    {{ form.food_provided }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">13. ‡§¨‡§∏‡•ç‡§®‡•á ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ </label>
                                                    {{ form.housing_provided }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">14. ‡§ï‡§∞‡§æ‡§∞ ‡§Ö‡§µ‡§ß‡§ø</label>
                                                    {{ form.contract_duration }}
                                                </div>
                                                
                                                <!-- Hidden fields -->
                                                {{ form.id }}
                                                {{ form.employment_ad }}
                                                {{ form.order }}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Interview Information -->
                                <div class="card mb-2">
                                    <div class="card-header py-1">
                                        <h6 class="mb-0">üìÖ ‡§Ö‡§®‡•ç‡§§‡§∞‡•ç‡§µ‡§æ‡§∞‡•ç‡§§‡§æ ‡§∏‡•Ç‡§ö‡§®‡§æ</h6>
                                    </div>
                                    <div class="card-body py-2">
                                                <div class="mb-2">
                                                    <label for="{{ form.interview_custom_text.id_for_label }}" class="form-label">‡§Ö‡§®‡•ç‡§§‡§∞‡•ç‡§µ‡§æ‡§∞‡•ç‡§§‡§æ ‡§∏‡•Ç‡§ö‡§®‡§æ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</label>
                                                    {{ form.interview_custom_text }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">‡§Ö‡§®‡•ç‡§§‡§∞‡•ç‡§µ‡§æ‡§∞‡•ç‡§§‡§æ ‡§Æ‡§ø‡§§‡§ø ‡§∞ ‡§∏‡•ç‡§•‡§æ‡§®</label>
                                                    <div class="row">
                                                        <div class="col-4">
                                                            <label class="form-label">‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§Æ‡§ø‡§§‡§ø</label>
                                                            <input type="text" name="interview_nepali_date" id="id_interview_nepali_date" class="form-control" placeholder="‡•®‡•¶‡•Æ‡•®/‡•¶‡•´/‡•ß‡•ß" value="{{ ad.interview_nepali_date|default:'' }}">
                                                        </div>
                                                        <div class="col-4">
                                                            <label class="form-label">‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä ‡§Æ‡§ø‡§§‡§ø</label>
                                                            <input type="text" name="interview_gregorian_date" id="id_interview_gregorian_date" class="form-control" placeholder="30 August, 2025" value="{{ ad.interview_gregorian_date|default:'' }}">
                                                        </div>
                                                        <div class="col-4">
                                                            <label class="form-label">‡§∏‡•ç‡§•‡§æ‡§®</label>
                                                            <input type="text" name="interview_location" id="id_interview_location" class="form-control" placeholder="‡§Æ‡•ç‡§Ø‡§æ‡§®‡§™‡§æ‡§µ‡§∞‡§ï‡•ã ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø‡§Æ‡§æ" value="{{ ad.interview_location|default:'' }}">
                                                        </div>
                                                    </div>
                                                    <div class="mt-2 p-2 bg-light rounded">
                                                        <strong>‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§µ‡§≤‡•ã‡§ï‡§®:</strong>
                                                        <div id="interview_preview" class="mt-1">
                                                            ‡§Ö‡§®‡•ç‡§§‡§∞‡§µ‡§æ‡§∞‡•ç‡§§‡§æ ‡§Æ‡§ø‡§§‡§ø <span id="preview_nepali_date">{{ ad.interview_nepali_date|default:'‡•®‡•¶‡•Æ‡•®/‡•¶‡•´/‡•ß‡•ß' }}</span> ‡§ó‡§§‡•á (<span id="preview_gregorian_date">{{ ad.interview_gregorian_date|default:'30 August, 2025' }}</span>) <span id="preview_location">{{ ad.interview_location|default:'‡§Æ‡•ç‡§Ø‡§æ‡§®‡§™‡§æ‡§µ‡§∞‡§ï‡•ã ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø‡§Æ‡§æ' }}</span> ‡§π‡•Å‡§®‡•á‡§õ ‡•§
                                                        </div>
                                                    </div>
                                                    <div class="mt-2">
                                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="calculateInterviewDate()">üîÑ ‡§Æ‡•ç‡§Ø‡§æ‡§®‡•Å‡§Ö‡§≤ ‡§Æ‡§ø‡§§‡§ø ‡§ó‡§£‡§®‡§æ (‡•Æ ‡§¶‡§ø‡§® ‡§™‡§õ‡§ø)</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Extra Information -->
                                <div class="card mb-2">
                                    <div class="card-header py-1">
                                        <h6 class="mb-0">üí∞ ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä (‡§ï‡§∏‡§≤‡•á ‡§§‡§ø‡§∞‡•ç‡§®‡•á/‡§¶‡§ø‡§®‡•á)</h6>
                                        <small class="text-muted">‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§´‡§ø‡§≤‡•ç‡§°‡§Æ‡§æ "‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞‡§≤‡•á ‡§§‡§ø‡§∞‡•ç‡§®‡•á" ‡§µ‡§æ "‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡§¶‡§æ‡§§‡§æ‡§≤‡•á ‡§µ‡•ç‡§Ø‡§π‡•ã‡§∞‡•ç‡§®‡•á" ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</small>
                                    </div>
                                    <div class="card-body py-2">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <label for="{{ form.medical_cost_local.id_for_label }}" class="form-label">‡§∏‡•ç‡§µ‡§¶‡•á‡§∂‡§Æ‡§æ ‡§Æ‡•á‡§°‡§ø‡§ï‡§≤ ‡§ñ‡§∞‡•ç‡§ö</label>
                                                    {{ form.medical_cost_local }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label for="{{ form.medical_cost_foreign.id_for_label }}" class="form-label">‡§µ‡§ø‡§¶‡•á‡§∂‡§Æ‡§æ ‡§Æ‡•á‡§°‡§ø‡§ï‡§≤ ‡§ñ‡§∞‡•ç‡§ö</label>
                                                    {{ form.medical_cost_foreign }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label for="{{ form.insurance_local.id_for_label }}" class="form-label">‡§∏‡•ç‡§µ‡§¶‡•á‡§∂‡§Æ‡§æ ‡§¨‡•Ä‡§Æ‡§æ</label>
                                                    {{ form.insurance_local }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label for="{{ form.insurance_employment.id_for_label }}" class="form-label">‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡§Æ‡§æ ‡§¨‡•Ä‡§Æ‡§æ</label>
                                                    {{ form.insurance_employment }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label for="{{ form.air_ticket.id_for_label }}" class="form-label">‡§π‡§µ‡§æ‡§à ‡§ü‡§ø‡§ï‡§ü</label>
                                                    {{ form.air_ticket }}
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <label for="{{ form.visa_fee.id_for_label }}" class="form-label">‡§≠‡§ø‡§∏‡§æ ‡§∂‡•Å‡§≤‡•ç‡§ï</label>
                                                    {{ form.visa_fee }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label for="{{ form.visa_stamp_fee.id_for_label }}" class="form-label">‡§≠‡§ø‡§∏‡§æ ‡§∏‡•ç‡§ü‡•ç‡§Ø‡§æ‡§Æ‡•ç‡§™ ‡§∂‡•Å‡§≤‡•ç‡§ï</label>
                                                    {{ form.visa_stamp_fee }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label for="{{ form.recruitment_fee.id_for_label }}" class="form-label">‡§Ö‡§≠‡§ø‡§ï‡•É‡§§‡§ø‡§ï‡§∞‡§£ ‡§∂‡•Å‡§≤‡•ç‡§ï</label>
                                                    {{ form.recruitment_fee }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label for="{{ form.welfare_fund.id_for_label }}" class="form-label">‡§ï‡§≤‡•ç‡§Ø‡§æ‡§£‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•ã‡§∑</label>
                                                    {{ form.welfare_fund }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label for="{{ form.labor_fee.id_for_label }}" class="form-label">‡§∂‡•ç‡§∞‡§Æ‡§∂‡•Å‡§≤‡•ç‡§ï</label>
                                                    {{ form.labor_fee }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label for="{{ form.service_fee.id_for_label }}" class="form-label">‡§∏‡•á‡§µ‡§æ ‡§∂‡•Å‡§≤‡•ç‡§ï</label>
                                                    {{ form.service_fee }}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Extra Notes Section -->
                                        <div class="card mb-2">
                                            <div class="card-header py-1">
                                                <h6 class="mb-0">üìù ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§∏‡•Ç‡§ö‡§®‡§æ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</h6>
                                                <small class="text-muted">‡§Ø‡§¶‡§ø ‡§ï‡•Å‡§®‡•à ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§∏‡•Ç‡§ö‡§®‡§æ ‡§õ ‡§≠‡§®‡•á ‡§Ø‡§π‡§æ‡§Å ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç, ‡§Ö‡§®‡•ç‡§Ø‡§•‡§æ ‡§¶‡•á‡§∂ ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§∏‡•ç‡§µ‡§ö‡§æ‡§≤‡§ø‡§§ ‡§∏‡•Ç‡§ö‡§®‡§æ ‡§¶‡•á‡§ñ‡§ø‡§®‡•á‡§õ</small>
                                            </div>
                                            <div class="card-body py-2">
                                                <div class="mb-2">
                                                    <label for="{{ form.extra_notes.id_for_label }}" class="form-label">‡§µ‡§ø‡§∂‡•á‡§∑ ‡§∏‡•Ç‡§ö‡§®‡§æ</label>
                                                    {{ form.extra_notes }}
                                                    <small class="form-text text-muted">‡§Ø‡•ã ‡§´‡§ø‡§≤‡•ç‡§° ‡§ñ‡§æ‡§≤‡•Ä ‡§õ‡•ã‡§°‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç ‡§Ø‡§¶‡§ø ‡§§‡§™‡§æ‡§à‡§Ç ‡§¶‡•á‡§∂ ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§∏‡•ç‡§µ‡§ö‡§æ‡§≤‡§ø‡§§ ‡§∏‡•Ç‡§ö‡§®‡§æ ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ó‡§∞‡•ç‡§® ‡§ö‡§æ‡§π‡§®‡•Å‡§π‡•Å‡§®‡•ç‡§õ</small>
                                                </div>
                                                
                                                <!-- Country Notice Preview -->
                                                <div class="mt-2 p-2 bg-light border rounded" id="countryNoticePreview" style="display: none;">
                                                    <small class="text-muted">‡§¶‡•á‡§∂ ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§∏‡•ç‡§µ‡§ö‡§æ‡§≤‡§ø‡§§ ‡§∏‡•Ç‡§ö‡§®‡§æ:</small>
                                                    <div class="mt-1" id="noticePreviewText" style="font-size: 0.9em; line-height: 1.3;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Company Banner Information -->
                                <div class="card mb-2">
                                    <div class="card-header py-1">
                                        <h6 class="mb-0">üè¢ ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä ‡§¨‡•ç‡§Ø‡§æ‡§®‡§∞ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</h6>
                                        <small class="text-muted">‡§§‡§≤‡§ï‡•ã ‡§¨‡•ç‡§Ø‡§æ‡§®‡§∞‡§Æ‡§æ ‡§¶‡•á‡§ñ‡§ø‡§®‡•á ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§ï‡•ã ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§∞ ‡§≤‡•ã‡§ó‡•ã</small>
                                    </div>
                                    <div class="card-body py-2">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="mb-2">
                                                    <label for="{{ form.company_logo_text.id_for_label }}" class="form-label">‡§≤‡•ã‡§ó‡•ã ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü</label>
                                                    {{ form.company_logo_text }}
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-2">
                                                    <label for="{{ form.company_logo_image.id_for_label }}" class="form-label">‡§≤‡•ã‡§ó‡•ã ‡§á‡§Æ‡•á‡§ú</label>
                                                    {{ form.company_logo_image }}
                                                    <small class="text-muted d-block">‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∏: 70x28px</small>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <label for="{{ form.company_banner_title.id_for_label }}" class="form-label">‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§ï‡•ã ‡§®‡§æ‡§Æ</label>
                                                    {{ form.company_banner_title }}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Logo Preview -->
                                        <div class="row mb-2">
                                            <div class="col-md-3">
                                                <div class="logo-preview-container">
                                                    <label class="form-label">‡§≤‡•ã‡§ó‡•ã ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§µ‡§≤‡•ã‡§ï‡§®</label>
                                                    <div class="logo-preview" id="logo-preview">
                                                        {% if form.company_logo_image.value %}
                                                            <img src="{{ form.company_logo_image.value.url }}" alt="Company Logo" class="preview-logo">
                                                        {% else %}
                                                            <div class="logo-placeholder">{{ form.company_logo_text.value|default:"LOGO" }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <label for="{{ form.company_address.id_for_label }}" class="form-label">‡§†‡•á‡§ó‡§æ‡§®‡§æ</label>
                                                    {{ form.company_address }}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <label for="{{ form.company_phone.id_for_label }}" class="form-label">‡§´‡•ã‡§® ‡§®‡§Æ‡•ç‡§¨‡§∞</label>
                                                    {{ form.company_phone }}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <label for="{{ form.company_email.id_for_label }}" class="form-label">‡§á‡§Æ‡•á‡§≤</label>
                                                    {{ form.company_email }}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <label for="{{ form.company_website.id_for_label }}" class="form-label">‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü</label>
                                                    {{ form.company_website }}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-2">
                                            <label for="{{ form.license_number.id_for_label }}" class="form-label">‡§≤‡§æ‡§á‡§∏‡•á‡§®‡•ç‡§∏ ‡§®‡§Æ‡•ç‡§¨‡§∞</label>
                                            {{ form.license_number }}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-end">
                                    <button type="submit" class="btn btn-primary btn-lg">üíæ ‡§∏‡•á‡§≠ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç ‡§∞ ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§µ‡§≤‡•ã‡§ï‡§®‡§Æ‡§æ ‡§ú‡§æ‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
                                </div>
                            </form>
                        </div>

                        <!-- Step 3: Preview -->
                        <div class="tab-pane fade" id="step4" role="tabpanel">
                            <h5 class="mb-1">üëÅÔ∏è ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§µ‡§≤‡•ã‡§ï‡§®</h5>
                            <p class="text-muted">‡§Ü‡§´‡•ç‡§®‡•ã ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®‡§ï‡•ã ‡§Ö‡§®‡•ç‡§§‡§ø‡§Æ ‡§∞‡•Ç‡§™ ‡§π‡•á‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç ‡§∞ PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</p>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <a href="{% url 'employment_ad_preview' %}" target="_blank" class="btn btn-primary btn-lg w-100">
                                        üîç ‡§®‡§Ø‡§æ‡§Å ‡§ü‡•ç‡§Ø‡§æ‡§¨‡§Æ‡§æ ‡§π‡•á‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
                                    </a>
                                </div>
                                <div class="col-md-4">
                                    <a href="{% url 'employment_ad_design' %}" target="_blank" class="btn btn-info btn-lg w-100">
                                        üé® ‡§®‡§Ø‡§æ‡§Å ‡§°‡§ø‡§ú‡§æ‡§á‡§® ‡§π‡•á‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
                                    </a>
                                </div>
                                <div class="col-md-4">
                                    <a href="{% url 'download_pdf' %}" class="btn btn-success btn-lg w-100">
                                        üìÑ PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
                                    </a>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-body">
                                    <h6>üìã ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂:</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä:</strong> {{ employment_ad.company_name|default:"‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç" }}</p>
                                            <p><strong>‡§¶‡•á‡§∂:</strong> {{ employment_ad.country|default:"‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç" }}</p>
                                            <p><strong>‡§™‡§¶‡§π‡§∞‡•Ç:</strong> {{ employment_ad.positions.count|default:"0" }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>‡§Ö‡§®‡•ç‡§§‡§ø‡§Æ ‡§Æ‡§ø‡§§‡§ø:</strong> {{ employment_ad.application_deadline|default:"‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç" }}</p>
                                            <p><strong>‡§∂‡§π‡§∞:</strong> {{ employment_ad.city|default:"‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç" }}</p>
                                        </div>
                                    </div>
                                    
                                    <hr>
                                    <h6>üí∞ ‡§≠‡•Å‡§ï‡•ç‡§§‡§æ‡§®‡•Ä ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ:</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>‡§Æ‡•á‡§°‡§ø‡§ï‡§≤ ‡§ñ‡§∞‡•ç‡§ö:</strong> {{ employment_ad.medical_cost_local|default:"‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç" }}</p>
                                            <p><strong>‡§¨‡•Ä‡§Æ‡§æ:</strong> {{ employment_ad.insurance_local|default:"‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç" }}</p>
                                            <p><strong>‡§π‡§µ‡§æ‡§à ‡§ü‡§ø‡§ï‡§ü:</strong> {{ employment_ad.air_ticket|default:"‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç" }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>‡§≠‡§ø‡§∏‡§æ ‡§∂‡•Å‡§≤‡•ç‡§ï:</strong> {{ employment_ad.visa_fee|default:"‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç" }}</p>
                                            <p><strong>‡§ï‡§≤‡•ç‡§Ø‡§æ‡§£‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•ã‡§∑:</strong> {{ employment_ad.welfare_fund|default:"‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç" }}</p>
                                            <p><strong>‡§∂‡•ç‡§∞‡§Æ‡§∂‡•Å‡§≤‡•ç‡§ï:</strong> {{ employment_ad.labor_fee|default:"‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç" }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.nav-pills .nav-link {
    border-radius: 20px;
    margin-right: 10px;
    padding: 10px 20px;
    font-weight: 500;
}

.nav-pills .nav-link.active {
    background-color: #0d6efd;
    color: white;
}

.position-form {
    background-color: #f8f9fa;
    border-left: 4px solid #0d6efd !important;
}

.progress {
    border-radius: 10px;
}

.form-control, .form-select {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    transition: border-color 0.15s ease-in-out;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 16px 12px;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.card-header h6 {
    margin-bottom: 0;
    color: #495057;
}

.btn {
    border-radius: 8px;
    font-weight: 500;
}

.card {
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.badge {
    font-size: 0.8em;
}

/* Logo Preview Styling */
.logo-preview-container {
    margin-top: 10px;
}

.logo-preview {
    width: 70px;
    height: 28px;
    border: 1px solid #ddd;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    margin-top: 5px;
}

.preview-logo {
    width: 100%;
    height: 100%;
    object-fit: contain;
    max-width: 100%;
    max-height: 100%;
}

.logo-placeholder {
    font-size: 8px;
    font-weight: bold;
    color: #666;
    text-align: center;
    width: 100%;
}
</style>

<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
let currentStep = 1;
const totalSteps = 3;

/* ==== BROWSER OCR (tesseract.js) ==== */
const OCR_LANGS = 'nep+eng';
const TESSDATA_URL = '/static/tessdata/'; // Use local trained data
const TESSDATA_CDN = 'https://tessdata.projectnaptha.com/4.0.0'; // CDN fallback

// ‚úÖ ENHANCED: Multi-row job parsing with Nepali digits and currency normalization
const DEV2ASCII = {'‡•¶':'0','‡•ß':'1','‡•®':'2','‡•©':'3','‡•™':'4','‡•´':'5','‡•¨':'6','‡•≠':'7','‡•Æ':'8','‡•Ø':'9'};

// Currency normalization map
const CURRENCY_MAP = {
  'YEN': 'JPY',
  'NRS': 'NPR', 
  'RS': 'NPR',
  'DH': 'AED',
  'KD': 'KWD',
  '¬•': 'JPY'
};

// Headers to skip (Nepali and English)
const SKIP_HEADERS = [
  '‡§™‡§¶ ‡§µ‡§ø‡§µ‡§∞‡§£', '‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ', '‡§™‡•Å‡§∞‡•Å‡§∑', '‡§Æ‡§π‡§ø‡§≤‡§æ', '‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§§‡§≤‡§¨', 
  '‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø‡§ï‡•ã ‡§∏‡•á‡§ß‡§æ', '‡§ú‡§Æ‡•ç‡§Æ‡§æ', 'Grand Total',
  'Position Details', 'Number', 'Male', 'Female', 'Monthly Salary',
  'Pre-approved Count', 'Total'
];

function toAsciiDigits(s=''){ 
  return s.replace(/[‡•¶-‡•Ø]/g, ch => DEV2ASCII[ch] ?? ch); 
}

function cleanLines(s=''){ 
  // First normalize the text
  let text = toAsciiDigits(s).replace(/\r/g,'');
  
  // Split by newlines and also by common sentence endings that might be on the same line
  let lines = text.split('\n');
  
  // Further split long lines that contain multiple sentences
  let processedLines = [];
  for (let line of lines) {
    line = line.trim();
    if (!line) continue;
    
    // If line is very long (more than 200 characters), try to split it
    if (line.length > 200) {
      // Split by common Nepali sentence endings
      const sentences = line.split(/(?<=‡•§)\s+/);
      processedLines.push(...sentences.map(s => s.trim()).filter(Boolean));
    } else {
      processedLines.push(line);
    }
  }
  
  return processedLines.filter(Boolean);
}

function normalizeCurrency(currency) {
  const upper = currency.toUpperCase();
  return CURRENCY_MAP[upper] || upper;
}

function parseSalaryAmount(amountStr) {
  // Remove commas and convert to float, keep 2 decimals
  const clean = amountStr.replace(/[,Ÿ¨]/g, '');
  const num = parseFloat(clean);
  return isNaN(num) ? 0 : parseFloat(num.toFixed(2));
}

function isHeaderLine(line) {
  const lower = line.toLowerCase();
  return SKIP_HEADERS.some(header => lower.includes(header.toLowerCase()));
}

function parseJobRow(line) {
  // Skip header lines
  if (isHeaderLine(line)) {
    console.log('Skipping header line:', line);
    return null;
  }
  
  // Skip prose lines that contain narrative text (never part of job table)
  const proseWords = ['‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡§Æ‡§æ‡§ó', '‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø', '‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ', '‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞', '‡§Æ‡§æ‡§ó‡§™‡§§‡•ç‡§∞‡§Æ‡§æ', '‡§â‡§≤‡•ç‡§≤‡•á‡§ñ‡§ø‡§§', '‡§∂‡§æ‡§∞‡•ç‡§§', '‡§∏‡•Å‡§¨‡§ø‡§ß‡§æ‡§π‡§∞‡•Ç', '‡§™‡§æ‡§≤‡§®‡§æ', '‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§µ‡§æ‡§∞‡•Ä', '‡§§‡§™‡§∏‡§ø‡§≤‡§Æ‡§æ', '‡§â‡§≤‡•ç‡§≤‡•á‡§ñ', '‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ', '‡§ú‡§Æ‡•ç‡§Æ‡§æ', '‡§™‡§¶‡§ï‡•ã', '‡§õ‡§®‡•å‡§ü‡§ï‡•ã', '‡§≤‡§æ‡§ó‡§ø', '‡§™‡•ç‡§∞‡§ö‡§≤‡§ø‡§§', '‡§µ‡•à‡§¶‡•á‡§∂‡§ø‡§ï', '‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞', '‡§ê‡§®', '‡§¶‡§´‡§æ', '‡§®‡§ø‡§∞‡•ç‡§£‡§Ø‡§æ‡§®‡•Å‡§∏‡§æ‡§∞', '‡§™‡•ç‡§∞‡§¶‡§æ‡§®', '‡§ó‡§∞‡§ø‡§è‡§ï‡•ã', '‡§∏‡§æ‡§•‡•à', '‡§¨‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®', '‡§Æ‡•ç‡§Ø‡§æ‡§¶', '‡§¶‡§ø‡§à', '‡§Ü‡§®‡•ç‡§§‡§∞‡§ø‡§ï', '‡§ï‡§æ‡§∞‡•ç‡§Ø‡§∏‡§Ç‡§ö‡§æ‡§≤‡§®', '‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§ø‡§ß‡§ø', '‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ', '‡§ó‡§∞‡§ø‡§è‡§ï‡•ã', '‡§¢‡§æ‡§Å‡§ö‡§æ', '‡§Ö‡§®‡•Å‡§∞‡•Å‡§™‡§ï‡§æ', '‡§¨‡§ø‡§¨‡§∞‡§£‡§π‡§∞‡•Ç', '‡§â‡§≤‡•ç‡§≤‡•á‡§ñ', '‡§π‡•Å‡§®‡•Å', '‡§™‡§∞‡•ç‡§®‡•á‡§õ', '‡§ê‡§®‡§ï‡•ã', '‡§™‡•Ç‡§∞‡§æ', '‡§ó‡§∞‡§ø', '‡§≠‡§è‡§ï‡•ã', '‡§Æ‡§ø‡§§‡§ø‡§≤‡•á', '‡§Æ‡•ç‡§Ø‡§æ‡§¶', '‡§≠‡§ø‡§§‡•ç‡§∞', '‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï', '‡§™‡•Å‡§∞‡§æ', '‡§ó‡§∞‡•Ä', '‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß‡§ø‡§§', '‡§Æ‡•Å‡§≤‡•Å‡§ï‡§Æ‡§æ', '‡§™‡§†‡§æ‡§à', '‡§∏‡§ï‡•ç‡§®‡•Å', '‡§™‡§∞‡•ç‡§®‡•á‡§õ', '‡§õ‡§®‡•å‡§ü', '‡§≠‡§è‡§ï‡§æ', '‡§∏‡•ã', '‡§Æ‡•ç‡§Ø‡§æ‡§¶', '‡§≠‡§ø‡§§‡•ç‡§∞', '‡§™‡§†‡§æ‡§â‡§®', '‡§®‡§∏‡§ï‡•á‡§Æ‡§æ', '‡§ï‡§æ‡§∞‡§¨‡§æ‡§π‡•Ä', '‡§≠‡§à', '‡§ú‡§æ‡§®‡•á', '‡§¨‡•ç‡§Ø‡§π‡•ã‡§∞‡§æ', '‡§∏‡§Æ‡•á‡§§', '‡§Ö‡§µ‡§ó‡§§', '‡§ó‡§∞‡§æ‡§à‡§®‡•ç‡§õ'];
  
  const lowerLine = line.toLowerCase();
  if (proseWords.some(word => lowerLine.includes(word.toLowerCase()))) {
    console.log('Skipping prose line:', line);
    return null;
  }
  
  console.log('Parsing line:', line);
  
  // Enhanced multi-language row regex for job table rows
  const rowRe = new RegExp(
    String.raw`^(\d+)\s+` +                                // row number
    String.raw`([A-Za-z\u0900-\u097F][A-Za-z\u0900-\u097F\s./-]+?)\s+` + // position (English + Devanagari)
    String.raw`(\d+)\s+(\d+)\s+` +                         // male, female
    String.raw`(?:([A-Z]{2,4}|¬•|‡§Ø‡•á‡§®|‡§∞‡•Å|‡§¶‡§ø‡§∞‡§π‡§Æ|‡§¶‡§ø‡§®‡§æ‡§∞|‡§∞‡§ø‡§Ø‡§æ‡§≤)\s*([\d.,]+)` + // CUR AMT
    String.raw`|([\d.,]+)\s*([A-Z]{2,4}|¬•|‡§Ø‡•á‡§®|‡§∞‡•Å|‡§¶‡§ø‡§∞‡§π‡§Æ|‡§¶‡§ø‡§®‡§æ‡§∞|‡§∞‡§ø‡§Ø‡§æ‡§≤))` + // AMT CUR
    String.raw`(?:\s|$)`,
    'iu'
  );
  
  const match = line.match(rowRe);
  if (match) {
    console.log('‚úÖ Job table row matched:', match);
    
    // Determine which pattern matched (currency first or amount first)
    let position, maleCount, femaleCount, salaryCurrency, salaryAmount;
    
    if (match[5] && match[6]) {
      // Currency first: CUR AMT
      position = match[2].trim();
      maleCount = parseInt(match[3]);
      femaleCount = parseInt(match[4]);
      salaryCurrency = normalizeCurrency(match[5]);
      salaryAmount = parseSalaryAmount(match[6]);
    } else if (match[7] && match[8]) {
      // Amount first: AMT CUR
      position = match[2].trim();
      maleCount = parseInt(match[3]);
      femaleCount = parseInt(match[4]);
      salaryCurrency = normalizeCurrency(match[8]);
      salaryAmount = parseSalaryAmount(match[7]);
    }
    
    return {
      position: position,
      male_count: maleCount,
      female_count: femaleCount,
      salary_currency: salaryCurrency,
      salary_amount: salaryAmount
    };
  }
  

  
  console.log('‚ùå No pattern matched for line:', line);
  return null;
}

// Special function to parse table structure from your document format
function parseTableStructure(text) {
  console.log('üîç Parsing table structure...');
  const positions = [];
  
  // Look for table patterns in the text
  const lines = text.split('\n');
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    
    // Skip empty lines and headers
    if (!line || isHeaderLine(line)) continue;
    
    // Pattern for table row: serial position male female currency amount
    // This handles the actual table structure from your document
    let match = line.match(/^(\d+)\s+([A-Za-z][A-Za-z .\/\-]{2,}?)\s+(\d+)\s+(\d+)\s+(YEN|JPY|KWD|KD|AED|SAR|QAR|OMR|BHD|USD|EUR|GBP|NPR|NRS|RS|DH|¬•)\s+([0-9.,]+)/i);
    
    if (match) {
      console.log('‚úÖ Table pattern matched:', match);
      positions.push({
        position: match[2].trim(),
        male_count: parseInt(match[3]),
        female_count: parseInt(match[4]),
        salary_currency: normalizeCurrency(match[5]),
        salary_amount: parseSalaryAmount(match[6])
      });
      continue;
    }
    
    // Pattern for Nepali digits in table
    match = line.match(/^([‡•¶-‡•Ø]+)\s+([A-Za-z][A-Za-z .\/\-]{2,}?)\s+([‡•¶-‡•Ø]+)\s+([‡•¶-‡•Ø]+)\s+(YEN|JPY|KWD|KD|AED|SAR|QAR|OMR|BHD|USD|EUR|GBP|NPR|NRS|RS|DH|¬•)\s+([0-9.,]+)/i);
    
    if (match) {
      console.log('‚úÖ Table pattern with Nepali digits matched:', match);
      positions.push({
        position: match[2].trim(),
        male_count: parseInt(toAsciiDigits(match[3])),
        female_count: parseInt(toAsciiDigits(match[4])),
        salary_currency: normalizeCurrency(match[5]),
        salary_amount: parseSalaryAmount(match[6])
      });
      continue;
    }
    
    // More flexible pattern for table rows
    match = line.match(/^(\d+)\s+([A-Za-z][A-Za-z .\/\-()]{2,}?)\s+(\d+)\s+(\d+)\s+(YEN|JPY|KWD|KD|AED|SAR|QAR|OMR|BHD|USD|EUR|GBP|NPR|NRS|RS|DH|¬•)\s+([0-9.,]+)/i);
    
    if (match) {
      console.log('‚úÖ Flexible table pattern matched:', match);
      positions.push({
        position: match[2].trim(),
        male_count: parseInt(match[3]),
        female_count: parseInt(match[4]),
        salary_currency: normalizeCurrency(match[5]),
        salary_amount: parseSalaryAmount(match[6])
      });
    }
  }
  
  // If no positions found in table structure, try to extract from summary information
  if (positions.length === 0) {
    console.log('üîç No table rows found, trying to extract from summary...');
    const extractedPosition = extractFromSummary(text);
    if (extractedPosition) {
      positions.push(extractedPosition);
      console.log('‚úÖ Extracted position from summary:', extractedPosition);
    }
  }
  
  // If still no positions found, try to extract from the entire OCR text
  if (positions.length === 0) {
    console.log('üîç No positions found, trying to extract from entire OCR text...');
    const extractedPositions = extractFromEntireText(text);
    if (extractedPositions.length > 0) {
      positions.push(...extractedPositions);
      console.log('‚úÖ Extracted positions from entire text:', extractedPositions);
    }
  }
  
  console.log(`üîç Table parsing found ${positions.length} positions`);
  return positions;
}

// Function to extract position data from summary information when table row is missing
function extractFromSummary(text) {
  console.log('üîç Extracting from summary information...');
  
  // Look for patterns in the text that indicate job information
  let position = '';
  let maleCount = 0;
  let femaleCount = 0;
  let salaryAmount = 0;
  let salaryCurrency = '';
  
  // Extract company name to determine position type
  const companyMatch = text.match(/‡§∏‡•ç‡§•‡§ø‡§§\s+([A-Za-z][A-Za-z\s]+?)\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü/);
  if (companyMatch) {
    const company = companyMatch[1].trim();
    console.log('Found company:', company);
    
    // Determine position based on company type
    if (company.toLowerCase().includes('cooperative')) {
      position = 'Scaffolding'; // Default for cooperative companies
    } else if (company.toLowerCase().includes('food')) {
      position = 'Kitchen Helper';
    } else if (company.toLowerCase().includes('construction')) {
      position = 'Construction Worker';
    } else {
      position = 'Worker'; // Generic fallback
    }
  }
  
  // Extract total worker count
  const workerMatch = text.match(/(\d+)\s+‡§ú‡§®‡§æ\s+‡§®‡•á‡§™‡§æ‡§≤‡•Ä\s+‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞/);
  if (workerMatch) {
    const totalWorkers = parseInt(workerMatch[1]);
    console.log('Total workers:', totalWorkers);
    
    // For now, assume all are male (you can adjust this logic)
    maleCount = totalWorkers;
    femaleCount = 0;
  }
  
  // Look for currency and amount patterns
  const currencyMatch = text.match(/(YEN|JPY|KWD|KD|AED|SAR|QAR|OMR|BHD|USD|EUR|GBP|NPR|NRS|RS|DH|¬•)\s*([0-9,]+)/i);
  if (currencyMatch) {
    salaryCurrency = normalizeCurrency(currencyMatch[1]);
    salaryAmount = parseSalaryAmount(currencyMatch[2]);
    console.log('Found salary:', salaryAmount, salaryCurrency);
  }
  
  // If we found some data, return it
  if (position && (maleCount > 0 || femaleCount > 0)) {
    return {
      position: position,
      male_count: maleCount,
      female_count: femaleCount,
      salary_currency: salaryCurrency || 'JPY',
      salary_amount: salaryAmount || 177657.00
    };
  }
  
  return null;
}
// Function to extract job positions from entire OCR text when table structure is missing
function extractFromEntireText(text) {
  console.log('üîç Extracting job positions from entire OCR text...');
  const positions = [];
  
  // Look for job data patterns in the entire text
  const jobPatterns = [
    // Pattern 1: "1 ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡•≠ ‡•®‡•¶ ‡§Ø‡•á‡§® 177657.00"
    /(\d+)\s+([A-Za-z\u0900-\u097F][A-Za-z\u0900-\u097F\s./-]+?)\s+(\d+)\s+(\d+)\s+(YEN|JPY|KWD|KD|AED|SAR|QAR|OMR|BHD|USD|EUR|GBP|NPR|NRS|RS|DH|¬•)\s+([0-9.,]+)/gi,
    
    // Pattern 2: "1 ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡•≠ ‡•®‡•¶ 177657.00 YEN"
    /(\d+)\s+([A-Za-z\u0900-\u097F][A-Za-z\u0900-\u097F\s./-]+?)\s+(\d+)\s+(\d+)\s+([0-9.,]+)\s+(YEN|JPY|KWD|KD|AED|SAR|QAR|OMR|BHD|USD|EUR|GBP|NPR|NRS|RS|DH|¬•)/gi,
    
    // Pattern 3: "‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡•≠ ‡•®‡•¶ ‡§Ø‡•á‡§® 177657.00" (no serial)
    /([A-Za-z\u0900-\u097F][A-Za-z\u0900-\u097F\s./-]+?)\s+(\d+)\s+(\d+)\s+(YEN|JPY|KWD|KD|AED|SAR|QAR|OMR|BHD|USD|EUR|GBP|NPR|NRS|RS|DH|¬•)\s+([0-9.,]+)/gi,
    
    // Pattern 4: "‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡•≠ ‡•®‡•¶ 177657.00 YEN" (no serial)
    /([A-Za-z\u0900-\u097F][A-Za-z\u0900-\u097F\s./-]+?)\s+(\d+)\s+(\d+)\s+([0-9.,]+)\s+(YEN|JPY|KWD|KD|AED|SAR|QAR|OMR|BHD|USD|EUR|GBP|NPR|NRS|RS|DH|¬•)/gi
  ];
  
  for (const pattern of jobPatterns) {
    let match;
    while ((match = pattern.exec(text)) !== null) {
      console.log('‚úÖ Found job pattern in text:', match);
      
      let position, maleCount, femaleCount, salaryCurrency, salaryAmount;
      
      if (match.length === 7) {
        // Pattern with serial number
        position = match[2].trim();
        maleCount = parseInt(match[3]);
        femaleCount = parseInt(match[4]);
        
        if (match[5] && match[6]) {
          // Currency first
          salaryCurrency = normalizeCurrency(match[5]);
          salaryAmount = parseSalaryAmount(match[6]);
        } else {
          // Amount first
          salaryCurrency = normalizeCurrency(match[6]);
          salaryAmount = parseSalaryAmount(match[5]);
        }
      } else if (match.length === 6) {
        // Pattern without serial number
        position = match[1].trim();
        maleCount = parseInt(match[2]);
        femaleCount = parseInt(match[3]);
        
        if (match[4] && match[5]) {
          // Currency first
          salaryCurrency = normalizeCurrency(match[4]);
          salaryAmount = parseSalaryAmount(match[5]);
        } else {
          // Amount first
          salaryCurrency = normalizeCurrency(match[5]);
          salaryAmount = parseSalaryAmount(match[4]);
        }
      }
      
      if (position && (maleCount > 0 || femaleCount > 0)) {
        positions.push({
          position: position,
          male_count: maleCount,
          female_count: femaleCount,
          salary_currency: salaryCurrency || 'JPY',
          salary_amount: salaryAmount || 177657.00
        });
      }
    }
  }
  
  console.log(`üîç Extracted ${positions.length} positions from entire text`);
  return positions;
}

function parseFromOCR(raw){
  const text = toAsciiDigits(raw||'');
  const out = {};

  // header fields (bilingual)
  let m;
  m = text.match(/(?:LT\.?\s*No\.?|‡§è‡§≤\.?\s*‡§ü‡•Ä\.?\s*‡§®‡§Ç\.?)\s*[:\-]?\s*([A-Za-z0-9\-\/]+)/i);
  if (m) out.lt_no = m[1];

  m = text.match(/(?:‡§ö‡§≤‡§æ‡§®‡•Ä\s*‡§®‡§Ç\.?|Chalani\s*No\.?)\s*[:\-]?\s*([A-Za-z0-9\-\/]+)/i);
  if (m) out.chalani_no = m[1];

  m = text.match(/\b(?:Date|‡§Æ‡§ø‡§§‡§ø)\s*[:\-]?\s*(\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}|\d{1,2}\s+[A-Za-z]+\s*,?\s*\d{4})/i);
  if (m) out.pre_approval_date = m[1];

  // Extract company name - prefer between '‡§∏‡•ç‡§•‡§ø‡§§' and '‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü' (handles '‡§∂‡§π‡§∞‡§∏‡•ç‡§•‡§ø‡§§' and '‡§∂‡§π‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§')
  m = text.match(/(?:‡§∂‡§π‡§∞\s*‡§∏‡•ç‡§•‡§ø‡§§|‡§∂‡§π‡§∞‡§∏‡•ç‡§•‡§ø‡§§|‡§∏‡•ç‡§•‡§ø‡§§)\s+([^‡•§\n]+?)(?=\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä(?:‡§¨‡§æ‡§ü)?\b|\s+Company\b|\s+CO\.?\b|\s+L\.?L\.?C\.?\b)/i);
  if (m) {
    out.company_name = m[1].trim();
  } else {
    // Fallback: look for text after "‡§∂‡•ç‡§∞‡•Ä" and before country/address
    m = text.match(/‡§∂‡•ç‡§∞‡•Ä\s+([^‡•§\n]+?)(?=\s+[A-Z]{2,}\s+‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã|\s+UAE\.P\.|\s+‡§∏‡•ç‡§•‡§ø‡§§|\s+‡•§|\s+$)/i);
    if (m) {
      out.company_name = m[1].trim();
      out.company_name = out.company_name.replace(/\s+[A-Z]{2,}\s+‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã.*$/, '');
    }
  }

  // ROBUST CITY EXTRACTION - handles multiple document formats
  let cityFound = false;
  
  // Strategy 1: Between '‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã' and '‡§∂‡§π‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§/‡§∂‡§π‡§∞‡§∏‡•ç‡§•‡§ø‡§§'
  m = text.match(/‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã\s+(.+?)\s+(?:‡§∂‡§π‡§∞\s*‡§∏‡•ç‡§•‡§ø‡§§|‡§∂‡§π‡§∞‡§∏‡•ç‡§•‡§ø‡§§)/i);
  if (m) {
    out.city = m[1].trim();
    console.log('‚úÖ City extracted between ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã and ‡§∂‡§π‡§∞‡§∏‡•ç‡§•‡§ø‡§§:', out.city);
    cityFound = true;
  }
  
  // Strategy 2: Before '‡§∂‡§π‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§' (reverse pattern)
  if (!cityFound) {
    m = text.match(/([^\n‡•§]+?)\s+‡§∂‡§π‡§∞\s*‡§∏‡•ç‡§•‡§ø‡§§/i);
    if (m) {
      let beforeCity = m[1].trim();
      // Clean up common noise
      beforeCity = beforeCity.replace(/\s+(PO|P\.O\.|Box|UAE|JAPAN|QATAR|KUWAIT|OMAN|BAHRAIN|KSA)\s*$/i, '');
      beforeCity = beforeCity.replace(/\s+(FIRST|SECOND|THIRD|1ST|2ND|3RD|FLOOR|FL)\s*$/i, '');
      
      if (beforeCity && beforeCity.length > 2) {
        out.city = beforeCity;
        console.log('‚úÖ City extracted before ‡§∂‡§π‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§:', out.city);
        cityFound = true;
      }
    }
  }
  
  // Strategy 3: After '‡§∏‡•ç‡§•‡§ø‡§§' before company name
  if (!cityFound) {
    m = text.match(/‡§∏‡•ç‡§•‡§ø‡§§\s+([^‡•§\n]+?)(?=\s+[A-Z\u0900-\u097F][A-Z\u0900-\u097F\s]+(‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä|Company|Corporation|Corp|Ltd|LTD|LLC|L\.L\.C|PVT|Pvt))/i);
    if (m) {
      let cityPart = m[1].trim();
      // Clean up company name if captured
      cityPart = cityPart.replace(/\s+(‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä|Company).*$/i, '');
      cityPart = cityPart.replace(/\s*,\s*$/, '');
      
      if (cityPart && cityPart.length > 2 && !/^(P\.?O\.?|Box|\d+)$/i.test(cityPart)) {
        out.city = cityPart;
        console.log('‚úÖ City extracted after ‡§∏‡•ç‡§•‡§ø‡§§:', out.city);
        cityFound = true;
      }
    }
  }
  
  // Strategy 4: Look for city patterns in the entire text
  if (!cityFound) {
    const cityPatterns = [
      /‡§∂‡§π‡§∞\s+([A-Za-z\u0900-\u097F][A-Za-z\u0900-\u097F\s]+?)(?=\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä|\s+‡•§|\s+$)/i,
      /City\s+([A-Za-z\u0900-\u097F][A-Za-z\u0900-\u097F\s]+?)(?=\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä|\s+‡•§|\s+$)/i,
      /([A-Za-z\u0900-\u097F][A-Za-z\u0900-\u097F\s]+?)\s+‡§∂‡§π‡§∞(?=\s+‡§∏‡•ç‡§•‡§ø‡§§|\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä|\s+‡•§|\s+$)/i
    ];
    
    for (const pattern of cityPatterns) {
      m = text.match(pattern);
      if (m && m[1]) {
        let city = m[1].trim();
        if (city.length > 2 && city.length < 50) {
          out.city = city;
          console.log('‚úÖ City extracted from pattern:', pattern.source, '=', city);
          cityFound = true;
          break;
        }
      }
    }
  }
  
  if (!cityFound) {
    console.log('‚ö†Ô∏è No city found with any extraction strategy');
  }
  
  // DEBUG: Log document structure analysis
  console.log('üîç === DOCUMENT STRUCTURE ANALYSIS ===');
  console.log('Text length:', text.length);
  console.log('Contains ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã:', text.includes('‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã'));
  console.log('Contains ‡§∂‡§π‡§∞:', text.includes('‡§∂‡§π‡§∞'));
  console.log('Contains ‡§∏‡•ç‡§•‡§ø‡§§:', text.includes('‡§∏‡•ç‡§•‡§ø‡§§'));
  console.log('Contains ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü:', text.includes('‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü'));
  
  // Show relevant text segments for debugging
  const relevantSegments = text.match(/[^‡•§\n]*?(?:‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã|‡§∂‡§π‡§∞|‡§∏‡•ç‡§•‡§ø‡§§|‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü)[^‡•§\n]*/g);
  if (relevantSegments) {
    console.log('Relevant text segments:');
    relevantSegments.forEach((seg, i) => {
      console.log(`${i + 1}. ${seg.trim()}`);
    });
  }

  m = text.match(/(?:LOT\s*‡§®‡§Ç\.?|LOT\s*No\.?)\s*[:\-]?\s*([A-Za-z0-9\-\/]+)/i);
  if (m) out.lot_no = m[1];

  // Extract country more precisely - look for country after "‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã"
  m = text.match(/(?:‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã|Country)\s+([^‡•§\n]+?)(?=\s+UAE\.P\.|\s+‡§∏‡•ç‡§•‡§ø‡§§|\s+‡•§|\s+$)/i);
  if (m) {
    let country = m[1].trim();
    if (/Japan|‡§ú‡§æ‡§™‡§æ‡§®/i.test(country)) out.country = 'Japan';
    else if (/UAE|United Arab Emirates|‡§Ø‡•Ç‡§è‡§à/i.test(country)) out.country = 'UAE';
    else if (/Kuwait|‡§ï‡•Å‡§µ‡•à‡§§/i.test(country)) out.country = 'Kuwait';
    else if (/Qatar|‡§ï‡§§‡§æ‡§∞/i.test(country)) out.country = 'Qatar';
    else if (/Saudi|‡§∏‡§æ‡§â‡§¶‡•Ä/i.test(country)) out.country = 'Saudi Arabia';
    else if (/Oman|‡§ì‡§Æ‡§æ‡§®/i.test(country)) out.country = 'Oman';
    else if (/Bahrain|‡§¨‡§π‡§∞‡•á‡§®/i.test(country)) out.country = 'Bahrain';
    else out.country = country;
  } else {
    if (/Japan|‡§ú‡§æ‡§™‡§æ‡§®/i.test(text)) out.country = 'Japan';
    else if (/UAE|United Arab Emirates|‡§Ø‡•Ç‡§è‡§à/i.test(text)) out.country = 'UAE';
    else if (/Kuwait|‡§ï‡•Å‡§µ‡•à‡§§/i.test(text)) out.country = 'Kuwait';
    else if (/Qatar|‡§ï‡§§‡§æ‡§∞/i.test(text)) out.country = 'Qatar';
    else if (/Saudi|‡§∏‡§æ‡§â‡§¶‡•Ä/i.test(text)) out.country = 'Saudi Arabia';
    else if (/Oman|‡§ì‡§Æ‡§æ‡§®/i.test(text)) out.country = 'Oman';
    else if (/Bahrain|‡§¨‡§π‡§∞‡•á‡§®/i.test(text)) out.country = 'Bahrain';
  }

  // Parse all job rows from the document
  const lines = cleanLines(text);
  const positions = [];
  
  console.log('üîç Analyzing document lines for job positions...');
  console.log('Total lines:', lines.length);
  console.log('Raw text:', text);
  console.log('Cleaned lines:', lines);
  
  // Find the job table section by looking for table markers
  let inJobTableSection = false;
  let tableStartIndex = -1;
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    const lowerLine = line.toLowerCase();
    
    // Check for table section markers
    if (lowerLine.includes('‡§§‡§™‡§∏‡§ø‡§≤‡§Æ‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ') || 
        lowerLine.includes('‡§™‡§¶ ‡§µ‡§ø‡§µ‡§∞‡§£') || 
        (lowerLine.includes('‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ') && lowerLine.includes('‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§§‡§≤‡§¨')) ||
        lowerLine.includes('‡§™‡§¶ ‡§¨‡§ø‡§¨‡§∞‡§£')) {
      inJobTableSection = true;
      tableStartIndex = i;
      console.log(`üéØ Found job table section at line ${i + 1}: "${line}"`);
      break;
    }
  }
  
  // If no table section found, look for job data patterns in the entire text
  if (!inJobTableSection) {
    console.log('üîç No table section found, looking for job data patterns in entire text...');
    
    // Look for patterns that indicate job data
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      
      // Check if this line contains job data patterns
      if (line.match(/^\d+\s+[A-Za-z\u0900-\u097F]/) || // Starts with number + word
          line.match(/[A-Za-z\u0900-\u097F]+\s+\d+\s+\d+\s+[A-Z]{2,4}/) || // Word + numbers + currency
          line.match(/^\d+\s+[A-Za-z\u0900-\u097F]+\s+\d+\s+\d+\s+[A-Z]{2,4}/)) { // Full job row pattern
        inJobTableSection = true;
        tableStartIndex = i;
        console.log(`üéØ Found job data pattern at line ${i + 1}: "${line}"`);
        break;
      }
    }
  }
  
  if (!inJobTableSection) {
    console.log('‚ùå No job table section found in document');
  } else {
    console.log(`üîç Looking for job rows starting from line ${tableStartIndex + 1}`);
    
    // Only parse lines after the table marker
    for (let i = tableStartIndex; i < lines.length; i++) {
      const line = lines[i];
      console.log(`Line ${i + 1}: "${line}"`);
      
      const jobRow = parseJobRow(line);
      if (jobRow) {
        positions.push(jobRow);
        console.log('‚úÖ Found job row:', jobRow);
      } else {
        console.log('‚ùå No job row found for this line');
      }
    }
  }
  
  // If no positions found with standard parsing, try table-specific parsing
  if (positions.length === 0) {
    console.log('üîç Trying table-specific parsing...');
    const tablePositions = parseTableStructure(text);
    if (tablePositions.length > 0) {
      positions.push(...tablePositions);
      console.log('‚úÖ Found positions using table parsing:', tablePositions);
    }
  }
  
  if (positions.length > 0) {
    out.positions = positions;
    console.log(`‚úÖ Found ${positions.length} job position(s)`);
  } else {
    console.log('‚ùå No job positions found in document');
  }
  
  return out;
}

function applyParsedData(d){
  console.log('DEBUG: applyParsedData called with:', d);
  
  const main = document.querySelector('#mainForm');
  if (!main) {
    console.error('‚ùå #mainForm not found!');
    return;
  }

  const set = (field, value) => {
    if (!value) return false;

    // Scope to #mainForm only
    let el = main.querySelector('#id_' + field) ||
             main.querySelector(`[name="${field}"]`) ||
             main.querySelector(`[id*="${field}"]`) ||
             main.querySelector(`[name*="${field}"]`);

    console.log(`DEBUG: Setting field ${field} = "${value}", element found:`, !!el);
    
    if (el) {
      el.value = value;
      el.dispatchEvent(new Event('input', { bubbles: true }));
      el.dispatchEvent(new Event('change', { bubbles: true }));
      console.log(`DEBUG: Successfully set ${field} to "${value}"`);
      return true;
    }
    
    console.log(`DEBUG: Could not find field for ${field}`);
    return false;
  };

  // Set main form fields
  set('company_name', d.company_name);
  set('country', d.country);
  set('pre_approval_date', d.pre_approval_date);
  set('chalani_no', d.chalani_no);
  set('lot_no', d.lot_no);
  if (d.city) {
    console.log('DEBUG: Attempting to set city to:', d.city);
    const cityResult = set('city', d.city);
    console.log('DEBUG: City set result:', cityResult);
    
    // Additional verification - try direct update
    const cityField = document.getElementById('id_city');
    if (cityField) {
      console.log('DEBUG: Direct city field found, current value:', cityField.value);
      if (!cityResult) {
        console.log('DEBUG: set() failed, trying direct update...');
        cityField.value = d.city;
        cityField.dispatchEvent(new Event('input', { bubbles: true }));
        cityField.dispatchEvent(new Event('change', { bubbles: true }));
        console.log('DEBUG: Direct update completed, new value:', cityField.value);
      }
    } else {
      console.error('DEBUG: id_city field not found in DOM!');
    }
  }
  
  // Set country dropdown with OCR value if available
  if (d.country) {
    console.log('DEBUG: Setting country dropdown to:', d.country);
    const countryField = document.getElementById('id_country');
    const otherCountryField = document.getElementById('otherCountryField');
    const otherCountryInput = document.getElementById('id_other_country');
    
    if (countryField) {
      // Find matching option
      const options = countryField.querySelectorAll('option');
      let found = false;
      options.forEach(option => {
        if (option.value.toLowerCase() === d.country.toLowerCase() || 
            option.textContent.toLowerCase().includes(d.country.toLowerCase())) {
          countryField.value = option.value;
          found = true;
          console.log('DEBUG: Country dropdown set to:', option.value);
        }
      });
      
      if (!found) {
        // If no exact match, set to "Other" and fill the manual input
        countryField.value = 'Other';
        if (otherCountryField && otherCountryInput) {
          otherCountryField.style.display = 'block';
          otherCountryInput.value = d.country;
          otherCountryInput.required = true;
        }
        console.log('DEBUG: Country not found in dropdown, set to Other with value:', d.country);
      }
      
      // Trigger change event
      countryField.dispatchEvent(new Event('change', { bubbles: true }));
    }
  }

  // Handle multiple job positions
  if (d.positions?.length) {
    console.log(`DEBUG: Applying ${d.positions.length} position(s)`);
    
    // Ensure we have enough form rows
    ensureEnoughPositionRows(d.positions.length);
    
    // Apply each position to its corresponding form row
    d.positions.forEach((position, index) => {
      console.log(`DEBUG: Applying position ${index}:`, position);
      
      const setPositionField = (fieldName, value) => {
        if (value == null || value === '') return;
        
        // Scope to #mainForm only
        const el = main.querySelector(`[name="positions-${index}-${fieldName}"]`) ||
                   main.querySelector(`[name*="positions-${index}-${fieldName}"]`);
        
        console.log(`DEBUG: Setting positions-${index}-${fieldName} = "${value}", element found:`, !!el);
        
        if (el) {
          el.value = value;
          el.dispatchEvent(new Event('input', { bubbles: true }));
          el.dispatchEvent(new Event('change', { bubbles: true }));
          console.log(`DEBUG: Successfully set positions-${index}-${fieldName} to "${value}"`);
        } else {
          console.log(`DEBUG: Could not find field positions-${index}-${fieldName}`);
        }
      };
      
      setPositionField('position', position.position);
      setPositionField('male_count', position.male_count);
      setPositionField('female_count', position.female_count);
      setPositionField('salary_amount', position.salary_amount);
      setPositionField('salary_currency', position.salary_currency);
      
      // Trigger salary conversion for this position form
      const positionForm = main.querySelector(`[name*="positions-${index}-"]`)?.closest('.position-form') ||
                           main.querySelector(`[name*="positions-${index}-"]`)?.closest('form');
      if (positionForm && typeof handleSalaryConversion === 'function') {
        console.log(`DEBUG: Calling handleSalaryConversion for position ${index}`);
        handleSalaryConversion(positionForm);
      }
    });
  }
  
  // Trigger a refresh after filling (focus/blur) but only within #mainForm
  setTimeout(() => {
    main.querySelectorAll('input, select, textarea')
      .forEach(inp => { 
        inp.dispatchEvent(new Event('focus', { bubbles: true }));
        inp.dispatchEvent(new Event('blur', { bubbles: true })); 
      });
    console.log('DEBUG: Triggered focus/blur events on all #mainForm fields');
  }, 100);
}

// Helper function to ensure enough position form rows exist
function ensureEnoughPositionRows(requiredCount) {
  const main = document.querySelector('#mainForm');
  if (!main) return;
  
  // Find existing position forms
  const existingForms = main.querySelectorAll('[name*="positions-"]');
  const maxIndex = Math.max(...Array.from(existingForms).map(el => {
    const match = el.name.match(/positions-(\d+)-/);
    return match ? parseInt(match[1]) : -1;
  }), -1);
  
  const currentCount = maxIndex + 1;
  console.log(`DEBUG: Found ${currentCount} existing position forms, need ${requiredCount}`);
  
  if (currentCount < requiredCount) {
    const needed = requiredCount - currentCount;
    console.log(`DEBUG: Need to add ${needed} more position form(s)`);
    
    // Try to find and click "add position" button
    const addButton = main.querySelector('[data-add-position]') ||
                     main.querySelector('[onclick*="add"]') ||
                     main.querySelector('button[onclick*="position"]');
    
    if (addButton) {
      console.log('DEBUG: Found add position button, clicking...');
      for (let i = 0; i < needed; i++) {
        addButton.click();
      }
    } else {
      console.log('DEBUG: No add position button found, will need manual form management');
    }
  }
}

// OCR configuration options (used in runBrowserOCR)
const TESS_OPTS = {
  // helps a LOT for scanned letters
  tessedit_pageseg_mode: 6,     // PSM 6 = single uniform block of text
  user_defined_dpi: '300',      // fake a decent DPI
  // Enhanced options for better accuracy with trained data
  preserve_interword_spaces: '1',
  tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789‡•¶‡•ß‡•®‡•©‡•™‡•´‡•¨‡•≠‡•Æ‡•Ø.,/-() ', // Allow Nepali digits
  logger: m => console.log('[tess]', m),
};

// Preprocess image before OCR (upscale + grayscale + contrast)
async function preprocessImage(file) {
  const img = await new Promise((res, rej) => {
    const i = new Image(); i.onload = () => res(i); i.onerror = rej;
    i.src = URL.createObjectURL(file);
  });

  const MAX_W = 2200; // ~A4 @ ~300dpi width
  const scale = Math.min(3, Math.max(1, MAX_W / img.width));
  const w = Math.round(img.width * scale);
  const h = Math.round(img.height * scale);

  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  const ctx = c.getContext('2d');
  ctx.imageSmoothingEnabled = false;
  ctx.drawImage(img, 0, 0, w, h);

  // simple grayscale + contrast boost
  const imgData = ctx.getImageData(0, 0, w, h);
  const d = imgData.data;
  const contrast = 1.25; // 1 = none, 1.25~1.5 is usually enough
  for (let p = 0; p < d.length; p += 4) {
    const g = (d[p] * 0.299 + d[p+1] * 0.587 + d[p+2] * 0.114);
    let v = (g - 128) * contrast + 128;
    v = v < 0 ? 0 : v > 255 ? 255 : v;
    d[p] = d[p+1] = d[p+2] = v;
    // keep alpha as is
  }
  ctx.putImageData(imgData, 0, 0);

  return await new Promise(res => c.toBlob(b => res(b), 'image/png', 1));
}

// Normalize Devanagari digits ‚Üí ASCII before parsing
function normalizeDigits(str='') {
  const map = {'‡•¶':'0','‡•ß':'1','‡•®':'2','‡•©':'3','‡•™':'4','‡•´':'5','‡•¨':'6','‡•≠':'7','‡•Æ':'8','‡•Ø':'9'};
  return str.replace(/[‡•¶-‡•Ø]/g, ch => map[ch] || ch)
            .replace(/[Ÿ¨,]/g, ',').replace(/[ \s]+/g, ' ');
}

function normalizeText(raw='') {
  return normalizeDigits(raw).replace(/\r/g,'').replace(/[|¬¶]/g,'I'); // common OCR artifacts
}
// run OCR fully in the browser
async function runBrowserOCR(file) {
  const box = document.getElementById('ocrClientBox');
  const prog = document.getElementById('ocrProgress');
  const out  = document.getElementById('ocrPreview');
  
  if (box) box.style.display = 'block';
  if (prog) prog.value = 0;
  if (out)  out.textContent = '‡§Ö‡§ß‡•ç‡§Ø‡§Ø‡§® ‡§ó‡§∞‡•ç‡§¶‡•à...';

  // Add timeout to prevent getting stuck
  const timeout = setTimeout(() => {
    if (out) out.textContent = 'OCR timeout - please try again with a smaller image';
    if (prog) prog.value = 0;
    console.error('OCR timeout after 30 seconds');
  }, 30000); // 30 second timeout

  try {
    // Check if Tesseract is available
    if (typeof Tesseract === 'undefined') {
      throw new Error('Tesseract.js library not loaded');
    }

    // Preprocess the image for better OCR accuracy
    if (out) out.textContent = 'Image preprocessing...';
    const prepped = await preprocessImage(file);
    if (out) out.textContent = 'Running OCR...';

    // Create a custom logger that updates the UI
    const customLogger = m => {
      console.log('[tess]', m);
      if (m.status === 'recognizing text' && prog) {
        prog.value = m.progress || 0;
      }
      if (out && m.status) {
        out.textContent = `Status: ${m.status}...`;
      }
    };

    // Set up OCR options
    const ocrOptions = {
      tessedit_pageseg_mode: 6,     // PSM 6 = single uniform block of text
      user_defined_dpi: '300',      // fake a decent DPI
      preserve_interword_spaces: '1',
      logger: customLogger
    };

    console.log('üîç Starting OCR with languages:', OCR_LANGS);
    console.log('üéØ Using trained data for better accuracy...');
    
    let data;
    try {
      // Try local trained data FIRST (your custom trained data)
      console.log('üîÑ Trying LOCAL trained data (your custom data)...');
      const result = await Tesseract.recognize(prepped, OCR_LANGS, {
        ...ocrOptions,
        langPath: TESSDATA_URL
      });
      data = result;
      console.log('‚úÖ OCR completed using LOCAL trained data (best accuracy)');
    } catch (localError) {
      console.log('‚ö†Ô∏è Local trained data failed, trying CDN...');
      
      // Fallback to CDN
      try {
        const result = await Tesseract.recognize(prepped, OCR_LANGS, {
          ...ocrOptions,
          langPath: TESSDATA_CDN
        });
        data = result;
        console.log('‚úÖ OCR completed using CDN trained data');
      } catch (cdnError) {
        console.log('‚ùå Both local and CDN failed, trying without langPath...');
        
        // Last resort - no langPath
        const result = await Tesseract.recognize(prepped, OCR_LANGS, ocrOptions);
        data = result;
        console.log('‚úÖ OCR completed using default trained data');
      }
    }

    // Normalize the raw OCR text for better parsing
    const raw = (data.text || '').trim();
    const text = normalizeText(raw);
    
    if (out) {
      const resultText = `üéØ OCR completed with trained data!\n\n${text || '(‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§≠‡•á‡§ü‡§ø‡§è‡§®)'}`;
      out.textContent = resultText;
    }
    if (prog) prog.value = 1;
    
    console.log('OCR completed successfully:', text);
    console.log('Raw OCR text:', raw);
    console.log('Normalized text:', text);
    
    // Clear timeout since OCR completed successfully
    clearTimeout(timeout);
    return text;
    
  } catch (error) {
    console.error('OCR Error:', error);
    if (out) out.textContent = `OCR Error: ${error.message}`;
    if (prog) prog.value = 0;
    
    // Clear timeout on error
    clearTimeout(timeout);
    throw error;
  }
}





// Function to test parsing with the exact data from your form
function testCurrentFormData() {
  console.log('üîç Testing current form data parsing...');
  
  // Get the current form data
  const positionField = document.querySelector('input[name*="position"]');
  const maleField = document.querySelector('input[name*="male_count"]');
  const femaleField = document.querySelector('input[name*="female_count"]');
  const salaryField = document.querySelector('input[name*="salary_amount"]');
  const currencyField = document.querySelector('select[name*="salary_currency"]');
  
  console.log('Current form values:', {
    position: positionField?.value || 'NOT FOUND',
    male: maleField?.value || 'NOT FOUND',
    female: femaleField?.value || 'NOT FOUND',
    salary: salaryField?.value || 'NOT FOUND',
    currency: currencyField?.value || 'NOT FOUND'
  });
  
  // Test parsing with the current values
  const testLine = `1 ${positionField?.value || 'Unknown'} ${maleField?.value || '0'} ${femaleField?.value || '0'} ${currencyField?.value || 'YEN'} ${salaryField?.value || '0'}`;
  console.log('Test line:', testLine);
  
  const result = parseJobRow(testLine);
  console.log('Parsing result:', result);
  
  // Test with your exact expected format
  const expectedLine = '1 Scaffolding 2 0 YEN 177657.00';
  console.log('Testing expected format:', expectedLine);
  const expectedResult = parseJobRow(expectedLine);
  console.log('Expected format result:', expectedResult);
  
  alert(`Current Form Data Test:\n\nPosition: ${positionField?.value || 'NOT FOUND'}\nMale: ${maleField?.value || 'NOT FOUND'}\nFemale: ${femaleField?.value || 'NOT FOUND'}\nSalary: ${salaryField?.value || 'NOT FOUND'}\nCurrency: ${currencyField?.value || 'NOT FOUND'}\n\nExpected: Scaffolding, 2, 0, 177657.00, JPY\n\nCheck console for parsing details.`);
}

// Function to manually set the correct values based on your document
function setCorrectValues() {
  console.log('üîß Setting correct values based on your document...');
  
  // Set the correct values for your document (based on your actual document)
  const correctData = {
    position: 'Scaffolding', // Based on your document showing 2 workers for Meia Cooperative
    male_count: '2', // Total workers mentioned in document
    female_count: '0', // No females mentioned
    salary_amount: '177657.00', // Standard salary for Japan
    salary_currency: 'JPY' // Japan uses JPY
  };
  
  // Find and set the values
  const positionField = document.querySelector('input[name*="position"]');
  const maleField = document.querySelector('input[name*="male_count"]');
  const femaleField = document.querySelector('input[name*="female_count"]');
  const salaryField = document.querySelector('input[name*="salary_amount"]');
  const currencyField = document.querySelector('select[name*="salary_currency"]');
  
  if (positionField) {
    positionField.value = correctData.position;
    positionField.dispatchEvent(new Event('input', { bubbles: true }));
    positionField.dispatchEvent(new Event('change', { bubbles: true }));
  }
  
  if (maleField) {
    maleField.value = correctData.male_count;
    maleField.dispatchEvent(new Event('input', { bubbles: true }));
    maleField.dispatchEvent(new Event('change', { bubbles: true }));
  }
  
  if (femaleField) {
    femaleField.value = correctData.female_count;
    femaleField.dispatchEvent(new Event('input', { bubbles: true }));
    femaleField.dispatchEvent(new Event('change', { bubbles: true }));
  }
  
  if (salaryField) {
    salaryField.value = correctData.salary_amount;
    salaryField.dispatchEvent(new Event('input', { bubbles: true }));
    salaryField.dispatchEvent(new Event('change', { bubbles: true }));
  }
  
  if (currencyField) {
    currencyField.value = correctData.salary_currency;
    currencyField.dispatchEvent(new Event('change', { bubbles: true }));
  }
  
  console.log('‚úÖ Correct values set:', correctData);
  alert('‚úÖ Correct values set based on your document:\n\nPosition: Scaffolding\nMale: 2\nFemale: 0\nSalary: 177657.00\nCurrency: JPY');
}

// Function to test extraction from your actual OCR text
function testYourActualOCR() {
  console.log('üîç Testing extraction from your actual OCR text...');
  
  // Your actual OCR text
  const actualOCRText = `‡§®‡•á‡§™‡§æ‡§≤ ‡§∏‡§∞‡§ï‡§æ‡§∞ ‡§∂‡•ç‡§∞‡§Æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§§‡§•‡§æ ‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§Æ‡§®‡•ç‡§≤‡§æ‡§≤‡§Ø ‡§µ‡•à‡§¶‡•á‡§∂‡§ø‡§ï ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§¨‡§ø‡§≠‡§æ‡§ó ‡§ï‡§æ‡§†‡§Æ‡§æ‡§£‡•ç‡§°‡•å‡§Å ‡§¨‡§ø‡§∑‡§Ø : LT. No. 327122 ‡§ï‡•ã ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø I Date: 2025/08/17 ‡§ö‡§≤‡§æ‡§®‡•Ä ‡§®‡§Ç. : 60243265 LT. No. 327122 ‡§∂‡•ç‡§∞‡•Ä SUCCESS NEPAL MANPOWER AGENCY PVT. LTD. Japan ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã Japan,na ‡§∂‡§π‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§ Meia Cooperative ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü 2 ‡§ú‡§®‡§æ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡§Æ‡§æ‡§ó ‡§≠‡§à ‡§Ü‡§è‡§ï‡•ã ‡§∏‡§®‡•ç‡§¶‡§∞‡•ç‡§≠‡§Æ‡§æ ‡§§‡•ç‡§Ø‡§∏ ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§≤‡•á ‡§¨‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§ó‡§∞‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡§õ‡§®‡•å‡§ü ‡§ó‡§∞‡•ç‡§® ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§ó‡§∞‡•á ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§ï‡§æ‡§∞‡§µ‡§æ‡§π‡•Ä ‡§π‡•Å‡§Å‡§¶‡§æ ‡§Æ‡§æ‡§ó‡§™‡§§‡•ç‡§∞‡§Æ‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ‡§ø‡§§ ‡§∂‡§æ‡§∞‡•ç‡§§ ‡§è‡§µ ‡§∏‡•Å‡§¨‡§ø‡§ß‡§æ‡§π‡§∞‡•Ç ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§™‡§æ‡§≤‡§®‡§æ ‡§ó‡§∞‡§æ‡§â‡§® ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä ‡§∏‡•ç‡§µ‡§Ø‡§Ç ‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§µ‡§æ‡§∞‡•Ä ‡§π‡•Å‡§®‡•á ‡§ó‡§∞‡•Ä ‡§§‡§™‡§∏‡§ø‡§≤‡§Æ‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§≠‡§è ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§ú‡§Æ‡•ç‡§Æ‡§æ I ‡§™‡§¶‡§ï‡•ã ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞‡§π‡§∞‡•Å‡§ï‡•ã ‡§õ‡§®‡•å‡§ü‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§™‡•ç‡§∞‡§ö‡§≤‡§ø‡§§ ‡§µ‡•à‡§¶‡•á‡§∂‡§ø‡§ï ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§ê‡§®, 2064 ‡§ï‡•ã ‡§¶‡§´‡§æ 15(2) ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§Æ‡§ø‡§§‡§ø 2025/08/15 ‡§ï‡•ã ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø‡§æ‡§®‡•Å‡§∏‡§æ‡§∞ ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡§ø‡§ï‡•É‡§§‡§ø ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§õ ‡•§ ‡§∏‡§æ‡§•‡•à ‡§¨‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§ó‡§∞‡•ç‡§¶‡§æ ‡§ï‡§Æ‡•ç‡§§‡§ø‡§Æ‡§æ 7 ‡§¶‡§ø‡§®‡§ï‡•ã ‡§Æ‡•ç‡§Ø‡§æ‡§¶ ‡§¶‡§ø‡§à ‡§Ø‡§∏ ‡§µ‡§ø‡§≠‡§æ‡§ó‡§ï‡•ã ‡§Ü‡§®‡•ç‡§§‡§∞‡§ø‡§ï ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§∏‡§Ç‡§ö‡§æ‡§≤‡§® ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§ø‡§ß‡§ø 2066 ‡§Æ‡§æ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§¢‡§æ‡§Å‡§ö‡§æ ‡§Ö‡§®‡•Å‡§∞‡•Å‡§™‡§ï‡§æ ‡§∏‡§Æ‡•ç‡§™‡•Ç‡§∞‡•ç‡§£ ‡§¨‡§ø‡§¨‡§∞‡§£‡§π‡§∞‡•Ç ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§π‡•Å‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á‡§õ ‡§∞ ‡§ê‡§®‡§ï‡•ã ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§ó‡§∞‡§ø ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡§õ‡§®‡•å‡§ü ‡§≠‡§è‡§ï‡•ã ‡§Æ‡§ø‡§§‡§ø‡§≤‡•á ‡§µ‡•à‡§¶‡•á‡§∂‡§ø‡§ï ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§ê‡§® 2064 ‡§ï‡•ã ‡§¶‡§´‡§æ 20 ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ‡§ï‡•ã ‡§Æ‡•ç‡§Ø‡§æ‡§¶ ‡§≠‡§ø‡§§‡•ç‡§∞ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§™‡•Å‡§∞‡§æ ‡§ó‡§∞‡•Ä ‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß‡§ø‡§§ ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§Æ‡§æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§™‡§†‡§æ‡§à ‡§∏‡§ï‡•ç‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á‡§õ I ‡§õ‡§®‡•å‡§ü ‡§≠‡§è‡§ï‡§æ ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞‡§π‡§∞‡•Å ‡§∏‡•ã ‡§Æ‡•ç‡§Ø‡§æ‡§¶ ‡§≠‡§ø‡§§‡•ç‡§∞ ‡§™‡§†‡§æ‡§â‡§® ‡§®‡§∏‡§ï‡•á‡§Æ‡§æ ‡§ê‡§®‡§ï‡•ã ‡§¶‡§´‡§æ 20(2) ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§ï‡§æ‡§∞‡§¨‡§æ‡§π‡•Ä ‡§≠‡§à ‡§ú‡§æ‡§®‡•á ‡§¨‡•ç‡§Ø‡§π‡•ã‡§∞‡§æ ‡§∏‡§Æ‡•á‡§§ ‡§Ö‡§µ‡§ó‡§§ ‡§ó‡§∞‡§æ‡§à‡§®‡•ç‡§õ ‡•§ [‡§â ‡§π‡•Å .‡§∏. ‡§™‡§¶ ‡§¨‡§ø‡§¨‡§∞‡§£ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§§‡§≤‡§¨ ‡§ï‡•à‡§´‡§ø‡§Ø‡§§ ‡§¨‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®‡§Æ‡§æ - ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§§‡§≤‡§¨ ‡§Æ‡§æ‡§§‡•ç‡§∞ ‡§â‡§§‡•ç‡§≤‡•á‡§ñ ‡§ó‡§∞‡•ç‡§®‡•á I - ‡§¨‡§ø‡§¶‡•á‡§∂ ‡§∏‡•ç‡§•‡§ø‡§§ ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§ï‡•ã ‡§®‡§æ‡§Æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§ó‡§∞‡•ç‡§®‡•á I - ‡§≠‡§ø‡§∑‡§æ ‡§∂‡•Å‡§≤‡•ç‡§ï ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§ó‡§∞‡•ç‡§®‡•á‡•§ ‡§≠‡§ø‡§∑‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§®‡§≠‡§à ‡§Ö‡§ó‡•ç‡§∞‡§ø‡§Æ ‡§≠‡§ï‡•ç‡§§‡§æ‡§®‡•Ä ‡§Æ‡§æ‡§ó ‡§®‡§ó‡§∞‡•ç‡§®‡•á I - ‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§≤‡•á‡§≠‡§ø ‡§§‡§ø‡§∞‡•ç‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á ‡§≠‡§è ‡§â‡§≤‡•ç‡§§‡•á‡§ñ ‡§™‡•Å‡§∞‡•Å‡§∑ I ‡§Æ‡§π‡§ø‡§≤‡§æ ‡§ó‡§∞‡•ç‡§®‡•á ‡•§ E - ‡§∏‡•ç‡§µ‡§ø‡§ï‡•É‡§§‡§ø ‡§≤‡§ø‡§à ‡§∂‡§æ‡§ñ‡§æ ‡§ñ‡•ã‡§≤‡§ø‡§á‡§è‡§ï‡•ã‡§Æ‡§æ ‡§¨‡§æ‡§π‡•á‡§ï ‡§∂‡§æ‡§ñ‡§æ ‡§∞ ‡§è‡§ú‡•á‡§®‡•ç‡§ü‡§ï‡•ã ‡§ï‡•Å‡§∞‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§®‡§ó‡§∞‡•ç‡§®‡•á ‡•§ DR ‚Äî ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ñ‡•Ä‡§ï‡•É‡§§‡§ø‡§ï‡•ã‡§∏‡§Æ‡§æ I 2] of ‡§°‡§ø‡§Æ‡§æ‡§£‡•ç‡§° ‡§≤‡•á‡§ü‡§∞ ‡§∞ ‡§ï‡§∞‡§æ‡§∞‡§ï‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§∂‡§∞‡•ç‡§§‡§π‡§∞‡•Ç ‡§∞ ‡§®‡§ø‡§∞‡•ç‡§¶‡§ø‡§∑‡•ç‡§ü ‡§¢‡§æ‡§Å‡§ö‡§æ ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ‡§ï‡§æ ‡§¨‡§ø‡§¨‡§∞‡§£‡§π‡§∞‡•Å ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§∞‡•Å‡§™‡§Æ‡§æ ‡§¨‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®‡§Æ‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§π‡•Å‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á‡§õ ‡§§‡§•‡§æ ‡§Ö‡§®‡•ç‡§§‡§∞‡§µ‡§æ‡§∞‡•ç‡§§‡§æ‡§ï‡•ã ‡§§‡§æ‡§ó‡§ø ‡§™‡•ç‡§∞‡§§‡§ø‡§®‡§ø‡§ß‡§ø ‡§Æ‡§æ‡§ó ‡§ó‡§∞‡•ç‡§¶‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§ø‡§§ ‡§™‡§§‡•ç‡§∞‡§ø‡§ï‡§æ‡§ï‡•ã ‡§Æ‡§ø‡§§‡§ø ‡§∏‡§Æ‡•á‡§§ ‡§™‡•ç‡§∞‡§∑‡•ç‡§ü ‡§≠‡§è‡§ï‡•ã ‡§∏‡§ï‡•ç‡§ï‡§≤ ‡§™‡§§‡•ç‡§∞‡§ø‡§ï ‡§®‡•à ‡§™‡•á‡§∂ ‡§ó‡§∞‡•ç‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á‡§õ I ‡§Ö‡§®‡•ç‡§Ø‡§•‡§æ ‡§™‡§õ‡§ø ‡§ï‡§æ‡§∞‡§µ‡§æ‡§π‡§ø ‡§®‡§π‡•Å‡§®‡•á ‡§µ‡•ç‡§Ø‡§π‡•ã‡§∞‡§æ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ó‡§∞‡§æ‡§à‡§®‡•ç‡§õ I ‡§∏‡§æ‡§•‡•à ‡§µ‡•à‡§¶‡•á‡§∂‡§ø‡§ï ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§ê‡§® 2064 ‡§∞ ‡§®‡§ø‡§Ø‡§Æ‡§µ‡§æ‡§≤‡§ø 2064 ‡§µ‡§ø‡§™‡§∞‡§ø‡§§ ‡§ï‡•Å‡§®‡•à ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ó‡§∞‡•á‡§Æ‡§æ ‡§Ø‡•ã ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡§ø‡§µ‡§ï‡•É‡§§‡§ø ‡§ú‡•Å‡§® ‡§∏‡•Å‡§ï‡•à ‡§∏‡§Æ‡§Ø‡§Æ‡§æ ‡§∞‡§¶‡•ç‡§¶ ‡§ó‡§∞‡§ø‡§®‡•á ‡§õ I : ‡§®‡•ã‡§ü : ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø‡§ï‡•ã ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§® ‡§ó‡§∞‡•ç‡§¶‡§æ ‡§®‡•á‡§™‡§æ‡§≤ ‡§∏‡§∞‡§ï‡§æ‡§∞‡§¨‡§æ‡§ü 10% ‡§ï‡•ã‡§ü‡§æ ‡§Æ‡§π‡§ø‡§≤‡§æ, ‡§¶‡§≤‡§ø‡§§, ‡§™‡§ø‡§õ‡§°‡§ø‡§è‡§ï‡•ã ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞, ‡§Ü‡§¶‡•Ä‡§¨‡§æ‡§∏‡•Ä ‡§ú‡§®‡§ú‡§æ‡§§‡§ø ‡§∞ ‡§Æ‡§ß‡•á‡§∏‡•Ä ‡§≤‡§æ‡§à ‡§õ‡•Å‡§ü‡•ç‡§Ø‡§æ‡§á‡§è‡§ï‡•ã ‡§≠‡§®‡•Ä ‡§≤‡•á‡§ñ‡•Ä ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§ø‡§§ ‡§ó‡§∞‡•ç‡§®‡•á ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã‡§Æ‡§æ ‡§π‡§æ‡§§ ‡§∏‡•ã ‡§¨‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ ‡§ï‡§æ‡§Ø‡§Æ ‡§®‡§∞‡§π‡•á‡§ï‡•ã‡§≤‡•á ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§® ‡§ó‡§∞‡§ø ‡§∞‡§æ‡§ñ‡•ç‡§®‡•Å ‡§®‡§™‡§∞‡•ç‡§®‡•á I`;
  
  console.log('Testing with your actual OCR text...');
  
  // Test the parsing
  const result = parseFromOCR(actualOCRText);
  console.log('Parsing result:', result);
  
  // Test the summary extraction
  const summaryResult = extractFromSummary(actualOCRText);
  console.log('Summary extraction result:', summaryResult);
  
  let resultText = 'üîç Your Actual OCR Test Results:\n\n';
  resultText += `Company: ${result.company_name || 'Not found'}\n`;
  resultText += `Country: ${result.country || 'Not found'}\n`;
  resultText += `LT No: ${result.lt_no || 'Not found'}\n`;
  resultText += `Challan No: ${result.chalani_no || 'Not found'}\n`;
  resultText += `Positions found: ${result.positions?.length || 0}\n\n`;
  
  if (result.positions && result.positions.length > 0) {
    result.positions.forEach((pos, index) => {
      resultText += `Position ${index + 1}:\n`;
      resultText += `  - Position: ${pos.position}\n`;
      resultText += `  - Male: ${pos.male_count}\n`;
      resultText += `  - Female: ${pos.female_count}\n`;
      resultText += `  - Salary: ${pos.salary_amount} ${pos.salary_currency}\n\n`;
    });
  }
  
  if (summaryResult) {
    resultText += `Summary Extraction:\n`;
    resultText += `  - Position: ${summaryResult.position}\n`;
    resultText += `  - Male: ${summaryResult.male_count}\n`;
    resultText += `  - Female: ${summaryResult.female_count}\n`;
    resultText += `  - Salary: ${summaryResult.salary_amount} ${summaryResult.salary_currency}\n`;
  }
  
  alert(resultText);
}

// Function to test the new job table parsing logic
function testJobTableParsing() {
  console.log('üß™ Testing new job table parsing logic...');
  
  // Test with expected job table format
  const testText = `‡§®‡•á‡§™‡§æ‡§≤ ‡§∏‡§∞‡§ï‡§æ‡§∞ ‡§∂‡•ç‡§∞‡§Æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§§‡§•‡§æ ‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§Æ‡§®‡•ç‡§≤‡§æ‡§≤‡§Ø ‡§µ‡•à‡§¶‡•á‡§∂‡§ø‡§ï ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§¨‡§ø‡§≠‡§æ‡§ó ‡§ï‡§æ‡§†‡§Æ‡§æ‡§£‡•ç‡§°‡•å‡§Å ‡§¨‡§ø‡§∑‡§Ø : LT. No. 327122 ‡§ï‡•ã ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø I Date: 2025/08/17 ‡§ö‡§≤‡§æ‡§®‡•Ä ‡§®‡§Ç. : 60243265 LT. No. 327122 ‡§∂‡•ç‡§∞‡•Ä SUCCESS NEPAL MANPOWER AGENCY PVT. LTD. Japan ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã Japan,na ‡§∂‡§π‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§ Meia Cooperative ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü 2 ‡§ú‡§®‡§æ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡§Æ‡§æ‡§ó ‡§≠‡§à ‡§Ü‡§è‡§ï‡•ã ‡§∏‡§®‡•ç‡§¶‡§∞‡•ç‡§≠‡§Æ‡§æ ‡§§‡•ç‡§Ø‡§∏ ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§≤‡•á ‡§¨‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§ó‡§∞‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡§õ‡§®‡•å‡§ü ‡§ó‡§∞‡•ç‡§® ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§ó‡§∞‡•á ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§ï‡§æ‡§∞‡§µ‡§æ‡§π‡•Ä ‡§π‡•Å‡§Å‡§¶‡§æ ‡§Æ‡§æ‡§ó‡§™‡§§‡•ç‡§∞‡§Æ‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ‡§ø‡§§ ‡§∂‡§æ‡§∞‡•ç‡§§ ‡§è‡§µ ‡§∏‡•Å‡§¨‡§ø‡§ß‡§æ‡§π‡§∞‡•Ç ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§™‡§æ‡§≤‡§®‡§æ ‡§ó‡§∞‡§æ‡§â‡§® ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä ‡§∏‡•ç‡§µ‡§Ø‡§Ç ‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§µ‡§æ‡§∞‡•Ä ‡§π‡•Å‡§®‡•á ‡§ó‡§∞‡•Ä ‡§§‡§™‡§∏‡§ø‡§≤‡§Æ‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§≠‡§è ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§ú‡§Æ‡•ç‡§Æ‡§æ I ‡§™‡§¶‡§ï‡•ã ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞‡§π‡§∞‡•Å‡§ï‡•ã ‡§õ‡§®‡•å‡§ü‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§™‡•ç‡§∞‡§ö‡§≤‡§ø‡§§ ‡§µ‡•à‡§¶‡•á‡§∂‡§ø‡§ï ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§ê‡§®, 2064 ‡§ï‡•ã ‡§¶‡§´‡§æ 15(2) ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§Æ‡§ø‡§§‡§ø 2025/08/15 ‡§ï‡•ã ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø‡§æ‡§®‡•Å‡§∏‡§æ‡§∞ ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡§ø‡§ï‡•É‡§§‡§ø ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§õ ‡•§ ‡§∏‡§æ‡§•‡•à ‡§¨‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§ó‡§∞‡•ç‡§¶‡§æ ‡§ï‡§Æ‡•ç‡§§‡§ø‡§Æ‡§æ 7 ‡§¶‡§ø‡§®‡§ï‡•ã ‡§Æ‡•ç‡§Ø‡§æ‡§¶ ‡§¶‡§ø‡§à ‡§Ø‡§∏ ‡§µ‡§ø‡§≠‡§æ‡§ó‡§ï‡•ã ‡§Ü‡§®‡•ç‡§§‡§∞‡§ø‡§ï ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§∏‡§Ç‡§ö‡§æ‡§≤‡§® ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§ø‡§ß‡§ø 2066 ‡§Æ‡§æ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§¢‡§æ‡§Å‡§ö‡§æ ‡§Ö‡§®‡•Å‡§∞‡•Å‡§™‡§ï‡§æ ‡§∏‡§Æ‡•ç‡§™‡•Ç‡§∞‡•ç‡§£ ‡§¨‡§ø‡§¨‡§∞‡§£‡§π‡§∞‡•Ç ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§π‡•Å‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á‡§õ ‡§∞ ‡§ê‡§®‡§ï‡•ã ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§ó‡§∞‡§ø ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡§õ‡§®‡•å‡§ü ‡§≠‡§è‡§ï‡•ã ‡§Æ‡§ø‡§§‡§ø‡§≤‡•á ‡§µ‡•à‡§¶‡•á‡§∂‡§ø‡§ï ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§ê‡§® 2064 ‡§ï‡•ã ‡§¶‡§´‡§æ 20 ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ‡§ï‡•ã ‡§Æ‡•ç‡§Ø‡§æ‡§¶ ‡§≠‡§ø‡§§‡•ç‡§∞ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§™‡•Å‡§∞‡§æ ‡§ó‡§∞‡•Ä ‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß‡§ø‡§§ ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§Æ‡§æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§™‡§†‡§æ‡§à ‡§∏‡§ï‡•ç‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á‡§õ I ‡§õ‡§®‡•å‡§ü ‡§≠‡§è‡§ï‡§æ ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞‡§π‡§∞‡•Å ‡§∏‡•ã ‡§Æ‡•ç‡§Ø‡§æ‡§¶ ‡§≠‡§ø‡§§‡•ç‡§∞ ‡§™‡§†‡§æ‡§â‡§® ‡§®‡§∏‡§ï‡•á‡§Æ‡§æ ‡§ê‡§®‡§ï‡•ã ‡§¶‡§´‡§æ 20(2) ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§ï‡§æ‡§∞‡§¨‡§æ‡§π‡•Ä ‡§≠‡§à ‡§ú‡§æ‡§®‡•á ‡§¨‡•ç‡§Ø‡§π‡•ã‡§∞‡§æ ‡§∏‡§Æ‡•á‡§§ ‡§Ö‡§µ‡§ó‡§§ ‡§ó‡§∞‡§æ‡§à‡§®‡•ç‡§õ ‡•§ 

‡§§‡§™‡§∏‡§ø‡§≤‡§Æ‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§≠‡§è ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ:
‡§ï‡•ç‡§∞.‡§∏. ‡§™‡§¶ ‡§¨‡§ø‡§¨‡§∞‡§£ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§§‡§≤‡§¨
‡§™‡•Å‡§∞‡•Å‡§∑ ‡§Æ‡§π‡§ø‡§≤‡§æ
1 ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡•≠ ‡•®‡•¶ ‡§Ø‡•á‡§® 177657.00
2 Welder ‡•© ‡•ß JPY 150000

‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø‡§ï‡•ã ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ 2 0`;
  
  console.log('Testing with job table format...');
  
  // Test the parsing
  const result = parseFromOCR(testText);
  console.log('Parsing result:', result);
  
  let resultText = 'üß™ Job Table Parsing Test Results:\n\n';
  resultText += `Company: ${result.company_name || 'Not found'}\n`;
  resultText += `Country: ${result.country || 'Not found'}\n`;
  resultText += `LT No: ${result.lt_no || 'Not found'}\n`;
  resultText += `Challan No: ${result.chalani_no || 'Not found'}\n`;
  resultText += `Positions found: ${result.positions?.length || 0}\n\n`;
  
  if (result.positions && result.positions.length > 0) {
    result.positions.forEach((pos, index) => {
      resultText += `Position ${index + 1}:\n`;
      resultText += `  - Position: ${pos.position}\n`;
      resultText += `  - Male: ${pos.male_count}\n`;
      resultText += `  - Female: ${pos.female_count}\n`;
      resultText += `  - Salary: ${pos.salary_amount} ${pos.salary_currency}\n\n`;
    });
  }
  
  alert(resultText);
}

// Test function to verify Tesseract.js is working
function testTesseract() {
  console.log('üß™ Testing Tesseract.js...');
  console.log('Tesseract object:', typeof Tesseract);
  console.log('Window object:', typeof window);
  console.log('Document object:', typeof document);
  
  if (typeof Tesseract !== 'undefined') {
    console.log('Tesseract version:', Tesseract.version);
    console.log('Tesseract methods:', Object.keys(Tesseract));
    
    // Test if recognize method exists
    if (typeof Tesseract.recognize === 'function') {
      console.log('‚úÖ Tesseract.recognize method is available');
    } else {
      console.log('‚ùå Tesseract.recognize method is NOT available');
    }
    
    // Test trained data availability
    console.log('üéØ Testing trained data availability...');
    console.log('OCR_LANGS:', OCR_LANGS);
    console.log('TESSDATA_URL (local):', TESSDATA_URL);
    console.log('TESSDATA_CDN (fallback):', TESSDATA_CDN);
    
    alert('‚úÖ Tesseract.js is loaded successfully!\nVersion: ' + Tesseract.version + '\n\nTrained data will be used for better accuracy.\nCheck console for detailed info.');
  } else {
    console.error('‚ùå Tesseract.js is not loaded!');
    console.log('Available global objects:', Object.keys(window).filter(k => k.toLowerCase().includes('tess')));
    alert('‚ùå Tesseract.js is not loaded!\nPlease check your internet connection.\n\nCheck console for details.');
  }
}

// Simple diagnostic function
function diagnoseOCR() {
  console.log('üîç OCR Diagnosis...');
  
  // Check network connectivity
  fetch('https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js', { method: 'HEAD' })
    .then(() => console.log('‚úÖ CDN is accessible'))
    .catch(() => console.log('‚ùå CDN is not accessible'));
  
  // Check if we're in a secure context (required for some browser APIs)
  console.log('Secure context:', window.isSecureContext);
  
  // Check available memory
  if ('memory' in performance) {
    console.log('Memory usage:', performance.memory);
  }
  
  // Check if canvas is supported
  const canvas = document.createElement('canvas');
  console.log('Canvas supported:', !!canvas.getContext);
  
  alert('üîç Diagnosis complete!\nCheck console for detailed information.');
}

// Debug function to check form fields
function debugFormFields() {
  console.log('üîç Debugging form fields...');
  
  // Check main form
  const mainForm = document.querySelector('#mainForm');
  console.log('Main form found:', !!mainForm);
  
  if (mainForm) {
    // Check position fields
    const positionFields = mainForm.querySelectorAll('[name*="positions-0"]');
    console.log('Position fields found:', positionFields.length);
    positionFields.forEach(field => {
      console.log(`Field: ${field.name}, ID: ${field.id}, Type: ${field.type}, Value: "${field.value}"`);
    });
    
    // Check all input fields in main form
    const allInputs = mainForm.querySelectorAll('input, select, textarea');
    console.log('All form fields:', allInputs.length);
    allInputs.forEach(field => {
      console.log(`Field: ${field.name || 'no-name'}, ID: ${field.id || 'no-id'}, Type: ${field.type}, Value: "${field.value}"`);
    });
  }
  
  // Check if we're in Step 3
  const step3 = document.querySelector('[data-step="3"]');
  console.log('Step 3 found:', !!step3);
  
  if (step3) {
    const step3Fields = step3.querySelectorAll('input, select, textarea');
    console.log('Step 3 fields:', step3Fields.length);
    step3Fields.forEach(field => {
      console.log(`Step 3 Field: ${field.name || 'no-name'}, ID: ${field.id || 'no-id'}, Type: ${field.type}`);
    });
  }
  
  // Check ALL forms on the page
  const allForms = document.querySelectorAll('form');
  console.log('All forms found:', allForms.length);
  allForms.forEach((form, index) => {
    console.log(`Form ${index}:`, form.id || 'no-id', form.className || 'no-class');
    const formFields = form.querySelectorAll('input, select, textarea');
    formFields.forEach(field => {
      console.log(`  Form ${index} Field: ${field.name || 'no-name'}, ID: ${field.id || 'no-id'}, Type: ${field.type}`);
    });
  });
  
  // Check for position-related fields anywhere on the page
  const allPositionFields = document.querySelectorAll('[name*="position"], [id*="position"], [name*="male"], [name*="female"], [name*="salary"]');
  console.log('All position-related fields found:', allPositionFields.length);
  allPositionFields.forEach(field => {
    console.log(`Position Field: ${field.name || 'no-name'}, ID: ${field.id || 'no-id'}, Type: ${field.type}`);
  });
  
  alert('üîç Form field debugging complete!\nCheck console for detailed information.');
}

// Function to show what data should be extracted from your document
function showExpectedData() {
  console.log('üìã Expected data from your document:');
  console.log('Based on the image description, your document should contain:');
  console.log('- Company: "NEW GURKHAS INTERNATIONAL PVT. LTD."');
  console.log('- Country: "UAE"');
  console.log('- City: "FINE FARE FOOD MARKET L.L.C"');
  console.log('- Date: "2025/08/08" (document date) or "2025/05/08" (pre-approval date)');
  console.log('- Chalani No: "60237432"');
  console.log('- LT No: "322862"');
  console.log('- Position: "Sales Officer"');
  console.log('- Male Count: "150"');
  console.log('- Female Count: "50"');
  console.log('- Salary: "2025.00"');
  console.log('- Currency: "AED"');
  
  alert('üìã Expected data from your document:\n\n' +
        'Company: NEW GURKHAS INTERNATIONAL PVT. LTD.\n' +
        'Country: UAE\n' +
        'City: FINE FARE FOOD MARKET L.L.C\n' +
        'Date: 2025/08/08\n' +
        'Chalani: 60237432\n' +
        'LT: 322862\n' +
        'Position: Sales Officer\n' +
        'Male: 150\n' +
        'Female: 50\n' +
        'Salary: 2025.00 AED\n\n' +
        'Check console for details.');
}

// Test parsing with your specific document format
function testYourDocumentFormat() {
  const sampleText = `‡§∂‡•ç‡§∞‡•Ä NEW GURKHAS INTERNATIONAL PVT. LTD. UAE ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã UAE, P.O.Box:677, 1ST FLOOR, NAD AL SHEBA FIRST MEYDAN, PO ‡§∂‡§π‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§ FINE FARE FOOD MARKET L.L.C ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü 200 ‡§ú‡§®‡§æ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡§Æ‡§æ‡§ó ‡§≠‡§à ‡§Ü‡§è‡§ï‡•ã ‡§∏‡§®‡•ç‡§¶‡§∞‡•ç‡§≠‡§Æ‡§æ ‡§§‡•ç‡§Ø‡§∏ ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§≤‡•á ‡§¨‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§ó‡§∞‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡§õ‡§®‡•å‡§ü ‡§ó‡§∞‡•ç‡§® ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§ó‡§∞‡•á ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§ï‡§æ‡§∞‡§µ‡§æ‡§π‡•Ä gal ‡§Æ‡§æ‡§ó‡§™‡§§‡•ç‡§∞‡§Æ‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ‡§ø‡§§ ‡§∂‡§∞‡•ç‡§§ ‡§è‡§µ ‡§∏‡•Å‡§¨‡§ø‡§ß‡§æ‡§π‡§∞‡•Ç ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§™‡§æ‡§≤‡§®‡§æ ‡§ó‡§∞‡§æ‡§â‡§® ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä ‡§∏‡•ç‡§µ‡§Ø‡§Ç ‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§µ‡§æ‡§∞‡•Ä ‡§π‡•Å‡§®‡•á ‡§ó‡§∞‡•Ä ‡§§‡§™‡§∏‡§ø‡§≤‡§Æ‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§≠‡§è ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§ú‡§Æ‡•ç‡§Æ‡§æ I ‡§™‡§¶‡§ï‡•ã ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞‡§π‡§∞‡•Å‡§ï‡•ã ‡§õ‡§®‡•å‡§ü‡§ï‡•ã ‡§§‡§æ‡§ó‡§ø ‡§™‡•ç‡§∞‡§ö‡§≤‡§ø‡§§ ‡§µ‡•à‡§¶‡•á‡§∂‡§ø‡§ï ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§ê‡§®, 2064 ‡§ï‡•ã ‡§¶‡§´‡§æ 15(2) ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§Æ‡§ø‡§§‡§ø 2025/05/08 ‡§ï‡•ã ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø‡§æ‡§®‡•Å‡§∏‡§æ‡§∞ ‡§™‡•Ç‡§∞‡•ç‡§µ Radia ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§õ I ‡§∏‡§æ‡§•‡•à ‡§¨‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§ó‡§∞‡•ç‡§¶‡§æ ‡§ï‡§Æ‡•ç‡§§‡§ø‡§Æ‡§æ 7 ‡§¶‡§ø‡§®‡§ï‡•ã ‡§Æ‡•ç‡§Ø‡§æ‡§¶ ‡§¶‡§ø‡§à ‡§Ø‡§∏ ‡§µ‡§ø‡§≠‡§æ‡§ó‡§ï‡•ã ‡§Ü‡§®‡•ç‡§§‡§∞‡§ø‡§ï ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§∏‡§Ç‡§ö‡§æ‡§≤‡§® ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§ø‡§ß‡§ø 2066 ‡§Æ‡§æ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§¢‡§æ‡§Å‡§ö‡§æ ‡§Ö‡§®‡•Å‡§∞‡•Å‡§™‡§ï‡§æ ‡§∏‡§Æ‡•ç‡§™‡•Ç‡§∞‡•ç‡§£ ‡§¨‡§ø‡§¨‡§∞‡§£‡§π‡§∞‡•Ç ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§π‡•Å‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á‡§õ ‡§∞ ‡§ê‡§®‡§ï‡•ã ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§ó‡§∞‡§ø ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡§õ‡§®‡•å‡§ü ‡§≠‡§è‡§ï‡•ã ‡§Æ‡§ø‡§§‡§ø‡§≤‡•á ‡§µ‡•à‡§¶‡•á‡§∂‡§ø‡§ï ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§ê‡§® 2064 ‡§ï‡•ã ‡§¶‡§´‡§æ 20 ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ‡§ï‡•ã ‡§Æ‡•ç‡§Ø‡§æ‡§¶ ‡§≠‡§ø‡§§‡•ç‡§∞ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§™‡•Å‡§∞‡§æ ‡§ó‡§∞‡•Ä ‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß‡§ø‡§§ ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§Æ‡§æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§™‡§†‡§æ‡§à ‡§∏‡§ï‡•ç‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á‡§õ I ‡§õ‡§®‡•å‡§ü ‡§≠‡§è‡§ï‡§æ ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞‡§π‡§∞‡•Å ‡§∏‡•ã ‡§Æ‡•ç‡§Ø‡§æ‡§¶ ‡§≠‡§ø‡§§‡•ç‡§∞ ‡§™‡§†‡§æ‡§â‡§® ‡§®‡§∏‡§ï‡•á‡§Æ‡§æ ‡§ê‡§®‡§ï‡•ã ‡§¶‡§´‡§æ 20(2) ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§ï‡§æ‡§∞‡§¨‡§æ‡§π‡•Ä ‡§≠‡§à ‡§ú‡§æ‡§®‡•á ‡§¨‡•ç‡§Ø‡§π‡•ã‡§∞‡§æ ‡§∏‡§Æ‡•á‡§§ ‡§Ö‡§µ‡§ó‡§§ ‡§ó‡§∞‡§æ‡§à‡§®‡•ç‡§õ ‡•§ IE A. ‡§™‡§¶ ‡§¨‡§ø‡§¨‡§∞‡§£ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§§‡§≤‡§¨ ‡§ï‡•à‡§´‡§ø‡§Ø‡§§ ‡§¨‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®‡§Æ‡§æ - ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§§‡§≤‡§¨ ‡§Æ‡§æ‡§§‡•ç‡§∞ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§ó‡§∞‡•ç‡§®‡•á I - ‡§¨‡§ø‡§¶‡•á‡§∂ ‡§∏‡•ç‡§•‡§ø‡§§ ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§ï‡•ã ‡§®‡§æ‡§Æ ‡§â‡§§‡•ç‡§≤‡•á‡§ñ ‡§ó‡§∞‡•ç‡§®‡•á ‡•§ - ‡§≠‡§ø‡§∑‡§æ ‡§∂‡•Å‡§≤‡•ç‡§ï ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§ó‡§∞‡•ç‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á‡•§ ‡§≠‡§ø‡§∑‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§®‡§≠‡§à ‡§Ö‡§ó‡•ç‡§∞‡§ø‡§Æ ‡§≠‡§ï‡•ç‡§§‡§æ‡§®‡•Ä ‡§Æ‡§æ‡§ó ‡§®‡§ó‡§∞‡•ç‡§®‡•á ‡•§ - ‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä Af ‡§§‡§ø‡§∞‡•ç‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á ‡§≠‡§è ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§™‡•Å‡§∞‡•Å‡§∑ I ‡§Æ‡§π‡§ø‡§≤‡§æ ‡§ó‡§∞‡•ç‡§®‡•á ‡•§ E ‡§π‡§ø - ‡§∏‡•ç‡§µ‡§ø‡§ï‡•É‡§§‡§ø ‡§≤‡§ø‡§à ‡§∂‡§æ‡§ñ‡§æ ‡§ñ‡•ã‡§≤‡§ø‡§á‡§è‡§ï‡•ã‡§Æ‡§æ ‡§¨‡§æ‡§π‡•á‡§ï ‡§∂‡§æ‡§ñ‡§æ ‡§∞ ‡§è‡§ú‡•á‡§®‡•ç‡§ü‡§ï‡•ã ‡§ï‡•Å‡§∞‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§®‡§ó‡§∞‡•ç‡§®‡•á ‡•§ DR ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø‡§ï‡•ã ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ 150 50 ‡§°‡§ø‡§Æ‡§æ‡§£‡•ç‡§° ‡§≤‡•à‡§ü‡§∞ ‡§∞ ‡§ï‡§∞‡§æ‡§∞‡§ï‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§∂‡§∞‡•ç‡§§‡§π‡§∞‡•Ç ‡§∞ ‡§®‡§ø‡§∞‡•ç‡§¶‡§ø‡§∑‡•ç‡§ü ‡§¢‡§æ‡§Å‡§ö‡§æ ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ‡§ï‡§æ ‡§¨‡§ø‡§¨‡§∞‡§£‡§π‡§∞‡•Å ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§∞‡•Å‡§™‡§Æ‡§æ ‡§¨‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®‡§Æ‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§π‡•Å‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á‡§õ ‡§§‡§•‡§æ ‡§Ö‡§®‡•ç‡§§‡§∞‡§µ‡§æ‡§∞‡•ç‡§§‡§æ‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§™‡•ç‡§∞‡§§‡§ø‡§®‡§ø‡§ß‡§ø ‡§Æ‡§æ‡§ó ‡§ó‡§∞‡•ç‡§¶‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§ø‡§§ ‡§™‡§§‡•ç‡§∞‡§ø‡§ï‡§æ‡§ï‡•ã ‡§Æ‡§ø‡§§‡§ø ‡§∏‡§Æ‡•á‡§§ ‡§™‡•ç‡§∞‡§∑‡•ç‡§ü ‡§≠‡§è‡§ï‡•ã ‡§∏‡§ï‡•ç‡§ï‡§§ ‡§™‡§§‡•ç‡§∞‡§ø‡§ï ‡§®‡•à ‡§™‡•á‡§∂ ‡§ó‡§∞‡•ç‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á‡§õ I ‡§Ö‡§®‡•ç‡§Ø‡§•‡§æ ‡§™‡§õ‡§ø ‡§ï‡§æ‡§∞‡§µ‡§æ‡§π‡§ø ‡§®‡§π‡•Å‡§®‡•á ‡§µ‡•ç‡§Ø‡§π‡•ã‡§∞‡§æ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ó‡§∞‡§æ‡§à‡§®‡•ç‡§õ I ‡§∏‡§æ‡§•‡•à ‡§µ‡•à‡§¶‡•á‡§∂‡§ø‡§ï ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§ê‡§® 2064 ‡§∞ ‡§®‡§ø‡§Ø‡§Æ‡§µ‡§æ‡§≤‡§ø 2064 ‡§µ‡§ø‡§™‡§∞‡§ø‡§§ ‡§ï‡•Å‡§®‡•à ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ó‡§∞‡•á‡§Æ‡§æ ‡§Ø‡•ã ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡§ø‡§ï‡•É‡§§‡§ø ‡§ú‡•Å‡§® ‡§∏‡•Å‡§ï‡•à ‡§∏‡§Æ‡§Ø‡§Æ‡§æ ‡§∞‡§¶‡•ç‡§¶ ‡§ó‡§∞‡§ø‡§®‡•á ‡§õ I : ‡§®‡•ã‡§ü : ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø‡§ï‡•ã ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§® ‡§ó‡§∞‡•ç‡§¶‡§æ ‡§®‡•á‡§™‡§æ‡§≤ ‡§∏‡§∞‡§ï‡§æ‡§∞‡§¨‡§æ‡§ü 10% ‡§ï‡•ã‡§ü‡§æ ‡§Æ‡§π‡§ø‡§≤‡§æ, ‡§¶‡§≤‡§ø‡§§, ‡§™‡§ø‡§õ‡§°‡§ø‡§è‡§ï‡•ã ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞, ‡§Ü‡§¶‡•Ä‡§¨‡§æ‡§∏‡•Ä ‡§ú‡§®‡§ú‡§æ‡§§‡§ø ‡§∞ ‡§Æ‡§ß‡•á‡§∏‡•Ä ‡§≤‡§æ‡§à ‡§õ‡•Å‡§ü‡•ç‡§Ø‡§æ‡§á‡§è‡§ï‡•ã ‡§≠‡§®‡•Ä ‡§≤‡•á‡§ñ‡•Ä ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§ø‡§§ ‡§ó‡§∞‡•ç‡§®‡•á ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã‡§Æ‡§æ ‡§π‡§æ‡§≤ ‡§∏‡•ã ‡§¨‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ ‡§ï‡§æ‡§Ø‡§Æ ‡§®‡§∞‡§π‡•á‡§ï‡•ã‡§≤‡•á ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§® ‡§ó‡§∞‡§ø ‡§∞‡§æ‡§ñ‡•ç‡§®‡•Å ‡§®‡§™‡§∞‡•ç‡§®‡•á ‡•§ 1 Sales Officer 150 50 AED 2025.00`;
  
  console.log('üß™ Testing parsing with your document format...');
  const result = parseFromOCR(sampleText);
  console.log('üìã Parsed result:', result);
  
  // Display results in alert
  let message = 'üìã Parsing Test Results:\n\n';
  message += `Company: ${result.company_name || 'Not found'}\n`;
  message += `Country: ${result.country || 'Not found'}\n`;
  message += `City: ${result.city || 'Not found'}\n`;
  message += `Date: ${result.pre_approval_date || 'Not found'}\n`;
  message += `Chalani: ${result.chalani_no || 'Not found'}\n`;
  message += `LOT: ${result.lot_no || 'Not found'}\n`;
  
  if (result.positions && result.positions.length) {
    const pos = result.positions[0];
    message += `\nPosition: ${pos.position || 'Not found'}\n`;
    message += `Male: ${pos.male_count || 'Not found'}\n`;
    message += `Female: ${pos.female_count || 'Not found'}\n`;
    message += `Salary: ${pos.salary_amount || 'Not found'} ${pos.salary_currency || ''}\n`;
  }
  
  alert(message);
}

// Test multi-row parsing with various formats
function testMultiRowParsing() {
  const multiRowText = `‡§™‡§¶ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§§‡§≤‡§¨
1 Scaffolding 2 0 YEN 177657.00
‡•ß Welder ‡•© ‡•ß JPY 150,000
2 Driver 0 4 1200 AED
‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø‡§ï‡•ã ‡§∏‡•á‡§ß‡§æ 5 5`;
  
  console.log('üß™ Testing multi-row parsing...');
  const result = parseFromOCR(multiRowText);
  console.log('üìã Multi-row parsed result:', result);
  
  let message = 'üìã Multi-Row Parsing Test:\n\n';
  if (result.positions && result.positions.length) {
    message += `Found ${result.positions.length} position(s):\n`;
    result.positions.forEach((pos, index) => {
      message += `\nPosition ${index + 1}:\n`;
      message += `  Position: ${pos.position}\n`;
      message += `  Male: ${pos.male_count}\n`;
      message += `  Female: ${pos.female_count}\n`;
      message += `  Salary: ${pos.salary_amount} ${pos.salary_currency}\n`;
    });
  } else {
    message += 'No positions found';
  }
  
  alert(message);
}
// Test your exact document format
function testYourExactFormat() {
  const exactText = `1 Scaffolding 2 0 YEN 177657.00`;
  
  console.log('üß™ Testing your exact document format...');
  console.log('Input text:', exactText);
  
  const result = parseFromOCR(exactText);
  console.log('üìã Parsed result:', result);
  
  let message = 'üìã Your Exact Format Test:\n\n';
  message += `Input: "${exactText}"\n\n`;
  
  if (result.positions && result.positions.length) {
    const pos = result.positions[0];
    message += `‚úÖ Extracted:\n`;
    message += `Position: ${pos.position}\n`;
    message += `Male: ${pos.male_count}\n`;
    message += `Female: ${pos.female_count}\n`;
    message += `Salary: ${pos.salary_amount}\n`;
    message += `Currency: ${pos.salary_currency}\n`;
  } else {
    message += '‚ùå No position found';
  }
  
  alert(message);
}

// Quick OCR test with a simple canvas
function testQuickOCR() {
  console.log('üß™ Starting Quick OCR Test...');
  
  // Check if Tesseract is loaded
  if (typeof Tesseract === 'undefined') {
    console.error('‚ùå Tesseract.js not loaded!');
    alert('‚ùå Tesseract.js not loaded!\nPlease check your internet connection.');
    return;
  }
  
  console.log('‚úÖ Tesseract.js is loaded, version:', Tesseract.version);
  
  // Show loading message
  alert('üîÑ Creating test image and running OCR...\nThis may take 10-15 seconds.');
  
  try {
    // Create a simple test image with text
    const canvas = document.createElement('canvas');
    canvas.width = 300;
    canvas.height = 100;
    const ctx = canvas.getContext('2d');
    
    // White background
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, 300, 100);
    
    // Black text
    ctx.fillStyle = 'black';
    ctx.font = 'bold 24px Arial';
    ctx.fillText('Test OCR 123', 20, 40);
    ctx.font = '16px Arial';
    ctx.fillText('This is a test image', 20, 70);
    
    console.log('‚úÖ Test image created');
    
    // Convert to blob with timeout
    canvas.toBlob(async (blob) => {
      if (!blob) {
        alert('‚ùå Failed to create test image blob');
        return;
      }
      
      console.log('‚úÖ Blob created, size:', blob.size);
      
      try {
        console.log('üîÑ Starting Tesseract.recognize...');
        
        // Add timeout to the OCR call
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('OCR timeout after 20 seconds')), 20000);
        });
        
        const ocrPromise = Tesseract.recognize(blob, 'eng', {
          logger: m => console.log('[OCR]', m.status, m.progress)
        });
        
        const result = await Promise.race([ocrPromise, timeoutPromise]);
        
        console.log('‚úÖ OCR completed successfully');
        console.log('OCR result:', result);
        
        const detectedText = result.data.text.trim();
        alert('‚úÖ OCR Test Successful!\n\nDetected Text:\n"' + detectedText + '"\n\nConfidence: ' + Math.round(result.data.confidence) + '%');
        
      } catch (error) {
        console.error('‚ùå OCR Test Failed:', error);
        alert('‚ùå OCR Test Failed:\n' + error.message + '\n\nPlease check console for details.');
      }
    }, 'image/png');
    
  } catch (error) {
    console.error('‚ùå Error creating test image:', error);
    alert('‚ùå Error creating test image:\n' + error.message);
  }
}

// Parse with tolerant patterns (don't rely on perfect "Label: value")
const LABELS = {
  company:  [/‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä(?:‡§ï‡•ã)?\s*‡§®‡§æ‡§Æ/i, /Company\s*Name/i, /Company/i, /‡§∂‡•ç‡§∞‡•Ä\s+([^‡•§\s]+(?:\s+[^‡•§\s]+)*)/i],
  country:  [/‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã\s+([^‡•§\s]+(?:\s+[^‡•§\s]+)*?)(?=\s+UAE\.P\.|\s+‡§∏‡•ç‡§•‡§ø‡§§|\s+‡•§|$)/i, /‡§¶‡•á‡§∂/i, /Country/i, /\bUAE\b/i],
  city:     [/‡§∂‡§π‡§∞\s+([^‡•§\n]+?)(?=\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü|\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§Æ‡§æ‡§ó|\s+‡§∏‡§®‡•ç‡§¶‡§∞‡•ç‡§≠‡§Æ‡§æ)/i, /City\s+([^‡•§\n]+?)(?=\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü|\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§Æ‡§æ‡§ó|\s+‡§∏‡§®‡•ç‡§¶‡§∞‡•ç‡§≠‡§Æ‡§æ)/i, /‡§∏‡•ç‡§•‡§ø‡§§\s+([^‡•§\n]+?)(?=\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü|\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§Æ‡§æ‡§ó|\s+‡§∏‡§®‡•ç‡§¶‡§∞‡•ç‡§≠‡§Æ‡§æ)/i, /([^‡•§\n]+?)\s+‡§∂‡§π‡§∞(?=\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü|\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§Æ‡§æ‡§ó|\s+‡§∏‡§®‡•ç‡§¶‡§∞‡•ç‡§≠‡§Æ‡§æ)/i, /([^‡•§\n]+?)\s+City(?=\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü|\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§Æ‡§æ‡§ó|\s+‡§∏‡§®‡•ç‡§¶‡§∞‡•ç‡§≠‡§Æ‡§æ)/i, /([^‡•§\n]+?)\s+‡§∂‡§π‡§∞\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü/i, /‡§∂‡§π‡§∞\s+([^‡•§\n]+?)\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü/i, /‡§∏‡•ç‡§•‡§ø‡§§\s+([^‡•§\n]+?)\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü/i, /‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü\s+([^‡•§\n]+?)\s+‡§∂‡§π‡§∞/i],
  chalani:  [/‡§ö‡§≤‡§æ‡§®‡•Ä\s*‡§®‡§Ç\.?\s*(\d+)/i, /Chalani\s*No\.?\s*(\d+)/i, /‡§ö‡§≤‡§æ‡§®‡•Ä\s*‡§®‡§Ç\.?/i, /Chalani\s*No\.?/i],
  lot:      [/LT\.\s*No\.\s*(\d+)/i, /LOT\s*‡§®‡§Ç\.?\s*(\d+)/i, /LOT\s*No\.?\s*(\d+)/i, /LOT\s*‡§®‡§Ç\.?/i, /LOT\s*No\.?/i],
  predate:  [/Date\s+(\d{4}\/\d{2}\/\d{2})/i, /‡§Æ‡§ø‡§§‡§ø\s+(\d{4}\/\d{2}\/\d{2})/i, /‡§™‡•Ç‡§∞‡•ç‡§µ\s*‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø\s*‡§Æ‡§ø‡§§‡§ø/i, /Pre[-\s]?approval\s*Date/i],
  position: [/‡§™‡§¶/i, /Position/i, /‡§™‡§¶\s*‡§¨‡§ø‡§¨‡§∞‡§£/i],
  male:     [/‡§™‡•Å‡§∞‡•Å‡§∑\s*(\d+)/i, /Male\s*(\d+)/i, /‡§™‡•Å‡§∞‡•Å‡§∑/i, /Male/i],
  female:   [/‡§Æ‡§π‡§ø‡§≤‡§æ\s*(\d+)/i, /Female\s*(\d+)/i, /‡§Æ‡§π‡§ø‡§≤‡§æ/i, /Female/i],
  salary:   [/‡§§‡§≤‡§¨|Salary|Basic\s*Salary|‡§Æ‡§æ‡§∏‡§ø‡§ï\s*‡§§‡§≤‡§¨/i]
};

function findAfterLabel(text, labelList, maxLook=120) {
  const lines = text.split('\n');
  
  for (let i=0;i<lines.length;i++){
    const L = lines[i];

    // Check if any label pattern matches this line
    for (const pattern of labelList) {
      if (pattern.test(L)) {
        // If pattern has capture groups, extract the captured value
        const match = L.match(pattern);
        if (match && match[1]) {
          return match[1].trim();
        }
        
        // try same line after delimiter - but with strict boundaries
        const m = L.split(/[:\-‚Äì|]\s*/).slice(1).join(' ').trim();
        if (m) {
          // Stop at common boundaries to prevent over-capturing
          const cleanValue = m.split(/[‡•§\s]+(?:‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã|‡§∏‡•ç‡§•‡§ø‡§§|UAE\.P\.|‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü|‡§∏‡§®‡•ç‡§¶‡§∞‡•ç‡§≠‡§Æ‡§æ|‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ|‡§ï‡§æ‡§∞‡§µ‡§æ‡§π‡•Ä|‡§ó‡§∞‡§ø‡§è‡§ï‡•ã|‡§≠‡§è‡§ï‡•ã|‡§ó‡§∞‡•ç‡§®|‡§π‡•Å‡§®‡•Å|‡§™‡§∞‡•ç‡§®‡•á|‡§õ|‡•§)/)[0].trim();
          if (cleanValue && cleanValue.length < 80) return cleanValue; // Limit length
        }
        
        // else take next non-empty line but with strict limits
        for (let j=i+1;j<Math.min(i+3,lines.length);j++){
          const v = lines[j].trim();
          if (v) {
            // Stop at boundaries and limit length
            const cleanValue = v.split(/[‡•§\s]+(?:‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã|‡§∏‡•ç‡§•‡§ø‡§§|UAE\.P\.|‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü|‡§∏‡§®‡•ç‡§¶‡§∞‡•ç‡§≠‡§Æ‡§æ|‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ|‡§ï‡§æ‡§∞‡§µ‡§æ‡§π‡•Ä|‡§ó‡§∞‡§ø‡§è‡§ï‡•ã|‡§≠‡§è‡§ï‡•ã|‡§ó‡§∞‡•ç‡§®|‡§π‡•Å‡§®‡•Å|‡§™‡§∞‡•ç‡§®‡•á|‡§õ|‡•§)/)[0].trim();
            if (cleanValue && cleanValue.length < 80) return cleanValue; // Limit length
          }
        }
      }
    }
  }
  
  // If no direct matches, try to find patterns in the entire text
  for (const pattern of labelList) {
    if (pattern.source.includes('([^‡•§\\s]+)') || pattern.source.includes('(\\d+)')) {
      const match = text.match(pattern);
      if (match && match[1]) {
        return match[1].trim();
      }
    }
  }
  
        return '';
    }
    
function firstNumber(s){ const m = (s||'').match(/[\d,.]+/); return m?m[0]:''; }

// Special function to extract information from employment letters
function extractEmploymentLetterInfo(text) {
  const info = {};
    
  // Extract company name (after ‡§∂‡•ç‡§∞‡•Ä, stop at ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã or ‡§∏‡•ç‡§•‡§ø‡§§)
  let companyMatch = text.match(/‡§∂‡•ç‡§∞‡•Ä\s+([^‡•§\s]+(?:\s+[^‡•§\s]+)*?)(?=\s+‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã|\s+‡§∏‡•ç‡§•‡§ø‡§§|\s+UAE\.P\.|$)/i);
  if (companyMatch) {
    info.company = companyMatch[1].trim();
  } else {
    // Fallback: try to find company name pattern
    const companyPattern = text.match(/([A-Z][A-Z\s&\.]+(?:PVT\.?|LTD\.?|LLC\.?|INC\.?|CO\.?)[A-Z\s&\.]*)/i);
    if (companyPattern) {
      info.company = companyPattern[1].trim();
    }
  }
  
  // Extract LOT/LT number
  const lotMatch = text.match(/LT\.\s*No\.\s*(\d+)/i);
  if (lotMatch) info.lot = lotMatch[1];
  
  // Extract Chalani number
  const chalaniMatch = text.match(/‡§ö‡§≤‡§æ‡§®‡•Ä\s*‡§®‡§Ç\.?\s*(\d+)/i);
  if (chalaniMatch) info.chalani = chalaniMatch[1];
  
  // Extract date
  const dateMatch = text.match(/Date\s+(\d{4}\/\d{2}\/\d{2})/i);
  if (dateMatch) info.date = dateMatch[1];
  
  // Extract country - be more specific to avoid over-capturing
  const countryMatch = text.match(/\bUAE\b/i);
  if (countryMatch) {
    info.country = 'UAE';
        } else {
    // Try to find country after ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã
    const countryAfterMuluk = text.match(/‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã\s+([^‡•§\s]+(?:\s+[^‡•§\s]+)*?)(?=\s+UAE\.P\.|\s+‡§∏‡•ç‡§•‡§ø‡§§|\s+‡•§|$)/i);
    if (countryAfterMuluk) {
      info.country = countryAfterMuluk[1].trim();
    }
  }
  
  // Extract city/location - handle multiple formats
  let city = '';
  
  // Try different city patterns
  const cityPatterns = [
    /‡§∏‡•ç‡§•‡§ø‡§§\s+([^‡•§\s]+(?:\s+[^‡•§\s]+)*?)(?=\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü|\s+‡•§|$)/i,  // ‡§∏‡•ç‡§•‡§ø‡§§ + city
    /‡§∂‡§π‡§∞\s+([^‡•§\s]+(?:\s+[^‡•§\s]+)*?)(?=\s+‡•§|$)/i,                    // ‡§∂‡§π‡§∞ + city
    /City\s+([^‡•§\s]+(?:\s+[^‡•§\s]+)*?)(?=\s+‡•§|$)/i,                    // City + city
    /([^‡•§\s]+(?:\s+[^‡•§\s]+)*?)\s+‡§∂‡§π‡§∞/i,                               // city + ‡§∂‡§π‡§∞
    /([^‡•§\s]+(?:\s+[^‡•§\s]+)*?)\s+City/i                                // city + City
  ];
  
  for (const pattern of cityPatterns) {
    const match = text.match(pattern);
    if (match && match[1]) {
      city = match[1].trim();
      console.log(`‚úÖ City found with pattern: ${pattern.source} = "${city}"`);
      break;
    }
  }
  
  info.city = city;
  
  // Extract country - handle multiple countries
  let country = '';
  
  // Check for common countries
  if (text.includes('UAE')) {
    const uaeMatch = text.match(/([^‡•§\s]+(?:\s+[^‡•§\s]+)*?)\s+‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã/i);
    if (uaeMatch) {
      country = uaeMatch[1].trim();
    } else {
      country = 'UAE';
    }
  } else if (text.includes('Japan') || text.includes('‡§ú‡§æ‡§™‡§æ‡§®')) {
    country = 'Japan';
  } else if (text.includes('Saudi') || text.includes('‡§∏‡§æ‡§â‡§¶‡•Ä')) {
    country = 'Saudi Arabia';
  } else if (text.includes('Qatar') || text.includes('‡§ï‡§§‡§æ‡§∞')) {
    country = 'Qatar';
  } else if (text.includes('Oman') || text.includes('‡§ì‡§Æ‡§æ‡§®')) {
    country = 'Oman';
  } else if (text.includes('Bahrain') || text.includes('‡§¨‡§π‡§∞‡•á‡§®')) {
    country = 'Bahrain';
  } else if (text.includes('Kuwait') || text.includes('‡§ï‡•Å‡§µ‡•à‡§§')) {
    country = 'Kuwait';
  } else {
    // Generic country extraction after ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã
    const countryMatch = text.match(/‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã\s+([^‡•§\s]+(?:\s+[^‡•§\s]+)*?)(?=\s+UAE\.P\.|\s+‡§∏‡•ç‡§•‡§ø‡§§|\s+‡•§|$)/i);
    if (countryMatch) {
      country = countryMatch[1].trim();
    }
  }
  
  info.country = country;
  
  // Extract employee count
  const countMatch = text.match(/(\d+)\s*‡§ú‡§®‡§æ\s*‡§®‡•á‡§™‡§æ‡§≤‡•Ä\s*‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞/i);
  if (countMatch) info.employeeCount = countMatch[1];
  
  console.log('üîç Extracted employment letter info:', info);
  
  // Debug company extraction specifically
  console.log('üîç === COMPANY EXTRACTION DEBUG ===');
  const companyPattern1 = text.match(/‡§∂‡•ç‡§∞‡•Ä\s+([^‡•§\s]+(?:\s+[^‡•§\s]+)*?)(?=\s+‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã|\s+‡§∏‡•ç‡§•‡§ø‡§§|\s+UAE\.P\.|$)/i);
  console.log('Pattern 1 (‡§∂‡•ç‡§∞‡•Ä + company):', companyPattern1);
  
  const companyPattern2 = text.match(/([A-Z][A-Z\s&\.]+(?:PVT\.?|LTD\.?|LLC\.?|INC\.?|CO\.?)[A-Z\s&\.]*)/i);
  console.log('Pattern 2 (Company format):', companyPattern2);
  
  return info;
}

// Intelligent OCR extraction that learns from document structure
function intelligentOCRExtraction(text) {
  console.log('üß† === INTELLIGENT OCR EXTRACTION ===');
  console.log('Analyzing document structure automatically...');
  
  const data = {};
  const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
  
  // 1. SMART FIELD DETECTION - Find fields by looking for common patterns
  const fieldDetectors = {
    // Numbers with labels
    chalani: {
      patterns: [
        /‡§ö‡§≤‡§æ‡§®‡•Ä\s*‡§®‡§Ç\.?\s*:?\s*(\d+)/i,
        /Chalani\s*No\.?\s*:?\s*(\d+)/i,
        /‡§ö‡§≤‡§æ‡§®‡•Ä\s*‡§®‡§Ç\.?\s*(\d+)/i
      ],
      description: 'Chalani number'
    },
    lot: {
      patterns: [
        /LT\.\s*No\.\s*(\d+)/i,
        /LOT\s*‡§®‡§Ç\.?\s*(\d+)/i,
        /LOT\s*No\.?\s*(\d+)/i
      ],
      description: 'LOT number'
    },
    date: {
      patterns: [
        /Date\s+(\d{4}[\/\-]\d{2}[\/\-]\d{2})/i,
        /‡§Æ‡§ø‡§§‡§ø\s+(\d{4}[\/\-]\d{2}[\/\-]\d{2})/i,
        /(\d{4}[\/\-]\d{2}[\/\-]\d{2})/i
      ],
      description: 'Date'
    },
    employeeCount: {
      patterns: [
        /(\d+)\s*‡§ú‡§®‡§æ\s*‡§®‡•á‡§™‡§æ‡§≤‡•Ä\s*‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞/i,
        /(\d+)\s*‡§®‡•á‡§™‡§æ‡§≤‡•Ä\s*‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞/i,
        /(\d+)\s*workers/i
      ],
      description: 'Employee count'
    }
  };
  
  // Extract structured data
  for (const [field, detector] of Object.entries(fieldDetectors)) {
    for (const pattern of detector.patterns) {
      const match = text.match(pattern);
      if (match && match[1]) {
        data[field] = match[1];
        console.log(`‚úÖ ${detector.description}: ${match[1]}`);
        break;
      }
    }
  }
  
  // 2. INTELLIGENT COMPANY EXTRACTION - Find company name by context
  console.log('\nüîç Looking for company name...');
  
  // Look for company after ‡§∂‡•ç‡§∞‡•Ä or similar indicators
  const companyIndicators = ['‡§∂‡•ç‡§∞‡•Ä', 'Shri', 'Mr.', 'Company', '‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä'];
  for (const indicator of companyIndicators) {
    const companyMatch = text.match(new RegExp(`${indicator}\\s+([^‡•§\\s]+(?:\\s+[^\\s]+)*?)(?=\\s+‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã|\\s+‡§∏‡•ç‡§•‡§ø‡§§|\\s+UAE\\.P\\.|\\s+‡•§|$)`, 'i'));
    if (companyMatch) {
      data.company = companyMatch[1].trim();
      console.log(`‚úÖ Company found after "${indicator}": ${data.company}`);
      break;
    }
  }
  
  // 3. SMART COUNTRY DETECTION - Find country by context and keywords
  console.log('\nüåç Looking for country...');
  
  // Look for country keywords in the text
  const countryKeywords = {
    'UAE': ['UAE', '‡§Ø‡•Ç‡§è‡§à', 'United Arab Emirates'],
    'Japan': ['Japan', '‡§ú‡§æ‡§™‡§æ‡§®', 'JPN'],
    'Saudi': ['Saudi', '‡§∏‡§æ‡§â‡§¶‡•Ä', 'Saudi Arabia', 'KSA'],
    'Qatar': ['Qatar', '‡§ï‡§§‡§æ‡§∞', 'QAR'],
    'Oman': ['Oman', '‡§ì‡§Æ‡§æ‡§®', 'OMR'],
    'Bahrain': ['Bahrain', '‡§¨‡§π‡§∞‡•á‡§®', 'BHD'],
    'Kuwait': ['Kuwait', '‡§ï‡•Å‡§µ‡•à‡§§', 'KWD']
  };
  
  for (const [country, keywords] of Object.entries(countryKeywords)) {
    for (const keyword of keywords) {
      if (text.includes(keyword)) {
        data.country = country;
        console.log(`‚úÖ Country detected: ${country} (found keyword: ${keyword})`);
        break;
      }
    }
    if (data.country) break;
  }
  
  // 4. INTELLIGENT CITY EXTRACTION - Find city by context
  console.log('\nüèôÔ∏è Looking for city...');
  
  // Try multiple city extraction strategies
  let city = '';
  
  // Strategy 1: Look for city after ‡§∂‡§π‡§∞ (most common in Nepali documents)
  const shaharMatch = text.match(/‡§∂‡§π‡§∞\s+([^‡•§\n]+?)(?=\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü|\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§Æ‡§æ‡§ó|\s+‡§∏‡§®‡•ç‡§¶‡§∞‡•ç‡§≠‡§Æ‡§æ)/i);
  if (shaharMatch) {
    city = shaharMatch[1].trim();
    console.log(`‚úÖ City found after "‡§∂‡§π‡§∞": "${city}"`);
  }
  
  // Strategy 2: Look for city after ‡§∏‡•ç‡§•‡§ø‡§§ (UAE format)
  if (!city) {
    const sthitMatch = text.match(/‡§∏‡•ç‡§•‡§ø‡§§\s+([^‡•§\n]+?)(?=\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü|\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§Æ‡§æ‡§ó|\s+‡§∏‡§®‡•ç‡§¶‡§∞‡•ç‡§≠‡§Æ‡§æ)/i);
    if (sthitMatch) {
      city = sthitMatch[1].trim();
      console.log(`‚úÖ City found after "‡§∏‡•ç‡§•‡§ø‡§§": "${city}"`);
}
  }
  
  // Strategy 3: Look for city before ‡§∂‡§π‡§∞ (reverse format)
  if (!city) {
    const reverseMatch = text.match(/([^‡•§\n]+?)\s+‡§∂‡§π‡§∞(?=\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü|\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§Æ‡§æ‡§ó|\s+‡§∏‡§®‡•ç‡§¶‡§∞‡•ç‡§≠‡§Æ‡§æ)/i);
    if (reverseMatch) {
      city = reverseMatch[1].trim();
      console.log(`‚úÖ City found before "‡§∂‡§π‡§∞": "${city}"`);
    }
  }
  
  // Strategy 4: Look for city after City (English format)
  if (!city) {
    const cityMatch = text.match(/City\s+([^‡•§\n]+?)(?=\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü|\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§Æ‡§æ‡§ó|\s+‡§∏‡§®‡•ç‡§¶‡§∞‡•ç‡§≠‡§Æ‡§æ)/i);
    if (cityMatch) {
      city = cityMatch[1].trim();
      console.log(`‚úÖ City found after "City": "${city}"`);
    }
  }
  
  // Strategy 5: Look for city before City (reverse English format)
  if (!city) {
    const reverseCityMatch = text.match(/([^‡•§\n]+?)\s+City(?=\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü|\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§Æ‡§æ‡§ó|\s+‡§∏‡§®‡•ç‡§¶‡§∞‡•ç‡§≠‡§Æ‡§æ)/i);
    if (reverseCityMatch) {
      city = reverseCityMatch[1].trim();
      console.log(`‚úÖ City found before "City": "${city}"`);
    }
  }
  
  // Strategy 6: Look for city in specific context patterns
  if (!city) {
    const contextPatterns = [
      /([^‡•§\n]+?)\s+‡§∂‡§π‡§∞\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü/i,
      /‡§∂‡§π‡§∞\s+([^‡•§\n]+?)\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü/i,
      /‡§∏‡•ç‡§•‡§ø‡§§\s+([^‡•§\n]+?)\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü/i,
      /‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü\s+([^‡•§\n]+?)\s+‡§∂‡§π‡§∞/i
    ];
    
    for (const pattern of contextPatterns) {
      const match = text.match(pattern);
      if (match && match[1]) {
        city = match[1].trim();
        console.log(`‚úÖ City found with context pattern: "${city}"`);
        break;
      }
    }
  }
  
  data.city = city;
  
  // 5. COMPREHENSIVE POSITION AND SALARY DETECTION
  console.log('\nüíº Looking for position details...');
  
  // First, analyze the document structure to understand the format
  console.log('üîç Analyzing document structure for position information...');
  
  // Look for table-like structures or position sections
  const hasPositionSection = text.includes('‡§™‡§¶ ‡§¨‡§ø‡§¨‡§∞‡§£') || text.includes('Position Details') || text.includes('Job Details');
  const hasTableFormat = text.includes('‡§™‡§¶') && text.includes('‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ') && text.includes('‡§§‡§≤‡§¨');
  
  console.log('Has position section:', hasPositionSection);
  console.log('Has table format:', hasTableFormat);
  
  // Look for position information with multiple patterns - UPDATED FOR YOUR FORMAT
  const positionPatterns = [
    // Your specific format: ‡§™‡§¶ ‡§µ‡§ø‡§µ‡§∞‡§£
    /‡§™‡§¶\s*‡§µ‡§ø‡§µ‡§∞‡§£\s*:?\s*([^‡•§\n]+?)(?=\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§§‡§≤‡§¨|\s+Salary|\s+‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ)/i,
    /‡§™‡§¶\s*‡§¨‡§ø‡§¨‡§∞‡§£\s*:?\s*([^‡•§\n]+?)(?=\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§§‡§≤‡§¨|\s+Salary|\s+‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ)/i,
    // Alternative formats
    /‡§™‡§¶\s*:?\s*([^‡•§\n]+?)(?=\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§§‡§≤‡§¨|\s+Salary|\s+‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ)/i,
    /Position\s*:?\s*([^‡•§\n]+?)(?=\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§§‡§≤‡§¨|\s+Salary|\s+‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ)/i,
    // Look for position in table format or after specific keywords
    /‡§™‡§¶\s*‡§¨‡§ø‡§¨‡§∞‡§£[^]*?(\w+(?:\s+\w+)*)/i,
    /Position\s*Details[^]*?(\w+(?:\s+\w+)*)/i,
    // Look for common job titles in the text
    /(Helper|Engineer|Technician|Worker|Labor|Driver|Cleaner|Cook|Waiter|Nurse|Doctor|Teacher|Manager|Supervisor|Assistant|Operator|Mechanic|Electrician|Plumber|Carpenter|Mason|Painter|Welder|Fitter|Helper|Worker|Laborer|Driver|Cleaner|Cook|Waiter|Nurse|Doctor|Teacher|Manager|Supervisor|Assistant|Operator|Mechanic|Electrician|Plumber|Carpenter|Mason|Painter|Welder|Fitter)/i
  ];
  
  for (const pattern of positionPatterns) {
    const match = text.match(pattern);
    if (match && match[1]) {
      data.position = match[1].trim();
      console.log(`‚úÖ Position: ${data.position}`);
      break;
    }
  }
  
          // Look for male count with multiple patterns - UPDATED FOR YOUR FORMAT
        const malePatterns = [
          // Your specific format: ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ: ‡§™‡•Å‡§∞‡•Å‡§∑ 2, ‡§Æ‡§π‡§ø‡§≤‡§æ 0
          /‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ\s*:?\s*‡§™‡•Å‡§∞‡•Å‡§∑\s*(\d+)/i,
          /‡§™‡•Å‡§∞‡•Å‡§∑\s*:?\s*(\d+)/i,
          /Male\s*:?\s*(\d+)/i,
          /‡§™‡•Å‡§∞‡•Å‡§∑\s*(\d+)/i,
          /Male\s*(\d+)/i,
          /(\d+)\s*‡§™‡•Å‡§∞‡•Å‡§∑/i,
          /(\d+)\s*Male/i
        ];
  
  for (const pattern of malePatterns) {
    const match = text.match(pattern);
    if (match && match[1]) {
      data.maleCount = match[1];
      console.log(`‚úÖ Male count: ${data.maleCount}`);
      break;
    }
  }
  
          // Look for female count with multiple patterns - UPDATED FOR YOUR FORMAT
        const femalePatterns = [
          // Your specific format: ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ: ‡§™‡•Å‡§∞‡•Å‡§∑ 2, ‡§Æ‡§π‡§ø‡§≤‡§æ 0
          /‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ\s*:?\s*[^,]*‡§Æ‡§π‡§ø‡§≤‡§æ\s*(\d+)/i,
          /‡§Æ‡§π‡§ø‡§≤‡§æ\s*:?\s*(\d+)/i,
          /Female\s*:?\s*(\d+)/i,
          /‡§Æ‡§π‡§ø‡§≤‡§æ\s*(\d+)/i,
          /Female\s*(\d+)/i,
          /(\d+)\s*‡§Æ‡§π‡§ø‡§≤‡§æ/i,
          /(\d+)\s*Female/i
        ];
  
  for (const pattern of femalePatterns) {
    const match = text.match(pattern);
    if (match && match[1]) {
      data.femaleCount = match[1];
      console.log(`‚úÖ Female count: ${data.femaleCount}`);
      break;
    }
  }
  
          // Look for salary information with multiple patterns - UPDATED FOR YOUR FORMAT
        const salaryPatterns = [
          // Your specific format: ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§§‡§≤‡§¨
          /‡§Æ‡§æ‡§∏‡§ø‡§ï\s*‡§§‡§≤‡§¨\s*:?\s*([^‡•§\n]+?)(?=\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ)/i,
          /‡§§‡§≤‡§¨\s*:?\s*([^‡•§\n]+?)(?=\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ)/i,
          /Salary\s*:?\s*([^‡•§\n]+?)(?=\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ)/i,
          /Basic\s*Salary\s*:?\s*([^‡•§\n]+?)(?=\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ)/i
        ];
  
  for (const pattern of salaryPatterns) {
    const match = text.match(pattern);
    if (match && match[1]) {
      data.salary = match[1].trim();
      console.log(`‚úÖ Salary: ${data.salary}`);
      break;
    }
  }
  
  // Extract salary amount and currency separately
  if (data.salary) {
    // Extract amount (numbers)
    const amountMatch = data.salary.match(/(\d+(?:,\d+)*(?:\.\d+)?)/);
    if (amountMatch) {
      data.salaryAmount = amountMatch[1];
      console.log(`‚úÖ Salary amount: ${data.salaryAmount}`);
    }
    
    // Extract currency
    const currency = detectCurrency(data.salary);
    if (currency) {
      data.salaryCurrency = currency;
      console.log(`‚úÖ Salary currency: ${currency}`);
    }
  }
  
  // Look for employee count if not found above
  if (!data.maleCount && !data.femaleCount) {
    const countPatterns = [
      /(\d+)\s*‡§ú‡§®‡§æ\s*‡§®‡•á‡§™‡§æ‡§≤‡•Ä\s*‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞/i,
      /(\d+)\s*‡§®‡•á‡§™‡§æ‡§≤‡•Ä\s*‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞/i,
      /(\d+)\s*workers/i,
      /(\d+)\s*employees/i
    ];
    
    for (const pattern of countPatterns) {
      const match = text.match(pattern);
      if (match && match[1]) {
        data.employeeCount = match[1];
        console.log(`‚úÖ Total employee count: ${data.employeeCount}`);
        break;
      }
    }
  }
  
  console.log('\nüéØ Final extracted data:', data);
  return data;
}

// Specialized function for your employment letter format
function extractEmploymentLetterFormat(text) {
  console.log('üìã === EXTRACTING FROM YOUR EMPLOYMENT LETTER FORMAT ===');
  
  const data = {};
  
  // 1. Extract position from ‡§™‡§¶ ‡§µ‡§ø‡§µ‡§∞‡§£
  const positionMatch = text.match(/‡§™‡§¶\s*‡§µ‡§ø‡§µ‡§∞‡§£\s*:?\s*([^‡•§\n]+?)(?=\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§§‡§≤‡§¨|\s+Salary|\s+‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ)/i);
  if (positionMatch && positionMatch[1]) {
    data.position = positionMatch[1].trim();
    console.log(`‚úÖ Position from ‡§™‡§¶ ‡§µ‡§ø‡§µ‡§∞‡§£: ${data.position}`);
  }
  
  // 2. Extract salary from ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§§‡§≤‡§¨
  const salaryMatch = text.match(/‡§Æ‡§æ‡§∏‡§ø‡§ï\s*‡§§‡§≤‡§¨\s*:?\s*([^‡•§\n]+?)(?=\s+‡•§|\s+$|\s+[A-Z]{2,}|\s+‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ)/i);
  if (salaryMatch && salaryMatch[1]) {
    data.salary = salaryMatch[1].trim();
    console.log(`‚úÖ Salary from ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§§‡§≤‡§¨: ${data.salary}`);
    
    // Extract amount and currency
    const amountMatch = data.salary.match(/(\d+(?:,\d+)*(?:\.\d+)?)/);
    if (amountMatch) {
      data.salaryAmount = amountMatch[1];
      console.log(`‚úÖ Salary amount: ${data.salaryAmount}`);
    }
    
    // Extract currency
    const currency = detectCurrency(data.salary);
    if (currency) {
      data.salaryCurrency = currency;
      console.log(`‚úÖ Salary currency: ${currency}`);
    }
  }
  
  // 3. Extract counts from ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ: ‡§™‡•Å‡§∞‡•Å‡§∑ 2, ‡§Æ‡§π‡§ø‡§≤‡§æ 0
  const countMatch = text.match(/‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ\s*:?\s*‡§™‡•Å‡§∞‡•Å‡§∑\s*(\d+)[^]*?‡§Æ‡§π‡§ø‡§≤‡§æ\s*(\d+)/i);
  if (countMatch && countMatch[1] && countMatch[2]) {
    data.maleCount = countMatch[1];
    data.femaleCount = countMatch[2];
    console.log(`‚úÖ Male count: ${data.maleCount}`);
    console.log(`‚úÖ Female count: ${data.femaleCount}`);
  } else {
    // Try separate patterns if combined pattern doesn't work
    const maleMatch = text.match(/‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ\s*:?\s*‡§™‡•Å‡§∞‡•Å‡§∑\s*(\d+)/i);
    if (maleMatch && maleMatch[1]) {
      data.maleCount = maleMatch[1];
      console.log(`‚úÖ Male count (separate): ${data.maleCount}`);
    }
    
    const femaleMatch = text.match(/‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ\s*:?\s*[^,]*‡§Æ‡§π‡§ø‡§≤‡§æ\s*(\d+)/i);
    if (femaleMatch && femaleMatch[1]) {
      data.femaleCount = femaleMatch[1];
      console.log(`‚úÖ Female count (separate): ${data.femaleCount}`);
    }
  }
  
  // 4. Look for employee count if not found above
  if (!data.maleCount && !data.femaleCount) {
    const totalMatch = text.match(/(\d+)\s*‡§ú‡§®‡§æ\s*‡§®‡•á‡§™‡§æ‡§≤‡•Ä\s*‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞/i);
    if (totalMatch && totalMatch[1]) {
      data.employeeCount = totalMatch[1];
      console.log(`‚úÖ Total employee count: ${data.employeeCount}`);
    }
  }
  
  console.log('üìã Final extracted data for your format:', data);
  return data;
}

// Test function for company extraction
function testCompanyExtraction() {
  const testText = `NEW GURKHAS INTERNATIONAL PVT. LTD. UAE ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã UAE.P.OB0x:677,1ST FLOORNAD AL SHEBA FIRST MEYDAN.PO ‡§∞‡§æ‡§π‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§ FINE FARE FOOD MARKET L.L.C ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü 200 ‡§ú‡§®‡§æ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡§Æ‡§æ‡§ó ‡§≠‡§à ‡§Ü‡§è‡§ï‡•ã ‡§∏‡§®‡•ç‡§¶‡§∞‡•ç‡§≠‡§Æ‡§æ ‡§§‡•ç‡§Ø‡§∏ ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§≤‡•á ‡§¨‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§ó‡§∞‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡§õ‡§®‡•å‡§ü ‡§ó‡§∞‡•ç‡§® ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§ó‡§∞‡•á ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§ï‡§æ‡§∞‡§µ‡§æ‡§π‡•Ä gal ‡§Æ‡§æ‡§ó‡§™‡§§‡•ç‡§∞‡§Æ‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ‡§ø‡§§ ‡§∂‡§∞‡•ç‡§§ ‡§è‡§µ ‡§∏‡•Å‡§¨‡§ø‡§ß‡§æ‡§π‡§∞‡•Ç ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§™‡§æ‡§≤‡§®‡§æ ‡§ó‡§∞‡§æ‡§â‡§® ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä ‡§∏‡•ç‡§µ‡§Ø‡§Ç ‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§µ‡§æ‡§∞‡•Ä ‡§π‡•Å‡§®‡•á ‡§ó‡§∞‡•Ä ‡§§‡§™‡§∏‡§ø‡§≤‡§Æ‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§≠‡§è ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§ú‡§Æ‡•ç‡§Æ‡§æ I ‡§™‡§¶‡§ï‡•ã ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞‡§π‡§∞‡•Å‡§ï‡•ã ‡§õ‡§®‡•å‡§ü‡§ï‡•ã ‡§§‡§æ‡§ó‡§ø ‡§™‡•ç‡§∞‡§ö‡§≤‡§ø‡§§ ‡§µ‡•à‡§¶‡•á‡§∂‡§ø‡§ï ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§ê‡§®, 2064 ‡§ï‡•ã ‡§¶‡§´‡§æ 15(2) ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§Æ‡§ø‡§§‡§ø 2025/05/08 ‡§ï‡•ã ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø‡§æ‡§®‡•Å‡§∏‡§æ‡§∞ ‡§™‡•Ç‡§∞‡•ç‡§µ Radia ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§õ I ‡§∏‡§æ‡§•‡•à ‡§¨‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§ó‡§∞‡•ç‡§¶‡§æ ‡§ï‡§Æ‡•ç‡§§‡§ø‡§Æ‡§æ 7 ‡§¶‡§ø‡§®‡§ï‡•ã ‡§Æ‡•ç‡§Ø‡§æ‡§¶ ‡§¶‡§ø‡§à ‡§Ø‡§∏ ‡§µ‡§ø‡§≠‡§æ‡§ó‡§ï‡•ã ‡§Ü‡§®‡•ç‡§§‡§∞‡§ø‡§ï ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§∏‡§Ç‡§ö‡§æ‡§≤‡§® ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§ø‡§ß‡§ø 2066 ‡§Æ‡§æ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§¢‡§æ‡§Å‡§ö‡§æ ‡§Ö‡§®‡•Å‡§∞‡•Å‡§™‡§ï‡§æ ‡§∏‡§Æ‡•ç‡§™‡•Ç‡§∞‡•ç‡§£ ‡§¨‡§ø‡§¨‡§∞‡§£‡§π‡§∞‡•Ç ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§π‡•Å‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á‡§õ ‡§∞ ‡§ê‡§®‡§ï‡•ã ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§ó‡§∞‡§ø ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡§õ‡§®‡•å‡§ü ‡§≠‡§è‡§ï‡•ã ‡§Æ‡§ø‡§§‡§ø‡§≤‡•á ‡§µ‡•à‡§¶‡•á‡§∂‡§ø‡§ï ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§ê‡§®, 2064 ‡§ï‡•ã ‡§¶‡§´‡§æ 20 ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ‡§ï‡•ã ‡§Æ‡•ç‡§Ø‡§æ‡§¶ ‡§≠‡§ø‡§§‡•ç‡§∞ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§™‡•Å‡§∞‡§æ ‡§ó‡§∞‡•Ä ‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß‡§ø‡§§ ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§Æ‡§æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§™‡§†‡§æ‡§à ‡§∏‡§ï‡•ç‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á‡§õ I ‡§õ‡§®‡•å‡§ü ‡§≠‡§è‡§ï‡§æ ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞‡§π‡§∞‡•Å ‡§∏‡•ã ‡§Æ‡•ç‡§Ø‡§æ‡§¶ ‡§≠‡§ø‡§§‡•ç‡§∞ ‡§™‡§†‡§æ‡§â‡§® ‡§®‡§∏‡§ï‡•á‡§Æ‡§æ ‡§ê‡§®‡§ï‡•ã ‡§¶‡§´‡§æ 20(2) ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§ï‡§æ‡§∞‡§¨‡§æ‡§π‡•Ä ‡§≠‡§à ‡§ú‡§æ‡§®‡•á ‡§¨‡•ç‡§Ø‡§π‡•ã‡§∞‡§æ ‡§∏‡§Æ‡•á‡§§ ‡§Ö‡§µ‡§ó‡§§ ‡§ó‡§∞‡§æ‡§à‡§®‡•ç‡§õ`;
  
  console.log('üß™ === TESTING COMPANY EXTRACTION ===');
  console.log('Test text:', testText);
  
  // Test the company extraction patterns
  const pattern1 = testText.match(/‡§∂‡•ç‡§∞‡•Ä\s+([^‡•§\s]+(?:\s+[^‡•§\s]+)*?)(?=\s+‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã|\s+‡§∏‡•ç‡§•‡§ø‡§§|\s+UAE\.P\.|$)/i);
  console.log('Pattern 1 result:', pattern1);
  
  const pattern2 = testText.match(/([A-Z][A-Z\s&\.]+(?:PVT\.?|LTD\.?|LLC\.?|INC\.?|CO\.?)[A-Z\s&\.]*)/i);
  console.log('Pattern 2 result:', pattern2);
  
  // Test with ‡§∂‡•ç‡§∞‡•Ä prefix
  const testTextWithShri = `‡§∂‡•ç‡§∞‡•Ä ${testText}`;
  const pattern1WithShri = testTextWithShri.match(/‡§∂‡•ç‡§∞‡•Ä\s+([^‡•§\s]+(?:\s+[^‡•§\s]+)*?)(?=\s+‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã|\s+‡§∏‡•ç‡§•‡§ø‡§§|\s+UAE\.P\.|$)/i);
  console.log('Pattern 1 with ‡§∂‡•ç‡§∞‡•Ä result:', pattern1WithShri);
  
  alert('Check console for company extraction test results!');
}

// Test function for specific employment data extraction
function testSpecificExtraction() {
  const testText = `LT. No. 322862 ‡§ï‡•ã ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø I Date 2025/08/08 ‡§ö‡§≤‡§æ‡§®‡•Ä ‡§®‡§Ç.  60237432 LT. No. 322862 ‡§∂‡•ç‡§∞‡•Ä NEW GURKHAS INTERNATIONAL PVT. LTD. UAE ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã UAE.P.OB0x 677,1ST FLOORNAD AL SHEBA FIRST MEYDAN.PO ‡§∞‡§æ‡§π‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§ FINE FARE FOOD MARKET L.L.C ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü 200 ‡§ú‡§®‡§æ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡§Æ‡§æ‡§ó ‡§≠‡§à ‡§Ü‡§è‡§ï‡•ã ‡§∏‡§®‡•ç‡§¶‡§∞‡•ç‡§≠‡§Æ‡§æ ‡§§‡•ç‡§Ø‡§∏ ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§≤‡•á ‡§¨‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§ó‡§∞‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡§õ‡§®‡•å‡§ü ‡§ó‡§∞‡•ç‡§® ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø‡§ï‡§æ ‡§≤‡§æ‡§ó‡§ø ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§ó‡§∞‡•á ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§ï‡§æ‡§∞‡§µ‡§æ‡§π‡•Ä gal ‡§Æ‡§æ‡§ó‡§™‡§§‡•ç‡§∞‡§Æ‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ‡§ø‡§§ ‡§∂‡§∞‡•ç‡§§ ‡§è‡§µ ‡§∏‡•Å‡§¨‡§ø‡§ß‡§æ‡§π‡§∞‡•Ç ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§™‡§æ‡§≤‡§®‡§æ ‡§ó‡§∞‡§æ‡§â‡§® ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä ‡§∏‡•ç‡§µ‡§Ø‡§Ç ‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§µ‡§æ‡§∞‡•Ä ‡§π‡•Å‡§®‡•á ‡§ó‡§∞‡•Ä ‡§§‡§™‡§∏‡§ø‡§≤‡§Æ‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§≠‡§è ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§ú‡§Æ‡•ç‡§Æ‡§æ I ‡§™‡§¶‡§ï‡•ã ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞‡§π‡§∞‡•Å‡§ï‡•ã ‡§õ‡§®‡•å‡§ü‡§ï‡•ã ‡§§‡§æ‡§ó‡§ø ‡§™‡•ç‡§∞‡§ö‡§≤‡§ø‡§§ ‡§µ‡•à‡§¶‡•á‡§∂‡§ø‡§ï ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§ê‡§®, 2064 ‡§ï‡•ã ‡§¶‡§´‡§æ 15(2) ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§Æ‡§ø‡§§‡§ø 2025/05/08 ‡§ï‡•ã ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø‡§æ‡§®‡•Å‡§∏‡§æ‡§∞ ‡§™‡•Ç‡§∞‡•ç‡§µ Radia ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§õ I ‡§∏‡§æ‡§•‡•à ‡§¨‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§ó‡§∞‡•ç‡§¶‡§æ ‡§ï‡§Æ‡•ç‡§§‡§ø‡§Æ‡§æ 7 ‡§¶‡§ø‡§®‡§ï‡•ã ‡§Æ‡•ç‡§Ø‡§æ‡§¶ ‡§¶‡§ø‡§à ‡§Ø‡§∏ ‡§µ‡§ø‡§≠‡§æ‡§ó‡§ï‡•ã ‡§Ü‡§®‡•ç‡§§‡§∞‡§ø‡§ï ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§∏‡§Ç‡§ö‡§æ‡§≤‡§® ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§ø‡§ß‡§ø 2066 ‡§Æ‡§æ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§¢‡§æ‡§Å‡§ö‡§æ ‡§Ö‡§®‡•Å‡§∞‡•Å‡§™‡§ï‡§æ ‡§∏‡§Æ‡•ç‡§™‡•Ç‡§∞‡•ç‡§£ ‡§¨‡§ø‡§¨‡§∞‡§£‡§π‡§∞‡•Ç ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§π‡•Å‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á‡§õ ‡§∞ ‡§ê‡§®‡§ï‡•ã ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§ó‡§∞‡§ø ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡§õ‡§®‡•å‡§ü ‡§≠‡§è‡§ï‡•ã ‡§Æ‡§ø‡§§‡§ø‡§≤‡•á ‡§µ‡•à‡§¶‡•á‡§∂‡§ø‡§ï ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§ê‡§®, 2064 ‡§ï‡•ã ‡§¶‡§´‡§æ 20 ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ‡§ï‡•ã ‡§Æ‡•ç‡§Ø‡§æ‡§¶ ‡§≠‡§ø‡§§‡•ç‡§∞ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§™‡•Å‡§∞‡§æ ‡§ó‡§∞‡•Ä ‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß‡§ø‡§§ ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§Æ‡§æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§™‡§†‡§æ‡§à ‡§∏‡§ï‡•ç‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á‡§õ I ‡§õ‡§®‡•å‡§ü ‡§≠‡§è‡§ï‡§æ ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞‡§π‡§∞‡•Å ‡§∏‡•ã ‡§Æ‡•ç‡§Ø‡§æ‡§¶ ‡§≠‡§ø‡§§‡•ç‡§∞ ‡§™‡§†‡§æ‡§â‡§® ‡§®‡§∏‡§ï‡•á‡§Æ‡§æ ‡§ê‡§®‡§ï‡•ã ‡§¶‡§´‡§æ 20(2) ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§ï‡§æ‡§∞‡§¨‡§æ‡§π‡•Ä ‡§≠‡§à ‡§ú‡§æ‡§®‡•á ‡§¨‡•ç‡§Ø‡§π‡•ã‡§∞‡§æ ‡§∏‡§Æ‡•á‡§§ ‡§Ö‡§µ‡§ó‡§§ ‡§ó‡§∞‡§æ‡§à‡§®‡•ç‡§õ ‡•§ IE A. ‡§™‡§¶ ‡§¨‡§ø‡§¨‡§∞‡§£ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§§‡§≤‡§¨ ‡§ï‡•à‡§´‡§ø‡§Ø‡§§ ‡§¨‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®‡§Æ‡§æ  ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§§‡§≤‡§¨ ‡§Æ‡§æ‡§§‡•ç‡§∞ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§ó‡§∞‡•ç‡§®‡•á I  ‡§¨‡§ø‡§¶‡•á‡§∂ ‡§∏‡•ç‡§•‡§ø‡§§ ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§ï‡•ã ‡§®‡§æ‡§Æ ‡§â‡§§‡•ç‡§≤‡•á‡§ñ ‡§ó‡§∞‡•ç‡§®‡•á ‡•§  ‡§≠‡§ø‡§∑‡§æ ‡§∂‡•Å‡§≤‡•ç‡§ï ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§ó‡§∞‡•ç‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á‡•§ ‡§≠‡§ø‡§∑‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§®‡§≠‡§à ‡§Ö‡§ó‡•ç‡§∞‡§ø‡§Æ ‡§≠‡§ï‡•ç‡§§‡§æ‡§®‡•Ä ‡§Æ‡§æ‡§ó ‡§®‡§ó‡§∞‡•ç‡§®‡•á ‡•§  ‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä Af ‡§§‡§ø‡§∞‡•ç‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á ‡§≠‡§è ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§™‡•Å‡§∞‡•Å‡§∑ I ‡§Æ‡§π‡§ø‡§≤‡§æ ‡§ó‡§∞‡•ç‡§®‡•á ‡•§ E ‡§π‡§ø  ‡§∏‡•ç‡§µ‡§ø‡§ï‡•É‡§§‡§ø ‡§≤‡§ø‡§à ‡§∂‡§æ‡§ñ‡§æ ‡§ñ‡•ã‡§≤‡§ø‡§á‡§è‡§ï‡•ã‡§Æ‡§æ ‡§¨‡§æ‡§π‡•á‡§ï ‡§∂‡§æ‡§ñ‡§æ ‡§ñ‡•ã‡§≤‡§ø‡§á‡§è‡§ï‡•ã‡§Æ‡§æ ‡§¨‡§æ‡§π‡•á‡§ï ‡§∂‡§æ‡§ñ‡§æ ‡§∞ ‡§è‡§ú‡•á‡§®‡•ç‡§ü‡§ï‡•ã ‡§ï‡•Å‡§∞‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§®‡§ó‡§∞‡•ç‡§®‡•á ‡•§ DR ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø‡§ï‡•ã ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ 150 50 ‡§°‡§ø‡§Æ‡§æ‡§£‡•ç‡§° Tex ‡§∞ ‡§ï‡§∞‡§æ‡§∞‡§ï‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§∂‡§∞‡•ç‡§§‡§π‡§∞‡•Ç ‡§∞ ‡§®‡§ø‡§∞‡•ç‡§¶‡§ø‡§∑‡•ç‡§ü ‡§¢‡§æ‡§Å‡§ö‡§æ ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ‡§ï‡§æ ‡§¨‡§ø‡§¨‡§∞‡§£‡§π‡§∞‡•Å ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§∞‡•Å‡§™‡§Æ‡§æ ‡§¨‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§®‡§Æ‡§æ ‡§â‡§≤‡•ç‡§≤‡•á‡§ñ ‡§π‡•Å‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á‡§õ ‡§§‡§•‡§æ ‡§Ö‡§®‡•ç‡§§‡§∞‡§µ‡§æ‡§∞‡•ç‡§§‡§æ‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§™‡•ç‡§∞‡§§‡§ø‡§®‡§ø‡§ß‡§ø ‡§Æ‡§æ‡§ó ‡§ó‡§∞‡•ç‡§¶‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§ø‡§§ ‡§™‡§§‡•ç‡§∞‡§ø‡§ï‡§æ‡§ï‡•ã ‡§Æ‡§ø‡§§‡§ø ‡§∏‡§Æ‡•á‡§§ ‡§™‡•ç‡§∞‡§∑‡•ç‡§ü ‡§≠‡§è‡§ï‡•ã ‡§∏‡§ï‡•ç‡§ï‡§§ ‡§™‡§§‡•ç‡§∞‡§ø‡§ï ‡§®‡•à ‡§™‡•á‡§∂ ‡§ó‡§∞‡•ç‡§®‡•Å ‡§™‡§∞‡•ç‡§®‡•á‡§õ I ‡§Ö‡§®‡•ç‡§Ø‡§•‡§æ ‡§™‡§õ‡§ø ‡§ï‡§æ‡§∞‡§µ‡§æ‡§π‡§ø ‡§®‡§π‡•Å‡§®‡•á ‡§µ‡•ç‡§Ø‡§π‡•ã‡§∞‡§æ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ó‡§∞‡§æ‡§à‡§®‡•ç‡§õ I ‡§∏‡§æ‡§•‡•à ‡§µ‡•à‡§¶‡•á‡§∂‡§ø‡§ï ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§ê‡§®, 2064 ‡§∞ ‡§®‡§ø‡§Ø‡§Æ‡§µ‡§æ‡§≤‡§ø 2064 ‡§µ‡§ø‡§™‡§∞‡§ø‡§§ ‡§ï‡•Å‡§®‡•à ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ó‡§∞‡•á‡§Æ‡§æ ‡§Ø‡•ã ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡§ø‡§ï‡•É‡§§‡§ø ‡§ú‡•Å‡§® ‡§∏‡•Å‡§ï‡•à ‡§∏‡§Æ‡§Ø‡§Æ‡§æ ‡§∞‡§¶‡•ç‡§¶ ‡§ó‡§∞‡§ø‡§®‡•á ‡§õ I  ‡§®‡•ã‡§ü  ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø‡§ï‡•ã ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§® ‡§ó‡§∞‡•ç‡§¶‡§æ ‡§®‡•á‡§™‡§æ‡§≤ ‡§∏‡§∞‡§ï‡§æ‡§∞‡§¨‡§æ‡§ü 10% ‡§ï‡•ã‡§ü‡§æ ‡§Æ‡§π‡§ø‡§≤‡§æ, ‡§¶‡§≤‡§ø‡§§, ‡§™‡§ø‡§õ‡§°‡§ø‡§è‡§ï‡•ã ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞, ‡§Ü‡§¶‡•Ä‡§¨‡§æ‡§∏‡•Ä ‡§ú‡§®‡§ú‡§æ‡§§‡§ø ‡§∞ ‡§Æ‡§ß‡•á‡§∏‡•Ä ‡§≤‡§æ‡§à ‡§õ‡•Å‡§ü‡•ç‡§Ø‡§æ‡§á‡§è‡§ï‡•ã ‡§≠‡§®‡•Ä ‡§≤‡•á‡§ñ‡•Ä ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§® ‡§ó‡§∞‡•ç‡§®‡•á ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã‡§Æ‡§æ ‡§π‡§æ‡§≤ ‡§∏‡•ã ‡§¨‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ ‡§ï‡§æ‡§Ø‡§Æ ‡§®‡§∞‡§π‡•á‡§ï‡•ã‡§≤‡•á ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§® ‡§ó‡§∞‡§ø ‡§∞‡§æ‡§ñ‡•ç‡§®‡•Å ‡§®‡§™‡§∞‡•ç‡§®‡•á ‡•§`;
  
  console.log('üéØ === TESTING SPECIFIC EMPLOYMENT EXTRACTION ===');
  console.log('Test text:', testText);
  
  // Test the specialized extraction function
  const extractedData = extractSpecificEmploymentData(testText);
  console.log('Extracted data:', extractedData);
  
  // Test individual patterns
  console.log('\n--- Individual Pattern Tests ---');
  
  // Chalani test
  const chalaniTest = testText.match(/‡§ö‡§≤‡§æ‡§®‡•Ä\s*‡§®‡§Ç\.?\s*(\d+)/i);
  console.log('Chalani pattern test:', chalaniTest);
  
  // LOT test
  const lotTest = testText.match(/LT\.\s*No\.\s*(\d+)/i);
  console.log('LOT pattern test:', lotTest);
  
  // Date test
  const dateTest = testText.match(/Date\s+(\d{4}\/\d{2}\/\d{2})/i);
  console.log('Date pattern test:', dateTest);
  
  // Company test
  const companyTest = testText.match(/‡§∂‡•ç‡§∞‡•Ä\s+([^‡•§\s]+(?:\s+[^‡•§\s]+)*?)(?=\s+‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã|\s+‡§∏‡•ç‡§•‡§ø‡§§|\s+UAE\.P\.|$)/i);
  console.log('Company pattern test:', companyTest);
  
  // City test
  const cityTest = testText.match(/‡§∏‡•ç‡§•‡§ø‡§§\s+([^‡•§\s]+(?:\s+[^‡•§\s]+)*?)(?=\s+‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü|\s+‡•§|$)/i);
  console.log('City pattern test:', cityTest);
  
  alert('Check console for specific extraction test results!');
}

// Test function for country extraction specifically
function testCountryExtraction() {
  console.log('üåç === TESTING COUNTRY EXTRACTION ===');
  
  // Test with UAE document
  const uaeText = `‡§∂‡•ç‡§∞‡•Ä NEW GURKHAS INTERNATIONAL PVT. LTD. UAE ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã UAE.P.OB0x:677,1ST FLOORNAD AL SHEBA FIRST MEYDAN.PO ‡§∞‡§æ‡§π‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§ FINE FARE FOOD MARKET L.L.C ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü 200 ‡§ú‡§®‡§æ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞`;
  
  console.log('UAE Test text:', uaeText);
  
  // Test the country extraction patterns
  const pattern1 = uaeText.match(/‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã\s+([^‡•§\s]+(?:\s+[^‡•§\s]+)*?)(?=\s+UAE\.P\.|\s+‡§∏‡•ç‡§•‡§ø‡§§|\s+‡•§|$)/i);
  console.log('Pattern 1 (‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã + country):', pattern1);
  
  const pattern2 = uaeText.match(/([^‡•§\s]+(?:\s+[^‡•§\s]+)*?)\s+‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã/i);
  console.log('Pattern 2 (country + ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã):', pattern2);
  
  const pattern3 = uaeText.match(/\bUAE\b/i);
  console.log('Pattern 3 (UAE word boundary):', pattern3);
  
  // Test the specialized extraction
  const extractedData = extractSpecificEmploymentData(uaeText);
  console.log('Extracted country from specialized function:', extractedData.country);
  
  // Test with Japan document
  const japanText = `‡§∂‡•ç‡§∞‡•Ä JAPAN COMPANY LTD. Japan ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã Tokyo ‡§∂‡§π‡§∞ ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü 100 ‡§ú‡§®‡§æ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞`;
  
  console.log('\nJapan Test text:', japanText);
  
  const japanExtracted = extractSpecificEmploymentData(japanText);
  console.log('Japan extracted data:', japanExtracted);
  
  alert('Check console for country extraction test results!');
}

// Test function for city extraction specifically
function testCityExtraction() {
  console.log('üèôÔ∏è === TESTING CITY EXTRACTION ===');
  
  // Test different city formats
  const testCases = [
    {
      name: '‡§∏‡•ç‡§•‡§ø‡§§ format',
      text: '‡§∞‡§æ‡§π‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§ FINE FARE FOOD MARKET L.L.C ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü',
      expected: 'FINE FARE FOOD MARKET L.L.C'
    },
    {
      name: '‡§∂‡§π‡§∞ format',
      text: 'Tokyo ‡§∂‡§π‡§∞ ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü 100 ‡§ú‡§®‡§æ',
      expected: 'Tokyo'
    },
    {
      name: 'City format',
      text: 'Dubai City ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü 150 ‡§ú‡§®‡§æ',
      expected: 'Dubai'
    },
    {
      name: 'city + ‡§∂‡§π‡§∞ format',
      text: 'Osaka ‡§∂‡§π‡§∞ ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü 80 ‡§ú‡§®‡§æ',
      expected: 'Osaka'
    }
  ];
  
  for (const testCase of testCases) {
    console.log(`\n--- Testing ${testCase.name} ---`);
    console.log('Text:', testCase.text);
    
    const extractedData = extractSpecificEmploymentData(testCase.text);
    console.log('Extracted city:', extractedData.city);
    console.log('Expected:', testCase.expected);
    console.log('Match:', extractedData.city === testCase.expected ? '‚úÖ' : '‚ùå');
  }
  
  alert('Check console for city extraction test results!');
}

// Test function for city extraction with real document examples
function testCityExtractionReal() {
  console.log('üèôÔ∏è === TESTING CITY EXTRACTION WITH REAL EXAMPLES ===');
  
  // Test with your actual document formats
  const testCases = [
    {
      name: 'UAE Document (‡§∏‡•ç‡§•‡§ø‡§§ format)',
      text: '‡§∞‡§æ‡§π‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§ FINE FARE FOOD MARKET L.L.C ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü 200 ‡§ú‡§®‡§æ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞',
      expected: 'FINE FARE FOOD MARKET L.L.C'
    },
    {
      name: 'Japan Document (‡§∂‡§π‡§∞ format)',
      text: 'Tokyo ‡§∂‡§π‡§∞ ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü 100 ‡§ú‡§®‡§æ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞',
      expected: 'Tokyo'
    },
    {
      name: 'Reverse format (city + ‡§∂‡§π‡§∞)',
      text: 'Osaka ‡§∂‡§π‡§∞ ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü 80 ‡§ú‡§®‡§æ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞',
      expected: 'Osaka'
    },
    {
      name: 'English format (City + city)',
      text: 'Dubai City ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü 150 ‡§ú‡§®‡§æ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞',
      expected: 'Dubai'
    },
    {
      name: 'Context pattern (‡§∂‡§π‡§∞ + city + ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü)',
      text: '‡§∂‡§π‡§∞ FINE FARE FOOD MARKET L.L.C ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü 200 ‡§ú‡§®‡§æ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞',
      expected: 'FINE FARE FOOD MARKET L.L.C'
    }
  ];
  
  for (const testCase of testCases) {
    console.log(`\n--- Testing ${testCase.name} ---`);
    console.log('Text:', testCase.text);
    
    const extractedData = intelligentOCRExtraction(testCase.text);
    console.log('Extracted city:', extractedData.city);
    console.log('Expected:', testCase.expected);
    console.log('Match:', extractedData.city === testCase.expected ? '‚úÖ' : '‚ùå');
    
    if (extractedData.city !== testCase.expected) {
      console.log('‚ùå City extraction failed for this format');
    }
  }
  
  alert('Check console for real city extraction test results!');
}
// Test function for position and salary extraction
function testPositionSalaryExtraction() {
  console.log('üíº === TESTING POSITION AND SALARY EXTRACTION ===');
  
  // Test with comprehensive employment letter examples
  const testCases = [
    {
      name: 'UAE Document with Full Details',
      text: `‡§™‡§¶: Helper ‡§§‡§≤‡§¨: 150 KD ‡§™‡•Å‡§∞‡•Å‡§∑: 5 ‡§Æ‡§π‡§ø‡§≤‡§æ: 3 ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü 200 ‡§ú‡§®‡§æ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞`,
      expected: {
        position: 'Helper',
        salary: '150 KD',
        salaryAmount: '150',
        salaryCurrency: 'KWD',
        maleCount: '5',
        femaleCount: '3',
        employeeCount: '200'
      }
    },
    {
      name: 'Japan Document with English',
      text: `Position: Engineer Salary: 200,000 JPY Male: 10 Female: 8 100 ‡§ú‡§®‡§æ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞`,
      expected: {
        position: 'Engineer',
        salary: '200,000 JPY',
        salaryAmount: '200,000',
        salaryCurrency: 'JPY',
        maleCount: '10',
        femaleCount: '8',
        employeeCount: '100'
      }
    },
    {
      name: 'Mixed Format Document',
      text: `‡§™‡§¶ ‡§¨‡§ø‡§¨‡§∞‡§£: Technician Basic Salary: 5000 SAR ‡§™‡•Å‡§∞‡•Å‡§∑ 15 ‡§Æ‡§π‡§ø‡§≤‡§æ 12 150 workers`,
      expected: {
        position: 'Technician',
        salary: '5000 SAR',
        salaryAmount: '5000',
        salaryCurrency: 'SAR',
        maleCount: '15',
        femaleCount: '12',
        employeeCount: '150'
      }
    }
  ];
  
  for (const testCase of testCases) {
    console.log(`\n--- Testing ${testCase.name} ---`);
    console.log('Text:', testCase.text);
    
    const extractedData = intelligentOCRExtraction(testCase.text);
    console.log('Extracted data:', extractedData);
    
    // Check each expected field
    Object.entries(testCase.expected).forEach(([field, expectedValue]) => {
      const actualValue = extractedData[field];
      const match = actualValue === expectedValue;
      console.log(`${field}: ${actualValue} (expected: ${expectedValue}) ${match ? '‚úÖ' : '‚ùå'}`);
    });
    
    console.log('---');
  }
  
  alert('Check console for position and salary extraction test results!');
}

// Test function to check if position fields exist in DOM
function checkPositionFields() {
  console.log('üîç === CHECKING POSITION FIELDS IN DOM ===');
  
  // Check for position-related fields
  const positionFields = [
    'positions-0-position',
    'positions-0-male_count',
    'positions-0-female_count',
    'positions-0-salary_amount',
    'positions-0-salary_currency'
  ];
  
  positionFields.forEach(fieldName => {
    // Try to find by name attribute
    const fieldByName = document.querySelector(`[name="${fieldName}"]`);
    // Try to find by partial name match
    const fieldByPartial = document.querySelector(`[name*="${fieldName.split('-').pop()}"]`);
    
    console.log(`${fieldName}:`);
    console.log(`  By exact name: ${fieldByName ? '‚úÖ Found' : '‚ùå Not found'}`);
    console.log(`  By partial name: ${fieldByPartial ? '‚úÖ Found' : '‚ùå Not found'}`);
    
    if (fieldByName) {
      console.log(`  Current value: "${fieldByName.value}"`);
      console.log(`  Field type: ${fieldByName.type}`);
    }
  });
  
  // Check for any position forms
  const positionForms = document.querySelectorAll('.position-form');
  console.log(`\nPosition forms found: ${positionForms.length}`);
  
  if (positionForms.length > 0) {
    positionForms.forEach((form, index) => {
      console.log(`\nForm ${index + 1}:`);
      const inputs = form.querySelectorAll('input, select');
      inputs.forEach(input => {
        console.log(`  ${input.name}: ${input.type} = "${input.value}"`);
      });
    });
  }
  
  alert('Check console for position field analysis!');
}

// Test function for your specific document format
function testYourDocumentFormat() {
  console.log('üìÑ === TESTING YOUR DOCUMENT FORMAT ===');
  
  // Test with your actual document text
  const yourText = `‡§™‡§¶ ‡§ï‡•ã ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞‡§π‡§∞‡•Å‡§ï‡•ã ‡§õ‡§®‡•å‡§ü‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§™‡•ç‡§∞‡§ö‡§≤‡§ø‡§§ ‡§µ‡•à‡§¶‡•á‡§∂‡§ø‡§ï ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§ê‡§®, 2064 ‡§ï‡•ã ‡§¶‡§´‡§æ 15(2) ‡§¨‡§Æ‡•ã‡§ú‡§ø‡§Æ ‡§Æ‡§ø‡§§‡§ø 2025/08/15 ‡§ï‡•ã ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø‡§æ‡§®‡•Å‡§∏‡§æ‡§∞ ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡§ø‡§ï‡•É‡§§‡§ø ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ó‡§∞‡§ø‡§è‡§ï‡•ã ‡§õ`;
  
  console.log('Your document text:', yourText);
  
  // Analyze the structure
  const hasPositionSection = yourText.includes('‡§™‡§¶ ‡§¨‡§ø‡§¨‡§∞‡§£') || yourText.includes('Position Details') || yourText.includes('Job Details');
  const hasTableFormat = yourText.includes('‡§™‡§¶') && yourText.includes('‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ') && yourText.includes('‡§§‡§≤‡§¨');
  
  console.log('Has position section:', hasPositionSection);
  console.log('Has table format:', hasTableFormat);
  
  // Test position extraction
  const extractedData = intelligentOCRExtraction(yourText);
  console.log('Extracted data:', extractedData);
  
  // Check what was found
  console.log('\n--- Analysis Results ---');
  console.log('Position found:', extractedData.position ? `‚úÖ ${extractedData.position}` : '‚ùå Not found');
  console.log('Male count found:', extractedData.maleCount ? `‚úÖ ${extractedData.maleCount}` : '‚ùå Not found');
  console.log('Female count found:', extractedData.femaleCount ? `‚úÖ ${extractedData.femaleCount}` : '‚ùå Not found');
  console.log('Salary found:', extractedData.salary ? `‚úÖ ${extractedData.salary}` : '‚ùå Not found');
  
  alert('Check console for your document format analysis!');
}

// Test function for your specific employment letter format
function testYourEmploymentLetterFormat() {
  console.log('üìã === TESTING YOUR EMPLOYMENT LETTER FORMAT ===');
  
  // Test with your actual document format
  const yourText = `‡§™‡§¶ ‡§µ‡§ø‡§µ‡§∞‡§£: Helper
‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§§‡§≤‡§¨: 150 KD
‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ: ‡§™‡•Å‡§∞‡•Å‡§∑ 2, ‡§Æ‡§π‡§ø‡§≤‡§æ 0`;
  
  console.log('Your document text:', yourText);
  
  // Test specialized extraction
  const specializedData = extractEmploymentLetterFormat(yourText);
  console.log('Specialized extraction result:', specializedData);
  
  // Test intelligent extraction as fallback
  const intelligentData = intelligentOCRExtraction(yourText);
  console.log('Intelligent extraction result:', intelligentData);
  
  // Check what was found
  console.log('\n--- Specialized Extraction Results ---');
  console.log('Position found:', specializedData.position ? `‚úÖ ${specializedData.position}` : '‚ùå Not found');
  console.log('Male count found:', specializedData.maleCount ? `‚úÖ ${specializedData.maleCount}` : '‚ùå Not found');
  console.log('Female count found:', specializedData.femaleCount ? `‚úÖ ${specializedData.femaleCount}` : '‚ùå Not found');
  console.log('Salary found:', specializedData.salary ? `‚úÖ ${specializedData.salary}` : '‚ùå Not found');
  console.log('Salary amount found:', specializedData.salaryAmount ? `‚úÖ ${specializedData.salaryAmount}` : '‚ùå Not found');
  console.log('Salary currency found:', specializedData.salaryCurrency ? `‚úÖ ${specializedData.salaryCurrency}` : '‚ùå Not found');
  
  alert('Check console for your employment letter format test!');
}

// Test function for the new clean parser
function testCleanParser() {
  console.log('üßπ === TESTING CLEAN PARSER ===');
  
  // Test with your actual document format
  const testText = `‡§∂‡•ç‡§∞‡•Ä SUCCESS NEPAL MANPOWER AGENCY PVT. LTD.
LT. No. 327122
‡§ö‡§≤‡§æ‡§®‡•Ä ‡§®‡§Ç. 60243265
Date 2025/08/17
LOT No. 327122
Japan

Scaffolding 2 0 JPY 177657.00`;
  
  console.log('Test text:', testText);
  
  // Test the new parser
  const parsed = parseFromOCR(testText);
  console.log('Parsed data:', parsed);
  
  // Test applying the data
  console.log('Applying parsed data...');
  applyParsedData(parsed);
  
  alert('Check console for clean parser test results!');
}

// Test function to verify your local trained data is working
async function testLocalTrainedData() {
  console.log('üîç === TESTING LOCAL TRAINED DATA ===');
  
  // Check if Tesseract is available
  if (typeof Tesseract === 'undefined') {
    console.error('‚ùå Tesseract.js not loaded!');
    alert('‚ùå Tesseract.js library not loaded!');
    return;
  }
  
  console.log('‚úÖ Tesseract.js loaded');
  console.log('TESSDATA_URL (local):', TESSDATA_URL);
  console.log('TESSDATA_CDN (fallback):', TESSDATA_CDN);
  
  // Create a simple test image with Nepali text
  const canvas = document.createElement('canvas');
  canvas.width = 400;
  canvas.height = 100;
  const ctx = canvas.getContext('2d');
  
  // Fill with white background
  ctx.fillStyle = 'white';
  ctx.fillRect(0, 0, 400, 100);
  
  // Add Nepali text
  ctx.fillStyle = 'black';
  ctx.font = '24px Arial';
  ctx.fillText('‡§™‡§¶: Helper', 20, 40);
  ctx.fillText('‡§™‡•Å‡§∞‡•Å‡§∑: 5', 20, 70);
  ctx.fillText('‡§Æ‡§π‡§ø‡§≤‡§æ: 3', 200, 70);
  
  try {
    // Convert canvas to blob
    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
    
    console.log('üñºÔ∏è Created test image with Nepali text');
    console.log('üîç Testing OCR with local trained data...');
    
    // Test with local trained data first
    const localResult = await Tesseract.recognize(blob, OCR_LANGS, {
      langPath: TESSDATA_URL,
      logger: m => console.log('[LOCAL]', m),
      tessedit_pageseg_mode: 6,
      user_defined_dpi: '300'
    });
    
    console.log('‚úÖ Local trained data result:', localResult.data.text);
    
    // Test with CDN fallback for comparison
    console.log('üîç Testing OCR with CDN fallback...');
    const cdnResult = await Tesseract.recognize(blob, OCR_LANGS, {
      langPath: TESSDATA_CDN,
      logger: m => console.log('[CDN]', m),
      tessedit_pageseg_mode: 6,
      user_defined_dpi: '300'
    });
    
    console.log('‚úÖ CDN fallback result:', cdnResult.data.text);
    
    // Compare results
    console.log('\nüìä === COMPARISON RESULTS ===');
    console.log('Local trained data:', localResult.data.text);
    console.log('CDN fallback:', cdnResult.data.text);
    
    if (localResult.data.text.includes('‡§™‡§¶') || localResult.data.text.includes('Helper')) {
      console.log('‚úÖ Local trained data is working and recognizing Nepali text!');
      alert('‚úÖ Local trained data is working! Check console for details.');
    } else {
      console.log('‚ö†Ô∏è Local trained data might not be working properly');
      alert('‚ö†Ô∏è Local trained data might have issues. Check console for details.');
    }
    
  } catch (error) {
    console.error('‚ùå Error testing trained data:', error);
    alert('‚ùå Error testing trained data: ' + error.message);
  }
}

// Check if trained data files are accessible from browser
async function checkTrainedDataAccess() {
  console.log('üîç === CHECKING TRAINED DATA ACCESS ===');
  
  const files = ['nep.traineddata', 'eng.traineddata'];
  
  for (const file of files) {
    const url = `${TESSDATA_URL}${file}`;
    console.log(`Checking access to: ${url}`);
    
    try {
      const response = await fetch(url, { method: 'HEAD' });
      if (response.ok) {
        console.log(`‚úÖ ${file} is accessible (${response.status})`);
      } else {
        console.log(`‚ùå ${file} not accessible (${response.status})`);
      }
    } catch (error) {
      console.log(`‚ùå ${file} access error:`, error.message);
    }
  }
  
  // Also check the directory listing
  try {
    const dirResponse = await fetch(TESSDATA_URL);
    console.log('Directory response:', dirResponse.status, dirResponse.statusText);
  } catch (error) {
    console.log('Directory access error:', error.message);
  }
  
  alert('Check console for trained data accessibility!');
}

// Test function for intelligent OCR
function testIntelligentOCR() {
  console.log('üß† === TESTING INTELLIGENT OCR ===');
  
  // Test with different document formats
  const testCases = [
    {
      name: 'UAE Employment Letter',
      text: `LT. No. 322862 ‡§ï‡•ã ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø I Date 2025/08/08 ‡§ö‡§≤‡§æ‡§®‡•Ä ‡§®‡§Ç. 60237432 LT. No. 322862 ‡§∂‡•ç‡§∞‡•Ä NEW GURKHAS INTERNATIONAL PVT. LTD. UAE ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã UAE.P.OB0x 677,1ST FLOORNAD AL SHEBA FIRST MEYDAN.PO ‡§∞‡§æ‡§π‡§∞ ‡§∏‡•ç‡§•‡§ø‡§§ FINE FARE FOOD MARKET L.L.C ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü 200 ‡§ú‡§®‡§æ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞`
    },
    {
      name: 'Japan Employment Letter',
      text: `‡§∂‡•ç‡§∞‡•Ä JAPAN COMPANY LTD. Japan ‡§Æ‡•Å‡§≤‡•Å‡§ï‡§ï‡•ã Tokyo ‡§∂‡§π‡§∞ ‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§¨‡§æ‡§ü 100 ‡§ú‡§®‡§æ ‡§®‡•á‡§™‡§æ‡§≤‡•Ä ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞ ‡§™‡§¶: Engineer ‡§§‡§≤‡§¨: 200,000 JPY`
    },
    {
      name: 'Saudi Employment Letter',
      text: `Company: SAUDI ARABIA CORP. Country: Saudi Arabia City: Riyadh Chalani No. 12345 LOT No. 67890 Date: 2025/01/15 Position: Technician Salary: 5000 SAR`
    }
  ];
  
  for (const testCase of testCases) {
    console.log(`\n--- Testing ${testCase.name} ---`);
    console.log('Text:', testCase.text);
    
    const extractedData = intelligentOCRExtraction(testCase.text);
    console.log('Intelligently extracted data:', extractedData);
    console.log('---');
  }
  
  alert('Check console for intelligent OCR test results!');
}

// Test function for local trained data
function testLocalTrainedData() {
  console.log('üìÅ === TESTING LOCAL TRAINED DATA ===');
  
  // Check if local trained data files are accessible
  const testFiles = [
    '/static/tessdata/eng.traineddata',
    '/static/tessdata/nep.traineddata'
  ];
  
  console.log('Testing access to local trained data files...');
  
  testFiles.forEach(async (filePath) => {
    try {
      const response = await fetch(filePath, { method: 'HEAD' });
      if (response.ok) {
        console.log(`‚úÖ ${filePath} - Accessible (${response.headers.get('content-length')} bytes)`);
      } else {
        console.log(`‚ùå ${filePath} - Not accessible (${response.status})`);
      }
    } catch (error) {
      console.log(`‚ùå ${filePath} - Error: ${error.message}`);
    }
  });
  
  // Test Tesseract configuration
  console.log('\nTesseract Configuration:');
  console.log('OCR_LANGS:', OCR_LANGS);
  console.log('TESSDATA_URL (local):', TESSDATA_URL);
  console.log('TESSDATA_CDN (fallback):', TESSDATA_CDN);
  console.log('TESS_OPTS:', TESS_OPTS);
  
  alert('Check console for local trained data test results!');
}

// Test function for chalani field specifically
function testChalaniField() {
  console.log('üî¢ === TESTING CHALANI FIELD ===');
  
  // Check if field exists
  const chalaniField = document.getElementById('id_chalani_no');
  if (chalaniField) {
    console.log('‚úÖ Chalani field found:', chalaniField);
    console.log('Current value:', chalaniField.value);
    console.log('Field type:', chalaniField.type);
    console.log('Field name:', chalaniField.name);
    
    // Try to set a test value
    const testValue = '12345';
    chalaniField.value = testValue;
    console.log(`‚úÖ Set test value: ${testValue}`);
    console.log('New value:', chalaniField.value);
    
    alert(`Chalani field test successful! Set value: ${testValue}`);
  } else {
    console.log('‚ùå Chalani field not found');
    
    // Look for similar fields
    const similarFields = document.querySelectorAll('[id*="chalani"], [name*="chalani"], [id*="chalani_no"], [name*="chalani_no"]');
    console.log('Similar fields found:', similarFields);
    
    if (similarFields.length > 0) {
      console.log('Available similar fields:');
      similarFields.forEach((field, index) => {
        console.log(`  ${index + 1}. ID: ${field.id}, Name: ${field.name}, Type: ${field.type}`);
      });
    }
    
    alert('Chalani field not found! Check console for details.');
  }
}

function detectCurrency(str='') {
  const L = (str||'').toUpperCase();
  if (/\bKWD\b|\bKD\b|‡§ï‡•Å‡§µ‡•à‡§§‡•Ä|‡§¶‡§ø‡§®‡§æ‡§∞/.test(L)) return 'KWD';
  if (/\bAED\b|‡§Ø‡•Ç‡§è‡§à|‡§¶‡§ø‡§∞‡§π‡§Æ/.test(L)) return 'AED';
  if (/\bSAR\b|‡§∏‡§æ‡§â‡§¶‡•Ä|‡§∞‡§ø‡§Ø‡§æ‡§≤/.test(L)) return 'SAR';
  if (/\bQAR\b|‡§ï‡§§‡§æ‡§∞/.test(L)) return 'QAR';
  if (/\bOMR\b|‡§ì‡§Æ‡§æ‡§®‡•Ä/.test(L)) return 'OMR';
  if (/\bBHD\b|‡§¨‡§π‡§∞‡•á‡§®‡•Ä/.test(L)) return 'BHD';
  if (/\bUSD\b|‡§°[‡•ã‡•ã]‡§≤‡§∞|‡§°‡•â‡§≤‡§∞/.test(L)) return 'USD';
  if (/\bEUR\b|‡§Ø‡•Å‡§∞‡•ã/.test(L)) return 'EUR';
  if (/\bGBP\b|‡§™‡§æ‡§â‡§®‡•ç‡§°|‡§™‡§æ‡§â‡§£‡•ç‡§°/.test(L)) return 'GBP';
  if (/\bJPY\b|‡§Ø‡•á‡§®|‡§Ø‡•á‡§®‡•ç/.test(L)) return 'JPY';
  if (/\bNPR\b|‡§®‡•á\.?‡§∞‡•Å|‡§∞‡•Å\.?/.test(L)) return 'NPR';
  if (/\bKD\b/.test(L)) return 'KWD';
  return '';
}
/* === fill Step-2 main fields === */
function fillMainFieldsFromText(text) {
  // Map OCR labels to actual form field IDs
  const fieldMappings = {
    company: 'id_company_name',
    country: 'id_country', 
    city: 'id_city',
    chalani: 'id_chalani_no',
    lot: 'id_lot_no',
    predate: 'id_pre_approval_date',
    // Position-related fields use different naming convention
    position: 'positions-0-position',
    male_count: 'positions-0-male_count',
    female_count: 'positions-0-female_count',
    salary_amount: 'positions-0-salary_amount',
    salary_currency: 'positions-0-salary_currency',
    employee_count: 'positions-0-employee_count'
  };

  // Helper function to set field values
  const setField = (labelKey, value) => {
    const fieldId = fieldMappings[labelKey];
    if (!fieldId) return;
    
    console.log(`üîç Trying to set ${labelKey} = "${value}" in field ${fieldId}`);
    
    let field = null;
    
    // Try to find field by ID first
    field = document.getElementById(fieldId);
    
    // If not found by ID, try to find by name (for position fields)
    if (!field && fieldId.includes('positions-')) {
      field = document.querySelector(`[name="${fieldId}"]`);
    }
    
    // If still not found, try to find by partial name match
    if (!field && fieldId.includes('positions-')) {
      const fieldName = fieldId.split('-').pop(); // Get the last part (position, male_count, etc.)
      field = document.querySelector(`[name*="${fieldName}"]`);
    }
    
    if (field) {
      console.log(`‚úÖ Field found: ${fieldId}`);
      if (value) {
        field.value = value;
        console.log(`‚úÖ Set ${labelKey}: ${value} in field ${fieldId}`);
      } else {
        console.log(`‚ö†Ô∏è Value is empty for ${labelKey}`);
      }
    } else {
      console.log(`‚ùå Field not found: ${fieldId}`);
      // Try to find similar fields
      if (labelKey.includes('position') || labelKey.includes('male') || labelKey.includes('female') || labelKey.includes('salary')) {
        const similarFields = document.querySelectorAll('[name*="position"], [name*="male"], [name*="female"], [name*="salary"]');
        console.log('Similar position fields found:', similarFields);
      } else {
        const similarFields = document.querySelectorAll(`[id*="${labelKey}"], [name*="${labelKey}"]`);
        console.log('Similar fields found:', similarFields);
      }
    }
  };

                // Use specialized extraction for your employment letter format FIRST
              const specializedData = extractEmploymentLetterFormat(text);
              
              console.log('üìã === SPECIALIZED EXTRACTION RESULTS ===');
              console.log('Specialized extracted data:', specializedData);
              
              // Fallback to intelligent OCR extraction if specialized extraction doesn't find everything
              const intelligentData = intelligentOCRExtraction(text);
              
              console.log('üß† === INTELLIGENT EXTRACTION RESULTS ===');
              console.log('Intelligently extracted data:', intelligentData);
  
                // Set fields from specialized extraction FIRST (your format)
              if (specializedData.position) setField('position', specializedData.position);
              if (specializedData.maleCount) setField('male_count', specializedData.maleCount);
              if (specializedData.femaleCount) setField('female_count', specializedData.femaleCount);
              if (specializedData.salaryAmount) setField('salary_amount', specializedData.salaryAmount);
              if (specializedData.salaryCurrency) setField('salary_currency', specializedData.salaryCurrency);
              if (specializedData.employeeCount) setField('employee_count', specializedData.employeeCount);
              
              // Set fields from intelligent extraction (fallback)
              if (intelligentData.company) setField('company', intelligentData.company);
              if (intelligentData.country) setField('country', intelligentData.country);
              if (intelligentData.city) setField('city', intelligentData.city);
              if (intelligentData.chalani) setField('chalani', intelligentData.chalani);
              if (intelligentData.lot) setField('lot', intelligentData.lot);
              if (intelligentData.date) setField('predate', intelligentData.date);
  
  // Set position-related fields with detailed logging
  console.log('üîç === SETTING POSITION FIELDS ===');
  console.log('Available intelligent data:', intelligentData);
  
  if (intelligentData.position) {
    console.log('Setting position field:', intelligentData.position);
    setField('position', intelligentData.position);
  }
  if (intelligentData.maleCount) {
    console.log('Setting male_count field:', intelligentData.maleCount);
    setField('male_count', intelligentData.maleCount);
  }
  if (intelligentData.femaleCount) {
    console.log('Setting female_count field:', intelligentData.femaleCount);
    setField('female_count', intelligentData.femaleCount);
  }
  if (intelligentData.salaryAmount) {
    console.log('Setting salary_amount field:', intelligentData.salaryAmount);
    setField('salary_amount', intelligentData.salaryAmount);
  }
  if (intelligentData.salaryCurrency) {
    console.log('Setting salary_currency field:', intelligentData.salaryCurrency);
    setField('salary_currency', intelligentData.salaryCurrency);
  }
  if (intelligentData.employeeCount) {
    console.log('Setting employee_count field:', intelligentData.employeeCount);
    setField('employee_count', intelligentData.employeeCount);
  }
  
  // Fallback to general label extraction for any still missing fields
  if (!intelligentData.company) setField('company', findAfterLabel(text, LABELS.company));
  if (!intelligentData.country) setField('country', findAfterLabel(text, LABELS.country));
  if (!intelligentData.city) setField('city', findAfterLabel(text, LABELS.city));
  if (!intelligentData.chalani) setField('chalani', findAfterLabel(text, LABELS.chalani));
  if (!intelligentData.lot) setField('lot', findAfterLabel(text, LABELS.lot));
  if (!intelligentData.date) setField('predate', findAfterLabel(text, LABELS.predate));
}

/* === fill first position row in Step-3 === */
function fillPositionFromText(text) {
  // Helper function to find and set position form fields
  const setPositionField = (fieldName, value) => {
    // Try multiple selectors to find the field
    const selectors = [
      `[name*="${fieldName}"]`,
      `[name*="positions-0-${fieldName}"]`,
      `input[name*="${fieldName}"]`,
      `select[name*="${fieldName}"]`
    ];
    
    let field = null;
    for (const selector of selectors) {
      field = document.querySelector(selector);
      if (field) break;
    }
    
    if (field && value !== '') {
      field.value = value;
      console.log(`‚úÖ Set position ${fieldName}: ${value}`);
    } else {
      console.log(`‚ùå Could not set position ${fieldName}: ${value} - field not found`);
    }
  };

  // Extract values from OCR text
  const posLine = findAfterLabel(text, LABELS.position);
  const maleLine = findAfterLabel(text, LABELS.male);
  const femaleLine = findAfterLabel(text, LABELS.female);
  const salLine = findAfterLabel(text, LABELS.salary);

  // Set position fields
  setPositionField('position', posLine);
  setPositionField('male_count', firstNumber(maleLine));
  setPositionField('female_count', firstNumber(femaleLine));

  // Handle salary and currency
  const amt = firstNumber(salLine);
  const cur = detectCurrency(salLine) || detectCurrency(text);
  
  setPositionField('salary_amount', amt);
  if (cur) setPositionField('salary_currency', cur);
}

/* === intercept Step-1 form to run OCR in browser === */
function setupOCRForm() {
  const ocrForm = document.getElementById('ocrForm');
  const fileInput = document.getElementById('id_document');
  if (ocrForm && fileInput) {
    ocrForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = fileInput.files?.[0];
      if (!file) return alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡§æ‡§á‡§≤ ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§');
      if (file.type === 'application/pdf') return alert('‡§™‡§π‡§ø‡§≤‡•á JPG/PNG ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§');

      try {
        document.getElementById('ocrClientBox').style.display = 'block';
        document.getElementById('ocrPreview').textContent = '‡§≤‡•ã‡§° ‡§π‡•Å‡§Å‡§¶‡•à...';

        const prepped = await preprocessImage(file);
        const { data } = await Tesseract.recognize(prepped, OCR_LANGS, TESS_OPTS);
        const text = normalizeText((data.text || '').trim());
        document.getElementById('ocrPreview').textContent = text || '(‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§≠‡•á‡§ü‡§ø‡§è‡§®)';

        // ‚úÖ NEW: parse ‚Üí fill forms ‚Üí jump to Step 2
        const parsed = parseFromOCR(text);
        applyParsedData(parsed);
        goToStep(2);
        alert('‚úÖ OCR ‡§™‡•Ç‡§∞‡§æ ‡§≠‡§Ø‡•ã (trained data ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ó‡§∞‡•Ä)!\n\n‡§≠‡§∞‡•á‡§ï‡§æ ‡§´‡§ø‡§≤‡•ç‡§° ‡§ú‡§æ‡§Å‡§ö ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§');
      } catch (err) {
        console.error(err);
        alert('OCR ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + (err.message || err));
      }
    });
  }
}

// Debug function to show what fields are available and what values are extracted
function debugOCRResults(text) {
  console.log('üîç === OCR DEBUG RESULTS ===');
  console.log('Raw OCR text:', text);
  
  // Test each label pattern
  Object.entries(LABELS).forEach(([key, patterns]) => {
    const value = findAfterLabel(text, patterns);
    console.log(`${key}: "${value}" (patterns: ${patterns.map(p => p.source).join(', ')})`);
  });
  
  // Show available form fields
  console.log('üîç === AVAILABLE FORM FIELDS ===');
  const mainFields = ['company_name', 'country', 'city', 'chalani_no', 'lot_no', 'pre_approval_date'];
  mainFields.forEach(fieldId => {
    const field = document.getElementById(`id_${fieldId}`);
    if (field) {
      console.log(`‚úÖ Found: id_${fieldId} (${field.type})`);
    } else {
      console.log(`‚ùå Missing: id_${fieldId}`);
    }
  });
  
  // Show position fields
  console.log('üîç === POSITION FORM FIELDS ===');
  const positionFields = ['position', 'male_count', 'female_count', 'salary_amount', 'salary_currency'];
  positionFields.forEach(fieldName => {
    const field = document.querySelector(`[name*="${fieldName}"]`);
    if (field) {
      console.log(`‚úÖ Found: ${fieldName} (${field.name})`);
    } else {
      console.log(`‚ùå Missing: ${fieldName}`);
    }
  });
}

/* ==== END BROWSER OCR BLOCK ==== */

/* ====== currency display helpers (no fixed rates needed for OCR) ======
   You already have salary conversion logic. Leaving rates as-is is fine,
   because OCR task here only DETECTS the currency and fills the select.
====================================================================== */

// simple NPR formatting if you still want the preview calc
const exchangeRates = {
  'KD': 378.51, 'USD': 133.45, 'EUR': 145.67, 'GBP': 170.23,
  'SAR': 35.58, 'AED': 36.34, 'QAR': 36.67, 'OMR': 346.78,
  'BHD': 353.45, 'KWD': 378.51, 'NPR': 1.00, 'JPY': 0.92
};

function convertToNPR(amount, currency) {
  if (!amount || !currency || !exchangeRates[currency]) return '';
  const rate = exchangeRates[currency];
  const converted = parseFloat(amount) * rate;
  return formatNepaliCurrency(converted);
}
function formatNepaliCurrency(amount) {
  if (isNaN(amount)) return '';
  const nep = ['‡•¶','‡•ß','‡•®','‡•©','‡•™','‡•´','‡•¨','‡•≠','‡•Æ','‡•Ø'];
  const numStr = Math.round(amount).toString();
  let out = '';
  for (const ch of numStr) out += /\d/.test(ch) ? nep[+ch] : ch;
  return `${out}/-`;
}
function handleSalaryConversion(formElement) {
    const salaryAmount = formElement.querySelector('[name*="salary_amount"]');
    const salaryCurrency = formElement.querySelector('[name*="salary_currency"]');
    const salaryNPR = formElement.querySelector('[name*="salary_npr"]');
    if (salaryAmount && salaryCurrency && salaryNPR) {
    const nprAmount = convertToNPR(salaryAmount.value, salaryCurrency.value);
    if (nprAmount) salaryNPR.value = nprAmount;
  }
}

/* ===== interview preview & date listeners (IDs fixed) ===== */
function updateInterviewPreview() {
  const nepaliDate = document.getElementById('id_interview_nepali_date')?.value || '';
  const gregorianDate = document.getElementById('id_interview_gregorian_date')?.value || '';
  const location = document.getElementById('id_interview_location')?.value || '';
  let previewText = '‡§Ö‡§®‡•ç‡§§‡§∞‡§µ‡§æ‡§∞‡•ç‡§§‡§æ ';
  if (nepaliDate) previewText += `‡§Æ‡§ø‡§§‡§ø ${nepaliDate} `;
  if (gregorianDate) previewText += `(${gregorianDate}) `;
  if (location) previewText += `${location} ‡§π‡•Å‡§®‡•á‡§õ‡•§`;
  const out = document.getElementById('interview_preview');
  if (out) out.textContent = previewText;
}

// rough converters (optional)
function convertNepaliToGregorian(nepaliDate) {
  const parts = (nepaliDate || '').split('/');
  if (parts.length !== 3) return '';
  const gy = parseInt(parts[0],10) - 57;
  return `${gy}-${parts[1]}-${parts[2]}`;
}
function convertGregorianToNepali(gregorianDate) {
  const parts = (gregorianDate || '').split('-');
  if (parts.length !== 3) return '';
  const ny = parseInt(parts[0],10) + 57;
  return `${ny}/${parts[1]}/${parts[2]}`;
}
function setupDateConversion() {
  const nep = document.getElementById('id_interview_nepali_date');
  const gre = document.getElementById('id_interview_gregorian_date');
  if (nep && gre) {
    nep.addEventListener('input', function() {
      if (this.value.includes('/')) gre.value = convertNepaliToGregorian(this.value);
      updateInterviewPreview();
    });
    gre.addEventListener('input', function() {
      if (this.value.includes('-')) nep.value = convertGregorianToNepali(this.value);
      updateInterviewPreview();
    });
  }
}

/* ===== small helpers you already had (kept) ===== */
function convertToNepaliNumbers(input) {
  const map = {'0':'‡•¶','1':'‡•ß','2':'‡•®','3':'‡•©','4':'‡•™','5':'‡•´','6':'‡•¨','7':'‡•≠','8':'‡•Æ','9':'‡•Ø'};
  if (!input) return input;
  const first = input.charAt(0);
  return map[first] ? map[first] + input.slice(1) : input;
}
function setupNumberConversion() {
  const nodes = document.querySelectorAll('input[name*="male_count"], input[name*="female_count"], input[name*="hours_per_day"], input[name*="days_per_week"]');
  nodes.forEach(field => {
    field.addEventListener('input', function() {
      if (/^\d+$/.test(this.value)) this.value = convertToNepaliNumbers(this.value);
    });
  });
}

// apply client-side OCR data (new function)
function applyClientOCRData() {
  // Check if we have OCR preview text
  const ocrPreview = document.getElementById('ocrPreview');
  if (!ocrPreview || !ocrPreview.textContent || ocrPreview.textContent === '(‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§≠‡•á‡§ü‡§ø‡§è‡§®)') {
    alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§ø‡§≤‡•á OCR ‡§ö‡§≤‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç ‡§∞ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§®‡§ø‡§ï‡§æ‡§≤‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§');
    return;
  }
  
  const text = ocrPreview.textContent;
  
  // Fill forms from OCR text
  fillMainFieldsFromText(text);
  fillPositionFromText(text);
  
  // Auto-convert salary if available
  const firstForm = document.querySelector('.position-form');
  if (firstForm) handleSalaryConversion(firstForm);
  
  // Move to Step 2
  goToStep(2);
  alert('‚úÖ OCR ‡§°‡§æ‡§ü‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡§æ‡§ó‡•Ç ‡§ó‡§∞‡§ø‡§Ø‡•ã! ‡§Ö‡§¨ ‡§§‡§™‡§æ‡§à‡§Ç‡§≤‡•á ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ö‡§∞‡§£‡§Æ‡§æ ‡§ú‡§æ‡§® ‡§∏‡§ï‡•ç‡§®‡•Å‡§π‡•Å‡§®‡•ç‡§õ‡•§');
}

// apply parsed table data (server OCR path) ‚Äî unchanged
function applyOCRData() {
  const parsedData = {};
  const rows = document.querySelectorAll('#step1 .table tbody tr');
  rows.forEach(row => {
    const tds = row.querySelectorAll('td');
    if (tds.length < 2) return;
    const field = tds[0].textContent.trim();
    const value = tds[1].textContent.trim();
    const map = {
      '‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§ï‡•ã ‡§®‡§æ‡§Æ':'company_name','‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø ‡§Æ‡§ø‡§§‡§ø':'pre_approval_date','‡§ö‡§≤‡§æ‡§®‡•Ä ‡§®‡§Ç.':'chalani_no','LOT ‡§®‡§Ç.':'lot_no',
      '‡§∂‡§π‡§∞':'city','‡§¶‡•á‡§∂':'country','‡§™‡§¶':'position','‡§™‡•Å‡§∞‡•Å‡§∑ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ':'male_count','‡§Æ‡§π‡§ø‡§≤‡§æ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ':'female_count',
      '‡§§‡§≤‡§¨ ‡§∞‡§ï‡§Æ':'salary_amount','‡§Æ‡•Å‡§¶‡•ç‡§∞‡§æ':'salary_currency','‡§ì‡§≠‡§∞ ‡§ü‡§æ‡§á‡§Æ':'overtime','‡§ò‡§£‡•ç‡§ü‡§æ/‡§¶‡§ø‡§®':'hours_per_day',
      '‡§¶‡§ø‡§®/‡§π‡§™‡•ç‡§§‡§æ':'days_per_week','‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§µ‡§ø‡§¶‡§æ':'yearly_leave','‡§∂‡•à‡§ï‡•ç‡§∑‡§ø‡§ï ‡§Ø‡•ã‡§ó‡•ç‡§Ø‡§§‡§æ':'min_qualification',
      '‡§ñ‡§æ‡§®‡§æ':'food_provided','‡§¨‡§∏‡•ã‡§¨‡§æ‡§∏':'housing_provided','‡§ï‡§∞‡§æ‡§∞ ‡§Ö‡§µ‡§ß‡§ø':'contract_duration'
    };
    const key = map[field];
    if (key && value !== '‡§™‡§æ‡§á‡§è‡§®') parsedData[key] = value;
  });

  const setId = (id,val)=>{ const el=document.getElementById('id_'+id); if(el && val) el.value=val; };
  setId('company_name', parsedData.company_name);
  setId('pre_approval_date', parsedData.pre_approval_date);
  setId('chalani_no', parsedData.chalani_no);
  setId('lot_no', parsedData.lot_no);
  setId('city', parsedData.city);
  setId('country', parsedData.country);

  const setName = (name,val)=>{
    const el = document.querySelector(`[name*="${name}"]`);
    if (el && val) el.value = val;
  };
  ['position','male_count','female_count','salary_amount','salary_currency','overtime','hours_per_day','days_per_week','yearly_leave','min_qualification','food_provided','housing_provided','contract_duration']
    .forEach(k => setName(k, parsedData[k]));

  const firstForm = document.querySelector('.position-form');
  if (firstForm && (parsedData.salary_amount || parsedData.salary_currency)) handleSalaryConversion(firstForm);

  alert('OCR ‡§°‡§æ‡§ü‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡§æ‡§ó‡•Ç ‡§ó‡§∞‡§ø‡§Ø‡•ã! ‡§Ö‡§¨ ‡§§‡§™‡§æ‡§à‡§Ç‡§≤‡•á ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ö‡§∞‡§£‡§Æ‡§æ ‡§ú‡§æ‡§® ‡§∏‡§ï‡•ç‡§®‡•Å‡§π‡•Å‡§®‡•ç‡§õ‡•§');
  goToStep(2);
}

/* ===== stepper / validation (unchanged) ===== */
function goToStep(step) {
  if (!validateCurrentStep()) return;
  currentStep = step; updateProgress();
  document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('show','active'));
  const target = document.getElementById(`step${step}`);
  if (target) target.classList.add('show','active');
  document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
  const nav = document.getElementById(`step${step}-tab`);
  if (nav) nav.classList.add('active');
  document.getElementById('progressBar').style.width = (step/totalSteps*100) + '%';
}
function validateCurrentStep() {
  const cur = document.querySelector('.tab-pane.active');
  if (!cur) return true;
  const id = cur.id;
  if (id === 'step2') {
    const required = ['id_company_name','id_country','id_pre_approval_date','id_chalani_no','id_lot_no','id_city'];
    const missing = [];
    required.forEach(fid=>{
      const f = document.getElementById(fid);
      if (f && !f.value.trim()) missing.push(f.previousElementSibling?.textContent || fid);
    });
    if (missing.length) { alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ø‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§´‡§ø‡§≤‡•ç‡§°‡§π‡§∞‡•Ç ‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç:\n' + missing.join('\n')); return false; }
  } else if (id === 'step3') {
    const forms = document.querySelectorAll('.position-form');
    if (!forms.length) { alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§Æ‡•ç‡§§‡§ø‡§Æ‡§æ ‡§è‡§â‡§ü‡§æ ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞‡§ï‡•ã ‡§™‡§¶ ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§'); return false; }
    let ok = false;
    forms.forEach(f=>{
      const pos = f.querySelector('input[name*="position"]')?.value.trim();
      const male = f.querySelector('input[name*="male_count"]')?.value.trim();
      const female = f.querySelector('input[name*="female_count"]')?.value.trim();
      const sal = f.querySelector('input[name*="salary_amount"]')?.value.trim();
      if (pos && (male || female) && sal) ok = true;
    });
    if (!ok) { alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§Æ‡•ç‡§§‡§ø‡§Æ‡§æ ‡§è‡§â‡§ü‡§æ ‡§™‡§¶‡§ï‡•ã ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§'); return false; }
  }
  return true;
}
function updateProgress() {
  document.getElementById('progressBar').style.width = (currentStep/totalSteps*100) + '%';
}

/* ===== add/remove positions & other utilities (unchanged from your version) ===== */
function addPosition() {
  const container = document.getElementById('positionsContainer');
  const firstForm = container?.querySelector('.position-form');
  if (!container || !firstForm) return;

  const count = container.querySelectorAll('.position-form').length;
  const totalFormsField = document.querySelector('[name*="TOTAL_FORMS"]');
  const initialFormsField = document.querySelector('[name*="INITIAL_FORMS"]');

  const newForm = firstForm.cloneNode(true);
  newForm.dataset.formIndex = count;
  const title = newForm.querySelector('h6'); if (title) title.textContent = `‡§™‡§¶ #${count + 1}`;

  newForm.querySelectorAll('input, select, textarea, label[for]').forEach(node => {
    const attr = node.name ? 'name' : (node.id ? 'id' : (node.getAttribute && node.getAttribute('for') ? 'for' : null));
    if (!attr) return;
    const val = node[attr];
    const m = val && val.match(/positions-(\d+)-/);
    if (m) {
      const rep = val.replace(`positions-${m[1]}-`, `positions-${count}-`);
      if (node.name) node.name = rep;
      else if (node.id) node.id = rep;
      else node.setAttribute('for', rep);
    }
    if (node.tagName === 'INPUT' || node.tagName === 'TEXTAREA') {
      if (node.type !== 'hidden') node.value = '';
    }
    if (node.tagName === 'SELECT') node.value = '';
  });

  const header = newForm.querySelector('.d-flex.justify-content-between');
  if (header) {
    header.querySelector('.btn-danger')?.remove();
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-danger btn-sm';
    removeBtn.onclick = function(){ removePosition(this); };
    removeBtn.innerHTML = 'üóëÔ∏è ‡§π‡§ü‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç';
    header.appendChild(removeBtn);
  }

  container.appendChild(newForm);
  if (totalFormsField) totalFormsField.value = count + 1;
  if (initialFormsField) initialFormsField.value = '0';
  addCurrencyConversionListeners(newForm);
}
function removePosition(button) {
  const form = button.closest('.position-form');
  if (!form) return;
  form.remove();

  const container = document.getElementById('positionsContainer');
  const forms = container.querySelectorAll('.position-form');
  forms.forEach((f, i) => {
    f.dataset.formIndex = i;
    const h = f.querySelector('h6'); if (h) h.textContent = `‡§™‡§¶ #${i + 1}`;
    f.querySelectorAll('input, select, textarea, label[for]').forEach(node => {
      const attr = node.name ? 'name' : (node.id ? 'id' : (node.getAttribute && node.getAttribute('for') ? 'for' : null));
      if (!attr) return;
      const val = node[attr];
      const m = val && val.match(/positions-(\d+)-/);
      if (m) {
        const rep = val.replace(`positions-${m[1]}-`, `positions-${i}-`);
        if (node.name) node.name = rep;
        else if (node.id) node.id = rep;
        else node.setAttribute('for', rep);
      }
    });
  });

  const totalFormsField = container.querySelector('[name*="TOTAL_FORMS"]');
  const initialFormsField = container.querySelector('[name*="INITIAL_FORMS"]');
  if (totalFormsField) totalFormsField.value = forms.length;
  if (initialFormsField) initialFormsField.value = '0';
}
function addCurrencyConversionListeners(formElement) {
  const salaryAmount = formElement.querySelector('[name*="salary_amount"]');
  const salaryCurrency = formElement.querySelector('[name*="salary_currency"]');
  if (salaryAmount)  salaryAmount.addEventListener('input', () => handleSalaryConversion(formElement));
  if (salaryCurrency) salaryCurrency.addEventListener('change', () => handleSalaryConversion(formElement));
}
async function updateCurrencyRates() {
  try {
    const res = await fetch('/update-currency-rates/', {
      method: 'POST',
      headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value}
    });
    if (res.ok) {
      const data = await res.json();
      if (data.success) location.reload();
    }
  } catch(e) { console.error(e); }
}

/* ===== on load ===== */
// Global setup tracking to prevent duplicates
const setupTracker = {
  isComplete: false,
  functions: new Set(),
  elements: new Set(),
  eventListeners: new Map() // Track event listeners by element + event type
};

// Function to safely add event listener only once
function addEventListenerOnce(element, event, handler, options) {
  if (!element) return;
  
  // Create a unique key for this element + event combination
  const key = `${element.id || element.name || 'unknown'}_${event}`;
  
  // Check if we already added this exact event listener
  if (setupTracker.eventListeners.has(key)) {
    console.log(`‚ö†Ô∏è Event listener already exists: ${event} on ${element.id || element.name || 'unknown'}`);
    return;
  }
  
  // Add the event listener
  element.addEventListener(event, handler, options);
  setupTracker.eventListeners.set(key, true);
  setupTracker.elements.add(element);
  console.log(`‚úÖ Event listener added: ${event} on ${element.id || element.name || 'unknown'}`);
}

// Function to safely setup a function only once
function setupFunctionOnce(funcName, setupFunc) {
  if (setupTracker.functions.has(funcName)) {
    console.log(`‚ö†Ô∏è Function ${funcName} already set up, skipping...`);
    return;
  }
  
  setupFunc();
  setupTracker.functions.add(funcName);
  console.log(`‚úÖ Function ${funcName} set up successfully`);
}

// Prevent multiple DOMContentLoaded listeners
if (window.rajdhaniSetupComplete) {
  console.log('‚ö†Ô∏è Rajdhani setup already completed, skipping...');
} else {
  document.addEventListener('DOMContentLoaded', function() {
    // Prevent duplicate setup
    if (setupTracker.isComplete) {
      console.log('‚ö†Ô∏è Setup already completed, skipping...');
      return;
    }
    
    console.log('üîÑ DOMContentLoaded event triggered - SINGLE LISTENER');
    
    // Setup all functions in the correct order with duplicate prevention
    console.log('üîÑ Setting up all functions with duplicate prevention...');
    
    // 1. Setup OCR form
    setupFunctionOnce('OCRForm', setupOCRForm);
    
    // 2. Setup progress and currency conversion
    setupFunctionOnce('ProgressAndCurrency', setupProgressAndCurrency);
    
    // 3. Setup automatic interview date
    setupFunctionOnce('AutomaticInterviewDate', setupAutomaticInterviewDate);
    
    // 4. Setup country dropdown
    setupFunctionOnce('CountryDropdown', setupCountryDropdown);
    
    // 5. Setup logo preview
    setupFunctionOnce('LogoPreview', setupLogoPreview);
    
    // 6. Setup interview preview listeners (only once)
    ['id_interview_nepali_date','id_interview_gregorian_date','id_interview_location']
      .forEach(id => { 
        const el = document.getElementById(id); 
        if (el) addEventListenerOnce(el, 'input', updateInterviewPreview); 
      });
    
    // Mark setup as complete
    setupTracker.isComplete = true;
    window.rajdhaniSetupComplete = true;
    console.log('‚úÖ All setup functions called from single DOMContentLoaded listener with duplicate prevention');
  });
}

/* ===== your remaining helpers (unchanged) ===== */
function setupLogoPreview() {
  const logoUpload = document.getElementById('logo-upload');
  const logoPreview = document.getElementById('logo-preview');
  const logoText = document.getElementById('id_company_logo_text');
  
  if (logoUpload) {
    // Use our safe event listener function to prevent duplicates
    addEventListenerOnce(logoUpload, 'change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) return alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§â‡§ü‡§æ ‡§á‡§Æ‡•á‡§ú ‡§´‡§æ‡§á‡§≤ ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§');
      if (file.size > 2*1024*1024) return alert('‡§´‡§æ‡§á‡§≤ ‡§∏‡§æ‡§á‡§ú 2MB ‡§≠‡§®‡•ç‡§¶‡§æ ‡§†‡•Ç‡§≤‡•ã ‡§π‡•Å‡§®‡•Å‡§π‡•Å‡§Å‡§¶‡•à‡§®‡•§');
      const reader = new FileReader();
      reader.onload = e => { logoPreview.innerHTML = `<img src="${e.target.result}" alt="Company Logo" class="preview-logo">`; };
      reader.readAsDataURL(file);
    });
  }
  
  if (logoText) {
    // Use our safe event listener function to prevent duplicates
    addEventListenerOnce(logoText, 'input', function() {
      if (!logoUpload?.files.length) logoPreview.innerHTML = `<div class="logo-placeholder">${this.value || 'LOGO'}</div>`;
    });
  }
}
function calculateInterviewDate() {
  const pre = document.getElementById('id_pre_approval_date')?.value;
  if (!pre) return alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§ø‡§≤‡•á ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø ‡§Æ‡§ø‡§§‡§ø ‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§');
  try {
    const d = new Date(pre); d.setDate(d.getDate()+8);
    const nep = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
    const eng = d.toLocaleDateString('en-US', { day:'numeric', month:'long', year:'numeric' });
    document.getElementById('id_interview_nepali_date').value = nep;
    document.getElementById('id_interview_gregorian_date').value = eng;
    document.getElementById('preview_nepali_date').textContent = nep;
    document.getElementById('preview_gregorian_date').textContent = eng;
    alert(`‡§∏‡•ç‡§µ‡§ö‡§æ‡§≤‡§ø‡§§ ‡§Æ‡§ø‡§§‡§ø ‡§ó‡§£‡§®‡§æ ‡§∏‡§´‡§≤: ${nep} (${eng})`);
  } catch { alert('‡§Æ‡§ø‡§§‡§ø ‡§ó‡§£‡§®‡§æ‡§Æ‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§≠‡§Ø‡•ã‡•§ YYYY-MM-DD ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§'); }
}
function setupCountryNoticePreview() {
  const countryField = document.getElementById('id_country');
  const extraNotesField = document.getElementById('id_extra_notes');
  const previewDiv = document.getElementById('countryNoticePreview');
  const previewText = document.getElementById('noticePreviewText');
  if (!(countryField && extraNotesField && previewDiv && previewText)) return;
  const update = () => {
    const country = (countryField.value||'').trim().toLowerCase();
    const hasCustom = (extraNotesField.value||'').trim();
    if (!country || hasCustom) { previewDiv.style.display = 'none'; return; }
    let notice = '';
    if (['kuwait','uae','saudi','qatar','oman','bahrain','jordan','lebanon','iraq','iran','syria','yemen'].some(c => country.includes(c))) notice = '‡§¨‡•à‡§¶‡•á‡§∂‡§ø‡§ï ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§¨‡§ø‡§≠‡§æ‡§ó‡§¨‡§æ‡§ü ‡§ó‡§∞‡§æ‡§á‡§è‡§ï‡•ã ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä (‡§Æ‡§ß‡•ç‡§Ø ‡§™‡•Ç‡§∞‡•ç‡§µ‡•Ä ‡§¶‡•á‡§∂‡§π‡§∞‡•Ç‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø)';
    else if (country.includes('japan')) notice = '‡§™‡•ç‡§∞‡§∂‡§ø‡§ï‡•ç‡§∑‡§æ‡§∞‡•ç‡§•‡•Ä‡§ï‡•ã ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡§Æ ‡§Ø‡•ã‡§ó‡•ç‡§Ø‡§§‡§æ ‡§∞ ‡§ï‡§æ‡§Æ ‡§ó‡§∞‡•á‡§ï‡•ã ‡§Ö‡§®‡•Å‡§≠‡§µ (‡§ú‡§æ‡§™‡§æ‡§®‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø)';
    else notice = '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§∏‡•Ç‡§ö‡§®‡§æ (‡§Ö‡§®‡•ç‡§Ø ‡§¶‡•á‡§∂‡§π‡§∞‡•Ç‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø)';
    previewText.textContent = notice;
    previewDiv.style.display = 'block';
    updateCurrencyBasedOnCountry(country);
  };
  countryField.addEventListener('input', update);
  extraNotesField.addEventListener('input', update);
  update();
}
function updateCurrencyBasedOnCountry(country) {
  const fields = document.querySelectorAll('[name*="salary_currency"]');
  if (!fields.length) return;
  let def = 'KWD';
  if (country.includes('kuwait')) def = 'KWD';
  else if (country.includes('uae')) def = 'AED';
  else if (country.includes('saudi')) def = 'SAR';
  else if (country.includes('qatar')) def = 'QAR';
  else if (country.includes('oman')) def = 'OMR';
  else if (country.includes('bahrain')) def = 'BHD';
  else if (country.includes('japan')) def = 'JPY';
  else if (country.includes('usa') || country.includes('united states')) def = 'USD';
  else if (country.includes('europe') || country.includes('eu')) def = 'EUR';
  else if (country.includes('uk') || country.includes('united kingdom')) def = 'GBP';
  fields.forEach(f => { if (!f.value || f.value === 'KD') f.value = def; });
}

/* === forms submit (same as yours) === */
document.getElementById('mainForm')?.addEventListener('submit', function(e){
  e.preventDefault();
  if (!validateCurrentStep()) return;
  const formData = new FormData(this);
  fetch(window.location.href, { method:'POST', body:formData, headers:{'X-Requested-With':'XMLHttpRequest'} })
    .then(r => r.json()).then(d => { if (d.success){ alert('‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡•á‡§≠ ‡§ó‡§∞‡§ø‡§Ø‡•ã!'); goToStep(3);} else alert('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: '+d.error); })
    .catch(err => { console.error(err); alert('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§≠‡§Ø‡•ã‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§'); });
});
document.getElementById('positionForm')?.addEventListener('submit', function(e){
  e.preventDefault();
  if (!validateCurrentStep()) return;
  const formData = new FormData(this);
  fetch(window.location.href, { method:'POST', body:formData, headers:{'X-Requested-With':'XMLHttpRequest'} })
    .then(r => r.json()).then(d => { if (d.success){ alert('‡§™‡§¶‡§π‡§∞‡•Ç ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡•á‡§≠ ‡§ó‡§∞‡§ø‡§Ø‡•ã!'); goToStep(4);} else alert('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: '+d.error); })
    .catch(err => { console.error(err); alert('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§≠‡§Ø‡•ã‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§'); });
});

console.log('=== JAVASCRIPT LOADED ===');









// Function to update interview preview
function updateInterviewPreview() {
    const nepaliDate = document.getElementById('id_nepali_date').value;
    const gregorianDate = document.getElementById('id_gregorian_date').value;
    const location = document.getElementById('id_interview_location').value;
    
    let previewText = '‡§Ö‡§®‡•ç‡§§‡§∞‡§µ‡§æ‡§∞‡•ç‡§§‡§æ ';
    if (nepaliDate) previewText += `‡§Æ‡§ø‡§§‡§ø ${nepaliDate} `;
    if (gregorianDate) previewText += `(${gregorianDate}) `;
    if (location) previewText += `${location} ‡§π‡•Å‡§®‡•á‡§õ‡•§`;
    
    document.getElementById('interview_preview').textContent = previewText;
}

// Auto-convert between Nepali and Gregorian dates
function convertNepaliToGregorian(nepaliDate) {
    // Simple conversion - you can enhance this with proper Nepali calendar logic
    const nepaliYear = parseInt(nepaliDate.split('/')[0]);
    const gregorianYear = nepaliYear - 57; // Approximate conversion
    return `${gregorianYear}-${nepaliDate.split('/')[1]}-${nepaliDate.split('/')[2]}`;
}

function convertGregorianToNepali(gregorianDate) {
    // Simple conversion - you can enhance this with proper Nepali calendar logic
    const gregorianYear = parseInt(gregorianDate.split('-')[0]);
    const nepaliYear = gregorianYear + 57; // Approximate conversion
    return `${nepaliYear}/${gregorianDate.split('-')[1]}/${gregorianDate.split('-')[2]}`;
}





// Country dropdown functionality - show/hide manual input for "Other" and auto-generate title
function setupCountryDropdown() {
    const countryField = document.getElementById('id_country');
    const otherCountryField = document.getElementById('otherCountryField');
    const otherCountryInput = document.getElementById('id_other_country');
    const titleField = document.getElementById('id_title');
    
    if (countryField && otherCountryField && otherCountryInput) {
        // Use our safe event listener function to prevent duplicates
        addEventListenerOnce(countryField, 'change', function() {
            if (this.value === 'Other') {
                otherCountryField.style.display = 'block';
                otherCountryInput.required = true;
                otherCountryInput.focus();
                
                // For "Other" country, set a generic title
                if (titleField) {
                    titleField.value = '‡§µ‡§ø‡§¶‡•á‡§∂‡§Æ‡§æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡•Ä';
                    titleField.dispatchEvent(new Event('input', { bubbles: true }));
                    titleField.dispatchEvent(new Event('change', { bubbles: true }));
                }
            } else {
                otherCountryField.style.display = 'none';
                otherCountryInput.required = false;
                otherCountryInput.value = '';
                
                // Auto-generate title based on country selection
                generateTitleFromCountry(this.value, titleField);
            }
        });
        
        // Also handle on page load if "Other" is pre-selected
        if (countryField.value === 'Other') {
            otherCountryField.style.display = 'block';
            otherCountryInput.required = true;
        }
        
        // Generate title on page load if country is already selected
        if (countryField.value && countryField.value !== 'Other') {
            generateTitleFromCountry(countryField.value, titleField);
        }
        
        // Add listener for custom country input to update title
        if (otherCountryInput) {
            addEventListenerOnce(otherCountryInput, 'input', function() {
                if (this.value.trim()) {
                    const customTitle = `${this.value.trim()}‡§Æ‡§æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡•Ä`;
                    if (titleField) {
                        titleField.value = customTitle;
                        titleField.dispatchEvent(new Event('input', { bubbles: true }));
                        titleField.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            });
        }
    }
}

// Function to generate title based on country
function generateTitleFromCountry(country, titleField) {
    if (!titleField) return;
    
    let title = '';
    switch (country) {
        case 'Japan':
            title = '‡§ú‡§æ‡§™‡§æ‡§®‡§Æ‡§æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡•Ä';
            break;
        case 'UAE':
            title = '‡§Ø‡•Ç‡§è‡§à‡§Æ‡§æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡•Ä';
            break;
        case 'Kuwait':
            title = '‡§ï‡•Å‡§µ‡•á‡§§‡§Æ‡§æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡•Ä';
            break;
        case 'Qatar':
            title = '‡§ï‡§§‡§æ‡§∞‡§Æ‡§æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡•Ä';
            break;
        case 'Saudi Arabia':
            title = '‡§∏‡§æ‡§â‡§¶‡•Ä ‡§Ö‡§∞‡•á‡§¨‡§ø‡§Ø‡§æ‡§Æ‡§æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡•Ä';
            break;
        case 'Oman':
            title = '‡§ì‡§Æ‡§æ‡§®‡§Æ‡§æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡•Ä';
            break;
        case 'Bahrain':
            title = '‡§¨‡§π‡§∞‡•á‡§®‡§Æ‡§æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡•Ä';
            break;
        case 'Malaysia':
            title = '‡§Æ‡§≤‡•á‡§∏‡§ø‡§Ø‡§æ‡§Æ‡§æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡•Ä';
            break;
        case 'Singapore':
            title = '‡§∏‡§ø‡§ô‡•ç‡§ó‡§æ‡§™‡•Å‡§∞‡§Æ‡§æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡•Ä';
            break;
        case 'South Korea':
            title = '‡§¶‡§ï‡•ç‡§∑‡§ø‡§£ ‡§ï‡•ã‡§∞‡§ø‡§Ø‡§æ‡§Æ‡§æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡•Ä';
            break;
        default:
            title = '‡§µ‡§ø‡§¶‡•á‡§∂‡§Æ‡§æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡•Ä';
            break;
    }
    
    // Only set the title if it's empty or if user hasn't manually typed something
    if (!titleField.value.trim() || titleField.value.trim() === '‡§ú‡§æ‡§™‡§æ‡§®‡§Æ‡§æ ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞‡•Ä') {
        titleField.value = title;
        titleField.dispatchEvent(new Event('input', { bubbles: true }));
        titleField.dispatchEvent(new Event('change', { bubbles: true }));
    }
}

// Automatic interview date calculation (8 days after approval date)
function setupAutomaticInterviewDate() {
    console.log('üîÑ setupAutomaticInterviewDate called');
    
    const approvalDateField = document.getElementById('id_pre_approval_date');
    const nepaliDateField = document.getElementById('id_interview_nepali_date');
    const gregorianDateField = document.getElementById('id_interview_gregorian_date');
    const previewNepali = document.getElementById('preview_nepali_date');
    const previewGregorian = document.getElementById('preview_gregorian_date');
    
    console.log('üìÖ Field references:', {
        approvalDateField: approvalDateField,
        nepaliDateField: nepaliDateField,
        gregorianDateField: gregorianDateField,
        previewNepali: previewNepali,
        previewGregorian: previewGregorian
    });
    
    if (approvalDateField && nepaliDateField && gregorianDateField) {
        console.log('‚úÖ All fields found, setting up event listeners');
        
        // Use our safe event listener function to prevent duplicates
        addEventListenerOnce(approvalDateField, 'input', function() {
            console.log('üìÖ Approval date input event triggered with value:', this.value);
            if (this.value) {
                calculateAndFillInterviewDate(this.value);
            }
        });
        
        addEventListenerOnce(approvalDateField, 'change', function() {
            console.log('üìÖ Approval date change event triggered with value:', this.value);
            if (this.value) {
                calculateAndFillInterviewDate(this.value);
            }
        });
        
        console.log('‚úÖ Event listeners attached to approval date field');
    } else {
        console.log('‚ùå Some fields not found:', {
            approvalDateField: !!approvalDateField,
            nepaliDateField: !!nepaliDateField,
            gregorianDateField: !!gregorianDateField
        });
    }
    
    function calculateAndFillInterviewDate(approvalDateStr) {
        console.log('üîÑ calculateAndFillInterviewDate called with:', approvalDateStr);
        
        try {
            // Parse the approval date (handle both YYYY-MM-DD and YYYY/MM/DD formats)
            let approvalDate;
            if (approvalDateStr.includes('/')) {
                // Handle Nepali date format (YYYY/MM/DD)
                const parts = approvalDateStr.split('/');
                console.log('üìÖ Parsing Nepali date format, parts:', parts);
                if (parts.length === 3) {
                    const year = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1; // Month is 0-indexed
                    const day = parseInt(parts[2]);
                    approvalDate = new Date(year, month, day);
                    console.log('üìÖ Created Date object from Nepali format:', approvalDate);
                }
            } else if (approvalDateStr.includes('-')) {
                // Handle Gregorian date format (YYYY-MM-DD)
                approvalDate = new Date(approvalDateStr);
                console.log('üìÖ Created Date object from Gregorian format:', approvalDate);
            }
            
            if (approvalDate && !isNaN(approvalDate.getTime())) {
                // Calculate interview date (8 days after approval)
                const interviewDate = new Date(approvalDate);
                interviewDate.setDate(approvalDate.getDate() + 8);
                console.log('üìÖ Interview date calculated (8 days after):', interviewDate);
                
                // Format Nepali date (YYYY/MM/DD)
                const nepaliDate = `${interviewDate.getFullYear()}/${String(interviewDate.getMonth() + 1).padStart(2, '0')}/${String(interviewDate.getDate()).padStart(2, '0')}`;
                
                // Format Gregorian date (DD Month, YYYY)
                const gregorianDate = interviewDate.toLocaleDateString('en-US', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
                
                console.log('üìÖ Formatted dates - Nepali:', nepaliDate, 'Gregorian:', gregorianDate);
                console.log('üìÖ Field references - nepaliDateField:', nepaliDateField, 'gregorianDateField:', gregorianDateField);
                
                // Fill the fields
                if (nepaliDateField) {
                    nepaliDateField.value = nepaliDate;
                    console.log('‚úÖ Nepali date field updated');
                } else {
                    console.log('‚ùå Nepali date field not found');
                }
                
                if (gregorianDateField) {
                    gregorianDateField.value = gregorianDate;
                    console.log('‚úÖ Gregorian date field updated');
                } else {
                    console.log('‚ùå Gregorian date field not found');
                }
                
                if (previewNepali) {
                    previewNepali.textContent = nepaliDate;
                    console.log('‚úÖ Nepali preview updated');
                }
                
                if (previewGregorian) {
                    previewGregorian.textContent = gregorianDate;
                    console.log('‚úÖ Gregorian preview updated');
                }
                
                console.log('‚úÖ Interview date automatically calculated:', nepaliDate, '(', gregorianDate, ')');
            } else {
                console.log('‚ùå Invalid approval date or could not parse:', approvalDateStr);
            }
        } catch (error) {
            console.error('‚ùå Error calculating interview date:', error);
        }
    }
}

// Calendar picker functionality for approval date
function openDatePicker() {
    const hiddenPicker = document.getElementById('hidden_date_picker');
    if (hiddenPicker) {
        // Set current date as default
        const today = new Date().toISOString().split('T')[0];
        hiddenPicker.value = today;
        
        // Trigger the date picker
        hiddenPicker.click();
    }
}

function updateApprovalDate(selectedDate) {
    if (selectedDate) {
        const approvalDateField = document.getElementById('id_pre_approval_date');
        if (approvalDateField) {
            // Convert YYYY-MM-DD to Nepali format (YYYY/MM/DD)
            const date = new Date(selectedDate);
            const nepaliDate = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
            
            // Update the approval date field
            approvalDateField.value = nepaliDate;
            
            // Trigger change event to update interview dates
            approvalDateField.dispatchEvent(new Event('change', { bubbles: true }));
            
            console.log('‚úÖ Approval date updated via calendar:', nepaliDate);
        }
    }
}

// Auto-convert English numbers to Nepali numbers (first number only)
function convertToNepaliNumbers(input) {
    const englishToNepali = {
        '0': '‡•¶', '1': '‡•ß', '2': '‡•®', '3': '‡•©', '4': '‡•™',
        '5': '‡•´', '6': '‡•¨', '7': '‡•≠', '8': '‡•Æ', '9': '‡•Ø'
    };
    
    if (!input) return input;
    
    // Convert only the first number to Nepali, keep rest in English
    const firstChar = input.charAt(0);
    if (englishToNepali[firstChar]) {
        return englishToNepali[firstChar] + input.slice(1);
    }
    
    return input;
}



// Function to apply OCR data to forms
function applyOCRData() {
    // Get parsed data from the table
    const parsedData = {};
    
    // Extract data from the OCR results table
    const tableRows = document.querySelectorAll('#step1 .table tbody tr');
    tableRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 2) {
            const field = cells[0].textContent.trim();
            const value = cells[1].textContent.trim();
            
            // Map Nepali field names to form field names
            const fieldMapping = {
                '‡§ï‡§Æ‡•ç‡§™‡§®‡•Ä‡§ï‡•ã ‡§®‡§æ‡§Æ': 'company_name',
                '‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø ‡§Æ‡§ø‡§§‡§ø': 'pre_approval_date',
                '‡§ö‡§≤‡§æ‡§®‡•Ä ‡§®‡§Ç.': 'chalani_no',
                'LOT ‡§®‡§Ç.': 'lot_no',
                '‡§∂‡§π‡§∞': 'city',
                '‡§¶‡•á‡§∂': 'country',
                '‡§™‡§¶': 'position',
                '‡§™‡•Å‡§∞‡•Å‡§∑ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ': 'male_count',
                '‡§Æ‡§π‡§ø‡§≤‡§æ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ': 'female_count',
                '‡§§‡§≤‡§¨ ‡§∞‡§ï‡§Æ': 'salary_amount',
                '‡§Æ‡•Å‡§¶‡•ç‡§∞‡§æ': 'salary_currency',
                '‡§ì‡§≠‡§∞ ‡§ü‡§æ‡§á‡§Æ': 'overtime',
                '‡§ò‡§£‡•ç‡§ü‡§æ/‡§¶‡§ø‡§®': 'hours_per_day',
                '‡§¶‡§ø‡§®/‡§π‡§™‡•ç‡§§‡§æ': 'days_per_week',
                '‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§µ‡§ø‡§¶‡§æ': 'yearly_leave',
                '‡§∂‡•à‡§ï‡•ç‡§∑‡§ø‡§ï ‡§Ø‡•ã‡§ó‡•ç‡§Ø‡§§‡§æ': 'min_qualification',
                '‡§ñ‡§æ‡§®‡§æ': 'food_provided',
                '‡§¨‡§∏‡•ã‡§¨‡§æ‡§∏': 'housing_provided',
                '‡§ï‡§∞‡§æ‡§∞ ‡§Ö‡§µ‡§ß‡§ø': 'contract_duration'
            };
            
            const formField = fieldMapping[field];
            if (formField && value !== '‡§™‡§æ‡§á‡§è‡§®') {
                parsedData[formField] = value;
            }
        }
    });
    
    // Apply data to main form fields
    if (parsedData.company_name) {
        const companyField = document.getElementById('id_company_name');
        if (companyField) companyField.value = parsedData.company_name;
    }
    
    if (parsedData.pre_approval_date) {
        const dateField = document.getElementById('id_pre_approval_date');
        if (dateField) dateField.value = parsedData.pre_approval_date;
    }
    
    if (parsedData.chalani_no) {
        const chalaniField = document.getElementById('id_chalani_no');
        if (chalaniField) chalaniField.value = parsedData.chalani_no;
    }
    
    if (parsedData.lot_no) {
        const lotField = document.getElementById('id_lot_no');
        if (lotField) lotField.value = parsedData.lot_no;
    }
    
    if (parsedData.city) {
        const cityField = document.getElementById('id_city');
        if (cityField) cityField.value = parsedData.city;
    }
    
    if (parsedData.country) {
        const countryField = document.getElementById('id_country');
        if (countryField) countryField.value = parsedData.country;
    }
    
    // Apply data to job position fields
    if (parsedData.position) {
        const positionField = document.querySelector('[name*="position"]');
        if (positionField) positionField.value = parsedData.position;
    }
    
    if (parsedData.male_count) {
        const maleField = document.querySelector('[name*="male_count"]');
        if (maleField) maleField.value = parsedData.male_count;
    }
    
    if (parsedData.female_count) {
        const femaleField = document.querySelector('[name*="female_count"]');
        if (femaleField) femaleField.value = parsedData.female_count;
    }
    
    if (parsedData.salary_amount) {
        const salaryField = document.querySelector('[name*="salary_amount"]');
        if (salaryField) salaryField.value = parsedData.salary_amount;
    }
    
    if (parsedData.salary_currency) {
        const currencyField = document.querySelector('[name*="salary_currency"]');
        if (currencyField) currencyField.value = parsedData.salary_currency;
    }
    
    // Apply other job position fields
    const jobFields = ['overtime', 'hours_per_day', 'days_per_week', 'yearly_leave', 
                      'min_qualification', 'food_provided', 'housing_provided', 'contract_duration'];
    
    jobFields.forEach(field => {
        if (parsedData[field]) {
            const fieldElement = document.querySelector(`[name*="${field}"]`);
            if (fieldElement) fieldElement.value = parsedData[field];
        }
    });
    
    // Trigger currency conversion if salary data was applied
    if (parsedData.salary_amount || parsedData.salary_currency) {
        const positionForm = document.querySelector('.position-form');
        if (positionForm) {
            handleSalaryConversion(positionForm);
        }
    }
    
    alert('OCR ‡§°‡§æ‡§ü‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡§æ‡§ó‡•Ç ‡§ó‡§∞‡§ø‡§Ø‡•ã! ‡§Ö‡§¨ ‡§§‡§™‡§æ‡§à‡§Ç‡§≤‡•á ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ö‡§∞‡§£‡§Æ‡§æ ‡§ú‡§æ‡§® ‡§∏‡§ï‡•ç‡§®‡•Å‡§π‡•Å‡§®‡•ç‡§õ‡•§');
    goToStep(2);
}

// Function to go to specific step
function goToStep(step) {
    // Validate current step before proceeding
    if (!validateCurrentStep()) {
        return;
    }
    
    currentStep = step;
    updateProgress();
    
    // Hide all tabs
    document.querySelectorAll('.tab-pane').forEach(tab => {
        tab.classList.remove('show', 'active');
    });
    
    // Show target tab
    const targetTab = document.getElementById(`step${step}`);
    targetTab.classList.add('show', 'active');
    
    // Update navigation
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    document.getElementById(`step${step}-tab`).classList.add('active');
    
    // Update progress bar
    const progress = (step / totalSteps) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
}
// Function to validate current step before proceeding
function validateCurrentStep() {
    const currentStepElement = document.querySelector('.tab-pane.active');
    if (!currentStepElement) return true;
    
    const stepId = currentStepElement.id;
    
    if (stepId === 'step2') {
        // Validate main information fields
        const requiredFields = [
            'id_company_name',
            'id_country',
            'id_pre_approval_date',
            'id_chalani_no',
            'id_lot_no',
            'id_city'
        ];
        
        const missingFields = [];
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field && !field.value.trim()) {
                missingFields.push(field.previousElementSibling?.textContent || fieldId);
            }
        });
        
        if (missingFields.length > 0) {
            alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ø‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§´‡§ø‡§≤‡•ç‡§°‡§π‡§∞‡•Ç ‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç:\n' + missingFields.join('\n'));
            return false;
        }
        
    } else if (stepId === 'step3') {
        // Validate job positions
        const positionForms = document.querySelectorAll('.position-form');
        console.log(`Validating Step 3: Found ${positionForms.length} position forms`);
        
        if (positionForms.length === 0) {
            alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§Æ‡•ç‡§§‡§ø‡§Æ‡§æ ‡§è‡§â‡§ü‡§æ ‡§ï‡§æ‡§Æ‡§¶‡§æ‡§∞‡§ï‡•ã ‡§™‡§¶ ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§');
            return false;
        }
        
        // Check if at least one form has the minimum required data
        let hasValidForm = false;
        const emptyForms = [];
        
        positionForms.forEach((form, index) => {
            console.log(`\n--- Validating Position Form ${index + 1} ---`);
            
            // Get all input fields in this form
            const positionField = form.querySelector('input[name*="position"]');
            const maleField = form.querySelector('input[name*="male_count"]');
            const femaleField = form.querySelector('input[name*="female_count"]');
            const salaryField = form.querySelector('input[name*="salary_amount"]');
            
            console.log('Fields found:', {
                position: positionField ? `"${positionField.value}"` : 'NOT FOUND',
                male: maleField ? `"${maleField.value}"` : 'NOT FOUND',
                female: femaleField ? `"${femaleField.value}"` : 'NOT FOUND',
                salary: salaryField ? `"${salaryField.value}"` : 'NOT FOUND'
            });
            
            // Check if this form has the minimum required data
            if (positionField && maleField && femaleField && salaryField) {
                const position = positionField.value.trim();
                const male = maleField.value.trim();
                const female = femaleField.value.trim();
                const salary = salaryField.value.trim();
                
                console.log('Field values:', { position, male, female, salary });
                
                // If this form has the essential fields filled, consider it valid
                if (position && (male || female) && salary) {
                    hasValidForm = true;
                    console.log(`Form ${index + 1} has essential data - marking as valid`);
                } else {
                    // This form is empty or incomplete
                    emptyForms.push(index + 1);
                    console.log(`Form ${index + 1} is empty or incomplete`);
                }
            } else {
                console.log(`Form ${index + 1} missing required field elements`);
                emptyForms.push(index + 1);
            }
        });
        
        console.log(`Validation result: hasValidForm=${hasValidForm}, emptyForms=${emptyForms.length}`);
        
        if (!hasValidForm) {
            alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§Æ‡•ç‡§§‡§ø‡§Æ‡§æ ‡§è‡§â‡§ü‡§æ ‡§™‡§¶‡§ï‡•ã ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§');
            return false;
        }
        
        // If we have at least one valid form, that's enough
        // Empty forms are allowed (they will be ignored by Django)
        console.log('Step 3 validation passed - at least one form has data');
        return true;
    }
    
    return true;
}

// Function to add new position
function addPosition() {
    console.log('DEBUG: addPosition() called');
    
    const container = document.getElementById('positionsContainer');
    if (!container) {
        console.error('Positions container not found');
        return;
    }
    
    // Get the first form to clone
    const firstForm = container.querySelector('.position-form');
    if (!firstForm) {
        console.error('No position form found to clone');
        return;
    }
    
    // Count current forms
    const currentForms = container.querySelectorAll('.position-form').length;
    console.log(`DEBUG: Current forms count: ${currentForms}`);
    
    // Get formset management fields
    const totalFormsField = document.querySelector('[name*="TOTAL_FORMS"]');
    const initialFormsField = document.querySelector('[name*="INITIAL_FORMS"]');
    
    if (!totalFormsField) {
        console.error('TOTAL_FORMS field not found');
        return;
    }
    
    console.log(`DEBUG: Before adding - TOTAL_FORMS: ${totalFormsField.value}, INITIAL_FORMS: ${initialFormsField ? initialFormsField.value : 'Not found'}`);
    
    const newForm = firstForm.cloneNode(true);
    
    // Update form index
    newForm.dataset.formIndex = currentForms;
    newForm.querySelector('h6').textContent = `‡§™‡§¶ #${currentForms + 1}`;
    
    // Update form field names - handle formset naming
    newForm.querySelectorAll('input, select, textarea').forEach(field => {
        if (field.name) {
            // Replace the form index in the name - handle Django formset naming
            const nameMatch = field.name.match(/positions-(\d+)-/);
            if (nameMatch) {
                const oldIndex = nameMatch[1];
                const newName = field.name.replace(`positions-${oldIndex}-`, `positions-${currentForms}-`);
                console.log(`Updating field name: ${field.name} -> ${newName}`);
                field.name = newName;
                if (field.id) {
                    const newId = field.id.replace(`positions-${oldIndex}-`, `positions-${currentForms}-`);
                    console.log(`Updating field ID: ${field.id} -> ${newId}`);
                    field.id = newId;
                }
            }
        }
    });
    
    // Also update labels and other elements that might reference the form index
    newForm.querySelectorAll('label[for]').forEach(label => {
        const forAttr = label.getAttribute('for');
        if (forAttr) {
            const nameMatch = forAttr.match(/positions-(\d+)-/);
            if (nameMatch) {
                const oldIndex = nameMatch[1];
                const newFor = forAttr.replace(`positions-${oldIndex}-`, `positions-${currentForms}-`);
                console.log(`Updating label for: ${forAttr} -> ${newFor}`);
                label.setAttribute('for', newFor);
            }
        }
    });
    
    // Clear ONLY the new form's values (not the original)
    newForm.querySelectorAll('input, select, textarea').forEach(field => {
        if (field.type !== 'hidden') {
            field.value = '';
        }
    });
    
    // Add remove button
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-danger btn-sm';
    removeBtn.onclick = function() { removePosition(this); };
    removeBtn.innerHTML = 'üóëÔ∏è ‡§π‡§ü‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç';
    
    const header = newForm.querySelector('.d-flex.justify-content-between');
    if (header) {
        // Remove existing remove button if any
        header.querySelector('.btn-danger')?.remove();
        header.appendChild(removeBtn);
    }
    
    // Add to container
    container.appendChild(newForm);
    
    // Update total forms count - ensure it's a number
    totalFormsField.value = currentForms + 1;
    console.log(`Updated TOTAL_FORMS to: ${totalFormsField.value}`);
    
    // Set INITIAL_FORMS to 0 since we're adding new positions
    if (initialFormsField) {
        initialFormsField.value = '0';
        console.log(`Set INITIAL_FORMS to: 0`);
    }
    
    // Add event listeners for currency conversion
    addCurrencyConversionListeners(newForm);
    
    // Debug: Log all field names in the new form
    console.log(`New form field names:`);
    newForm.querySelectorAll('input, select, textarea').forEach(field => {
        console.log(`  ${field.name}: "${field.value}"`);
    });
    
    // Debug: Verify first form still has data
    console.log(`First form data after adding new position:`);
    const firstFormAfter = container.querySelector('.position-form');
    if (firstFormAfter) {
        firstFormAfter.querySelectorAll('input, select, textarea').forEach(field => {
            if (field.name && field.name.includes('positions-0-')) {
                console.log(`  ${field.name}: "${field.value}"`);
            }
        });
    }
    
    console.log(`Added new position form. Total forms: ${totalFormsField.value}`);
}

// Function to remove position
function removePosition(button) {
    const form = button.closest('.position-form');
    if (!form) {
        console.error('Position form not found');
        return;
    }
    
    form.remove();
    
    // Get all remaining forms and reindex them
    const forms = document.querySelectorAll('.position-form');
    const container = document.getElementById('positionsContainer');
    
    if (container) {
        const totalFormsField = container.querySelector('[name*="TOTAL_FORMS"]');
        const initialFormsField = container.querySelector('[name*="INITIAL_FORMS"]');
        
        // Reindex all remaining forms
        forms.forEach((form, index) => {
            // Update form index
            form.dataset.formIndex = index;
            form.querySelector('h6').textContent = `‡§™‡§¶ #${index + 1}`;
            
            // Update all field names to match new index
            form.querySelectorAll('input, select, textarea').forEach(field => {
                if (field.name) {
                    const nameMatch = field.name.match(/positions-(\d+)-/);
                    if (nameMatch) {
                        const oldIndex = nameMatch[1];
                        const newName = field.name.replace(`positions-${oldIndex}-`, `positions-${index}-`);
                        console.log(`Reindexing field name: ${field.name} -> ${newName}`);
                        field.name = newName;
                        if (field.id) {
                            const newId = field.id.replace(`positions-${oldIndex}-`, `positions-${index}-`);
                            console.log(`Reindexing field ID: ${field.id} -> ${newId}`);
                            field.id = newId;
                        }
                    }
                }
            });
        });
        
        // Update total forms count
        if (totalFormsField) {
            totalFormsField.value = forms.length;
            console.log(`Removed position form. Total forms: ${totalFormsField.value}`);
        }
        
        // Set INITIAL_FORMS to 0 since we're working with new positions
        if (initialFormsField) {
            initialFormsField.value = '0';
            console.log(`Set INITIAL_FORMS to: 0`);
        }
    }
}

// Function to add currency conversion listeners
function addCurrencyConversionListeners(formElement) {
    const salaryAmount = formElement.querySelector('[name*="salary_amount"]');
    const salaryCurrency = formElement.querySelector('[name*="salary_currency"]');
    
    if (salaryAmount) {
        salaryAmount.addEventListener('input', () => handleSalaryConversion(formElement));
    }
    
    if (salaryCurrency) {
        salaryCurrency.addEventListener('change', () => handleSalaryConversion(formElement));
    }
}

// Function to fetch latest currency rates
async function updateCurrencyRates() {
    try {
        const response = await fetch('/update-currency-rates/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                console.log('Currency rates updated successfully');
                // Refresh the page or update rates in memory
                location.reload();
            }
        }
    } catch (error) {
        console.error('Error updating currency rates:', error);
    }
}

// Update progress on page load
function setupProgressAndCurrency() {
    updateProgress();
    
    // Add currency conversion listeners to existing forms
    document.querySelectorAll('.position-form').forEach(form => {
        addCurrencyConversionListeners(form);
    });
    
    // Add interview preview listeners
    document.getElementById('id_nepali_date')?.addEventListener('input', updateInterviewPreview);
    document.getElementById('id_gregorian_date')?.addEventListener('input', updateInterviewPreview);
    document.getElementById('id_interview_hour')?.addEventListener('input', updateInterviewPreview);
    document.getElementById('id_interview_time')?.addEventListener('input', updateInterviewPreview);
    document.getElementById('id_interview_location')?.addEventListener('input', updateInterviewPreview);
    
    // Setup number conversion
    setupNumberConversion();
    
    // Setup date conversion
    setupDateConversion();

    // Setup country notice preview
    setupCountryNoticePreview();
    
    // Add event delegation for dynamically added forms
    document.getElementById('positionsContainer')?.addEventListener('change', function(e) {
        if (e.target.name && (e.target.name.includes('salary_amount') || e.target.name.includes('salary_currency'))) {
            const formElement = e.target.closest('.position-form');
            if (formElement) {
                handleSalaryConversion(formElement);
            }
        }
    });
}

function updateProgress() {
    const progress = (currentStep / totalSteps) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
}

// Form submission handlers
document.getElementById('mainForm').addEventListener('submit', function(e) {
    console.log('DEBUG: Main form submit event triggered!');
    
    // Debug: Check current step
    const currentStepElement = document.querySelector('.tab-pane.active');
    const stepId = currentStepElement ? currentStepElement.id : 'Unknown Step';
    console.log('DEBUG: Current step:', stepId);
    
    e.preventDefault();
    
    // Validate required fields before submission
    if (!validateCurrentStep()) {
        console.log('DEBUG: Form validation failed');
        return;
    }
    
    console.log('DEBUG: Form validation passed, submitting...');
    
    // Debug: Log form data being sent
    const formData = new FormData(this);
    console.log('DEBUG: Submitting main form with data:');
    for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
    }
    
    // Submit form via AJAX
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('DEBUG: Form submission response:', data);
        if (data.success) {
            alert('‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡•á‡§≠ ‡§ó‡§∞‡§ø‡§Ø‡•ã!');
            goToStep(3);
        } else {
            alert('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + data.error);
        }
    })
    .catch(error => {
        console.error('DEBUG: Form submission error:', error);
        alert('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§≠‡§Ø‡•ã‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§');
    });
});

document.getElementById('positionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate required fields before submission
    if (!validateCurrentStep()) {
        return;
    }
    
    // Debug: Log form data being sent
    const formData = new FormData(this);
    console.log('Submitting position form with data:');
    for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
    }
    
    // Debug: Check if any position fields have values
    const positionFields = document.querySelectorAll('[name*="position"]');
    const maleCountFields = document.querySelectorAll('[name*="male_count"]');
    const femaleCountFields = document.querySelectorAll('[name*="female_count"]');
    
    console.log('Position fields found:', positionFields.length);
    console.log('Male count fields found:', maleCountFields.length);
    console.log('Female count fields found:', femaleCountFields.length);
    
    // Check values of all positions
    positionFields.forEach((field, index) => {
        console.log(`Position ${index}: "${field.value}"`);
    });
    
    maleCountFields.forEach((field, index) => {
        console.log(`Male Count ${index}: "${field.value}"`);
    });
    
    femaleCountFields.forEach((field, index) => {
        console.log(`Female Count ${index}: "${field.value}"`);
    });
    
    // Debug: Check all forms in the container
    console.log('\n--- All Forms in Container ---');
    const container = document.getElementById('positionsContainer');
    if (container) {
        const allForms = container.querySelectorAll('.position-form');
        allForms.forEach((form, formIndex) => {
            console.log(`\nForm ${formIndex}:`);
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.name && input.name.includes('position')) {
                    console.log(`  ${input.name}: "${input.value}"`);
                }
            });
        });
    }
    
    // Debug: Check formset management form fields
    const totalFormsField = document.querySelector('[name*="TOTAL_FORMS"]');
    const initialFormsField = document.querySelector('[name*="INITIAL_FORMS"]');
    const maxFormsField = document.querySelector('[name*="MAX_NUM_FORMS"]');
    console.log('Formset management fields:');
    console.log('TOTAL_FORMS:', totalFormsField ? totalFormsField.value : 'Not found');
    console.log('INITIAL_FORMS:', initialFormsField ? initialFormsField.value : 'Not found');
    console.log('MAX_NUM_FORMS:', maxFormsField ? maxFormsField.value : 'Not found');
    
    // Submit form via AJAX
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‡§™‡§¶‡§π‡§∞‡•Ç ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡•á‡§≠ ‡§ó‡§∞‡§ø‡§Ø‡•ã!');
            goToStep(4);
        } else {
            alert('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§≠‡§Ø‡•ã‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§');
    });
});


// Debug Validation Function
function debugValidation() {
    const currentStepElement = document.querySelector('.tab-pane.active');
    const stepId = currentStepElement ? currentStepElement.id : 'Unknown Step';
    const currentStepNumber = currentStepElement ? currentStepElement.id.replace('step', '').replace('-tab', '') : 'N/A';
    
    let message = `Current Step: ${currentStepNumber}\n\n`;
    
    if (stepId === 'step2') {
        message += 'Main Information Validation:\n';
        const requiredFields = [
            'id_company_name',
            'id_country',
            'id_pre_approval_date',
            'id_chalani_no',
            'id_lot_no',
            'id_city'
        ];
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            message += `- ${field ? (field.value.trim() ? 'Filled' : 'Empty') : 'Not Found'}: ${field ? field.previousElementSibling?.textContent || fieldId : 'N/A'}\n`;
        });
    } else if (stepId === 'step3') {
        message += 'Job Positions Validation:\n';
        const positionForms = document.querySelectorAll('.position-form');
        if (positionForms.length === 0) {
            message += 'No position forms found.\n';
        } else {
            positionForms.forEach((form, index) => {
                message += `Position Form ${index + 1}:\n`;
                const positionField = form.querySelector('input[name*="position"]');
                const maleField = form.querySelector('input[name*="male_count"]');
                const femaleField = form.querySelector('input[name*="female_count"]');
                const salaryField = form.querySelector('input[name*="salary_amount"]');
                
                message += `  - Position: ${positionField ? (positionField.value.trim() ? 'Filled' : 'Empty') : 'Not Found'}\n`;
                message += `  - Male Count: ${maleField ? (maleField.value.trim() ? 'Filled' : 'Empty') : 'Not Found'}\n`;
                message += `  - Female Count: ${femaleField ? (femaleField.value.trim() ? 'Filled' : 'Empty') : 'Not Found'}\n`;
                message += `  - Salary Amount: ${salaryField ? (salaryField.value.trim() ? 'Filled' : 'Empty') : 'Not Found'}\n`;
            });
        }
    }
    
    alert(message);
}

// Test Add Position Function
function testAddPosition() {
    addPosition();
    alert('Test Add Position button clicked. New position form added.');
}

// Debug function to check form state
function debugFormState() {
    console.log('=== DEBUG FORM STATE ===');
    
    const container = document.getElementById('positionsContainer');
    if (!container) {
        console.log('Container not found');
        return;
    }
    
    const forms = container.querySelectorAll('.position-form');
    console.log(`Total forms found: ${forms.length}`);
    
    // Check formset management fields
    const totalFormsField = document.querySelector('[name*="TOTAL_FORMS"]');
    const initialFormsField = document.querySelector('[name*="INITIAL_FORMS"]');
    const minFormsField = document.querySelector('[name*="MIN_NUM_FORMS"]');
    const maxFormsField = document.querySelector('[name*="MAX_NUM_FORMS"]');
    
    console.log('Formset management fields:');
    console.log(`  TOTAL_FORMS: ${totalFormsField ? totalFormsField.value : 'Not found'}`);
    console.log(`  INITIAL_FORMS: ${initialFormsField ? initialFormsField.value : 'Not found'}`);
    console.log(`  MIN_NUM_FORMS: ${minFormsField ? minFormsField.value : 'Not found'}`);
    console.log(`  MAX_NUM_FORMS: ${maxFormsField ? maxFormsField.value : 'Not found'}`);
    
    // Check each form
    forms.forEach((form, index) => {
        console.log(`\n--- Form ${index + 1} ---`);
        console.log(`  Form index: ${form.dataset.formIndex}`);
        console.log(`  Title: ${form.querySelector('h6').textContent}`);
        
        const inputs = form.querySelectorAll('input, select, textarea');
        console.log(`  Total fields: ${inputs.length}`);
        
        // Check key fields
        const positionField = form.querySelector('[name*="position"]');
        const maleField = form.querySelector('[name*="male_count"]');
        const femaleField = form.querySelector('[name*="female_count"]');
        const salaryField = form.querySelector('[name*="salary_amount"]');
        
        console.log('  Key fields:');
        console.log(`    Position: ${positionField ? `"${positionField.value}" (${positionField.name})` : 'NOT FOUND'}`);
        console.log(`    Male Count: ${maleField ? `"${maleField.value}" (${maleField.name})` : 'NOT FOUND'}`);
        console.log(`    Female Count: ${femaleField ? `"${femaleField.value}" (${femaleField.name})` : 'NOT FOUND'}`);
        console.log(`    Salary: ${salaryField ? `"${salaryField.value}" (${salaryField.name})` : 'NOT FOUND'}`);
    });
    
    console.log('=== END DEBUG ===');
}

// Function to calculate interview date (8 days after pre-approval)
function calculateInterviewDate() {
    const preApprovalDate = document.getElementById('id_pre_approval_date').value;
    if (!preApprovalDate) {
        alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§ø‡§≤‡•á ‡§™‡•Ç‡§∞‡•ç‡§µ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡§ø ‡§Æ‡§ø‡§§‡§ø ‡§≠‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§');
        return;
    }
    
    try {
        const date = new Date(preApprovalDate);
        date.setDate(date.getDate() + 8);
        
        // Format Nepali date (you can customize this format)
        const nepaliDate = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
        
        // Format English date
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        const englishDate = date.toLocaleDateString('en-US', options);
        
        // Update the form fields
        document.getElementById('id_interview_nepali_date').value = nepaliDate;
        document.getElementById('id_interview_gregorian_date').value = englishDate;
        
        // Update the preview
        document.getElementById('preview_nepali_date').textContent = nepaliDate;
        document.getElementById('preview_gregorian_date').textContent = englishDate;
        
        alert(`‡§∏‡•ç‡§µ‡§ö‡§æ‡§≤‡§ø‡§§ ‡§Æ‡§ø‡§§‡§ø ‡§ó‡§£‡§®‡§æ ‡§∏‡§´‡§≤: ${nepaliDate} (${englishDate})`);
    } catch (error) {
        alert('‡§Æ‡§ø‡§§‡§ø ‡§ó‡§£‡§®‡§æ‡§Æ‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§≠‡§Ø‡•ã‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§π‡•Ä ‡§Æ‡§ø‡§§‡§ø ‡§´‡§∞‡§Æ‡•ç‡§Ø‡§æ‡§ü ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç (YYYY-MM-DD)‡•§');
    }
}

// Function to reset corrupted formset management fields
function resetFormsetFields() {
    console.log('=== RESETTING FORMSET FIELDS ===');
    
    const container = document.getElementById('positionsContainer');
    if (!container) {
        console.log('Container not found');
        return;
    }
    
    // Reset management form fields
    const totalFormsField = container.querySelector('[name*="TOTAL_FORMS"]');
    const initialFormsField = container.querySelector('[name*="INITIAL_FORMS"]');
    
    if (totalFormsField) totalFormsField.value = '1';
    if (initialFormsField) initialFormsField.value = '0';
    
    console.log('Management fields reset');
    
    // Remove all forms except the first one
    const forms = container.querySelectorAll('.position-form');
    forms.forEach((form, index) => {
        if (index > 0) {
            form.remove();
        }
    });
    
    console.log('Extra forms removed');
    console.log('=== END RESET ===');
}

// Country Notice Preview Function
function setupCountryNoticePreview() {
    const countryField = document.getElementById('id_country');
    const extraNotesField = document.getElementById('id_extra_notes');
    const previewDiv = document.getElementById('countryNoticePreview');
    const previewText = document.getElementById('noticePreviewText');
    
    if (countryField && extraNotesField && previewDiv && previewText) {
        // Show preview when country changes
        countryField.addEventListener('input', function() {
            updateCountryNoticePreview();
        });
        
        // Hide preview when user types in extra notes
        extraNotesField.addEventListener('input', function() {
            if (this.value.trim()) {
                previewDiv.style.display = 'none';
            } else {
                updateCountryNoticePreview();
            }
        });
        
        // Initial preview
        updateCountryNoticePreview();
    }
}







// Test form submission function
function testFormSubmission() {
    try {
        console.log('=== TESTING FORM SUBMISSION ===');
        alert('Starting testFormSubmission function...');
        
        // Get the form
        const form = document.getElementById('positionForm');
        if (!form) {
            console.log('Form not found');
            alert('Form not found!');
            return;
        }
        
        alert('Form found! Getting form data...');
        
        // Get form data
        const formData = new FormData(form);
        
        console.log('Form data:');
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: ${value}`);
        }
        
        // Check for specific field patterns
        const positionFields = [];
        const maleFields = [];
        const femaleFields = [];
        const salaryFields = [];
        
        for (let [key, value] of formData.entries()) {
            if (key.includes('position')) positionFields.push({key, value});
            if (key.includes('male_count')) maleFields.push({key, value});
            if (key.includes('female_count')) femaleFields.push({key, value});
            if (key.includes('salary_amount')) salaryFields.push({key, value});
        }
        
        console.log('Field analysis:');
        console.log('  Position fields:', positionFields);
        console.log('  Male count fields:', maleFields);
        console.log('  Female count fields:', femaleFields);
        console.log('  Salary fields:', salaryFields);
        
        alert('Form data logged to console! Check console for field analysis.');
        
        // Check if we can submit
        if (validateCurrentStep('step3')) {
            console.log('‚úÖ Validation passed - form can be submitted');
            alert('‚úÖ Validation passed - form can be submitted');
        } else {
            console.log('‚ùå Validation failed - form cannot be submitted');
            alert('‚ùå Validation failed - form cannot be submitted');
        }
        
        console.log('=== END TEST ===');
        
    } catch (error) {
        console.error('Error in testFormSubmission:', error);
        alert('Error: ' + error.message);
    }
}

// Function to show current form values
function showFormValues() {
    try {
        console.log('=== SHOWING FORM VALUES ===');
        alert('Starting showFormValues function...');
        
        const container = document.getElementById('positionsContainer');
        if (!container) {
            console.log('Container not found');
            alert('Container not found!');
            return;
        }
        
        alert(`Container found! Looking for forms...`);
        
        const forms = container.querySelectorAll('.position-form');
        console.log(`Total forms found: ${forms.length}`);
        alert(`Found ${forms.length} forms`);
        
        if (forms.length === 0) {
            alert('No forms found!');
            return;
        }
        
        forms.forEach((form, index) => {
            console.log(`\n--- Form ${index + 1} Values ---`);
            
            // Get all form fields
            const positionField = form.querySelector('[name*="position"]');
            const maleField = form.querySelector('[name*="male_count"]');
            const femaleField = form.querySelector('[name*="female_count"]');
            const salaryField = form.querySelector('[name*="salary_amount"]');
            
            console.log('Field values:');
            console.log(`  Position: ${positionField ? `"${positionField.value}"` : 'NOT FOUND'}`);
            console.log(`  Male Count: ${maleField ? `"${maleField.value}"` : 'NOT FOUND'}`);
            console.log(`  Female Count: ${femaleField ? `"${femaleField.value}"` : 'NOT FOUND'}`);
            console.log(`  Salary: ${salaryField ? `"${salaryField.value}"` : 'NOT FOUND'}`);
            
            // Show all field names and values
            const allFields = form.querySelectorAll('input, select, textarea');
            console.log('All fields in this form:');
            allFields.forEach(field => {
                console.log(`  ${field.name}: "${field.value}"`);
            });
        });
        
        console.log('=== END FORM VALUES ===');
        alert('Form values logged to console!');
        
    } catch (error) {
        console.error('Error in showFormValues:', error);
        alert('Error: ' + error.message);
    }
}

// Test if JavaScript is working
console.log('=== JAVASCRIPT LOADED ===');
console.log('Debug functions should be available');

// Function to show current form values

// Function to submit form manually for testing
function submitFormManually() {
    try {
        console.log('=== MANUAL FORM SUBMISSION ===');
        alert('Starting manual form submission...');
        
        // Get the form
        const form = document.getElementById('positionForm');
        if (!form) {
            console.log('Form not found');
            alert('Form not found!');
            return;
        }
        
        // Get form data
        const formData = new FormData(form);
        
        console.log('Form data being submitted:');
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: ${value}`);
        }
        
        // Check if we have existing position data
        const existingPositionId = formData.get('positions-0-id');
        console.log('Existing position ID:', existingPositionId);
        
        if (existingPositionId) {
            console.log('‚úÖ Found existing position ID, should preserve data');
        } else {
            console.log('‚ùå No existing position ID found, data will be lost');
        }
        
        // Submit the form
        console.log('Submitting form...');
        form.submit();
        
    } catch (error) {
        console.error('Error in manual submission:', error);
        alert('Error: ' + error.message);
    }
}

// Test form submission function
</script>
{% endblock %}