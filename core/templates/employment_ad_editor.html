{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">


    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">ЁЯУЛ рд░реЛрдЬрдЧрд╛рд░ рд╡рд┐рдЬреНрдЮрд╛рдкрди рд╕рдореНрдкрд╛рджрдХ</h4>
                </div>
                <div class="card-body">
                    
                    <!-- Step Progress Indicator -->
                    <div class="progress mb-4" style="height: 8px;">
                        <div class="progress-bar" role="progressbar" style="width: 33.33%;" id="progressBar"></div>
                    </div>
                    
                    <!-- Step Navigation -->
                    <ul class="nav nav-pills mb-4" id="stepTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="step1-tab" data-bs-toggle="pill" data-bs-target="#step1" type="button" role="tab">
                                <span class="badge bg-primary me-2">1</span> OCR рдЕрдкрд▓реЛрдб
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="step2-tab" data-bs-toggle="pill" data-bs-target="#step2" type="button" role="tab">
                                <span class="badge bg-secondary me-2">2</span> рдореБрдЦреНрдп рдЬрд╛рдирдХрд╛рд░реА рд░ рдкрджрд╣рд░реВ
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="step3-tab" data-bs-toggle="pill" data-bs-target="#step4" type="button" role="tab">
                                <span class="badge bg-secondary me-2">3</span> рдкреВрд░реНрд╡рд╛рд╡рд▓реЛрдХрди
                            </button>
                        </li>
                    </ul>

                    <!-- Step Content -->
                    <div class="tab-content" id="stepContent">
                        
                        <!-- Step 1: OCR Upload -->
                        <div class="tab-pane fade show active" id="step1" role="tabpanel">
                            <div class="row">
                                <div class="col-md-12">
                                    <h5 class="mb-1">ЁЯУД OCR рдЕрдкрд▓реЛрдб рд░ рдкрд╛рд░реНрд╕рд┐рдЩ</h5>
                                    <p class="text-muted mb-2">рд╡рд┐рдЬреНрдЮрд╛рдкрди рдкрддреНрд░ рдЕрдкрд▓реЛрдб рдЧрд░реНрдиреБрд╣реЛрд╕реН рд░ OCR рджреНрд╡рд╛рд░рд╛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реБрдкрдорд╛ рдлрд┐рд▓реНрдбрд╣рд░реВ рднрд░реНрдиреБрд╣реЛрд╕реН</p>
                                    
                                    <form method="post" enctype="multipart/form-data" id="ocrForm">
                                        {% csrf_token %}
                                        <input type="hidden" name="form_type" value="ocr">
                                        
                                        <div class="mb-2">
                                            <label for="id_document" class="form-label mb-1">рд╡рд┐рдЬреНрдЮрд╛рдкрди рдкрддреНрд░ рдЕрдкрд▓реЛрдб рдЧрд░реНрдиреБрд╣реЛрд╕реН</label>
                                            <input type="file" class="form-control" id="id_document" name="document" accept="image/*,.pdf" required>
                                            <div class="form-text">PNG, JPG, JPEG, PDF рдлрд╛рдЗрд▓рд╣рд░реВ рд╕реНрд╡реАрдХрд╛рд░реНрдп рдЫрдиреН</div>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            ЁЯФН OCR рдЪрд▓рд╛рдЙрдиреБрд╣реЛрд╕реН
                                        </button>
                                        
                                        <!-- Client-side OCR (browser) preview + progress -->
                                        <div id="ocrClientBox" class="mt-2" style="display:none;">
                                          <label class="form-label mb-1">ЁЯФО Client-side OCR Preview</label>
                                          <progress id="ocrProgress" max="1" value="0" style="width:100%;height:10px;"></progress>
                                          <pre id="ocrPreview" style="white-space:pre-wrap;font-size:12px;max-height:220px;overflow:auto;margin-top:6px;"></pre>
                                          <small class="text-muted">рдпреЛ рдЯреЗрдХреНрд╕реНрдЯ рдмреНрд░рд╛рдЙрдЬрд░рдореИ OCR рдЧрд░реА рдирд┐рдХрд╛рд▓рд┐рдПрдХреЛ рд╣реЛ (рд╕рд░реНрднрд░рдорд╛ рдкрдард╛рдЗрдПрдХреЛ рдЫреИрди)ред</small>
                                        </div>
                                    </form>
                                </div>
                                

                            </div>
                            

                        </div>

                        <!-- Step 2: Main Information -->
                        <div class="tab-pane fade" id="step2" role="tabpanel">
                            <h5 class="mb-1">ЁЯПв рдореБрдЦреНрдп рдЬрд╛рдирдХрд╛рд░реА</h5>
                            <p class="text-muted mb-2">рдХрдореНрдкрдиреА рд░ рд╡рд┐рдЬреНрдЮрд╛рдкрдирдХреЛ рдореБрдЦреНрдп рд╡рд┐рд╡рд░рдг рднрд░реНрдиреБрд╣реЛрд╕реН</p>
                            
                            <form method="post" enctype="multipart/form-data" id="mainForm">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="edit">
                                
                                <!-- Company Information -->
                                <div class="card mb-2">
                                    <div class="card-header py-1">
                                        <h6 class="mb-0">ЁЯПв рдХрдореНрдкрдиреАрдХреЛ рдЬрд╛рдирдХрд╛рд░реА</h6>
                                    </div>
                                    <div class="card-body py-2">
                                                                                <div class="mb-2">
                                            <label for="{{ form.title.id_for_label }}" class="form-label">1. рд╢реАрд░реНрд╖рдХ</label>
                                                    {{ form.title }}
                                                </div>
                                                
                                        <div class="mb-2">
                                            <label for="{{ form.country.id_for_label }}" class="form-label">2. рджреЗрд╢</label>
                                                    <select id="id_country" name="country" class="form-select" required>
                                                        <option value="">Select Country</option>
                                                        <option value="UAE">UAE</option>
                                                        <option value="Japan">Japan</option>
                                                        <option value="Kuwait">Kuwait</option>
                                                        <option value="Qatar">Qatar</option>
                                                        <option value="Saudi Arabia">Saudi Arabia</option>
                                                        <option value="Oman">Oman</option>
                                                        <option value="Bahrain">Bahrain</option>
                                                        <option value="Malaysia">Malaysia</option>
                                                        <option value="Singapore">Singapore</option>
                                                        <option value="South Korea">South Korea</option>
                                                        <option value="Other">Other</option>
                                                    </select>
                                                </div>
                                                
                                                <!-- Manual country input field (hidden by default) -->
                                        <div id="otherCountryField" class="mb-2" style="display: none;">
                                            <label for="id_other_country" class="form-label">Enter Country Name</label>
                                                    <input type="text" id="id_other_country" name="other_country" class="form-control" placeholder="Type country name here...">
                                                </div>
                                                
                                        <div class="mb-2">
                                            <label for="{{ form.company_name.id_for_label }}" class="form-label">3. рдХрдореНрдкрдиреАрдХреЛ рдирд╛рдо</label>
                                            {{ form.company_name }}
                                        </div>
                                                
                                                                                <div class="mb-2">
                                            <label for="id_right_section_text" class="form-label">4. рдкреБрди : рд╡рд┐рдЬреНрдЮрд╛рдкрди </label>
                                            <select id="id_right_section_text" name="right_section_text" class="form-select">
                                                <option value="">рд╣реИрди?</option>
                                                <option value="рдкреБрди : рд╡рд┐рдЬреНрдЮрд╛рдкрди" {% if ad.right_section_text == "рдкреБрди : рд╡рд┐рдЬреНрдЮрд╛рдкрди" %}selected{% endif %}>рд╣реЛ?</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-2">
                                            <label for="{{ form.pre_approval_date.id_for_label }}" class="form-label">5. рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐ рдорд┐рддрд┐</label>
                                                    <div class="input-group">
                                                    {{ form.pre_approval_date }}
                                                        <button type="button" class="btn btn-outline-secondary" onclick="openDatePicker()">
                                                            ЁЯУЕ рдХреНрдпрд╛рд▓реЗрдиреНрдбрд░
                                                        </button>
                                                    </div>
                                                <!-- Hidden date picker input for calendar -->
                                                <input type="date" id="hidden_date_picker" style="display: none;" onchange="updateApprovalDate(this.value)">
                                        </div>
                                                
                                        <div class="mb-2">
                                            <label for="{{ form.chalani_no.id_for_label }}" class="form-label">6. рдЪрд▓рд╛рдиреА рдирдВ.</label>
                                                    {{ form.chalani_no }}
                                            </div>
                                            
                                        <div class="mb-2">
                                            <label for="{{ form.lot_no.id_for_label }}" class="form-label">7. LOT рдирдВ.</label>
                                                    {{ form.lot_no }}
                                                </div>
                                                
                                                <div class="mb-2">
                                            <label for="{{ form.city.id_for_label }}" class="form-label">8. рд╢рд╣рд░</label>
                                                    {{ form.city }}
                                        </div>
                                    </div>
                                                </div>
                                                
                                <!-- Job Positions Section -->
                                <div class="card mb-2">
                                    <div class="card-header py-1">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">ЁЯСе рдХрд╛рдорджрд╛рд░рдХреЛ рдкрджрд╣рд░реВ</h6>
                                            <button type="button" class="btn btn-success btn-sm" onclick="addPosition()">
                                                тЮХ рдирдпрд╛рдБ рдкрдж рдердкреНрдиреБрд╣реЛрд╕реН
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body py-2">
                                        <div id="positionsContainer">
                                            {{ formset.management_form }}
                                            {% for form in formset %}
                                            <div class="position-form border rounded p-3 mb-3" data-form-index="{{ forloop.counter0 }}">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="mb-0">рдкрдж #{{ forloop.counter }}</h6>
                                                    {% if forloop.counter > 1 %}
                                                    <button type="button" class="btn btn-danger btn-sm" onclick="removePosition(this)">
                                                        ЁЯЧСя╕П рд╣рдЯрд╛рдЙрдиреБрд╣реЛрд╕реН
                                                    </button>
                                                    {% endif %}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">1. рдХрд╛рдорджрд╛рд░рдХреЛ рдкрдж </label>
                                                    {{ form.position }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">2. рдкреБрд░реБрд╖</label>
                                                    {{ form.male_count }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">3. рдорд╣рд┐рд▓рд╛</label>
                                                    {{ form.female_count }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">4. рдорд╛рд╕рд┐рдХ рддрд▓рдм</label>
                                                    {{ form.salary_amount }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">5. рдореБрджреНрд░рд╛</label>
                                                    {{ form.salary_currency }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">6. рдиреЗ.рд░реБ.</label>
                                                    {{ form.salary_npr }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">7. рдХрд╛рдорджрд╛рд░рдХрд╛ рдиреНрдпреБрдирддрдо рдпреЛрдЧреНрдпрддрд╛ </label>
                                                    {{ form.min_qualification }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">8. рдУрднрд░ рдЯрд╛рдИрдо рд╕реБрдмрд┐рдзрд╛ </label>
-                                                    {{ form.overtime }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">9. рдкреНрд░рддрд┐рджрд┐рди рдХрд╛рдо рдЧрд░реНрдиреЗ рдШрдгреНрдЯрд╛ </label>
                                                    {{ form.hours_per_day }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">10. рд╣рдкреНрддрд╛рдорд╛ рдХрд╛рдо рдЧрд░реНрдиреЗ рджрд┐рди </label>
                                                    {{ form.days_per_week }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">11. рд╡рд╛рд░реНрд╖рд┐рдХ рдмрд┐рджрд╛ </label>
                                                    {{ form.yearly_leave }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">12. рдЦрд╛рдиреЗ рд╕реБрд╡рд┐рдзрд╛</label>
                                                    {{ form.food_provided }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">13. рдмрд╕реНрдиреЗ рд╕реБрд╡рд┐рдзрд╛ </label>
                                                    {{ form.housing_provided }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">14. рдХрд░рд╛рд░ рдЕрд╡рдзрд┐</label>
                                                    {{ form.contract_duration }}
                                                </div>
                                                
                                                <!-- Hidden fields -->
                                                {{ form.id }}
                                                {{ form.employment_ad }}
                                                {{ form.order }}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Interview Information -->
                                <div class="card mb-2">
                                    <div class="card-header py-1">
                                        <h6 class="mb-0">ЁЯУЕ рдЕрдиреНрддрд░реНрд╡рд╛рд░реНрддрд╛ рд╕реВрдЪрдирд╛</h6>
                                    </div>
                                    <div class="card-body py-2">
                                                <div class="mb-2">
                                                    <label for="{{ form.interview_custom_text.id_for_label }}" class="form-label">рдЕрдиреНрддрд░реНрд╡рд╛рд░реНрддрд╛ рд╕реВрдЪрдирд╛ (рд╡реИрдХрд▓реНрдкрд┐рдХ)</label>
                                                    {{ form.interview_custom_text }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label class="form-label">рдЕрдиреНрддрд░реНрд╡рд╛рд░реНрддрд╛ рдорд┐рддрд┐ рд░ рд╕реНрдерд╛рди</label>
                                                    <div class="row">
                                                        <div class="col-4">
                                                            <label class="form-label">рдиреЗрдкрд╛рд▓реА рдорд┐рддрд┐</label>
                                                            <input type="text" name="interview_nepali_date" id="id_interview_nepali_date" class="form-control" placeholder="реирежреореи/режрел/резрез" value="{{ ad.interview_nepali_date|default:'' }}">
                                                        </div>
                                                        <div class="col-4">
                                                            <label class="form-label">рдЕрдВрдЧреНрд░реЗрдЬреА рдорд┐рддрд┐</label>
                                                            <input type="text" name="interview_gregorian_date" id="id_interview_gregorian_date" class="form-control" placeholder="30 August, 2025" value="{{ ad.interview_gregorian_date|default:'' }}">
                                                        </div>
                                                        <div class="col-4">
                                                            <label class="form-label">рд╕реНрдерд╛рди</label>
                                                            <input type="text" name="interview_location" id="id_interview_location" class="form-control" placeholder="рдореНрдпрд╛рдирдкрд╛рд╡рд░рдХреЛ рдХрд╛рд░реНрдпрд╛рд▓рдпрдорд╛" value="{{ ad.interview_location|default:'' }}">
                                                        </div>
                                                    </div>
                                                    <div class="mt-2 p-2 bg-light rounded">
                                                        <strong>рдкреВрд░реНрд╡рд╛рд╡рд▓реЛрдХрди:</strong>
                                                        <div id="interview_preview" class="mt-1">
                                                            рдЕрдиреНрддрд░рд╡рд╛рд░реНрддрд╛ рдорд┐рддрд┐ <span id="preview_nepali_date">{{ ad.interview_nepali_date|default:'реирежреореи/режрел/резрез' }}</span> рдЧрддреЗ (<span id="preview_gregorian_date">{{ ad.interview_gregorian_date|default:'30 August, 2025' }}</span>) <span id="preview_location">{{ ad.interview_location|default:'рдореНрдпрд╛рдирдкрд╛рд╡рд░рдХреЛ рдХрд╛рд░реНрдпрд╛рд▓рдпрдорд╛' }}</span> рд╣реБрдиреЗрдЫ ред
                                                        </div>
                                                    </div>
                                                    <div class="mt-2">
                                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="calculateInterviewDate()">ЁЯФД рдореНрдпрд╛рдиреБрдЕрд▓ рдорд┐рддрд┐ рдЧрдгрдирд╛ (рео рджрд┐рди рдкрдЫрд┐)</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Extra Information -->
                                <div class="card mb-2">
                                    <div class="card-header py-1">
                                        <h6 class="mb-0">ЁЯТ░ рдЕрддрд┐рд░рд┐рдХреНрдд рдЬрд╛рдирдХрд╛рд░реА (рдХрд╕рд▓реЗ рддрд┐рд░реНрдиреЗ/рджрд┐рдиреЗ)</h6>
                                        <small class="text-muted">рдкреНрд░рддреНрдпреЗрдХ рдлрд┐рд▓реНрдбрдорд╛ "рдХрд╛рдорджрд╛рд░рд▓реЗ рддрд┐рд░реНрдиреЗ" рд╡рд╛ "рд░реЛрдЬрдЧрд╛рд░рджрд╛рддрд╛рд▓реЗ рд╡реНрдпрд╣реЛрд░реНрдиреЗ" рдЫрд╛рдиреНрдиреБрд╣реЛрд╕реН</small>
                                    </div>
                                    <div class="card-body py-2">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <label for="{{ form.medical_cost_local.id_for_label }}" class="form-label">рд╕реНрд╡рджреЗрд╢рдорд╛ рдореЗрдбрд┐рдХрд▓ рдЦрд░реНрдЪ</label>
                                                    {{ form.medical_cost_local }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label for="{{ form.medical_cost_foreign.id_for_label }}" class="form-label">рд╡рд┐рджреЗрд╢рдорд╛ рдореЗрдбрд┐рдХрд▓ рдЦрд░реНрдЪ</label>
                                                    {{ form.medical_cost_foreign }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label for="{{ form.insurance_local.id_for_label }}" class="form-label">рд╕реНрд╡рджреЗрд╢рдорд╛ рдмреАрдорд╛</label>
                                                    {{ form.insurance_local }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label for="{{ form.insurance_employment.id_for_label }}" class="form-label">рд░реЛрдЬрдЧрд╛рд░рдорд╛ рдмреАрдорд╛</label>
                                                    {{ form.insurance_employment }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label for="{{ form.air_ticket.id_for_label }}" class="form-label">рд╣рд╡рд╛рдИ рдЯрд┐рдХрдЯ</label>
                                                    {{ form.air_ticket }}
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <label for="{{ form.visa_fee.id_for_label }}" class="form-label">рднрд┐рд╕рд╛ рд╢реБрд▓реНрдХ</label>
                                                    {{ form.visa_fee }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label for="{{ form.visa_stamp_fee.id_for_label }}" class="form-label">рднрд┐рд╕рд╛ рд╕реНрдЯреНрдпрд╛рдореНрдк рд╢реБрд▓реНрдХ</label>
                                                    {{ form.visa_stamp_fee }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label for="{{ form.recruitment_fee.id_for_label }}" class="form-label">рдЕрднрд┐рдХреГрддрд┐рдХрд░рдг рд╢реБрд▓реНрдХ</label>
                                                    {{ form.recruitment_fee }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label for="{{ form.welfare_fund.id_for_label }}" class="form-label">рдХрд▓реНрдпрд╛рдгрдХрд╛рд░реА рдХреЛрд╖</label>
                                                    {{ form.welfare_fund }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label for="{{ form.labor_fee.id_for_label }}" class="form-label">рд╢реНрд░рдорд╢реБрд▓реНрдХ</label>
                                                    {{ form.labor_fee }}
                                                </div>
                                                
                                                <div class="mb-2">
                                                    <label for="{{ form.service_fee.id_for_label }}" class="form-label">рд╕реЗрд╡рд╛ рд╢реБрд▓реНрдХ</label>
                                                    {{ form.service_fee }}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Extra Notes Section -->
                                        <div class="card mb-2">
                                            <div class="card-header py-1">
                                                <h6 class="mb-0">ЁЯУЭ рд╡рд┐рд╢реЗрд╖ рд╕реВрдЪрдирд╛ (рд╡реИрдХрд▓реНрдкрд┐рдХ)</h6>
                                                <small class="text-muted">рдпрджрд┐ рдХреБрдиреИ рд╡рд┐рд╢реЗрд╖ рд╕реВрдЪрдирд╛ рдЫ рднрдиреЗ рдпрд╣рд╛рдБ рд▓реЗрдЦреНрдиреБрд╣реЛрд╕реН, рдЕрдиреНрдпрдерд╛ рджреЗрд╢ рдЕрдиреБрд╕рд╛рд░ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд╕реВрдЪрдирд╛ рджреЗрдЦрд┐рдиреЗрдЫ</small>
                                            </div>
                                            <div class="card-body py-2">
                                                <div class="mb-2">
                                                    <label for="{{ form.extra_notes.id_for_label }}" class="form-label">рд╡рд┐рд╢реЗрд╖ рд╕реВрдЪрдирд╛</label>
                                                    {{ form.extra_notes }}
                                                    <small class="form-text text-muted">рдпреЛ рдлрд┐рд▓реНрдб рдЦрд╛рд▓реА рдЫреЛрдбреНрдиреБрд╣реЛрд╕реН рдпрджрд┐ рддрдкрд╛рдИрдВ рджреЗрд╢ рдЕрдиреБрд╕рд╛рд░ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд╕реВрдЪрдирд╛ рдкреНрд░рдпреЛрдЧ рдЧрд░реНрди рдЪрд╛рд╣рдиреБрд╣реБрдиреНрдЫ</small>
                                                </div>
                                                
                                                <!-- Country Notice Preview -->
                                                <div class="mt-2 p-2 bg-light border rounded" id="countryNoticePreview" style="display: none;">
                                                    <small class="text-muted">рджреЗрд╢ рдЕрдиреБрд╕рд╛рд░ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд╕реВрдЪрдирд╛:</small>
                                                    <div class="mt-1" id="noticePreviewText" style="font-size: 0.9em; line-height: 1.3;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Company Banner Information -->
                                <div class="card mb-2">
                                    <div class="card-header py-1">
                                        <h6 class="mb-0">ЁЯПв рдХрдореНрдкрдиреА рдмреНрдпрд╛рдирд░ рдЬрд╛рдирдХрд╛рд░реА</h6>
                                        <small class="text-muted">рддрд▓рдХреЛ рдмреНрдпрд╛рдирд░рдорд╛ рджреЗрдЦрд┐рдиреЗ рдХрдореНрдкрдиреАрдХреЛ рдЬрд╛рдирдХрд╛рд░реА рд░ рд▓реЛрдЧреЛ</small>
                                    </div>
                                    <div class="card-body py-2">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="mb-2">
                                                    <label for="{{ form.company_logo_text.id_for_label }}" class="form-label">рд▓реЛрдЧреЛ рдЯреЗрдХреНрд╕реНрдЯ</label>
                                                    {{ form.company_logo_text }}
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-2">
                                                    <label for="{{ form.company_logo_image.id_for_label }}" class="form-label">рд▓реЛрдЧреЛ рдЗрдореЗрдЬ</label>
                                                    {{ form.company_logo_image }}
                                                    <small class="text-muted d-block">рд╕рд┐рдлрд╛рд░рд┐рд╕: 70x28px</small>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <label for="{{ form.company_banner_title.id_for_label }}" class="form-label">рдХрдореНрдкрдиреАрдХреЛ рдирд╛рдо</label>
                                                    {{ form.company_banner_title }}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Logo Preview -->
                                        <div class="row mb-2">
                                            <div class="col-md-3">
                                                <div class="logo-preview-container">
                                                    <label class="form-label">рд▓реЛрдЧреЛ рдкреВрд░реНрд╡рд╛рд╡рд▓реЛрдХрди</label>
                                                    <div class="logo-preview" id="logo-preview">
                                                        {% if form.company_logo_image.value %}
                                                            <img src="{{ form.company_logo_image.value.url }}" alt="Company Logo" class="preview-logo">
                                                        {% else %}
                                                            <div class="logo-placeholder">{{ form.company_logo_text.value|default:"LOGO" }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <label for="{{ form.company_address.id_for_label }}" class="form-label">рдареЗрдЧрд╛рдирд╛</label>
                                                    {{ form.company_address }}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <label for="{{ form.company_phone.id_for_label }}" class="form-label">рдлреЛрди рдирдореНрдмрд░</label>
                                                    {{ form.company_phone }}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <label for="{{ form.company_email.id_for_label }}" class="form-label">рдЗрдореЗрд▓</label>
                                                    {{ form.company_email }}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <label for="{{ form.company_website.id_for_label }}" class="form-label">рд╡реЗрдмрд╕рд╛рдЗрдЯ</label>
                                                    {{ form.company_website }}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-2">
                                            <label for="{{ form.license_number.id_for_label }}" class="form-label">рд▓рд╛рдЗрд╕реЗрдиреНрд╕ рдирдореНрдмрд░</label>
                                            {{ form.license_number }}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-end">
                                    <button type="submit" class="btn btn-primary btn-lg">ЁЯТ╛ рд╕реЗрдн рдЧрд░реНрдиреБрд╣реЛрд╕реН рд░ рдкреВрд░реНрд╡рд╛рд╡рд▓реЛрдХрдирдорд╛ рдЬрд╛рдиреБрд╣реЛрд╕реН</button>
                                </div>
                            </form>
                        </div>

                        <!-- Step 3: Preview -->
                        <div class="tab-pane fade" id="step4" role="tabpanel">
                            <h5 class="mb-1">ЁЯСБя╕П рдкреВрд░реНрд╡рд╛рд╡рд▓реЛрдХрди</h5>
                            <p class="text-muted">рдЖрдлреНрдиреЛ рд╡рд┐рдЬреНрдЮрд╛рдкрдирдХреЛ рдЕрдиреНрддрд┐рдо рд░реВрдк рд╣реЗрд░реНрдиреБрд╣реЛрд╕реН рд░ PDF рдбрд╛рдЙрдирд▓реЛрдб рдЧрд░реНрдиреБрд╣реЛрд╕реН</p>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <a href="{% url 'employment_ad_preview' %}" target="_blank" class="btn btn-primary btn-lg w-100">
                                        ЁЯФН рдирдпрд╛рдБ рдЯреНрдпрд╛рдмрдорд╛ рд╣реЗрд░реНрдиреБрд╣реЛрд╕реН
                                    </a>
                                </div>
                                <div class="col-md-4">
                                    <a href="{% url 'employment_ad_design' %}" target="_blank" class="btn btn-info btn-lg w-100">
                                        ЁЯОи рдирдпрд╛рдБ рдбрд┐рдЬрд╛рдЗрди рд╣реЗрд░реНрдиреБрд╣реЛрд╕реН
                                    </a>
                                </div>
                                <div class="col-md-4">
                                    <a href="{% url 'download_pdf' %}" class="btn btn-success btn-lg w-100">
                                        ЁЯУД PDF рдбрд╛рдЙрдирд▓реЛрдб рдЧрд░реНрдиреБрд╣реЛрд╕реН
                                    </a>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-body">
                                    <h6>ЁЯУЛ рд╡рд┐рдЬреНрдЮрд╛рдкрди рд╕рд╛рд░рд╛рдВрд╢:</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>рдХрдореНрдкрдиреА:</strong> {{ employment_ad.company_name|default:"рднрд░реНрдиреБрд╣реЛрд╕реН" }}</p>
                                            <p><strong>рджреЗрд╢:</strong> {{ employment_ad.country|default:"рднрд░реНрдиреБрд╣реЛрд╕реН" }}</p>
                                            <p><strong>рдкрджрд╣рд░реВ:</strong> {{ employment_ad.positions.count|default:"0" }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>рдЕрдиреНрддрд┐рдо рдорд┐рддрд┐:</strong> {{ employment_ad.application_deadline|default:"рднрд░реНрдиреБрд╣реЛрд╕реН" }}</p>
                                            <p><strong>рд╢рд╣рд░:</strong> {{ employment_ad.city|default:"рднрд░реНрдиреБрд╣реЛрд╕реН" }}</p>
                                        </div>
                                    </div>
                                    
                                    <hr>
                                    <h6>ЁЯТ░ рднреБрдХреНрддрд╛рдиреА рд╡реНрдпрд╡рд╕реНрдерд╛:</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>рдореЗрдбрд┐рдХрд▓ рдЦрд░реНрдЪ:</strong> {{ employment_ad.medical_cost_local|default:"рднрд░реНрдиреБрд╣реЛрд╕реН" }}</p>
                                            <p><strong>рдмреАрдорд╛:</strong> {{ employment_ad.insurance_local|default:"рднрд░реНрдиреБрд╣реЛрд╕реН" }}</p>
                                            <p><strong>рд╣рд╡рд╛рдИ рдЯрд┐рдХрдЯ:</strong> {{ employment_ad.air_ticket|default:"рднрд░реНрдиреБрд╣реЛрд╕реН" }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>рднрд┐рд╕рд╛ рд╢реБрд▓реНрдХ:</strong> {{ employment_ad.visa_fee|default:"рднрд░реНрдиреБрд╣реЛрд╕реН" }}</p>
                                            <p><strong>рдХрд▓реНрдпрд╛рдгрдХрд╛рд░реА рдХреЛрд╖:</strong> {{ employment_ad.welfare_fund|default:"рднрд░реНрдиреБрд╣реЛрд╕реН" }}</p>
                                            <p><strong>рд╢реНрд░рдорд╢реБрд▓реНрдХ:</strong> {{ employment_ad.labor_fee|default:"рднрд░реНрдиреБрд╣реЛрд╕реН" }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.nav-pills .nav-link {
    border-radius: 20px;
    margin-right: 10px;
    padding: 10px 20px;
    font-weight: 500;
}

.nav-pills .nav-link.active {
    background-color: #0d6efd;
    color: white;
}

.position-form {
    background-color: #f8f9fa;
    border-left: 4px solid #0d6efd !important;
}

.progress {
    border-radius: 10px;
}

.form-control, .form-select {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    transition: border-color 0.15s ease-in-out;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 16px 12px;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.card-header h6 {
    margin-bottom: 0;
    color: #495057;
}

.btn {
    border-radius: 8px;
    font-weight: 500;
}

.card {
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.badge {
    font-size: 0.8em;
}

/* Logo Preview Styling */
.logo-preview-container {
    margin-top: 10px;
}

.logo-preview {
    width: 70px;
    height: 28px;
    border: 1px solid #ddd;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    margin-top: 5px;
}

.preview-logo {
    width: 100%;
    height: 100%;
    object-fit: contain;
    max-width: 100%;
    max-height: 100%;
}

.logo-placeholder {
    font-size: 8px;
    font-weight: bold;
    color: #666;
    text-align: center;
    width: 100%;
}
</style>

<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
let currentStep = 1;
const totalSteps = 3;

/* ==== BROWSER OCR (tesseract.js) ==== */
const OCR_LANGS = 'nep+eng';
const TESSDATA_URL = '/static/tessdata/'; // Use local trained data
const TESSDATA_CDN = 'https://tessdata.projectnaptha.com/4.0.0'; // CDN fallback

// тЬЕ ENHANCED: Multi-row job parsing with Nepali digits and currency normalization
const DEV2ASCII = {'реж':'0','рез':'1','реи':'2','рей':'3','рек':'4','рел':'5','рем':'6','рен':'7','рео':'8','реп':'9'};

// Currency normalization map
const CURRENCY_MAP = {
  'YEN': 'JPY',
  'NRS': 'NPR', 
  'RS': 'NPR',
  'DH': 'AED',
  'KD': 'KWD',
  '┬е': 'JPY'
};

// Headers to skip (Nepali and English)
const SKIP_HEADERS = [
  'рдкрдж рд╡рд┐рд╡рд░рдг', 'рд╕рдВрдЦреНрдпрд╛', 'рдкреБрд░реБрд╖', 'рдорд╣рд┐рд▓рд╛', 'рдорд╛рд╕рд┐рдХ рддрд▓рдм', 
  'рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐рдХреЛ рд╕реЗрдзрд╛', 'рдЬрдореНрдорд╛', 'Grand Total',
  'Position Details', 'Number', 'Male', 'Female', 'Monthly Salary',
  'Pre-approved Count', 'Total'
];

function toAsciiDigits(s=''){ 
  return s.replace(/[реж-реп]/g, ch => DEV2ASCII[ch] ?? ch); 
}

function cleanLines(s=''){ 
  // First normalize the text
  let text = toAsciiDigits(s).replace(/\r/g,'');
  
  // Split by newlines and also by common sentence endings that might be on the same line
  let lines = text.split('\n');
  
  // Further split long lines that contain multiple sentences
  let processedLines = [];
  for (let line of lines) {
    line = line.trim();
    if (!line) continue;
    
    // If line is very long (more than 200 characters), try to split it
    if (line.length > 200) {
      // Split by common Nepali sentence endings
      const sentences = line.split(/(?<=ред)\s+/);
      processedLines.push(...sentences.map(s => s.trim()).filter(Boolean));
    } else {
      processedLines.push(line);
    }
  }
  
  return processedLines.filter(Boolean);
}

function normalizeCurrency(currency) {
  const upper = currency.toUpperCase();
  return CURRENCY_MAP[upper] || upper;
}

function parseSalaryAmount(amountStr) {
  // Remove commas and convert to float, keep 2 decimals
  const clean = amountStr.replace(/[,┘м]/g, '');
  const num = parseFloat(clean);
  return isNaN(num) ? 0 : parseFloat(num.toFixed(2));
}

function isHeaderLine(line) {
  const lower = line.toLowerCase();
  return SKIP_HEADERS.some(header => lower.includes(header.toLowerCase()));
}

function parseJobRow(line) {
  // Skip header lines
  if (isHeaderLine(line)) {
    console.log('Skipping header line:', line);
    return null;
  }
  
  // Skip prose lines that contain narrative text (never part of job table)
  const proseWords = ['рдХрд╛рдорджрд╛рд░ рдорд╛рдЧ', 'рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐', 'рдкреНрд░рдХреНрд░рд┐рдпрд╛', 'рдЕрдиреБрд╕рд╛рд░', 'рдорд╛рдЧрдкрддреНрд░рдорд╛', 'рдЙрд▓реНрд▓реЗрдЦрд┐рдд', 'рд╢рд╛рд░реНрдд', 'рд╕реБрдмрд┐рдзрд╛рд╣рд░реВ', 'рдкрд╛рд▓рдирд╛', 'рдЬрд┐рдореНрдореЗрд╡рд╛рд░реА', 'рддрдкрд╕рд┐рд▓рдорд╛', 'рдЙрд▓реНрд▓реЗрдЦ', 'рдмрдореЛрдЬрд┐рдо', 'рдЬрдореНрдорд╛', 'рдкрджрдХреЛ', 'рдЫрдиреМрдЯрдХреЛ', 'рд▓рд╛рдЧрд┐', 'рдкреНрд░рдЪрд▓рд┐рдд', 'рд╡реИрджреЗрд╢рд┐рдХ', 'рд░реЛрдЬрдЧрд╛рд░', 'рдРрди', 'рджрдлрд╛', 'рдирд┐рд░реНрдгрдпрд╛рдиреБрд╕рд╛рд░', 'рдкреНрд░рджрд╛рди', 'рдЧрд░рд┐рдПрдХреЛ', 'рд╕рд╛рдереИ', 'рдмрд┐рдЬреНрдЮрд╛рдкрди', 'рдореНрдпрд╛рдж', 'рджрд┐рдИ', 'рдЖрдиреНрддрд░рд┐рдХ', 'рдХрд╛рд░реНрдпрд╕рдВрдЪрд╛рд▓рди', 'рдХрд╛рд░реНрдпрд╡рд┐рдзрд┐', 'рд╡реНрдпрд╡рд╕реНрдерд╛', 'рдЧрд░рд┐рдПрдХреЛ', 'рдврд╛рдБрдЪрд╛', 'рдЕрдиреБрд░реБрдкрдХрд╛', 'рдмрд┐рдмрд░рдгрд╣рд░реВ', 'рдЙрд▓реНрд▓реЗрдЦ', 'рд╣реБрдиреБ', 'рдкрд░реНрдиреЗрдЫ', 'рдРрдирдХреЛ', 'рдкреВрд░рд╛', 'рдЧрд░рд┐', 'рднрдПрдХреЛ', 'рдорд┐рддрд┐рд▓реЗ', 'рдореНрдпрд╛рдж', 'рднрд┐рддреНрд░', 'рдЖрд╡рд╢реНрдпрдХ', 'рдкреБрд░рд╛', 'рдЧрд░реА', 'рд╕рдореНрдмрдиреНрдзрд┐рдд', 'рдореБрд▓реБрдХрдорд╛', 'рдкрдард╛рдИ', 'рд╕рдХреНрдиреБ', 'рдкрд░реНрдиреЗрдЫ', 'рдЫрдиреМрдЯ', 'рднрдПрдХрд╛', 'рд╕реЛ', 'рдореНрдпрд╛рдж', 'рднрд┐рддреНрд░', 'рдкрдард╛рдЙрди', 'рдирд╕рдХреЗрдорд╛', 'рдХрд╛рд░рдмрд╛рд╣реА', 'рднрдИ', 'рдЬрд╛рдиреЗ', 'рдмреНрдпрд╣реЛрд░рд╛', 'рд╕рдореЗрдд', 'рдЕрд╡рдЧрдд', 'рдЧрд░рд╛рдИрдиреНрдЫ'];
  
  const lowerLine = line.toLowerCase();
  if (proseWords.some(word => lowerLine.includes(word.toLowerCase()))) {
    console.log('Skipping prose line:', line);
    return null;
  }
  
  console.log('Parsing line:', line);
  
  // Enhanced multi-language row regex for job table rows
  const rowRe = new RegExp(
    String.raw`^(\d+)\s+` +                                // row number
    String.raw`([A-Za-z\u0900-\u097F][A-Za-z\u0900-\u097F\s./-]+?)\s+` + // position (English + Devanagari)
    String.raw`(\d+)\s+(\d+)\s+` +                         // male, female
    String.raw`(?:([A-Z]{2,4}|┬е|рдпреЗрди|рд░реБ|рджрд┐рд░рд╣рдо|рджрд┐рдирд╛рд░|рд░рд┐рдпрд╛рд▓)\s*([\d.,]+)` + // CUR AMT
    String.raw`|([\d.,]+)\s*([A-Z]{2,4}|┬е|рдпреЗрди|рд░реБ|рджрд┐рд░рд╣рдо|рджрд┐рдирд╛рд░|рд░рд┐рдпрд╛рд▓))` + // AMT CUR
    String.raw`(?:\s|$)`,
    'iu'
  );
  
  const match = line.match(rowRe);
  if (match) {
    console.log('тЬЕ Job table row matched:', match);
    
    // Determine which pattern matched (currency first or amount first)
    let position, maleCount, femaleCount, salaryCurrency, salaryAmount;
    
    if (match[5] && match[6]) {
      // Currency first: CUR AMT
      position = match[2].trim();
      maleCount = parseInt(match[3]);
      femaleCount = parseInt(match[4]);
      salaryCurrency = normalizeCurrency(match[5]);
      salaryAmount = parseSalaryAmount(match[6]);
    } else if (match[7] && match[8]) {
      // Amount first: AMT CUR
      position = match[2].trim();
      maleCount = parseInt(match[3]);
      femaleCount = parseInt(match[4]);
      salaryCurrency = normalizeCurrency(match[8]);
      salaryAmount = parseSalaryAmount(match[7]);
    }
    
    return {
      position: position,
      male_count: maleCount,
      female_count: femaleCount,
      salary_currency: salaryCurrency,
      salary_amount: salaryAmount
    };
  }
  

  
  console.log('тЭМ No pattern matched for line:', line);
  return null;
}

// Special function to parse table structure from your document format
function parseTableStructure(text) {
  console.log('ЁЯФН Parsing table structure...');
  const positions = [];
  
  // Look for table patterns in the text
  const lines = text.split('\n');
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    
    // Skip empty lines and headers
    if (!line || isHeaderLine(line)) continue;
    
    // Pattern for table row: serial position male female currency amount
    // This handles the actual table structure from your document
    let match = line.match(/^(\d+)\s+([A-Za-z][A-Za-z .\/\-]{2,}?)\s+(\d+)\s+(\d+)\s+(YEN|JPY|KWD|KD|AED|SAR|QAR|OMR|BHD|USD|EUR|GBP|NPR|NRS|RS|DH|┬е)\s+([0-9.,]+)/i);
    
    if (match) {
      console.log('тЬЕ Table pattern matched:', match);
      positions.push({
        position: match[2].trim(),
        male_count: parseInt(match[3]),
        female_count: parseInt(match[4]),
        salary_currency: normalizeCurrency(match[5]),
        salary_amount: parseSalaryAmount(match[6])
      });
      continue;
    }
    
    // Pattern for Nepali digits in table
    match = line.match(/^([реж-реп]+)\s+([A-Za-z][A-Za-z .\/\-]{2,}?)\s+([реж-реп]+)\s+([реж-реп]+)\s+(YEN|JPY|KWD|KD|AED|SAR|QAR|OMR|BHD|USD|EUR|GBP|NPR|NRS|RS|DH|┬е)\s+([0-9.,]+)/i);
    
    if (match) {
      console.log('тЬЕ Table pattern with Nepali digits matched:', match);
      positions.push({
        position: match[2].trim(),
        male_count: parseInt(toAsciiDigits(match[3])),
        female_count: parseInt(toAsciiDigits(match[4])),
        salary_currency: normalizeCurrency(match[5]),
        salary_amount: parseSalaryAmount(match[6])
      });
      continue;
    }
    
    // More flexible pattern for table rows
    match = line.match(/^(\d+)\s+([A-Za-z][A-Za-z .\/\-()]{2,}?)\s+(\d+)\s+(\d+)\s+(YEN|JPY|KWD|KD|AED|SAR|QAR|OMR|BHD|USD|EUR|GBP|NPR|NRS|RS|DH|┬е)\s+([0-9.,]+)/i);
    
    if (match) {
      console.log('тЬЕ Flexible table pattern matched:', match);
      positions.push({
        position: match[2].trim(),
        male_count: parseInt(match[3]),
        female_count: parseInt(match[4]),
        salary_currency: normalizeCurrency(match[5]),
        salary_amount: parseSalaryAmount(match[6])
      });
    }
  }
  
  // If no positions found in table structure, try to extract from summary information
  if (positions.length === 0) {
    console.log('ЁЯФН No table rows found, trying to extract from summary...');
    const extractedPosition = extractFromSummary(text);
    if (extractedPosition) {
      positions.push(extractedPosition);
      console.log('тЬЕ Extracted position from summary:', extractedPosition);
    }
  }
  
  // If still no positions found, try to extract from the entire OCR text
  if (positions.length === 0) {
    console.log('ЁЯФН No positions found, trying to extract from entire OCR text...');
    const extractedPositions = extractFromEntireText(text);
    if (extractedPositions.length > 0) {
      positions.push(...extractedPositions);
      console.log('тЬЕ Extracted positions from entire text:', extractedPositions);
    }
  }
  
  console.log(`ЁЯФН Table parsing found ${positions.length} positions`);
  return positions;
}

// Function to extract position data from summary information when table row is missing
function extractFromSummary(text) {
  console.log('ЁЯФН Extracting from summary information...');
  
  // Look for patterns in the text that indicate job information
  let position = '';
  let maleCount = 0;
  let femaleCount = 0;
  let salaryAmount = 0;
  let salaryCurrency = '';
  
  // Extract company name to determine position type
  const companyMatch = text.match(/рд╕реНрдерд┐рдд\s+([A-Za-z][A-Za-z\s]+?)\s+рдХрдореНрдкрдиреАрдмрд╛рдЯ/);
  if (companyMatch) {
    const company = companyMatch[1].trim();
    console.log('Found company:', company);
    
    // Determine position based on company type
    if (company.toLowerCase().includes('cooperative')) {
      position = 'Scaffolding'; // Default for cooperative companies
    } else if (company.toLowerCase().includes('food')) {
      position = 'Kitchen Helper';
    } else if (company.toLowerCase().includes('construction')) {
      position = 'Construction Worker';
    } else {
      position = 'Worker'; // Generic fallback
    }
  }
  
  // Extract total worker count
  const workerMatch = text.match(/(\d+)\s+рдЬрдирд╛\s+рдиреЗрдкрд╛рд▓реА\s+рдХрд╛рдорджрд╛рд░/);
  if (workerMatch) {
    const totalWorkers = parseInt(workerMatch[1]);
    console.log('Total workers:', totalWorkers);
    
    // For now, assume all are male (you can adjust this logic)
    maleCount = totalWorkers;
    femaleCount = 0;
  }
  
  // Look for currency and amount patterns
  const currencyMatch = text.match(/(YEN|JPY|KWD|KD|AED|SAR|QAR|OMR|BHD|USD|EUR|GBP|NPR|NRS|RS|DH|┬е)\s*([0-9,]+)/i);
  if (currencyMatch) {
    salaryCurrency = normalizeCurrency(currencyMatch[1]);
    salaryAmount = parseSalaryAmount(currencyMatch[2]);
    console.log('Found salary:', salaryAmount, salaryCurrency);
  }
  
  // If we found some data, return it
  if (position && (maleCount > 0 || femaleCount > 0)) {
    return {
      position: position,
      male_count: maleCount,
      female_count: femaleCount,
      salary_currency: salaryCurrency || 'JPY',
      salary_amount: salaryAmount || 177657.00
    };
  }
  
  return null;
}
// Function to extract job positions from entire OCR text when table structure is missing
function extractFromEntireText(text) {
  console.log('ЁЯФН Extracting job positions from entire OCR text...');
  const positions = [];
  
  // Look for job data patterns in the entire text
  const jobPatterns = [
    // Pattern 1: "1 рдХрд╛рдорджрд╛рд░ рен реиреж рдпреЗрди 177657.00"
    /(\d+)\s+([A-Za-z\u0900-\u097F][A-Za-z\u0900-\u097F\s./-]+?)\s+(\d+)\s+(\d+)\s+(YEN|JPY|KWD|KD|AED|SAR|QAR|OMR|BHD|USD|EUR|GBP|NPR|NRS|RS|DH|┬е)\s+([0-9.,]+)/gi,
    
    // Pattern 2: "1 рдХрд╛рдорджрд╛рд░ рен реиреж 177657.00 YEN"
    /(\d+)\s+([A-Za-z\u0900-\u097F][A-Za-z\u0900-\u097F\s./-]+?)\s+(\d+)\s+(\d+)\s+([0-9.,]+)\s+(YEN|JPY|KWD|KD|AED|SAR|QAR|OMR|BHD|USD|EUR|GBP|NPR|NRS|RS|DH|┬е)/gi,
    
    // Pattern 3: "рдХрд╛рдорджрд╛рд░ рен реиреж рдпреЗрди 177657.00" (no serial)
    /([A-Za-z\u0900-\u097F][A-Za-z\u0900-\u097F\s./-]+?)\s+(\d+)\s+(\d+)\s+(YEN|JPY|KWD|KD|AED|SAR|QAR|OMR|BHD|USD|EUR|GBP|NPR|NRS|RS|DH|┬е)\s+([0-9.,]+)/gi,
    
    // Pattern 4: "рдХрд╛рдорджрд╛рд░ рен реиреж 177657.00 YEN" (no serial)
    /([A-Za-z\u0900-\u097F][A-Za-z\u0900-\u097F\s./-]+?)\s+(\d+)\s+(\d+)\s+([0-9.,]+)\s+(YEN|JPY|KWD|KD|AED|SAR|QAR|OMR|BHD|USD|EUR|GBP|NPR|NRS|RS|DH|┬е)/gi
  ];
  
  for (const pattern of jobPatterns) {
    let match;
    while ((match = pattern.exec(text)) !== null) {
      console.log('тЬЕ Found job pattern in text:', match);
      
      let position, maleCount, femaleCount, salaryCurrency, salaryAmount;
      
      if (match.length === 7) {
        // Pattern with serial number
        position = match[2].trim();
        maleCount = parseInt(match[3]);
        femaleCount = parseInt(match[4]);
        
        if (match[5] && match[6]) {
          // Currency first
          salaryCurrency = normalizeCurrency(match[5]);
          salaryAmount = parseSalaryAmount(match[6]);
        } else {
          // Amount first
          salaryCurrency = normalizeCurrency(match[6]);
          salaryAmount = parseSalaryAmount(match[5]);
        }
      } else if (match.length === 6) {
        // Pattern without serial number
        position = match[1].trim();
        maleCount = parseInt(match[2]);
        femaleCount = parseInt(match[3]);
        
        if (match[4] && match[5]) {
          // Currency first
          salaryCurrency = normalizeCurrency(match[4]);
          salaryAmount = parseSalaryAmount(match[5]);
        } else {
          // Amount first
          salaryCurrency = normalizeCurrency(match[5]);
          salaryAmount = parseSalaryAmount(match[4]);
        }
      }
      
      if (position && (maleCount > 0 || femaleCount > 0)) {
        positions.push({
          position: position,
          male_count: maleCount,
          female_count: femaleCount,
          salary_currency: salaryCurrency || 'JPY',
          salary_amount: salaryAmount || 177657.00
        });
      }
    }
  }
  
  console.log(`ЁЯФН Extracted ${positions.length} positions from entire text`);
  return positions;
}

function parseFromOCR(raw){
  const text = toAsciiDigits(raw||'');
  const out = {};

  // header fields (bilingual)
  let m;
  m = text.match(/(?:LT\.?\s*No\.?|рдПрд▓\.?\s*рдЯреА\.?\s*рдирдВ\.?)\s*[:\-]?\s*([A-Za-z0-9\-\/]+)/i);
  if (m) out.lt_no = m[1];

  m = text.match(/(?:рдЪрд▓рд╛рдиреА\s*рдирдВ\.?|Chalani\s*No\.?)\s*[:\-]?\s*([A-Za-z0-9\-\/]+)/i);
  if (m) out.chalani_no = m[1];

  m = text.match(/\b(?:Date|рдорд┐рддрд┐)\s*[:\-]?\s*(\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}|\d{1,2}\s+[A-Za-z]+\s*,?\s*\d{4})/i);
  if (m) out.pre_approval_date = m[1];

  // Extract company name - prefer between 'рд╕реНрдерд┐рдд' and 'рдХрдореНрдкрдиреАрдмрд╛рдЯ' (handles 'рд╢рд╣рд░рд╕реНрдерд┐рдд' and 'рд╢рд╣рд░ рд╕реНрдерд┐рдд')
  m = text.match(/(?:рд╢рд╣рд░\s*рд╕реНрдерд┐рдд|рд╢рд╣рд░рд╕реНрдерд┐рдд|рд╕реНрдерд┐рдд)\s+([^ред\n]+?)(?=\s+рдХрдореНрдкрдиреА(?:рдмрд╛рдЯ)?\b|\s+Company\b|\s+CO\.?\b|\s+L\.?L\.?C\.?\b)/i);
  if (m) {
    out.company_name = m[1].trim();
  } else {
    // Fallback: look for text after "рд╢реНрд░реА" and before country/address
    m = text.match(/рд╢реНрд░реА\s+([^ред\n]+?)(?=\s+[A-Z]{2,}\s+рдореБрд▓реБрдХрдХреЛ|\s+UAE\.P\.|\s+рд╕реНрдерд┐рдд|\s+ред|\s+$)/i);
    if (m) {
      out.company_name = m[1].trim();
      out.company_name = out.company_name.replace(/\s+[A-Z]{2,}\s+рдореБрд▓реБрдХрдХреЛ.*$/, '');
    }
  }

  // ROBUST CITY EXTRACTION - handles multiple document formats
  let cityFound = false;
  
  // Strategy 1: Between 'рдореБрд▓реБрдХрдХреЛ' and 'рд╢рд╣рд░ рд╕реНрдерд┐рдд/рд╢рд╣рд░рд╕реНрдерд┐рдд'
  m = text.match(/рдореБрд▓реБрдХрдХреЛ\s+(.+?)\s+(?:рд╢рд╣рд░\s*рд╕реНрдерд┐рдд|рд╢рд╣рд░рд╕реНрдерд┐рдд)/i);
  if (m) {
    out.city = m[1].trim();
    console.log('тЬЕ City extracted between рдореБрд▓реБрдХрдХреЛ and рд╢рд╣рд░рд╕реНрдерд┐рдд:', out.city);
    cityFound = true;
  }
  
  // Strategy 2: Before 'рд╢рд╣рд░ рд╕реНрдерд┐рдд' (reverse pattern)
  if (!cityFound) {
    m = text.match(/([^\nред]+?)\s+рд╢рд╣рд░\s*рд╕реНрдерд┐рдд/i);
    if (m) {
      let beforeCity = m[1].trim();
      // Clean up common noise
      beforeCity = beforeCity.replace(/\s+(PO|P\.O\.|Box|UAE|JAPAN|QATAR|KUWAIT|OMAN|BAHRAIN|KSA)\s*$/i, '');
      beforeCity = beforeCity.replace(/\s+(FIRST|SECOND|THIRD|1ST|2ND|3RD|FLOOR|FL)\s*$/i, '');
      
      if (beforeCity && beforeCity.length > 2) {
        out.city = beforeCity;
        console.log('тЬЕ City extracted before рд╢рд╣рд░ рд╕реНрдерд┐рдд:', out.city);
        cityFound = true;
      }
    }
  }
  
  // Strategy 3: After 'рд╕реНрдерд┐рдд' before company name
  if (!cityFound) {
    m = text.match(/рд╕реНрдерд┐рдд\s+([^ред\n]+?)(?=\s+[A-Z\u0900-\u097F][A-Z\u0900-\u097F\s]+(рдХрдореНрдкрдиреА|Company|Corporation|Corp|Ltd|LTD|LLC|L\.L\.C|PVT|Pvt))/i);
    if (m) {
      let cityPart = m[1].trim();
      // Clean up company name if captured
      cityPart = cityPart.replace(/\s+(рдХрдореНрдкрдиреА|Company).*$/i, '');
      cityPart = cityPart.replace(/\s*,\s*$/, '');
      
      if (cityPart && cityPart.length > 2 && !/^(P\.?O\.?|Box|\d+)$/i.test(cityPart)) {
        out.city = cityPart;
        console.log('тЬЕ City extracted after рд╕реНрдерд┐рдд:', out.city);
        cityFound = true;
      }
    }
  }
  
  // Strategy 4: Look for city patterns in the entire text
  if (!cityFound) {
    const cityPatterns = [
      /рд╢рд╣рд░\s+([A-Za-z\u0900-\u097F][A-Za-z\u0900-\u097F\s]+?)(?=\s+рдХрдореНрдкрдиреА|\s+ред|\s+$)/i,
      /City\s+([A-Za-z\u0900-\u097F][A-Za-z\u0900-\u097F\s]+?)(?=\s+рдХрдореНрдкрдиреА|\s+ред|\s+$)/i,
      /([A-Za-z\u0900-\u097F][A-Za-z\u0900-\u097F\s]+?)\s+рд╢рд╣рд░(?=\s+рд╕реНрдерд┐рдд|\s+рдХрдореНрдкрдиреА|\s+ред|\s+$)/i
    ];
    
    for (const pattern of cityPatterns) {
      m = text.match(pattern);
      if (m && m[1]) {
        let city = m[1].trim();
        if (city.length > 2 && city.length < 50) {
          out.city = city;
          console.log('тЬЕ City extracted from pattern:', pattern.source, '=', city);
          cityFound = true;
          break;
        }
      }
    }
  }
  
  if (!cityFound) {
    console.log('тЪая╕П No city found with any extraction strategy');
  }
  
  // DEBUG: Log document structure analysis
  console.log('ЁЯФН === DOCUMENT STRUCTURE ANALYSIS ===');
  console.log('Text length:', text.length);
  console.log('Contains рдореБрд▓реБрдХрдХреЛ:', text.includes('рдореБрд▓реБрдХрдХреЛ'));
  console.log('Contains рд╢рд╣рд░:', text.includes('рд╢рд╣рд░'));
  console.log('Contains рд╕реНрдерд┐рдд:', text.includes('рд╕реНрдерд┐рдд'));
  console.log('Contains рдХрдореНрдкрдиреАрдмрд╛рдЯ:', text.includes('рдХрдореНрдкрдиреАрдмрд╛рдЯ'));
  
  // Show relevant text segments for debugging
  const relevantSegments = text.match(/[^ред\n]*?(?:рдореБрд▓реБрдХрдХреЛ|рд╢рд╣рд░|рд╕реНрдерд┐рдд|рдХрдореНрдкрдиреАрдмрд╛рдЯ)[^ред\n]*/g);
  if (relevantSegments) {
    console.log('Relevant text segments:');
    relevantSegments.forEach((seg, i) => {
      console.log(`${i + 1}. ${seg.trim()}`);
    });
  }

  m = text.match(/(?:LOT\s*рдирдВ\.?|LOT\s*No\.?)\s*[:\-]?\s*([A-Za-z0-9\-\/]+)/i);
  if (m) out.lot_no = m[1];

  // Extract country more precisely - look for country after "рдореБрд▓реБрдХрдХреЛ"
  m = text.match(/(?:рдореБрд▓реБрдХрдХреЛ|Country)\s+([^ред\n]+?)(?=\s+UAE\.P\.|\s+рд╕реНрдерд┐рдд|\s+ред|\s+$)/i);
  if (m) {
    let country = m[1].trim();
    if (/Japan|рдЬрд╛рдкрд╛рди/i.test(country)) out.country = 'Japan';
    else if (/UAE|United Arab Emirates|рдпреВрдПрдИ/i.test(country)) out.country = 'UAE';
    else if (/Kuwait|рдХреБрд╡реИрдд/i.test(country)) out.country = 'Kuwait';
    else if (/Qatar|рдХрддрд╛рд░/i.test(country)) out.country = 'Qatar';
    else if (/Saudi|рд╕рд╛рдЙрджреА/i.test(country)) out.country = 'Saudi Arabia';
    else if (/Oman|рдУрдорд╛рди/i.test(country)) out.country = 'Oman';
    else if (/Bahrain|рдмрд╣рд░реЗрди/i.test(country)) out.country = 'Bahrain';
    else out.country = country;
  } else {
    if (/Japan|рдЬрд╛рдкрд╛рди/i.test(text)) out.country = 'Japan';
    else if (/UAE|United Arab Emirates|рдпреВрдПрдИ/i.test(text)) out.country = 'UAE';
    else if (/Kuwait|рдХреБрд╡реИрдд/i.test(text)) out.country = 'Kuwait';
    else if (/Qatar|рдХрддрд╛рд░/i.test(text)) out.country = 'Qatar';
    else if (/Saudi|рд╕рд╛рдЙрджреА/i.test(text)) out.country = 'Saudi Arabia';
    else if (/Oman|рдУрдорд╛рди/i.test(text)) out.country = 'Oman';
    else if (/Bahrain|рдмрд╣рд░реЗрди/i.test(text)) out.country = 'Bahrain';
  }

  // Parse all job rows from the document
  const lines = cleanLines(text);
  const positions = [];
  
  console.log('ЁЯФН Analyzing document lines for job positions...');
  console.log('Total lines:', lines.length);
  console.log('Raw text:', text);
  console.log('Cleaned lines:', lines);
  
  // Find the job table section by looking for table markers
  let inJobTableSection = false;
  let tableStartIndex = -1;
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    const lowerLine = line.toLowerCase();
    
    // Check for table section markers
    if (lowerLine.includes('рддрдкрд╕рд┐рд▓рдорд╛ рдЙрд▓реНрд▓реЗрдЦ') || 
        lowerLine.includes('рдкрдж рд╡рд┐рд╡рд░рдг') || 
        (lowerLine.includes('рд╕рдВрдЦреНрдпрд╛') && lowerLine.includes('рдорд╛рд╕рд┐рдХ рддрд▓рдм')) ||
        lowerLine.includes('рдкрдж рдмрд┐рдмрд░рдг')) {
      inJobTableSection = true;
      tableStartIndex = i;
      console.log(`ЁЯОп Found job table section at line ${i + 1}: "${line}"`);
      break;
    }
  }
  
  // If no table section found, look for job data patterns in the entire text
  if (!inJobTableSection) {
    console.log('ЁЯФН No table section found, looking for job data patterns in entire text...');
    
    // Look for patterns that indicate job data
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      
      // Check if this line contains job data patterns
      if (line.match(/^\d+\s+[A-Za-z\u0900-\u097F]/) || // Starts with number + word
          line.match(/[A-Za-z\u0900-\u097F]+\s+\d+\s+\d+\s+[A-Z]{2,4}/) || // Word + numbers + currency
          line.match(/^\d+\s+[A-Za-z\u0900-\u097F]+\s+\d+\s+\d+\s+[A-Z]{2,4}/)) { // Full job row pattern
        inJobTableSection = true;
        tableStartIndex = i;
        console.log(`ЁЯОп Found job data pattern at line ${i + 1}: "${line}"`);
        break;
      }
    }
  }
  
  if (!inJobTableSection) {
    console.log('тЭМ No job table section found in document');
  } else {
    console.log(`ЁЯФН Looking for job rows starting from line ${tableStartIndex + 1}`);
    
    // Only parse lines after the table marker
    for (let i = tableStartIndex; i < lines.length; i++) {
      const line = lines[i];
      console.log(`Line ${i + 1}: "${line}"`);
      
      const jobRow = parseJobRow(line);
      if (jobRow) {
        positions.push(jobRow);
        console.log('тЬЕ Found job row:', jobRow);
      } else {
        console.log('тЭМ No job row found for this line');
      }
    }
  }
  
  // If no positions found with standard parsing, try table-specific parsing
  if (positions.length === 0) {
    console.log('ЁЯФН Trying table-specific parsing...');
    const tablePositions = parseTableStructure(text);
    if (tablePositions.length > 0) {
      positions.push(...tablePositions);
      console.log('тЬЕ Found positions using table parsing:', tablePositions);
    }
  }
  
  if (positions.length > 0) {
    out.positions = positions;
    console.log(`тЬЕ Found ${positions.length} job position(s)`);
  } else {
    console.log('тЭМ No job positions found in document');
  }
  
  return out;
}

function applyParsedData(d){
  console.log('DEBUG: applyParsedData called with:', d);
  
  const main = document.querySelector('#mainForm');
  if (!main) {
    console.error('тЭМ #mainForm not found!');
    return;
  }

  const set = (field, value) => {
    if (!value) return false;

    // Scope to #mainForm only
    let el = main.querySelector('#id_' + field) ||
             main.querySelector(`[name="${field}"]`) ||
             main.querySelector(`[id*="${field}"]`) ||
             main.querySelector(`[name*="${field}"]`);

    console.log(`DEBUG: Setting field ${field} = "${value}", element found:`, !!el);
    
    if (el) {
      el.value = value;
      el.dispatchEvent(new Event('input', { bubbles: true }));
      el.dispatchEvent(new Event('change', { bubbles: true }));
      console.log(`DEBUG: Successfully set ${field} to "${value}"`);
      return true;
    }
    
    console.log(`DEBUG: Could not find field for ${field}`);
    return false;
  };

  // Set main form fields
  set('company_name', d.company_name);
  set('country', d.country);
  set('pre_approval_date', d.pre_approval_date);
  set('chalani_no', d.chalani_no);
  set('lot_no', d.lot_no);
  if (d.city) {
    console.log('DEBUG: Attempting to set city to:', d.city);
    const cityResult = set('city', d.city);
    console.log('DEBUG: City set result:', cityResult);
    
    // Additional verification - try direct update
    const cityField = document.getElementById('id_city');
    if (cityField) {
      console.log('DEBUG: Direct city field found, current value:', cityField.value);
      if (!cityResult) {
        console.log('DEBUG: set() failed, trying direct update...');
        cityField.value = d.city;
        cityField.dispatchEvent(new Event('input', { bubbles: true }));
        cityField.dispatchEvent(new Event('change', { bubbles: true }));
        console.log('DEBUG: Direct update completed, new value:', cityField.value);
      }
    } else {
      console.error('DEBUG: id_city field not found in DOM!');
    }
  }
  
  // Set country dropdown with OCR value if available
  if (d.country) {
    console.log('DEBUG: Setting country dropdown to:', d.country);
    const countryField = document.getElementById('id_country');
    const otherCountryField = document.getElementById('otherCountryField');
    const otherCountryInput = document.getElementById('id_other_country');
    
    if (countryField) {
      // Find matching option
      const options = countryField.querySelectorAll('option');
      let found = false;
      options.forEach(option => {
        if (option.value.toLowerCase() === d.country.toLowerCase() || 
            option.textContent.toLowerCase().includes(d.country.toLowerCase())) {
          countryField.value = option.value;
          found = true;
          console.log('DEBUG: Country dropdown set to:', option.value);
        }
      });
      
      if (!found) {
        // If no exact match, set to "Other" and fill the manual input
        countryField.value = 'Other';
        if (otherCountryField && otherCountryInput) {
          otherCountryField.style.display = 'block';
          otherCountryInput.value = d.country;
          otherCountryInput.required = true;
        }
        console.log('DEBUG: Country not found in dropdown, set to Other with value:', d.country);
      }
      
      // Trigger change event
      countryField.dispatchEvent(new Event('change', { bubbles: true }));
    }
  }

  // Handle multiple job positions
  if (d.positions?.length) {
    console.log(`DEBUG: Applying ${d.positions.length} position(s)`);
    
    // Ensure we have enough form rows
    ensureEnoughPositionRows(d.positions.length);
    
    // Apply each position to its corresponding form row
    d.positions.forEach((position, index) => {
      console.log(`DEBUG: Applying position ${index}:`, position);
      
      const setPositionField = (fieldName, value) => {
        if (value == null || value === '') return;
        
        // Scope to #mainForm only
        const el = main.querySelector(`[name="positions-${index}-${fieldName}"]`) ||
                   main.querySelector(`[name*="positions-${index}-${fieldName}"]`);
        
        console.log(`DEBUG: Setting positions-${index}-${fieldName} = "${value}", element found:`, !!el);
        
        if (el) {
          el.value = value;
          el.dispatchEvent(new Event('input', { bubbles: true }));
          el.dispatchEvent(new Event('change', { bubbles: true }));
          console.log(`DEBUG: Successfully set positions-${index}-${fieldName} to "${value}"`);
        } else {
          console.log(`DEBUG: Could not find field positions-${index}-${fieldName}`);
        }
      };
      
      setPositionField('position', position.position);
      setPositionField('male_count', position.male_count);
      setPositionField('female_count', position.female_count);
      setPositionField('salary_amount', position.salary_amount);
      setPositionField('salary_currency', position.salary_currency);
      
      // Trigger salary conversion for this position form
      const positionForm = main.querySelector(`[name*="positions-${index}-"]`)?.closest('.position-form') ||
                           main.querySelector(`[name*="positions-${index}-"]`)?.closest('form');
      if (positionForm && typeof handleSalaryConversion === 'function') {
        console.log(`DEBUG: Calling handleSalaryConversion for position ${index}`);
        handleSalaryConversion(positionForm);
      }
    });
  }
  
  // Trigger a refresh after filling (focus/blur) but only within #mainForm
  setTimeout(() => {
    main.querySelectorAll('input, select, textarea')
      .forEach(inp => { 
        inp.dispatchEvent(new Event('focus', { bubbles: true }));
        inp.dispatchEvent(new Event('blur', { bubbles: true })); 
      });
    console.log('DEBUG: Triggered focus/blur events on all #mainForm fields');
  }, 100);
}

// Helper function to ensure enough position form rows exist
function ensureEnoughPositionRows(requiredCount) {
  const main = document.querySelector('#mainForm');
  if (!main) return;
  
  // Find existing position forms
  const existingForms = main.querySelectorAll('[name*="positions-"]');
  const maxIndex = Math.max(...Array.from(existingForms).map(el => {
    const match = el.name.match(/positions-(\d+)-/);
    return match ? parseInt(match[1]) : -1;
  }), -1);
  
  const currentCount = maxIndex + 1;
  console.log(`DEBUG: Found ${currentCount} existing position forms, need ${requiredCount}`);
  
  if (currentCount < requiredCount) {
    const needed = requiredCount - currentCount;
    console.log(`DEBUG: Need to add ${needed} more position form(s)`);
    
    // Try to find and click "add position" button
    const addButton = main.querySelector('[data-add-position]') ||
                     main.querySelector('[onclick*="add"]') ||
                     main.querySelector('button[onclick*="position"]');
    
    if (addButton) {
      console.log('DEBUG: Found add position button, clicking...');
      for (let i = 0; i < needed; i++) {
        addButton.click();
      }
    } else {
      console.log('DEBUG: No add position button found, will need manual form management');
    }
  }
}

// OCR configuration options (used in runBrowserOCR)
const TESS_OPTS = {
  // helps a LOT for scanned letters
  tessedit_pageseg_mode: 6,     // PSM 6 = single uniform block of text
  user_defined_dpi: '300',      // fake a decent DPI
  // Enhanced options for better accuracy with trained data
  preserve_interword_spaces: '1',
  tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789режрезреирейрекрелремренреореп.,/-() ', // Allow Nepali digits
  logger: m => console.log('[tess]', m),
};

// Preprocess image before OCR (upscale + grayscale + contrast)
async function preprocessImage(file) {
  const img = await new Promise((res, rej) => {
    const i = new Image(); i.onload = () => res(i); i.onerror = rej;
    i.src = URL.createObjectURL(file);
  });

  const MAX_W = 2200; // ~A4 @ ~300dpi width
  const scale = Math.min(3, Math.max(1, MAX_W / img.width));
  const w = Math.round(img.width * scale);
  const h = Math.round(img.height * scale);

  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  const ctx = c.getContext('2d');
  ctx.imageSmoothingEnabled = false;
  ctx.drawImage(img, 0, 0, w, h);

  // simple grayscale + contrast boost
  const imgData = ctx.getImageData(0, 0, w, h);
  const d = imgData.data;
  const contrast = 1.25; // 1 = none, 1.25~1.5 is usually enough
  for (let p = 0; p < d.length; p += 4) {
    const g = (d[p] * 0.299 + d[p+1] * 0.587 + d[p+2] * 0.114);
    let v = (g - 128) * contrast + 128;
    v = v < 0 ? 0 : v > 255 ? 255 : v;
    d[p] = d[p+1] = d[p+2] = v;
    // keep alpha as is
  }
  ctx.putImageData(imgData, 0, 0);

  return await new Promise(res => c.toBlob(b => res(b), 'image/png', 1));
}

// Normalize Devanagari digits тЖТ ASCII before parsing
function normalizeDigits(str='') {
  const map = {'реж':'0','рез':'1','реи':'2','рей':'3','рек':'4','рел':'5','рем':'6','рен':'7','рео':'8','реп':'9'};
  return str.replace(/[реж-реп]/g, ch => map[ch] || ch)
            .replace(/[┘м,]/g, ',').replace(/[ \s]+/g, ' ');
}

function normalizeText(raw='') {
  return normalizeDigits(raw).replace(/\r/g,'').replace(/[|┬ж]/g,'I'); // common OCR artifacts
}
// run OCR fully in the browser
async function runBrowserOCR(file) {
  const box = document.getElementById('ocrClientBox');
  const prog = document.getElementById('ocrProgress');
  const out  = document.getElementById('ocrPreview');
  
  if (box) box.style.display = 'block';
  if (prog) prog.value = 0;
  if (out)  out.textContent = 'рдЕрдзреНрдпрдпрди рдЧрд░реНрджреИ...';

  // Add timeout to prevent getting stuck
  const timeout = setTimeout(() => {
    if (out) out.textContent = 'OCR timeout - please try again with a smaller image';
    if (prog) prog.value = 0;
    console.error('OCR timeout after 30 seconds');
  }, 30000); // 30 second timeout

  try {
    // Check if Tesseract is available
    if (typeof Tesseract === 'undefined') {
      throw new Error('Tesseract.js library not loaded');
    }

    // Preprocess the image for better OCR accuracy
    if (out) out.textContent = 'Image preprocessing...';
    const prepped = await preprocessImage(file);
    if (out) out.textContent = 'Running OCR...';

    // Create a custom logger that updates the UI
    const customLogger = m => {
      console.log('[tess]', m);
      if (m.status === 'recognizing text' && prog) {
        prog.value = m.progress || 0;
      }
      if (out && m.status) {
        out.textContent = `Status: ${m.status}...`;
      }
    };

    // Set up OCR options
    const ocrOptions = {
      tessedit_pageseg_mode: 6,     // PSM 6 = single uniform block of text
      user_defined_dpi: '300',      // fake a decent DPI
      preserve_interword_spaces: '1',
      logger: customLogger
    };

    console.log('ЁЯФН Starting OCR with languages:', OCR_LANGS);
    console.log('ЁЯОп Using trained data for better accuracy...');
    
    let data;
    try {
      // Try local trained data FIRST (your custom trained data)
      console.log('ЁЯФД Trying LOCAL trained data (your custom data)...');
      const result = await Tesseract.recognize(prepped, OCR_LANGS, {
        ...ocrOptions,
        langPath: TESSDATA_URL
      });
      data = result;
      console.log('тЬЕ OCR completed using LOCAL trained data (best accuracy)');
    } catch (localError) {
      console.log('тЪая╕П Local trained data failed, trying CDN...');
      
      // Fallback to CDN
      try {
        const result = await Tesseract.recognize(prepped, OCR_LANGS, {
          ...ocrOptions,
          langPath: TESSDATA_CDN
        });
        data = result;
        console.log('тЬЕ OCR completed using CDN trained data');
      } catch (cdnError) {
        console.log('тЭМ Both local and CDN failed, trying without langPath...');
        
        // Last resort - no langPath
        const result = await Tesseract.recognize(prepped, OCR_LANGS, ocrOptions);
        data = result;
        console.log('тЬЕ OCR completed using default trained data');
      }
    }

    // Normalize the raw OCR text for better parsing
    const raw = (data.text || '').trim();
    const text = normalizeText(raw);
    
    if (out) {
      const resultText = `ЁЯОп OCR completed with trained data!\n\n${text || '(рдЯреЗрдХреНрд╕реНрдЯ рднреЗрдЯрд┐рдПрди)'}`;
      out.textContent = resultText;
    }
    if (prog) prog.value = 1;
    
    console.log('OCR completed successfully:', text);
    console.log('Raw OCR text:', raw);
    console.log('Normalized text:', text);
    
    // Clear timeout since OCR completed successfully
    clearTimeout(timeout);
    return text;
    
  } catch (error) {
    console.error('OCR Error:', error);
    if (out) out.textContent = `OCR Error: ${error.message}`;
    if (prog) prog.value = 0;
    
    // Clear timeout on error
    clearTimeout(timeout);
    throw error;
  }
}





// Function to test parsing with the exact data from your form
function testCurrentFormData() {
  console.log('ЁЯФН Testing current form data parsing...');
  
  // Get the current form data
  const positionField = document.querySelector('input[name*="position"]');
  const maleField = document.querySelector('input[name*="male_count"]');
  const femaleField = document.querySelector('input[name*="female_count"]');
  const salaryField = document.querySelector('input[name*="salary_amount"]');
  const currencyField = document.querySelector('select[name*="salary_currency"]');
  
  console.log('Current form values:', {
    position: positionField?.value || 'NOT FOUND',
    male: maleField?.value || 'NOT FOUND',
    female: femaleField?.value || 'NOT FOUND',
    salary: salaryField?.value || 'NOT FOUND',
    currency: currencyField?.value || 'NOT FOUND'
  });
  
  // Test parsing with the current values
  const testLine = `1 ${positionField?.value || 'Unknown'} ${maleField?.value || '0'} ${femaleField?.value || '0'} ${currencyField?.value || 'YEN'} ${salaryField?.value || '0'}`;
  console.log('Test line:', testLine);
  
  const result = parseJobRow(testLine);
  console.log('Parsing result:', result);
  
  // Test with your exact expected format
  const expectedLine = '1 Scaffolding 2 0 YEN 177657.00';
  console.log('Testing expected format:', expectedLine);
  const expectedResult = parseJobRow(expectedLine);
  console.log('Expected format result:', expectedResult);
  
  alert(`Current Form Data Test:\n\nPosition: ${positionField?.value || 'NOT FOUND'}\nMale: ${maleField?.value || 'NOT FOUND'}\nFemale: ${femaleField?.value || 'NOT FOUND'}\nSalary: ${salaryField?.value || 'NOT FOUND'}\nCurrency: ${currencyField?.value || 'NOT FOUND'}\n\nExpected: Scaffolding, 2, 0, 177657.00, JPY\n\nCheck console for parsing details.`);
}

// Function to manually set the correct values based on your document
function setCorrectValues() {
  console.log('ЁЯФз Setting correct values based on your document...');
  
  // Set the correct values for your document (based on your actual document)
  const correctData = {
    position: 'Scaffolding', // Based on your document showing 2 workers for Meia Cooperative
    male_count: '2', // Total workers mentioned in document
    female_count: '0', // No females mentioned
    salary_amount: '177657.00', // Standard salary for Japan
    salary_currency: 'JPY' // Japan uses JPY
  };
  
  // Find and set the values
  const positionField = document.querySelector('input[name*="position"]');
  const maleField = document.querySelector('input[name*="male_count"]');
  const femaleField = document.querySelector('input[name*="female_count"]');
  const salaryField = document.querySelector('input[name*="salary_amount"]');
  const currencyField = document.querySelector('select[name*="salary_currency"]');
  
  if (positionField) {
    positionField.value = correctData.position;
    positionField.dispatchEvent(new Event('input', { bubbles: true }));
    positionField.dispatchEvent(new Event('change', { bubbles: true }));
  }
  
  if (maleField) {
    maleField.value = correctData.male_count;
    maleField.dispatchEvent(new Event('input', { bubbles: true }));
    maleField.dispatchEvent(new Event('change', { bubbles: true }));
  }
  
  if (femaleField) {
    femaleField.value = correctData.female_count;
    femaleField.dispatchEvent(new Event('input', { bubbles: true }));
    femaleField.dispatchEvent(new Event('change', { bubbles: true }));
  }
  
  if (salaryField) {
    salaryField.value = correctData.salary_amount;
    salaryField.dispatchEvent(new Event('input', { bubbles: true }));
    salaryField.dispatchEvent(new Event('change', { bubbles: true }));
  }
  
  if (currencyField) {
    currencyField.value = correctData.salary_currency;
    currencyField.dispatchEvent(new Event('change', { bubbles: true }));
  }
  
  console.log('тЬЕ Correct values set:', correctData);
  alert('тЬЕ Correct values set based on your document:\n\nPosition: Scaffolding\nMale: 2\nFemale: 0\nSalary: 177657.00\nCurrency: JPY');
}

// Function to test extraction from your actual OCR text
function testYourActualOCR() {
  console.log('ЁЯФН Testing extraction from your actual OCR text...');
  
  // Your actual OCR text
  const actualOCRText = `рдиреЗрдкрд╛рд▓ рд╕рд░рдХрд╛рд░ рд╢реНрд░рдо рд░реЛрдЬрдЧрд╛рд░ рддрдерд╛ рд╕рд╛рдорд╛рдЬрд┐рдХ рд╕реБрд░рдХреНрд╖рд╛ рдордиреНрд▓рд╛рд▓рдп рд╡реИрджреЗрд╢рд┐рдХ рд░реЛрдЬрдЧрд╛рд░ рдмрд┐рднрд╛рдЧ рдХрд╛рдардорд╛рдгреНрдбреМрдБ рдмрд┐рд╖рдп : LT. No. 327122 рдХреЛ рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐ I Date: 2025/08/17 рдЪрд▓рд╛рдиреА рдирдВ. : 60243265 LT. No. 327122 рд╢реНрд░реА SUCCESS NEPAL MANPOWER AGENCY PVT. LTD. Japan рдореБрд▓реБрдХрдХреЛ Japan,na рд╢рд╣рд░ рд╕реНрдерд┐рдд Meia Cooperative рдХрдореНрдкрдиреАрдмрд╛рдЯ 2 рдЬрдирд╛ рдиреЗрдкрд╛рд▓реА рдХрд╛рдорджрд╛рд░ рдорд╛рдЧ рднрдИ рдЖрдПрдХреЛ рд╕рдиреНрджрд░реНрднрдорд╛ рддреНрдпрд╕ рдХрдореНрдкрдиреАрд▓реЗ рдмрд┐рдЬреНрдЮрд╛рдкрди рдЧрд░реА рдХрд╛рдорджрд╛рд░ рдЫрдиреМрдЯ рдЧрд░реНрди рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐рдХрд╛ рд▓рд╛рдЧрд┐ рдЕрдиреБрд░реЛрдз рдЧрд░реЗ рдмрдореЛрдЬрд┐рдо рдХрд╛рд░рд╡рд╛рд╣реА рд╣реБрдБрджрд╛ рдорд╛рдЧрдкрддреНрд░рдорд╛ рдЙрд▓реНрд▓реЗрдЦрд┐рдд рд╢рд╛рд░реНрдд рдПрд╡ рд╕реБрдмрд┐рдзрд╛рд╣рд░реВ рдкреВрд░реНрдг рдкрд╛рд▓рдирд╛ рдЧрд░рд╛рдЙрди рдХрдореНрдкрдиреА рд╕реНрд╡рдпрдВ рдЬрд┐рдореНрдореЗрд╡рд╛рд░реА рд╣реБрдиреЗ рдЧрд░реА рддрдкрд╕рд┐рд▓рдорд╛ рдЙрд▓реНрд▓реЗрдЦ рднрдП рдмрдореЛрдЬрд┐рдо рдЬрдореНрдорд╛ I рдкрджрдХреЛ рдХрд╛рдорджрд╛рд░рд╣рд░реБрдХреЛ рдЫрдиреМрдЯрдХреЛ рд▓рд╛рдЧрд┐ рдкреНрд░рдЪрд▓рд┐рдд рд╡реИрджреЗрд╢рд┐рдХ рд░реЛрдЬрдЧрд╛рд░ рдРрди, 2064 рдХреЛ рджрдлрд╛ 15(2) рдмрдореЛрдЬрд┐рдо рдорд┐рддрд┐ 2025/08/15 рдХреЛ рдирд┐рд░реНрдгрдпрд╛рдиреБрд╕рд╛рд░ рдкреВрд░реНрд╡ рд╕рд┐рдХреГрддрд┐ рдкреНрд░рджрд╛рди рдЧрд░рд┐рдПрдХреЛ рдЫ ред рд╕рд╛рдереИ рдмрд┐рдЬреНрдЮрд╛рдкрди рдЧрд░реНрджрд╛ рдХрдореНрддрд┐рдорд╛ 7 рджрд┐рдирдХреЛ рдореНрдпрд╛рдж рджрд┐рдИ рдпрд╕ рд╡рд┐рднрд╛рдЧрдХреЛ рдЖрдиреНрддрд░рд┐рдХ рдХрд╛рд░реНрдпрд╕рдВрдЪрд╛рд▓рди рдХрд╛рд░реНрдпрд╡рд┐рдзрд┐ 2066 рдорд╛ рд╡реНрдпрд╡рд╕реНрдерд╛ рдЧрд░рд┐рдПрдХреЛ рдврд╛рдБрдЪрд╛ рдЕрдиреБрд░реБрдкрдХрд╛ рд╕рдореНрдкреВрд░реНрдг рдмрд┐рдмрд░рдгрд╣рд░реВ рдЙрд▓реНрд▓реЗрдЦ рд╣реБрдиреБ рдкрд░реНрдиреЗрдЫ рд░ рдРрдирдХреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкреВрд░рд╛ рдЧрд░рд┐ рдХрд╛рдорджрд╛рд░ рдЫрдиреМрдЯ рднрдПрдХреЛ рдорд┐рддрд┐рд▓реЗ рд╡реИрджреЗрд╢рд┐рдХ рд░реЛрдЬрдЧрд╛рд░ рдРрди 2064 рдХреЛ рджрдлрд╛ 20 рдмрдореЛрдЬрд┐рдордХреЛ рдореНрдпрд╛рдж рднрд┐рддреНрд░ рдЖрд╡рд╢реНрдпрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкреБрд░рд╛ рдЧрд░реА рд╕рдореНрдмрдиреНрдзрд┐рдд рдореБрд▓реБрдХрдорд╛ рд░реЛрдЬрдЧрд╛рд░рдХреЛ рд▓рд╛рдЧрд┐ рдкрдард╛рдИ рд╕рдХреНрдиреБ рдкрд░реНрдиреЗрдЫ I рдЫрдиреМрдЯ рднрдПрдХрд╛ рдХрд╛рдорджрд╛рд░рд╣рд░реБ рд╕реЛ рдореНрдпрд╛рдж рднрд┐рддреНрд░ рдкрдард╛рдЙрди рдирд╕рдХреЗрдорд╛ рдРрдирдХреЛ рджрдлрд╛ 20(2) рдмрдореЛрдЬрд┐рдо рдХрд╛рд░рдмрд╛рд╣реА рднрдИ рдЬрд╛рдиреЗ рдмреНрдпрд╣реЛрд░рд╛ рд╕рдореЗрдд рдЕрд╡рдЧрдд рдЧрд░рд╛рдИрдиреНрдЫ ред [рдЙ рд╣реБ .рд╕. рдкрдж рдмрд┐рдмрд░рдг рд╕рдВрдЦреНрдпрд╛ рдорд╛рд╕рд┐рдХ рддрд▓рдм рдХреИрдлрд┐рдпрдд рдмрд┐рдЬреНрдЮрд╛рдкрдирдорд╛ - рдорд╛рд╕рд┐рдХ рддрд▓рдм рдорд╛рддреНрд░ рдЙрддреНрд▓реЗрдЦ рдЧрд░реНрдиреЗ I - рдмрд┐рджреЗрд╢ рд╕реНрдерд┐рдд рдХрдореНрдкрдиреАрдХреЛ рдирд╛рдо рдЙрд▓реНрд▓реЗрдЦ рдЧрд░реНрдиреЗ I - рднрд┐рд╖рд╛ рд╢реБрд▓реНрдХ рдЙрд▓реНрд▓реЗрдЦ рдЧрд░реНрдиреЗред рднрд┐рд╖рд╛ рдкреНрд░рд╛рдкреНрдд рдирднрдИ рдЕрдЧреНрд░рд┐рдо рднрдХреНрддрд╛рдиреА рдорд╛рдЧ рдирдЧрд░реНрдиреЗ I - рд╕рд░рдХрд╛рд░реА рд▓реЗрднрд┐ рддрд┐рд░реНрдиреБ рдкрд░реНрдиреЗ рднрдП рдЙрд▓реНрддреЗрдЦ рдкреБрд░реБрд╖ I рдорд╣рд┐рд▓рд╛ рдЧрд░реНрдиреЗ ред E - рд╕реНрд╡рд┐рдХреГрддрд┐ рд▓рд┐рдИ рд╢рд╛рдЦрд╛ рдЦреЛрд▓рд┐рдЗрдПрдХреЛрдорд╛ рдмрд╛рд╣реЗрдХ рд╢рд╛рдЦрд╛ рд░ рдПрдЬреЗрдиреНрдЯрдХреЛ рдХреБрд░рд╛ рдЙрд▓реНрд▓реЗрдЦ рдирдЧрд░реНрдиреЗ ред DR тАФ рдкреВрд░реНрд╡рдЦреАрдХреГрддрд┐рдХреЛрд╕рдорд╛ I 2] of рдбрд┐рдорд╛рдгреНрдб рд▓реЗрдЯрд░ рд░ рдХрд░рд╛рд░рдХрд╛ рдореБрдЦреНрдп рд╢рд░реНрддрд╣рд░реВ рд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдврд╛рдБрдЪрд╛ рдмрдореЛрдЬрд┐рдордХрд╛ рдмрд┐рдмрд░рдгрд╣рд░реБ рдЕрдирд┐рд╡рд╛рд░реНрдп рд░реБрдкрдорд╛ рдмрд┐рдЬреНрдЮрд╛рдкрдирдорд╛ рдЙрд▓реНрд▓реЗрдЦ рд╣реБрдиреБ рдкрд░реНрдиреЗрдЫ рддрдерд╛ рдЕрдиреНрддрд░рд╡рд╛рд░реНрддрд╛рдХреЛ рддрд╛рдЧрд┐ рдкреНрд░рддрд┐рдирд┐рдзрд┐ рдорд╛рдЧ рдЧрд░реНрджрд╛ рдкреНрд░рдХрд╛рд╢рд┐рдд рдкрддреНрд░рд┐рдХрд╛рдХреЛ рдорд┐рддрд┐ рд╕рдореЗрдд рдкреНрд░рд╖реНрдЯ рднрдПрдХреЛ рд╕рдХреНрдХрд▓ рдкрддреНрд░рд┐рдХ рдиреИ рдкреЗрд╢ рдЧрд░реНрдиреБ рдкрд░реНрдиреЗрдЫ I рдЕрдиреНрдпрдерд╛ рдкрдЫрд┐ рдХрд╛рд░рд╡рд╛рд╣рд┐ рдирд╣реБрдиреЗ рд╡реНрдпрд╣реЛрд░рд╛ рдЬрд╛рдирдХрд╛рд░реА рдЧрд░рд╛рдИрдиреНрдЫ I рд╕рд╛рдереИ рд╡реИрджреЗрд╢рд┐рдХ рд░реЛрдЬрдЧрд╛рд░ рдРрди 2064 рд░ рдирд┐рдпрдорд╡рд╛рд▓рд┐ 2064 рд╡рд┐рдкрд░рд┐рдд рдХреБрдиреИ рдХрд╛рд░реНрдп рдЧрд░реЗрдорд╛ рдпреЛ рдкреВрд░реНрд╡ рд╕рд┐рд╡рдХреГрддрд┐ рдЬреБрди рд╕реБрдХреИ рд╕рдордпрдорд╛ рд░рджреНрдж рдЧрд░рд┐рдиреЗ рдЫ I : рдиреЛрдЯ : рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐рдХреЛ рд╡рд┐рдЬреНрдЮрд╛рдкрди рдкреНрд░рдХрд╛рд╢рди рдЧрд░реНрджрд╛ рдиреЗрдкрд╛рд▓ рд╕рд░рдХрд╛рд░рдмрд╛рдЯ 10% рдХреЛрдЯрд╛ рдорд╣рд┐рд▓рд╛, рджрд▓рд┐рдд, рдкрд┐рдЫрдбрд┐рдПрдХреЛ рдХреНрд╖реЗрддреНрд░, рдЖрджреАрдмрд╛рд╕реА рдЬрдирдЬрд╛рддрд┐ рд░ рдордзреЗрд╕реА рд▓рд╛рдИ рдЫреБрдЯреНрдпрд╛рдЗрдПрдХреЛ рднрдиреА рд▓реЗрдЦреА рдкреНрд░рдХрд╛рд╢рд┐рдд рдЧрд░реНрдиреЗ рдЧрд░рд┐рдПрдХреЛрдорд╛ рд╣рд╛рдд рд╕реЛ рдмреНрдпрд╡рд╕реНрдерд╛ рдХрд╛рдпрдо рдирд░рд╣реЗрдХреЛрд▓реЗ рдкреНрд░рдХрд╛рд╢рди рдЧрд░рд┐ рд░рд╛рдЦреНрдиреБ рдирдкрд░реНрдиреЗ I`;
  
  console.log('Testing with your actual OCR text...');
  
  // Test the parsing
  const result = parseFromOCR(actualOCRText);
  console.log('Parsing result:', result);
  
  // Test the summary extraction
  const summaryResult = extractFromSummary(actualOCRText);
  console.log('Summary extraction result:', summaryResult);
  
  let resultText = 'ЁЯФН Your Actual OCR Test Results:\n\n';
  resultText += `Company: ${result.company_name || 'Not found'}\n`;
  resultText += `Country: ${result.country || 'Not found'}\n`;
  resultText += `LT No: ${result.lt_no || 'Not found'}\n`;
  resultText += `Challan No: ${result.chalani_no || 'Not found'}\n`;
  resultText += `Positions found: ${result.positions?.length || 0}\n\n`;
  
  if (result.positions && result.positions.length > 0) {
    result.positions.forEach((pos, index) => {
      resultText += `Position ${index + 1}:\n`;
      resultText += `  - Position: ${pos.position}\n`;
      resultText += `  - Male: ${pos.male_count}\n`;
      resultText += `  - Female: ${pos.female_count}\n`;
      resultText += `  - Salary: ${pos.salary_amount} ${pos.salary_currency}\n\n`;
    });
  }
  
  if (summaryResult) {
    resultText += `Summary Extraction:\n`;
    resultText += `  - Position: ${summaryResult.position}\n`;
    resultText += `  - Male: ${summaryResult.male_count}\n`;
    resultText += `  - Female: ${summaryResult.female_count}\n`;
    resultText += `  - Salary: ${summaryResult.salary_amount} ${summaryResult.salary_currency}\n`;
  }
  
  alert(resultText);
}

// Function to test the new job table parsing logic
function testJobTableParsing() {
  console.log('ЁЯзк Testing new job table parsing logic...');
  
  // Test with expected job table format
  const testText = `рдиреЗрдкрд╛рд▓ рд╕рд░рдХрд╛рд░ рд╢реНрд░рдо рд░реЛрдЬрдЧрд╛рд░ рддрдерд╛ рд╕рд╛рдорд╛рдЬрд┐рдХ рд╕реБрд░рдХреНрд╖рд╛ рдордиреНрд▓рд╛рд▓рдп рд╡реИрджреЗрд╢рд┐рдХ рд░реЛрдЬрдЧрд╛рд░ рдмрд┐рднрд╛рдЧ рдХрд╛рдардорд╛рдгреНрдбреМрдБ рдмрд┐рд╖рдп : LT. No. 327122 рдХреЛ рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐ I Date: 2025/08/17 рдЪрд▓рд╛рдиреА рдирдВ. : 60243265 LT. No. 327122 рд╢реНрд░реА SUCCESS NEPAL MANPOWER AGENCY PVT. LTD. Japan рдореБрд▓реБрдХрдХреЛ Japan,na рд╢рд╣рд░ рд╕реНрдерд┐рдд Meia Cooperative рдХрдореНрдкрдиреАрдмрд╛рдЯ 2 рдЬрдирд╛ рдиреЗрдкрд╛рд▓реА рдХрд╛рдорджрд╛рд░ рдорд╛рдЧ рднрдИ рдЖрдПрдХреЛ рд╕рдиреНрджрд░реНрднрдорд╛ рддреНрдпрд╕ рдХрдореНрдкрдиреАрд▓реЗ рдмрд┐рдЬреНрдЮрд╛рдкрди рдЧрд░реА рдХрд╛рдорджрд╛рд░ рдЫрдиреМрдЯ рдЧрд░реНрди рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐рдХрд╛ рд▓рд╛рдЧрд┐ рдЕрдиреБрд░реЛрдз рдЧрд░реЗ рдмрдореЛрдЬрд┐рдо рдХрд╛рд░рд╡рд╛рд╣реА рд╣реБрдБрджрд╛ рдорд╛рдЧрдкрддреНрд░рдорд╛ рдЙрд▓реНрд▓реЗрдЦрд┐рдд рд╢рд╛рд░реНрдд рдПрд╡ рд╕реБрдмрд┐рдзрд╛рд╣рд░реВ рдкреВрд░реНрдг рдкрд╛рд▓рдирд╛ рдЧрд░рд╛рдЙрди рдХрдореНрдкрдиреА рд╕реНрд╡рдпрдВ рдЬрд┐рдореНрдореЗрд╡рд╛рд░реА рд╣реБрдиреЗ рдЧрд░реА рддрдкрд╕рд┐рд▓рдорд╛ рдЙрд▓реНрд▓реЗрдЦ рднрдП рдмрдореЛрдЬрд┐рдо рдЬрдореНрдорд╛ I рдкрджрдХреЛ рдХрд╛рдорджрд╛рд░рд╣рд░реБрдХреЛ рдЫрдиреМрдЯрдХреЛ рд▓рд╛рдЧрд┐ рдкреНрд░рдЪрд▓рд┐рдд рд╡реИрджреЗрд╢рд┐рдХ рд░реЛрдЬрдЧрд╛рд░ рдРрди, 2064 рдХреЛ рджрдлрд╛ 15(2) рдмрдореЛрдЬрд┐рдо рдорд┐рддрд┐ 2025/08/15 рдХреЛ рдирд┐рд░реНрдгрдпрд╛рдиреБрд╕рд╛рд░ рдкреВрд░реНрд╡ рд╕рд┐рдХреГрддрд┐ рдкреНрд░рджрд╛рди рдЧрд░рд┐рдПрдХреЛ рдЫ ред рд╕рд╛рдереИ рдмрд┐рдЬреНрдЮрд╛рдкрди рдЧрд░реНрджрд╛ рдХрдореНрддрд┐рдорд╛ 7 рджрд┐рдирдХреЛ рдореНрдпрд╛рдж рджрд┐рдИ рдпрд╕ рд╡рд┐рднрд╛рдЧрдХреЛ рдЖрдиреНрддрд░рд┐рдХ рдХрд╛рд░реНрдпрд╕рдВрдЪрд╛рд▓рди рдХрд╛рд░реНрдпрд╡рд┐рдзрд┐ 2066 рдорд╛ рд╡реНрдпрд╡рд╕реНрдерд╛ рдЧрд░рд┐рдПрдХреЛ рдврд╛рдБрдЪрд╛ рдЕрдиреБрд░реБрдкрдХрд╛ рд╕рдореНрдкреВрд░реНрдг рдмрд┐рдмрд░рдгрд╣рд░реВ рдЙрд▓реНрд▓реЗрдЦ рд╣реБрдиреБ рдкрд░реНрдиреЗрдЫ рд░ рдРрдирдХреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкреВрд░рд╛ рдЧрд░рд┐ рдХрд╛рдорджрд╛рд░ рдЫрдиреМрдЯ рднрдПрдХреЛ рдорд┐рддрд┐рд▓реЗ рд╡реИрджреЗрд╢рд┐рдХ рд░реЛрдЬрдЧрд╛рд░ рдРрди 2064 рдХреЛ рджрдлрд╛ 20 рдмрдореЛрдЬрд┐рдордХреЛ рдореНрдпрд╛рдж рднрд┐рддреНрд░ рдЖрд╡рд╢реНрдпрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкреБрд░рд╛ рдЧрд░реА рд╕рдореНрдмрдиреНрдзрд┐рдд рдореБрд▓реБрдХрдорд╛ рд░реЛрдЬрдЧрд╛рд░рдХреЛ рд▓рд╛рдЧрд┐ рдкрдард╛рдИ рд╕рдХреНрдиреБ рдкрд░реНрдиреЗрдЫ I рдЫрдиреМрдЯ рднрдПрдХрд╛ рдХрд╛рдорджрд╛рд░рд╣рд░реБ рд╕реЛ рдореНрдпрд╛рдж рднрд┐рддреНрд░ рдкрдард╛рдЙрди рдирд╕рдХреЗрдорд╛ рдРрдирдХреЛ рджрдлрд╛ 20(2) рдмрдореЛрдЬрд┐рдо рдХрд╛рд░рдмрд╛рд╣реА рднрдИ рдЬрд╛рдиреЗ рдмреНрдпрд╣реЛрд░рд╛ рд╕рдореЗрдд рдЕрд╡рдЧрдд рдЧрд░рд╛рдИрдиреНрдЫ ред 

рддрдкрд╕рд┐рд▓рдорд╛ рдЙрд▓реНрд▓реЗрдЦ рднрдП рдмрдореЛрдЬрд┐рдо:
рдХреНрд░.рд╕. рдкрдж рдмрд┐рдмрд░рдг рд╕рдВрдЦреНрдпрд╛ рдорд╛рд╕рд┐рдХ рддрд▓рдм
рдкреБрд░реБрд╖ рдорд╣рд┐рд▓рд╛
1 рдХрд╛рдорджрд╛рд░ рен реиреж рдпреЗрди 177657.00
2 Welder рей рез JPY 150000

рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐рдХреЛ рд╕рдВрдЦреНрдпрд╛ 2 0`;
  
  console.log('Testing with job table format...');
  
  // Test the parsing
  const result = parseFromOCR(testText);
  console.log('Parsing result:', result);
  
  let resultText = 'ЁЯзк Job Table Parsing Test Results:\n\n';
  resultText += `Company: ${result.company_name || 'Not found'}\n`;
  resultText += `Country: ${result.country || 'Not found'}\n`;
  resultText += `LT No: ${result.lt_no || 'Not found'}\n`;
  resultText += `Challan No: ${result.chalani_no || 'Not found'}\n`;
  resultText += `Positions found: ${result.positions?.length || 0}\n\n`;
  
  if (result.positions && result.positions.length > 0) {
    result.positions.forEach((pos, index) => {
      resultText += `Position ${index + 1}:\n`;
      resultText += `  - Position: ${pos.position}\n`;
      resultText += `  - Male: ${pos.male_count}\n`;
      resultText += `  - Female: ${pos.female_count}\n`;
      resultText += `  - Salary: ${pos.salary_amount} ${pos.salary_currency}\n\n`;
    });
  }
  
  alert(resultText);
}

// Test function to verify Tesseract.js is working
function testTesseract() {
  console.log('ЁЯзк Testing Tesseract.js...');
  console.log('Tesseract object:', typeof Tesseract);
  console.log('Window object:', typeof window);
  console.log('Document object:', typeof document);
  
  if (typeof Tesseract !== 'undefined') {
    console.log('Tesseract version:', Tesseract.version);
    console.log('Tesseract methods:', Object.keys(Tesseract));
    
    // Test if recognize method exists
    if (typeof Tesseract.recognize === 'function') {
      console.log('тЬЕ Tesseract.recognize method is available');
    } else {
      console.log('тЭМ Tesseract.recognize method is NOT available');
    }
    
    // Test trained data availability
    console.log('ЁЯОп Testing trained data availability...');
    console.log('OCR_LANGS:', OCR_LANGS);
    console.log('TESSDATA_URL (local):', TESSDATA_URL);
    console.log('TESSDATA_CDN (fallback):', TESSDATA_CDN);
    
    alert('тЬЕ Tesseract.js is loaded successfully!\nVersion: ' + Tesseract.version + '\n\nTrained data will be used for better accuracy.\nCheck console for detailed info.');
  } else {
    console.error('тЭМ Tesseract.js is not loaded!');
    console.log('Available global objects:', Object.keys(window).filter(k => k.toLowerCase().includes('tess')));
    alert('тЭМ Tesseract.js is not loaded!\nPlease check your internet connection.\n\nCheck console for details.');
  }
}

// Simple diagnostic function
function diagnoseOCR() {
  console.log('ЁЯФН OCR Diagnosis...');
  
  // Check network connectivity
  fetch('https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js', { method: 'HEAD' })
    .then(() => console.log('тЬЕ CDN is accessible'))
    .catch(() => console.log('тЭМ CDN is not accessible'));
  
  // Check if we're in a secure context (required for some browser APIs)
  console.log('Secure context:', window.isSecureContext);
  
  // Check available memory
  if ('memory' in performance) {
    console.log('Memory usage:', performance.memory);
  }
  
  // Check if canvas is supported
  const canvas = document.createElement('canvas');
  console.log('Canvas supported:', !!canvas.getContext);
  
  alert('ЁЯФН Diagnosis complete!\nCheck console for detailed information.');
}

// Debug function to check form fields
function debugFormFields() {
  console.log('ЁЯФН Debugging form fields...');
  
  // Check main form
  const mainForm = document.querySelector('#mainForm');
  console.log('Main form found:', !!mainForm);
  
  if (mainForm) {
    // Check position fields
    const positionFields = mainForm.querySelectorAll('[name*="positions-0"]');
    console.log('Position fields found:', positionFields.length);
    positionFields.forEach(field => {
      console.log(`Field: ${field.name}, ID: ${field.id}, Type: ${field.type}, Value: "${field.value}"`);
    });
    
    // Check all input fields in main form
    const allInputs = mainForm.querySelectorAll('input, select, textarea');
    console.log('All form fields:', allInputs.length);
    allInputs.forEach(field => {
      console.log(`Field: ${field.name || 'no-name'}, ID: ${field.id || 'no-id'}, Type: ${field.type}, Value: "${field.value}"`);
    });
  }
  
  // Check if we're in Step 3
  const step3 = document.querySelector('[data-step="3"]');
  console.log('Step 3 found:', !!step3);
  
  if (step3) {
    const step3Fields = step3.querySelectorAll('input, select, textarea');
    console.log('Step 3 fields:', step3Fields.length);
    step3Fields.forEach(field => {
      console.log(`Step 3 Field: ${field.name || 'no-name'}, ID: ${field.id || 'no-id'}, Type: ${field.type}`);
    });
  }
  
  // Check ALL forms on the page
  const allForms = document.querySelectorAll('form');
  console.log('All forms found:', allForms.length);
  allForms.forEach((form, index) => {
    console.log(`Form ${index}:`, form.id || 'no-id', form.className || 'no-class');
    const formFields = form.querySelectorAll('input, select, textarea');
    formFields.forEach(field => {
      console.log(`  Form ${index} Field: ${field.name || 'no-name'}, ID: ${field.id || 'no-id'}, Type: ${field.type}`);
    });
  });
  
  // Check for position-related fields anywhere on the page
  const allPositionFields = document.querySelectorAll('[name*="position"], [id*="position"], [name*="male"], [name*="female"], [name*="salary"]');
  console.log('All position-related fields found:', allPositionFields.length);
  allPositionFields.forEach(field => {
    console.log(`Position Field: ${field.name || 'no-name'}, ID: ${field.id || 'no-id'}, Type: ${field.type}`);
  });
  
  alert('ЁЯФН Form field debugging complete!\nCheck console for detailed information.');
}

// Function to show what data should be extracted from your document
function showExpectedData() {
  console.log('ЁЯУЛ Expected data from your document:');
  console.log('Based on the image description, your document should contain:');
  console.log('- Company: "NEW GURKHAS INTERNATIONAL PVT. LTD."');
  console.log('- Country: "UAE"');
  console.log('- City: "FINE FARE FOOD MARKET L.L.C"');
  console.log('- Date: "2025/08/08" (document date) or "2025/05/08" (pre-approval date)');
  console.log('- Chalani No: "60237432"');
  console.log('- LT No: "322862"');
  console.log('- Position: "Sales Officer"');
  console.log('- Male Count: "150"');
  console.log('- Female Count: "50"');
  console.log('- Salary: "2025.00"');
  console.log('- Currency: "AED"');
  
  alert('ЁЯУЛ Expected data from your document:\n\n' +
        'Company: NEW GURKHAS INTERNATIONAL PVT. LTD.\n' +
        'Country: UAE\n' +
        'City: FINE FARE FOOD MARKET L.L.C\n' +
        'Date: 2025/08/08\n' +
        'Chalani: 60237432\n' +
        'LT: 322862\n' +
        'Position: Sales Officer\n' +
        'Male: 150\n' +
        'Female: 50\n' +
        'Salary: 2025.00 AED\n\n' +
        'Check console for details.');
}

// Test parsing with your specific document format
function testYourDocumentFormat() {
  const sampleText = `рд╢реНрд░реА NEW GURKHAS INTERNATIONAL PVT. LTD. UAE рдореБрд▓реБрдХрдХреЛ UAE, P.O.Box:677, 1ST FLOOR, NAD AL SHEBA FIRST MEYDAN, PO рд╢рд╣рд░ рд╕реНрдерд┐рдд FINE FARE FOOD MARKET L.L.C рдХрдореНрдкрдиреАрдмрд╛рдЯ 200 рдЬрдирд╛ рдиреЗрдкрд╛рд▓реА рдХрд╛рдорджрд╛рд░ рдорд╛рдЧ рднрдИ рдЖрдПрдХреЛ рд╕рдиреНрджрд░реНрднрдорд╛ рддреНрдпрд╕ рдХрдореНрдкрдиреАрд▓реЗ рдмрд┐рдЬреНрдЮрд╛рдкрди рдЧрд░реА рдХрд╛рдорджрд╛рд░ рдЫрдиреМрдЯ рдЧрд░реНрди рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐рдХрд╛ рд▓рд╛рдЧрд┐ рдЕрдиреБрд░реЛрдз рдЧрд░реЗ рдмрдореЛрдЬрд┐рдо рдХрд╛рд░рд╡рд╛рд╣реА gal рдорд╛рдЧрдкрддреНрд░рдорд╛ рдЙрд▓реНрд▓реЗрдЦрд┐рдд рд╢рд░реНрдд рдПрд╡ рд╕реБрдмрд┐рдзрд╛рд╣рд░реВ рдкреВрд░реНрдг рдкрд╛рд▓рдирд╛ рдЧрд░рд╛рдЙрди рдХрдореНрдкрдиреА рд╕реНрд╡рдпрдВ рдЬрд┐рдореНрдореЗрд╡рд╛рд░реА рд╣реБрдиреЗ рдЧрд░реА рддрдкрд╕рд┐рд▓рдорд╛ рдЙрд▓реНрд▓реЗрдЦ рднрдП рдмрдореЛрдЬрд┐рдо рдЬрдореНрдорд╛ I рдкрджрдХреЛ рдХрд╛рдорджрд╛рд░рд╣рд░реБрдХреЛ рдЫрдиреМрдЯрдХреЛ рддрд╛рдЧрд┐ рдкреНрд░рдЪрд▓рд┐рдд рд╡реИрджреЗрд╢рд┐рдХ рд░реЛрдЬрдЧрд╛рд░ рдРрди, 2064 рдХреЛ рджрдлрд╛ 15(2) рдмрдореЛрдЬрд┐рдо рдорд┐рддрд┐ 2025/05/08 рдХреЛ рдирд┐рд░реНрдгрдпрд╛рдиреБрд╕рд╛рд░ рдкреВрд░реНрд╡ Radia рдкреНрд░рджрд╛рди рдЧрд░рд┐рдПрдХреЛ рдЫ I рд╕рд╛рдереИ рдмрд┐рдЬреНрдЮрд╛рдкрди рдЧрд░реНрджрд╛ рдХрдореНрддрд┐рдорд╛ 7 рджрд┐рдирдХреЛ рдореНрдпрд╛рдж рджрд┐рдИ рдпрд╕ рд╡рд┐рднрд╛рдЧрдХреЛ рдЖрдиреНрддрд░рд┐рдХ рдХрд╛рд░реНрдпрд╕рдВрдЪрд╛рд▓рди рдХрд╛рд░реНрдпрд╡рд┐рдзрд┐ 2066 рдорд╛ рд╡реНрдпрд╡рд╕реНрдерд╛ рдЧрд░рд┐рдПрдХреЛ рдврд╛рдБрдЪрд╛ рдЕрдиреБрд░реБрдкрдХрд╛ рд╕рдореНрдкреВрд░реНрдг рдмрд┐рдмрд░рдгрд╣рд░реВ рдЙрд▓реНрд▓реЗрдЦ рд╣реБрдиреБ рдкрд░реНрдиреЗрдЫ рд░ рдРрдирдХреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкреВрд░рд╛ рдЧрд░рд┐ рдХрд╛рдорджрд╛рд░ рдЫрдиреМрдЯ рднрдПрдХреЛ рдорд┐рддрд┐рд▓реЗ рд╡реИрджреЗрд╢рд┐рдХ рд░реЛрдЬрдЧрд╛рд░ рдРрди 2064 рдХреЛ рджрдлрд╛ 20 рдмрдореЛрдЬрд┐рдордХреЛ рдореНрдпрд╛рдж рднрд┐рддреНрд░ рдЖрд╡рд╢реНрдпрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкреБрд░рд╛ рдЧрд░реА рд╕рдореНрдмрдиреНрдзрд┐рдд рдореБрд▓реБрдХрдорд╛ рд░реЛрдЬрдЧрд╛рд░рдХреЛ рд▓рд╛рдЧрд┐ рдкрдард╛рдИ рд╕рдХреНрдиреБ рдкрд░реНрдиреЗрдЫ I рдЫрдиреМрдЯ рднрдПрдХрд╛ рдХрд╛рдорджрд╛рд░рд╣рд░реБ рд╕реЛ рдореНрдпрд╛рдж рднрд┐рддреНрд░ рдкрдард╛рдЙрди рдирд╕рдХреЗрдорд╛ рдРрдирдХреЛ рджрдлрд╛ 20(2) рдмрдореЛрдЬрд┐рдо рдХрд╛рд░рдмрд╛рд╣реА рднрдИ рдЬрд╛рдиреЗ рдмреНрдпрд╣реЛрд░рд╛ рд╕рдореЗрдд рдЕрд╡рдЧрдд рдЧрд░рд╛рдИрдиреНрдЫ ред IE A. рдкрдж рдмрд┐рдмрд░рдг рд╕рдВрдЦреНрдпрд╛ рдорд╛рд╕рд┐рдХ рддрд▓рдм рдХреИрдлрд┐рдпрдд рдмрд┐рдЬреНрдЮрд╛рдкрдирдорд╛ - рдорд╛рд╕рд┐рдХ рддрд▓рдм рдорд╛рддреНрд░ рдЙрд▓реНрд▓реЗрдЦ рдЧрд░реНрдиреЗ I - рдмрд┐рджреЗрд╢ рд╕реНрдерд┐рдд рдХрдореНрдкрдиреАрдХреЛ рдирд╛рдо рдЙрддреНрд▓реЗрдЦ рдЧрд░реНрдиреЗ ред - рднрд┐рд╖рд╛ рд╢реБрд▓реНрдХ рдЙрд▓реНрд▓реЗрдЦ рдЧрд░реНрдиреБ рдкрд░реНрдиреЗред рднрд┐рд╖рд╛ рдкреНрд░рд╛рдкреНрдд рдирднрдИ рдЕрдЧреНрд░рд┐рдо рднрдХреНрддрд╛рдиреА рдорд╛рдЧ рдирдЧрд░реНрдиреЗ ред - рд╕рд░рдХрд╛рд░реА Af рддрд┐рд░реНрдиреБ рдкрд░реНрдиреЗ рднрдП рдЙрд▓реНрд▓реЗрдЦ рдкреБрд░реБрд╖ I рдорд╣рд┐рд▓рд╛ рдЧрд░реНрдиреЗ ред E рд╣рд┐ - рд╕реНрд╡рд┐рдХреГрддрд┐ рд▓рд┐рдИ рд╢рд╛рдЦрд╛ рдЦреЛрд▓рд┐рдЗрдПрдХреЛрдорд╛ рдмрд╛рд╣реЗрдХ рд╢рд╛рдЦрд╛ рд░ рдПрдЬреЗрдиреНрдЯрдХреЛ рдХреБрд░рд╛ рдЙрд▓реНрд▓реЗрдЦ рдирдЧрд░реНрдиреЗ ред DR рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐рдХреЛ рд╕рдВрдЦреНрдпрд╛ 150 50 рдбрд┐рдорд╛рдгреНрдб рд▓реИрдЯрд░ рд░ рдХрд░рд╛рд░рдХрд╛ рдореБрдЦреНрдп рд╢рд░реНрддрд╣рд░реВ рд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдврд╛рдБрдЪрд╛ рдмрдореЛрдЬрд┐рдордХрд╛ рдмрд┐рдмрд░рдгрд╣рд░реБ рдЕрдирд┐рд╡рд╛рд░реНрдп рд░реБрдкрдорд╛ рдмрд┐рдЬреНрдЮрд╛рдкрдирдорд╛ рдЙрд▓реНрд▓реЗрдЦ рд╣реБрдиреБ рдкрд░реНрдиреЗрдЫ рддрдерд╛ рдЕрдиреНрддрд░рд╡рд╛рд░реНрддрд╛рдХреЛ рд▓рд╛рдЧрд┐ рдкреНрд░рддрд┐рдирд┐рдзрд┐ рдорд╛рдЧ рдЧрд░реНрджрд╛ рдкреНрд░рдХрд╛рд╢рд┐рдд рдкрддреНрд░рд┐рдХрд╛рдХреЛ рдорд┐рддрд┐ рд╕рдореЗрдд рдкреНрд░рд╖реНрдЯ рднрдПрдХреЛ рд╕рдХреНрдХрдд рдкрддреНрд░рд┐рдХ рдиреИ рдкреЗрд╢ рдЧрд░реНрдиреБ рдкрд░реНрдиреЗрдЫ I рдЕрдиреНрдпрдерд╛ рдкрдЫрд┐ рдХрд╛рд░рд╡рд╛рд╣рд┐ рдирд╣реБрдиреЗ рд╡реНрдпрд╣реЛрд░рд╛ рдЬрд╛рдирдХрд╛рд░реА рдЧрд░рд╛рдИрдиреНрдЫ I рд╕рд╛рдереИ рд╡реИрджреЗрд╢рд┐рдХ рд░реЛрдЬрдЧрд╛рд░ рдРрди 2064 рд░ рдирд┐рдпрдорд╡рд╛рд▓рд┐ 2064 рд╡рд┐рдкрд░рд┐рдд рдХреБрдиреИ рдХрд╛рд░реНрдп рдЧрд░реЗрдорд╛ рдпреЛ рдкреВрд░реНрд╡ рд╕рд┐рдХреГрддрд┐ рдЬреБрди рд╕реБрдХреИ рд╕рдордпрдорд╛ рд░рджреНрдж рдЧрд░рд┐рдиреЗ рдЫ I : рдиреЛрдЯ : рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐рдХреЛ рд╡рд┐рдЬреНрдЮрд╛рдкрди рдкреНрд░рдХрд╛рд╢рди рдЧрд░реНрджрд╛ рдиреЗрдкрд╛рд▓ рд╕рд░рдХрд╛рд░рдмрд╛рдЯ 10% рдХреЛрдЯрд╛ рдорд╣рд┐рд▓рд╛, рджрд▓рд┐рдд, рдкрд┐рдЫрдбрд┐рдПрдХреЛ рдХреНрд╖реЗрддреНрд░, рдЖрджреАрдмрд╛рд╕реА рдЬрдирдЬрд╛рддрд┐ рд░ рдордзреЗрд╕реА рд▓рд╛рдИ рдЫреБрдЯреНрдпрд╛рдЗрдПрдХреЛ рднрдиреА рд▓реЗрдЦреА рдкреНрд░рдХрд╛рд╢рд┐рдд рдЧрд░реНрдиреЗ рдЧрд░рд┐рдПрдХреЛрдорд╛ рд╣рд╛рд▓ рд╕реЛ рдмреНрдпрд╡рд╕реНрдерд╛ рдХрд╛рдпрдо рдирд░рд╣реЗрдХреЛрд▓реЗ рдкреНрд░рдХрд╛рд╢рди рдЧрд░рд┐ рд░рд╛рдЦреНрдиреБ рдирдкрд░реНрдиреЗ ред 1 Sales Officer 150 50 AED 2025.00`;
  
  console.log('ЁЯзк Testing parsing with your document format...');
  const result = parseFromOCR(sampleText);
  console.log('ЁЯУЛ Parsed result:', result);
  
  // Display results in alert
  let message = 'ЁЯУЛ Parsing Test Results:\n\n';
  message += `Company: ${result.company_name || 'Not found'}\n`;
  message += `Country: ${result.country || 'Not found'}\n`;
  message += `City: ${result.city || 'Not found'}\n`;
  message += `Date: ${result.pre_approval_date || 'Not found'}\n`;
  message += `Chalani: ${result.chalani_no || 'Not found'}\n`;
  message += `LOT: ${result.lot_no || 'Not found'}\n`;
  
  if (result.positions && result.positions.length) {
    const pos = result.positions[0];
    message += `\nPosition: ${pos.position || 'Not found'}\n`;
    message += `Male: ${pos.male_count || 'Not found'}\n`;
    message += `Female: ${pos.female_count || 'Not found'}\n`;
    message += `Salary: ${pos.salary_amount || 'Not found'} ${pos.salary_currency || ''}\n`;
  }
  
  alert(message);
}

// Test multi-row parsing with various formats
function testMultiRowParsing() {
  const multiRowText = `рдкрдж рд╡рд┐рд╡рд░рдг рд╕рдВрдЦреНрдпрд╛ рдорд╛рд╕рд┐рдХ рддрд▓рдм
1 Scaffolding 2 0 YEN 177657.00
рез Welder рей рез JPY 150,000
2 Driver 0 4 1200 AED
рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐рдХреЛ рд╕реЗрдзрд╛ 5 5`;
  
  console.log('ЁЯзк Testing multi-row parsing...');
  const result = parseFromOCR(multiRowText);
  console.log('ЁЯУЛ Multi-row parsed result:', result);
  
  let message = 'ЁЯУЛ Multi-Row Parsing Test:\n\n';
  if (result.positions && result.positions.length) {
    message += `Found ${result.positions.length} position(s):\n`;
    result.positions.forEach((pos, index) => {
      message += `\nPosition ${index + 1}:\n`;
      message += `  Position: ${pos.position}\n`;
      message += `  Male: ${pos.male_count}\n`;
      message += `  Female: ${pos.female_count}\n`;
      message += `  Salary: ${pos.salary_amount} ${pos.salary_currency}\n`;
    });
  } else {
    message += 'No positions found';
  }
  
  alert(message);
}
// Test your exact document format
function testYourExactFormat() {
  const exactText = `1 Scaffolding 2 0 YEN 177657.00`;
  
  console.log('ЁЯзк Testing your exact document format...');
  console.log('Input text:', exactText);
  
  const result = parseFromOCR(exactText);
  console.log('ЁЯУЛ Parsed result:', result);
  
  let message = 'ЁЯУЛ Your Exact Format Test:\n\n';
  message += `Input: "${exactText}"\n\n`;
  
  if (result.positions && result.positions.length) {
    const pos = result.positions[0];
    message += `тЬЕ Extracted:\n`;
    message += `Position: ${pos.position}\n`;
    message += `Male: ${pos.male_count}\n`;
    message += `Female: ${pos.female_count}\n`;
    message += `Salary: ${pos.salary_amount}\n`;
    message += `Currency: ${pos.salary_currency}\n`;
  } else {
    message += 'тЭМ No position found';
  }
  
  alert(message);
}

// Quick OCR test with a simple canvas
function testQuickOCR() {
  console.log('ЁЯзк Starting Quick OCR Test...');
  
  // Check if Tesseract is loaded
  if (typeof Tesseract === 'undefined') {
    console.error('тЭМ Tesseract.js not loaded!');
    alert('тЭМ Tesseract.js not loaded!\nPlease check your internet connection.');
    return;
  }
  
  console.log('тЬЕ Tesseract.js is loaded, version:', Tesseract.version);
  
  // Show loading message
  alert('ЁЯФД Creating test image and running OCR...\nThis may take 10-15 seconds.');
  
  try {
    // Create a simple test image with text
    const canvas = document.createElement('canvas');
    canvas.width = 300;
    canvas.height = 100;
    const ctx = canvas.getContext('2d');
    
    // White background
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, 300, 100);
    
    // Black text
    ctx.fillStyle = 'black';
    ctx.font = 'bold 24px Arial';
    ctx.fillText('Test OCR 123', 20, 40);
    ctx.font = '16px Arial';
    ctx.fillText('This is a test image', 20, 70);
    
    console.log('тЬЕ Test image created');
    
    // Convert to blob with timeout
    canvas.toBlob(async (blob) => {
      if (!blob) {
        alert('тЭМ Failed to create test image blob');
        return;
      }
      
      console.log('тЬЕ Blob created, size:', blob.size);
      
      try {
        console.log('ЁЯФД Starting Tesseract.recognize...');
        
        // Add timeout to the OCR call
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('OCR timeout after 20 seconds')), 20000);
        });
        
        const ocrPromise = Tesseract.recognize(blob, 'eng', {
          logger: m => console.log('[OCR]', m.status, m.progress)
        });
        
        const result = await Promise.race([ocrPromise, timeoutPromise]);
        
        console.log('тЬЕ OCR completed successfully');
        console.log('OCR result:', result);
        
        const detectedText = result.data.text.trim();
        alert('тЬЕ OCR Test Successful!\n\nDetected Text:\n"' + detectedText + '"\n\nConfidence: ' + Math.round(result.data.confidence) + '%');
        
      } catch (error) {
        console.error('тЭМ OCR Test Failed:', error);
        alert('тЭМ OCR Test Failed:\n' + error.message + '\n\nPlease check console for details.');
      }
    }, 'image/png');
    
  } catch (error) {
    console.error('тЭМ Error creating test image:', error);
    alert('тЭМ Error creating test image:\n' + error.message);
  }
}

// Parse with tolerant patterns (don't rely on perfect "Label: value")
const LABELS = {
  company:  [/рдХрдореНрдкрдиреА(?:рдХреЛ)?\s*рдирд╛рдо/i, /Company\s*Name/i, /Company/i, /рд╢реНрд░реА\s+([^ред\s]+(?:\s+[^ред\s]+)*)/i],
  country:  [/рдореБрд▓реБрдХрдХреЛ\s+([^ред\s]+(?:\s+[^ред\s]+)*?)(?=\s+UAE\.P\.|\s+рд╕реНрдерд┐рдд|\s+ред|$)/i, /рджреЗрд╢/i, /Country/i, /\bUAE\b/i],
  city:     [/рд╢рд╣рд░\s+([^ред\n]+?)(?=\s+рдХрдореНрдкрдиреАрдмрд╛рдЯ|\s+ред|\s+$|\s+[A-Z]{2,}|\s+рдорд╛рдЧ|\s+рд╕рдиреНрджрд░реНрднрдорд╛)/i, /City\s+([^ред\n]+?)(?=\s+рдХрдореНрдкрдиреАрдмрд╛рдЯ|\s+ред|\s+$|\s+[A-Z]{2,}|\s+рдорд╛рдЧ|\s+рд╕рдиреНрджрд░реНрднрдорд╛)/i, /рд╕реНрдерд┐рдд\s+([^ред\n]+?)(?=\s+рдХрдореНрдкрдиреАрдмрд╛рдЯ|\s+ред|\s+$|\s+[A-Z]{2,}|\s+рдорд╛рдЧ|\s+рд╕рдиреНрджрд░реНрднрдорд╛)/i, /([^ред\n]+?)\s+рд╢рд╣рд░(?=\s+рдХрдореНрдкрдиреАрдмрд╛рдЯ|\s+ред|\s+$|\s+[A-Z]{2,}|\s+рдорд╛рдЧ|\s+рд╕рдиреНрджрд░реНрднрдорд╛)/i, /([^ред\n]+?)\s+City(?=\s+рдХрдореНрдкрдиреАрдмрд╛рдЯ|\s+ред|\s+$|\s+[A-Z]{2,}|\s+рдорд╛рдЧ|\s+рд╕рдиреНрджрд░реНрднрдорд╛)/i, /([^ред\n]+?)\s+рд╢рд╣рд░\s+рдХрдореНрдкрдиреАрдмрд╛рдЯ/i, /рд╢рд╣рд░\s+([^ред\n]+?)\s+рдХрдореНрдкрдиреАрдмрд╛рдЯ/i, /рд╕реНрдерд┐рдд\s+([^ред\n]+?)\s+рдХрдореНрдкрдиреАрдмрд╛рдЯ/i, /рдХрдореНрдкрдиреАрдмрд╛рдЯ\s+([^ред\n]+?)\s+рд╢рд╣рд░/i],
  chalani:  [/рдЪрд▓рд╛рдиреА\s*рдирдВ\.?\s*(\d+)/i, /Chalani\s*No\.?\s*(\d+)/i, /рдЪрд▓рд╛рдиреА\s*рдирдВ\.?/i, /Chalani\s*No\.?/i],
  lot:      [/LT\.\s*No\.\s*(\d+)/i, /LOT\s*рдирдВ\.?\s*(\d+)/i, /LOT\s*No\.?\s*(\d+)/i, /LOT\s*рдирдВ\.?/i, /LOT\s*No\.?/i],
  predate:  [/Date\s+(\d{4}\/\d{2}\/\d{2})/i, /рдорд┐рддрд┐\s+(\d{4}\/\d{2}\/\d{2})/i, /рдкреВрд░реНрд╡\s*рд╕реНрд╡реАрдХреГрддрд┐\s*рдорд┐рддрд┐/i, /Pre[-\s]?approval\s*Date/i],
  position: [/рдкрдж/i, /Position/i, /рдкрдж\s*рдмрд┐рдмрд░рдг/i],
  male:     [/рдкреБрд░реБрд╖\s*(\d+)/i, /Male\s*(\d+)/i, /рдкреБрд░реБрд╖/i, /Male/i],
  female:   [/рдорд╣рд┐рд▓рд╛\s*(\d+)/i, /Female\s*(\d+)/i, /рдорд╣рд┐рд▓рд╛/i, /Female/i],
  salary:   [/рддрд▓рдм|Salary|Basic\s*Salary|рдорд╛рд╕рд┐рдХ\s*рддрд▓рдм/i]
};

function findAfterLabel(text, labelList, maxLook=120) {
  const lines = text.split('\n');
  
  for (let i=0;i<lines.length;i++){
    const L = lines[i];

    // Check if any label pattern matches this line
    for (const pattern of labelList) {
      if (pattern.test(L)) {
        // If pattern has capture groups, extract the captured value
        const match = L.match(pattern);
        if (match && match[1]) {
          return match[1].trim();
        }
        
        // try same line after delimiter - but with strict boundaries
        const m = L.split(/[:\-тАУ|]\s*/).slice(1).join(' ').trim();
        if (m) {
          // Stop at common boundaries to prevent over-capturing
          const cleanValue = m.split(/[ред\s]+(?:рдореБрд▓реБрдХрдХреЛ|рд╕реНрдерд┐рдд|UAE\.P\.|рдХрдореНрдкрдиреАрдмрд╛рдЯ|рд╕рдиреНрджрд░реНрднрдорд╛|рдмрдореЛрдЬрд┐рдо|рдХрд╛рд░рд╡рд╛рд╣реА|рдЧрд░рд┐рдПрдХреЛ|рднрдПрдХреЛ|рдЧрд░реНрди|рд╣реБрдиреБ|рдкрд░реНрдиреЗ|рдЫ|ред)/)[0].trim();
          if (cleanValue && cleanValue.length < 80) return cleanValue; // Limit length
        }
        
        // else take next non-empty line but with strict limits
        for (let j=i+1;j<Math.min(i+3,lines.length);j++){
          const v = lines[j].trim();
          if (v) {
            // Stop at boundaries and limit length
            const cleanValue = v.split(/[ред\s]+(?:рдореБрд▓реБрдХрдХреЛ|рд╕реНрдерд┐рдд|UAE\.P\.|рдХрдореНрдкрдиреАрдмрд╛рдЯ|рд╕рдиреНрджрд░реНрднрдорд╛|рдмрдореЛрдЬрд┐рдо|рдХрд╛рд░рд╡рд╛рд╣реА|рдЧрд░рд┐рдПрдХреЛ|рднрдПрдХреЛ|рдЧрд░реНрди|рд╣реБрдиреБ|рдкрд░реНрдиреЗ|рдЫ|ред)/)[0].trim();
            if (cleanValue && cleanValue.length < 80) return cleanValue; // Limit length
          }
        }
      }
    }
  }
  
  // If no direct matches, try to find patterns in the entire text
  for (const pattern of labelList) {
    if (pattern.source.includes('([^ред\\s]+)') || pattern.source.includes('(\\d+)')) {
      const match = text.match(pattern);
      if (match && match[1]) {
        return match[1].trim();
      }
    }
  }
  
        return '';
    }
    
function firstNumber(s){ const m = (s||'').match(/[\d,.]+/); return m?m[0]:''; }

// Special function to extract information from employment letters
function extractEmploymentLetterInfo(text) {
  const info = {};
    
  // Extract company name (after рд╢реНрд░реА, stop at рдореБрд▓реБрдХрдХреЛ or рд╕реНрдерд┐рдд)
  let companyMatch = text.match(/рд╢реНрд░реА\s+([^ред\s]+(?:\s+[^ред\s]+)*?)(?=\s+рдореБрд▓реБрдХрдХреЛ|\s+рд╕реНрдерд┐рдд|\s+UAE\.P\.|$)/i);
  if (companyMatch) {
    info.company = companyMatch[1].trim();
  } else {
    // Fallback: try to find company name pattern
    const companyPattern = text.match(/([A-Z][A-Z\s&\.]+(?:PVT\.?|LTD\.?|LLC\.?|INC\.?|CO\.?)[A-Z\s&\.]*)/i);
    if (companyPattern) {
      info.company = companyPattern[1].trim();
    }
  }
  
  // Extract LOT/LT number
  const lotMatch = text.match(/LT\.\s*No\.\s*(\d+)/i);
  if (lotMatch) info.lot = lotMatch[1];
  
  // Extract Chalani number
  const chalaniMatch = text.match(/рдЪрд▓рд╛рдиреА\s*рдирдВ\.?\s*(\d+)/i);
  if (chalaniMatch) info.chalani = chalaniMatch[1];
  
  // Extract date
  const dateMatch = text.match(/Date\s+(\d{4}\/\d{2}\/\d{2})/i);
  if (dateMatch) info.date = dateMatch[1];
  
  // Extract country - be more specific to avoid over-capturing
  const countryMatch = text.match(/\bUAE\b/i);
  if (countryMatch) {
    info.country = 'UAE';
        } else {
    // Try to find country after рдореБрд▓реБрдХрдХреЛ
    const countryAfterMuluk = text.match(/рдореБрд▓реБрдХрдХреЛ\s+([^ред\s]+(?:\s+[^ред\s]+)*?)(?=\s+UAE\.P\.|\s+рд╕реНрдерд┐рдд|\s+ред|$)/i);
    if (countryAfterMuluk) {
      info.country = countryAfterMuluk[1].trim();
    }
  }
  
  // Extract city/location - handle multiple formats
  let city = '';
  
  // Try different city patterns
  const cityPatterns = [
    /рд╕реНрдерд┐рдд\s+([^ред\s]+(?:\s+[^ред\s]+)*?)(?=\s+рдХрдореНрдкрдиреАрдмрд╛рдЯ|\s+ред|$)/i,  // рд╕реНрдерд┐рдд + city
    /рд╢рд╣рд░\s+([^ред\s]+(?:\s+[^ред\s]+)*?)(?=\s+ред|$)/i,                    // рд╢рд╣рд░ + city
    /City\s+([^ред\s]+(?:\s+[^ред\s]+)*?)(?=\s+ред|$)/i,                    // City + city
    /([^ред\s]+(?:\s+[^ред\s]+)*?)\s+рд╢рд╣рд░/i,                               // city + рд╢рд╣рд░
    /([^ред\s]+(?:\s+[^ред\s]+)*?)\s+City/i                                // city + City
  ];
  
  for (const pattern of cityPatterns) {
    const match = text.match(pattern);
    if (match && match[1]) {
      city = match[1].trim();
      console.log(`тЬЕ City found with pattern: ${pattern.source} = "${city}"`);
      break;
    }
  }
  
  info.city = city;
  
  // Extract country - handle multiple countries
  let country = '';
  
  // Check for common countries
  if (text.includes('UAE')) {
    const uaeMatch = text.match(/([^ред\s]+(?:\s+[^ред\s]+)*?)\s+рдореБрд▓реБрдХрдХреЛ/i);
    if (uaeMatch) {
      country = uaeMatch[1].trim();
    } else {
      country = 'UAE';
    }
  } else if (text.includes('Japan') || text.includes('рдЬрд╛рдкрд╛рди')) {
    country = 'Japan';
  } else if (text.includes('Saudi') || text.includes('рд╕рд╛рдЙрджреА')) {
    country = 'Saudi Arabia';
  } else if (text.includes('Qatar') || text.includes('рдХрддрд╛рд░')) {
    country = 'Qatar';
  } else if (text.includes('Oman') || text.includes('рдУрдорд╛рди')) {
    country = 'Oman';
  } else if (text.includes('Bahrain') || text.includes('рдмрд╣рд░реЗрди')) {
    country = 'Bahrain';
  } else if (text.includes('Kuwait') || text.includes('рдХреБрд╡реИрдд')) {
    country = 'Kuwait';
  } else {
    // Generic country extraction after рдореБрд▓реБрдХрдХреЛ
    const countryMatch = text.match(/рдореБрд▓реБрдХрдХреЛ\s+([^ред\s]+(?:\s+[^ред\s]+)*?)(?=\s+UAE\.P\.|\s+рд╕реНрдерд┐рдд|\s+ред|$)/i);
    if (countryMatch) {
      country = countryMatch[1].trim();
    }
  }
  
  info.country = country;
  
  // Extract employee count
  const countMatch = text.match(/(\d+)\s*рдЬрдирд╛\s*рдиреЗрдкрд╛рд▓реА\s*рдХрд╛рдорджрд╛рд░/i);
  if (countMatch) info.employeeCount = countMatch[1];
  
  console.log('ЁЯФН Extracted employment letter info:', info);
  
  // Debug company extraction specifically
  console.log('ЁЯФН === COMPANY EXTRACTION DEBUG ===');
  const companyPattern1 = text.match(/рд╢реНрд░реА\s+([^ред\s]+(?:\s+[^ред\s]+)*?)(?=\s+рдореБрд▓реБрдХрдХреЛ|\s+рд╕реНрдерд┐рдд|\s+UAE\.P\.|$)/i);
  console.log('Pattern 1 (рд╢реНрд░реА + company):', companyPattern1);
  
  const companyPattern2 = text.match(/([A-Z][A-Z\s&\.]+(?:PVT\.?|LTD\.?|LLC\.?|INC\.?|CO\.?)[A-Z\s&\.]*)/i);
  console.log('Pattern 2 (Company format):', companyPattern2);
  
  return info;
}

// Intelligent OCR extraction that learns from document structure
function intelligentOCRExtraction(text) {
  console.log('ЁЯза === INTELLIGENT OCR EXTRACTION ===');
  console.log('Analyzing document structure automatically...');
  
  const data = {};
  const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
  
  // 1. SMART FIELD DETECTION - Find fields by looking for common patterns
  const fieldDetectors = {
    // Numbers with labels
    chalani: {
      patterns: [
        /рдЪрд▓рд╛рдиреА\s*рдирдВ\.?\s*:?\s*(\d+)/i,
        /Chalani\s*No\.?\s*:?\s*(\d+)/i,
        /рдЪрд▓рд╛рдиреА\s*рдирдВ\.?\s*(\d+)/i
      ],
      description: 'Chalani number'
    },
    lot: {
      patterns: [
        /LT\.\s*No\.\s*(\d+)/i,
        /LOT\s*рдирдВ\.?\s*(\d+)/i,
        /LOT\s*No\.?\s*(\d+)/i
      ],
      description: 'LOT number'
    },
    date: {
      patterns: [
        /Date\s+(\d{4}[\/\-]\d{2}[\/\-]\d{2})/i,
        /рдорд┐рддрд┐\s+(\d{4}[\/\-]\d{2}[\/\-]\d{2})/i,
        /(\d{4}[\/\-]\d{2}[\/\-]\d{2})/i
      ],
      description: 'Date'
    },
    employeeCount: {
      patterns: [
        /(\d+)\s*рдЬрдирд╛\s*рдиреЗрдкрд╛рд▓реА\s*рдХрд╛рдорджрд╛рд░/i,
        /(\d+)\s*рдиреЗрдкрд╛рд▓реА\s*рдХрд╛рдорджрд╛рд░/i,
        /(\d+)\s*workers/i
      ],
      description: 'Employee count'
    }
  };
  
  // Extract structured data
  for (const [field, detector] of Object.entries(fieldDetectors)) {
    for (const pattern of detector.patterns) {
      const match = text.match(pattern);
      if (match && match[1]) {
        data[field] = match[1];
        console.log(`тЬЕ ${detector.description}: ${match[1]}`);
        break;
      }
    }
  }
  
  // 2. INTELLIGENT COMPANY EXTRACTION - Find company name by context
  console.log('\nЁЯФН Looking for company name...');
  
  // Look for company after рд╢реНрд░реА or similar indicators
  const companyIndicators = ['рд╢реНрд░реА', 'Shri', 'Mr.', 'Company', 'рдХрдореНрдкрдиреА'];
  for (const indicator of companyIndicators) {
    const companyMatch = text.match(new RegExp(`${indicator}\\s+([^ред\\s]+(?:\\s+[^\\s]+)*?)(?=\\s+рдореБрд▓реБрдХрдХреЛ|\\s+рд╕реНрдерд┐рдд|\\s+UAE\\.P\\.|\\s+ред|$)`, 'i'));
    if (companyMatch) {
      data.company = companyMatch[1].trim();
      console.log(`тЬЕ Company found after "${indicator}": ${data.company}`);
      break;
    }
  }
  
  // 3. SMART COUNTRY DETECTION - Find country by context and keywords
  console.log('\nЁЯМН Looking for country...');
  
  // Look for country keywords in the text
  const countryKeywords = {
    'UAE': ['UAE', 'рдпреВрдПрдИ', 'United Arab Emirates'],
    'Japan': ['Japan', 'рдЬрд╛рдкрд╛рди', 'JPN'],
    'Saudi': ['Saudi', 'рд╕рд╛рдЙрджреА', 'Saudi Arabia', 'KSA'],
    'Qatar': ['Qatar', 'рдХрддрд╛рд░', 'QAR'],
    'Oman': ['Oman', 'рдУрдорд╛рди', 'OMR'],
    'Bahrain': ['Bahrain', 'рдмрд╣рд░реЗрди', 'BHD'],
    'Kuwait': ['Kuwait', 'рдХреБрд╡реИрдд', 'KWD']
  };
  
  for (const [country, keywords] of Object.entries(countryKeywords)) {
    for (const keyword of keywords) {
      if (text.includes(keyword)) {
        data.country = country;
        console.log(`тЬЕ Country detected: ${country} (found keyword: ${keyword})`);
        break;
      }
    }
    if (data.country) break;
  }
  
  // 4. INTELLIGENT CITY EXTRACTION - Find city by context
  console.log('\nЁЯПЩя╕П Looking for city...');
  
  // Try multiple city extraction strategies
  let city = '';
  
  // Strategy 1: Look for city after рд╢рд╣рд░ (most common in Nepali documents)
  const shaharMatch = text.match(/рд╢рд╣рд░\s+([^ред\n]+?)(?=\s+рдХрдореНрдкрдиреАрдмрд╛рдЯ|\s+ред|\s+$|\s+[A-Z]{2,}|\s+рдорд╛рдЧ|\s+рд╕рдиреНрджрд░реНрднрдорд╛)/i);
  if (shaharMatch) {
    city = shaharMatch[1].trim();
    console.log(`тЬЕ City found after "рд╢рд╣рд░": "${city}"`);
  }
  
  // Strategy 2: Look for city after рд╕реНрдерд┐рдд (UAE format)
  if (!city) {
    const sthitMatch = text.match(/рд╕реНрдерд┐рдд\s+([^ред\n]+?)(?=\s+рдХрдореНрдкрдиреАрдмрд╛рдЯ|\s+ред|\s+$|\s+[A-Z]{2,}|\s+рдорд╛рдЧ|\s+рд╕рдиреНрджрд░реНрднрдорд╛)/i);
    if (sthitMatch) {
      city = sthitMatch[1].trim();
      console.log(`тЬЕ City found after "рд╕реНрдерд┐рдд": "${city}"`);
}
  }
  
  // Strategy 3: Look for city before рд╢рд╣рд░ (reverse format)
  if (!city) {
    const reverseMatch = text.match(/([^ред\n]+?)\s+рд╢рд╣рд░(?=\s+рдХрдореНрдкрдиреАрдмрд╛рдЯ|\s+ред|\s+$|\s+[A-Z]{2,}|\s+рдорд╛рдЧ|\s+рд╕рдиреНрджрд░реНрднрдорд╛)/i);
    if (reverseMatch) {
      city = reverseMatch[1].trim();
      console.log(`тЬЕ City found before "рд╢рд╣рд░": "${city}"`);
    }
  }
  
  // Strategy 4: Look for city after City (English format)
  if (!city) {
    const cityMatch = text.match(/City\s+([^ред\n]+?)(?=\s+рдХрдореНрдкрдиреАрдмрд╛рдЯ|\s+ред|\s+$|\s+[A-Z]{2,}|\s+рдорд╛рдЧ|\s+рд╕рдиреНрджрд░реНрднрдорд╛)/i);
    if (cityMatch) {
      city = cityMatch[1].trim();
      console.log(`тЬЕ City found after "City": "${city}"`);
    }
  }
  
  // Strategy 5: Look for city before City (reverse English format)
  if (!city) {
    const reverseCityMatch = text.match(/([^ред\n]+?)\s+City(?=\s+рдХрдореНрдкрдиреАрдмрд╛рдЯ|\s+ред|\s+$|\s+[A-Z]{2,}|\s+рдорд╛рдЧ|\s+рд╕рдиреНрджрд░реНрднрдорд╛)/i);
    if (reverseCityMatch) {
      city = reverseCityMatch[1].trim();
      console.log(`тЬЕ City found before "City": "${city}"`);
    }
  }
  
  // Strategy 6: Look for city in specific context patterns
  if (!city) {
    const contextPatterns = [
      /([^ред\n]+?)\s+рд╢рд╣рд░\s+рдХрдореНрдкрдиреАрдмрд╛рдЯ/i,
      /рд╢рд╣рд░\s+([^ред\n]+?)\s+рдХрдореНрдкрдиреАрдмрд╛рдЯ/i,
      /рд╕реНрдерд┐рдд\s+([^ред\n]+?)\s+рдХрдореНрдкрдиреАрдмрд╛рдЯ/i,
      /рдХрдореНрдкрдиреАрдмрд╛рдЯ\s+([^ред\n]+?)\s+рд╢рд╣рд░/i
    ];
    
    for (const pattern of contextPatterns) {
      const match = text.match(pattern);
      if (match && match[1]) {
        city = match[1].trim();
        console.log(`тЬЕ City found with context pattern: "${city}"`);
        break;
      }
    }
  }
  
  data.city = city;
  
  // 5. COMPREHENSIVE POSITION AND SALARY DETECTION
  console.log('\nЁЯТ╝ Looking for position details...');
  
  // First, analyze the document structure to understand the format
  console.log('ЁЯФН Analyzing document structure for position information...');
  
  // Look for table-like structures or position sections
  const hasPositionSection = text.includes('рдкрдж рдмрд┐рдмрд░рдг') || text.includes('Position Details') || text.includes('Job Details');
  const hasTableFormat = text.includes('рдкрдж') && text.includes('рд╕рдВрдЦреНрдпрд╛') && text.includes('рддрд▓рдм');
  
  console.log('Has position section:', hasPositionSection);
  console.log('Has table format:', hasTableFormat);
  
  // Look for position information with multiple patterns - UPDATED FOR YOUR FORMAT
  const positionPatterns = [
    // Your specific format: рдкрдж рд╡рд┐рд╡рд░рдг
    /рдкрдж\s*рд╡рд┐рд╡рд░рдг\s*:?\s*([^ред\n]+?)(?=\s+ред|\s+$|\s+[A-Z]{2,}|\s+рддрд▓рдм|\s+Salary|\s+рд╕рдВрдЦреНрдпрд╛)/i,
    /рдкрдж\s*рдмрд┐рдмрд░рдг\s*:?\s*([^ред\n]+?)(?=\s+ред|\s+$|\s+[A-Z]{2,}|\s+рддрд▓рдм|\s+Salary|\s+рд╕рдВрдЦреНрдпрд╛)/i,
    // Alternative formats
    /рдкрдж\s*:?\s*([^ред\n]+?)(?=\s+ред|\s+$|\s+[A-Z]{2,}|\s+рддрд▓рдм|\s+Salary|\s+рд╕рдВрдЦреНрдпрд╛)/i,
    /Position\s*:?\s*([^ред\n]+?)(?=\s+ред|\s+$|\s+[A-Z]{2,}|\s+рддрд▓рдм|\s+Salary|\s+рд╕рдВрдЦреНрдпрд╛)/i,
    // Look for position in table format or after specific keywords
    /рдкрдж\s*рдмрд┐рдмрд░рдг[^]*?(\w+(?:\s+\w+)*)/i,
    /Position\s*Details[^]*?(\w+(?:\s+\w+)*)/i,
    // Look for common job titles in the text
    /(Helper|Engineer|Technician|Worker|Labor|Driver|Cleaner|Cook|Waiter|Nurse|Doctor|Teacher|Manager|Supervisor|Assistant|Operator|Mechanic|Electrician|Plumber|Carpenter|Mason|Painter|Welder|Fitter|Helper|Worker|Laborer|Driver|Cleaner|Cook|Waiter|Nurse|Doctor|Teacher|Manager|Supervisor|Assistant|Operator|Mechanic|Electrician|Plumber|Carpenter|Mason|Painter|Welder|Fitter)/i
  ];
  
  for (const pattern of positionPatterns) {
    const match = text.match(pattern);
    if (match && match[1]) {
      data.position = match[1].trim();
      console.log(`тЬЕ Position: ${data.position}`);
      break;
    }
  }
  
          // Look for male count with multiple patterns - UPDATED FOR YOUR FORMAT
        const malePatterns = [
          // Your specific format: рд╕рдВрдЦреНрдпрд╛: рдкреБрд░реБрд╖ 2, рдорд╣рд┐рд▓рд╛ 0
          /рд╕рдВрдЦреНрдпрд╛\s*:?\s*рдкреБрд░реБрд╖\s*(\d+)/i,
          /рдкреБрд░реБрд╖\s*:?\s*(\d+)/i,
          /Male\s*:?\s*(\d+)/i,
          /рдкреБрд░реБрд╖\s*(\d+)/i,
          /Male\s*(\d+)/i,
          /(\d+)\s*рдкреБрд░реБрд╖/i,
          /(\d+)\s*Male/i
        ];
  
  for (const pattern of malePatterns) {
    const match = text.match(pattern);
    if (match && match[1]) {
      data.maleCount = match[1];
      console.log(`тЬЕ Male count: ${data.maleCount}`);
      break;
    }
  }
  
          // Look for female count with multiple patterns - UPDATED FOR YOUR FORMAT
        const femalePatterns = [
          // Your specific format: рд╕рдВрдЦреНрдпрд╛: рдкреБрд░реБрд╖ 2, рдорд╣рд┐рд▓рд╛ 0
          /рд╕рдВрдЦреНрдпрд╛\s*:?\s*[^,]*рдорд╣рд┐рд▓рд╛\s*(\d+)/i,
          /рдорд╣рд┐рд▓рд╛\s*:?\s*(\d+)/i,
          /Female\s*:?\s*(\d+)/i,
          /рдорд╣рд┐рд▓рд╛\s*(\d+)/i,
          /Female\s*(\d+)/i,
          /(\d+)\s*рдорд╣рд┐рд▓рд╛/i,
          /(\d+)\s*Female/i
        ];
  
  for (const pattern of femalePatterns) {
    const match = text.match(pattern);
    if (match && match[1]) {
      data.femaleCount = match[1];
      console.log(`тЬЕ Female count: ${data.femaleCount}`);
      break;
    }
  }
  
          // Look for salary information with multiple patterns - UPDATED FOR YOUR FORMAT
        const salaryPatterns = [
          // Your specific format: рдорд╛рд╕рд┐рдХ рддрд▓рдм
          /рдорд╛рд╕рд┐рдХ\s*рддрд▓рдм\s*:?\s*([^ред\n]+?)(?=\s+ред|\s+$|\s+[A-Z]{2,}|\s+рд╕рдВрдЦреНрдпрд╛)/i,
          /рддрд▓рдм\s*:?\s*([^ред\n]+?)(?=\s+ред|\s+$|\s+[A-Z]{2,}|\s+рд╕рдВрдЦреНрдпрд╛)/i,
          /Salary\s*:?\s*([^ред\n]+?)(?=\s+ред|\s+$|\s+[A-Z]{2,}|\s+рд╕рдВрдЦреНрдпрд╛)/i,
          /Basic\s*Salary\s*:?\s*([^ред\n]+?)(?=\s+ред|\s+$|\s+[A-Z]{2,}|\s+рд╕рдВрдЦреНрдпрд╛)/i
        ];
  
  for (const pattern of salaryPatterns) {
    const match = text.match(pattern);
    if (match && match[1]) {
      data.salary = match[1].trim();
      console.log(`тЬЕ Salary: ${data.salary}`);
      break;
    }
  }
  
  // Extract salary amount and currency separately
  if (data.salary) {
    // Extract amount (numbers)
    const amountMatch = data.salary.match(/(\d+(?:,\d+)*(?:\.\d+)?)/);
    if (amountMatch) {
      data.salaryAmount = amountMatch[1];
      console.log(`тЬЕ Salary amount: ${data.salaryAmount}`);
    }
    
    // Extract currency
    const currency = detectCurrency(data.salary);
    if (currency) {
      data.salaryCurrency = currency;
      console.log(`тЬЕ Salary currency: ${currency}`);
    }
  }
  
  // Look for employee count if not found above
  if (!data.maleCount && !data.femaleCount) {
    const countPatterns = [
      /(\d+)\s*рдЬрдирд╛\s*рдиреЗрдкрд╛рд▓реА\s*рдХрд╛рдорджрд╛рд░/i,
      /(\d+)\s*рдиреЗрдкрд╛рд▓реА\s*рдХрд╛рдорджрд╛рд░/i,
      /(\d+)\s*workers/i,
      /(\d+)\s*employees/i
    ];
    
    for (const pattern of countPatterns) {
      const match = text.match(pattern);
      if (match && match[1]) {
        data.employeeCount = match[1];
        console.log(`тЬЕ Total employee count: ${data.employeeCount}`);
        break;
      }
    }
  }
  
  console.log('\nЁЯОп Final extracted data:', data);
  return data;
}

// Specialized function for your employment letter format
function extractEmploymentLetterFormat(text) {
  console.log('ЁЯУЛ === EXTRACTING FROM YOUR EMPLOYMENT LETTER FORMAT ===');
  
  const data = {};
  
  // 1. Extract position from рдкрдж рд╡рд┐рд╡рд░рдг
  const positionMatch = text.match(/рдкрдж\s*рд╡рд┐рд╡рд░рдг\s*:?\s*([^ред\n]+?)(?=\s+ред|\s+$|\s+[A-Z]{2,}|\s+рддрд▓рдм|\s+Salary|\s+рд╕рдВрдЦреНрдпрд╛)/i);
  if (positionMatch && positionMatch[1]) {
    data.position = positionMatch[1].trim();
    console.log(`тЬЕ Position from рдкрдж рд╡рд┐рд╡рд░рдг: ${data.position}`);
  }
  
  // 2. Extract salary from рдорд╛рд╕рд┐рдХ рддрд▓рдм
  const salaryMatch = text.match(/рдорд╛рд╕рд┐рдХ\s*рддрд▓рдм\s*:?\s*([^ред\n]+?)(?=\s+ред|\s+$|\s+[A-Z]{2,}|\s+рд╕рдВрдЦреНрдпрд╛)/i);
  if (salaryMatch && salaryMatch[1]) {
    data.salary = salaryMatch[1].trim();
    console.log(`тЬЕ Salary from рдорд╛рд╕рд┐рдХ рддрд▓рдм: ${data.salary}`);
    
    // Extract amount and currency
    const amountMatch = data.salary.match(/(\d+(?:,\d+)*(?:\.\d+)?)/);
    if (amountMatch) {
      data.salaryAmount = amountMatch[1];
      console.log(`тЬЕ Salary amount: ${data.salaryAmount}`);
    }
    
    // Extract currency
    const currency = detectCurrency(data.salary);
    if (currency) {
      data.salaryCurrency = currency;
      console.log(`тЬЕ Salary currency: ${currency}`);
    }
  }
  
  // 3. Extract counts from рд╕рдВрдЦреНрдпрд╛: рдкреБрд░реБрд╖ 2, рдорд╣рд┐рд▓рд╛ 0
  const countMatch = text.match(/рд╕рдВрдЦреНрдпрд╛\s*:?\s*рдкреБрд░реБрд╖\s*(\d+)[^]*?рдорд╣рд┐рд▓рд╛\s*(\d+)/i);
  if (countMatch && countMatch[1] && countMatch[2]) {
    data.maleCount = countMatch[1];
    data.femaleCount = countMatch[2];
    console.log(`тЬЕ Male count: ${data.maleCount}`);
    console.log(`тЬЕ Female count: ${data.femaleCount}`);
  } else {
    // Try separate patterns if combined pattern doesn't work
    const maleMatch = text.match(/рд╕рдВрдЦреНрдпрд╛\s*:?\s*рдкреБрд░реБрд╖\s*(\d+)/i);
    if (maleMatch && maleMatch[1]) {
      data.maleCount = maleMatch[1];
      console.log(`тЬЕ Male count (separate): ${data.maleCount}`);
    }
    
    const femaleMatch = text.match(/рд╕рдВрдЦреНрдпрд╛\s*:?\s*[^,]*рдорд╣рд┐рд▓рд╛\s*(\d+)/i);
    if (femaleMatch && femaleMatch[1]) {
      data.femaleCount = femaleMatch[1];
      console.log(`тЬЕ Female count (separate): ${data.femaleCount}`);
    }
  }
  
  // 4. Look for employee count if not found above
  if (!data.maleCount && !data.femaleCount) {
    const totalMatch = text.match(/(\d+)\s*рдЬрдирд╛\s*рдиреЗрдкрд╛рд▓реА\s*рдХрд╛рдорджрд╛рд░/i);
    if (totalMatch && totalMatch[1]) {
      data.employeeCount = totalMatch[1];
      console.log(`тЬЕ Total employee count: ${data.employeeCount}`);
    }
  }
  
  console.log('ЁЯУЛ Final extracted data for your format:', data);
  return data;
}

// Test function for company extraction
function testCompanyExtraction() {
  const testText = `NEW GURKHAS INTERNATIONAL PVT. LTD. UAE рдореБрд▓реБрдХрдХреЛ UAE.P.OB0x:677,1ST FLOORNAD AL SHEBA FIRST MEYDAN.PO рд░рд╛рд╣рд░ рд╕реНрдерд┐рдд FINE FARE FOOD MARKET L.L.C рдХрдореНрдкрдиреАрдмрд╛рдЯ 200 рдЬрдирд╛ рдиреЗрдкрд╛рд▓реА рдХрд╛рдорджрд╛рд░ рдорд╛рдЧ рднрдИ рдЖрдПрдХреЛ рд╕рдиреНрджрд░реНрднрдорд╛ рддреНрдпрд╕ рдХрдореНрдкрдиреАрд▓реЗ рдмрд┐рдЬреНрдЮрд╛рдкрди рдЧрд░реА рдХрд╛рдорджрд╛рд░ рдЫрдиреМрдЯ рдЧрд░реНрди рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐рдХрд╛ рд▓рд╛рдЧрд┐ рдЕрдиреБрд░реЛрдз рдЧрд░реЗ рдмрдореЛрдЬрд┐рдо рдХрд╛рд░рд╡рд╛рд╣реА gal рдорд╛рдЧрдкрддреНрд░рдорд╛ рдЙрд▓реНрд▓реЗрдЦрд┐рдд рд╢рд░реНрдд рдПрд╡ рд╕реБрдмрд┐рдзрд╛рд╣рд░реВ рдкреВрд░реНрдг рдкрд╛рд▓рдирд╛ рдЧрд░рд╛рдЙрди рдХрдореНрдкрдиреА рд╕реНрд╡рдпрдВ рдЬрд┐рдореНрдореЗрд╡рд╛рд░реА рд╣реБрдиреЗ рдЧрд░реА рддрдкрд╕рд┐рд▓рдорд╛ рдЙрд▓реНрд▓реЗрдЦ рднрдП рдмрдореЛрдЬрд┐рдо рдЬрдореНрдорд╛ I рдкрджрдХреЛ рдХрд╛рдорджрд╛рд░рд╣рд░реБрдХреЛ рдЫрдиреМрдЯрдХреЛ рддрд╛рдЧрд┐ рдкреНрд░рдЪрд▓рд┐рдд рд╡реИрджреЗрд╢рд┐рдХ рд░реЛрдЬрдЧрд╛рд░ рдРрди, 2064 рдХреЛ рджрдлрд╛ 15(2) рдмрдореЛрдЬрд┐рдо рдорд┐рддрд┐ 2025/05/08 рдХреЛ рдирд┐рд░реНрдгрдпрд╛рдиреБрд╕рд╛рд░ рдкреВрд░реНрд╡ Radia рдкреНрд░рджрд╛рди рдЧрд░рд┐рдПрдХреЛ рдЫ I рд╕рд╛рдереИ рдмрд┐рдЬреНрдЮрд╛рдкрди рдЧрд░реНрджрд╛ рдХрдореНрддрд┐рдорд╛ 7 рджрд┐рдирдХреЛ рдореНрдпрд╛рдж рджрд┐рдИ рдпрд╕ рд╡рд┐рднрд╛рдЧрдХреЛ рдЖрдиреНрддрд░рд┐рдХ рдХрд╛рд░реНрдпрд╕рдВрдЪрд╛рд▓рди рдХрд╛рд░реНрдпрд╡рд┐рдзрд┐ 2066 рдорд╛ рд╡реНрдпрд╡рд╕реНрдерд╛ рдЧрд░рд┐рдПрдХреЛ рдврд╛рдБрдЪрд╛ рдЕрдиреБрд░реБрдкрдХрд╛ рд╕рдореНрдкреВрд░реНрдг рдмрд┐рдмрд░рдгрд╣рд░реВ рдЙрд▓реНрд▓реЗрдЦ рд╣реБрдиреБ рдкрд░реНрдиреЗрдЫ рд░ рдРрдирдХреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкреВрд░рд╛ рдЧрд░рд┐ рдХрд╛рдорджрд╛рд░ рдЫрдиреМрдЯ рднрдПрдХреЛ рдорд┐рддрд┐рд▓реЗ рд╡реИрджреЗрд╢рд┐рдХ рд░реЛрдЬрдЧрд╛рд░ рдРрди, 2064 рдХреЛ рджрдлрд╛ 20 рдмрдореЛрдЬрд┐рдордХреЛ рдореНрдпрд╛рдж рднрд┐рддреНрд░ рдЖрд╡рд╢реНрдпрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкреБрд░рд╛ рдЧрд░реА рд╕рдореНрдмрдиреНрдзрд┐рдд рдореБрд▓реБрдХрдорд╛ рд░реЛрдЬрдЧрд╛рд░рдХреЛ рд▓рд╛рдЧрд┐ рдкрдард╛рдИ рд╕рдХреНрдиреБ рдкрд░реНрдиреЗрдЫ I рдЫрдиреМрдЯ рднрдПрдХрд╛ рдХрд╛рдорджрд╛рд░рд╣рд░реБ рд╕реЛ рдореНрдпрд╛рдж рднрд┐рддреНрд░ рдкрдард╛рдЙрди рдирд╕рдХреЗрдорд╛ рдРрдирдХреЛ рджрдлрд╛ 20(2) рдмрдореЛрдЬрд┐рдо рдХрд╛рд░рдмрд╛рд╣реА рднрдИ рдЬрд╛рдиреЗ рдмреНрдпрд╣реЛрд░рд╛ рд╕рдореЗрдд рдЕрд╡рдЧрдд рдЧрд░рд╛рдИрдиреНрдЫ`;
  
  console.log('ЁЯзк === TESTING COMPANY EXTRACTION ===');
  console.log('Test text:', testText);
  
  // Test the company extraction patterns
  const pattern1 = testText.match(/рд╢реНрд░реА\s+([^ред\s]+(?:\s+[^ред\s]+)*?)(?=\s+рдореБрд▓реБрдХрдХреЛ|\s+рд╕реНрдерд┐рдд|\s+UAE\.P\.|$)/i);
  console.log('Pattern 1 result:', pattern1);
  
  const pattern2 = testText.match(/([A-Z][A-Z\s&\.]+(?:PVT\.?|LTD\.?|LLC\.?|INC\.?|CO\.?)[A-Z\s&\.]*)/i);
  console.log('Pattern 2 result:', pattern2);
  
  // Test with рд╢реНрд░реА prefix
  const testTextWithShri = `рд╢реНрд░реА ${testText}`;
  const pattern1WithShri = testTextWithShri.match(/рд╢реНрд░реА\s+([^ред\s]+(?:\s+[^ред\s]+)*?)(?=\s+рдореБрд▓реБрдХрдХреЛ|\s+рд╕реНрдерд┐рдд|\s+UAE\.P\.|$)/i);
  console.log('Pattern 1 with рд╢реНрд░реА result:', pattern1WithShri);
  
  alert('Check console for company extraction test results!');
}

// Test function for specific employment data extraction
function testSpecificExtraction() {
  const testText = `LT. No. 322862 рдХреЛ рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐ I Date 2025/08/08 рдЪрд▓рд╛рдиреА рдирдВ.  60237432 LT. No. 322862 рд╢реНрд░реА NEW GURKHAS INTERNATIONAL PVT. LTD. UAE рдореБрд▓реБрдХрдХреЛ UAE.P.OB0x 677,1ST FLOORNAD AL SHEBA FIRST MEYDAN.PO рд░рд╛рд╣рд░ рд╕реНрдерд┐рдд FINE FARE FOOD MARKET L.L.C рдХрдореНрдкрдиреАрдмрд╛рдЯ 200 рдЬрдирд╛ рдиреЗрдкрд╛рд▓реА рдХрд╛рдорджрд╛рд░ рдорд╛рдЧ рднрдИ рдЖрдПрдХреЛ рд╕рдиреНрджрд░реНрднрдорд╛ рддреНрдпрд╕ рдХрдореНрдкрдиреАрд▓реЗ рдмрд┐рдЬреНрдЮрд╛рдкрди рдЧрд░реА рдХрд╛рдорджрд╛рд░ рдЫрдиреМрдЯ рдЧрд░реНрди рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐рдХрд╛ рд▓рд╛рдЧрд┐ рдЕрдиреБрд░реЛрдз рдЧрд░реЗ рдмрдореЛрдЬрд┐рдо рдХрд╛рд░рд╡рд╛рд╣реА gal рдорд╛рдЧрдкрддреНрд░рдорд╛ рдЙрд▓реНрд▓реЗрдЦрд┐рдд рд╢рд░реНрдд рдПрд╡ рд╕реБрдмрд┐рдзрд╛рд╣рд░реВ рдкреВрд░реНрдг рдкрд╛рд▓рдирд╛ рдЧрд░рд╛рдЙрди рдХрдореНрдкрдиреА рд╕реНрд╡рдпрдВ рдЬрд┐рдореНрдореЗрд╡рд╛рд░реА рд╣реБрдиреЗ рдЧрд░реА рддрдкрд╕рд┐рд▓рдорд╛ рдЙрд▓реНрд▓реЗрдЦ рднрдП рдмрдореЛрдЬрд┐рдо рдЬрдореНрдорд╛ I рдкрджрдХреЛ рдХрд╛рдорджрд╛рд░рд╣рд░реБрдХреЛ рдЫрдиреМрдЯрдХреЛ рддрд╛рдЧрд┐ рдкреНрд░рдЪрд▓рд┐рдд рд╡реИрджреЗрд╢рд┐рдХ рд░реЛрдЬрдЧрд╛рд░ рдРрди, 2064 рдХреЛ рджрдлрд╛ 15(2) рдмрдореЛрдЬрд┐рдо рдорд┐рддрд┐ 2025/05/08 рдХреЛ рдирд┐рд░реНрдгрдпрд╛рдиреБрд╕рд╛рд░ рдкреВрд░реНрд╡ Radia рдкреНрд░рджрд╛рди рдЧрд░рд┐рдПрдХреЛ рдЫ I рд╕рд╛рдереИ рдмрд┐рдЬреНрдЮрд╛рдкрди рдЧрд░реНрджрд╛ рдХрдореНрддрд┐рдорд╛ 7 рджрд┐рдирдХреЛ рдореНрдпрд╛рдж рджрд┐рдИ рдпрд╕ рд╡рд┐рднрд╛рдЧрдХреЛ рдЖрдиреНрддрд░рд┐рдХ рдХрд╛рд░реНрдпрд╕рдВрдЪрд╛рд▓рди рдХрд╛рд░реНрдпрд╡рд┐рдзрд┐ 2066 рдорд╛ рд╡реНрдпрд╡рд╕реНрдерд╛ рдЧрд░рд┐рдПрдХреЛ рдврд╛рдБрдЪрд╛ рдЕрдиреБрд░реБрдкрдХрд╛ рд╕рдореНрдкреВрд░реНрдг рдмрд┐рдмрд░рдгрд╣рд░реВ рдЙрд▓реНрд▓реЗрдЦ рд╣реБрдиреБ рдкрд░реНрдиреЗрдЫ рд░ рдРрдирдХреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкреВрд░рд╛ рдЧрд░рд┐ рдХрд╛рдорджрд╛рд░ рдЫрдиреМрдЯ рднрдПрдХреЛ рдорд┐рддрд┐рд▓реЗ рд╡реИрджреЗрд╢рд┐рдХ рд░реЛрдЬрдЧрд╛рд░ рдРрди, 2064 рдХреЛ рджрдлрд╛ 20 рдмрдореЛрдЬрд┐рдордХреЛ рдореНрдпрд╛рдж рднрд┐рддреНрд░ рдЖрд╡рд╢реНрдпрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкреБрд░рд╛ рдЧрд░реА рд╕рдореНрдмрдиреНрдзрд┐рдд рдореБрд▓реБрдХрдорд╛ рд░реЛрдЬрдЧрд╛рд░рдХреЛ рд▓рд╛рдЧрд┐ рдкрдард╛рдИ рд╕рдХреНрдиреБ рдкрд░реНрдиреЗрдЫ I рдЫрдиреМрдЯ рднрдПрдХрд╛ рдХрд╛рдорджрд╛рд░рд╣рд░реБ рд╕реЛ рдореНрдпрд╛рдж рднрд┐рддреНрд░ рдкрдард╛рдЙрди рдирд╕рдХреЗрдорд╛ рдРрдирдХреЛ рджрдлрд╛ 20(2) рдмрдореЛрдЬрд┐рдо рдХрд╛рд░рдмрд╛рд╣реА рднрдИ рдЬрд╛рдиреЗ рдмреНрдпрд╣реЛрд░рд╛ рд╕рдореЗрдд рдЕрд╡рдЧрдд рдЧрд░рд╛рдИрдиреНрдЫ ред IE A. рдкрдж рдмрд┐рдмрд░рдг рд╕рдВрдЦреНрдпрд╛ рдорд╛рд╕рд┐рдХ рддрд▓рдм рдХреИрдлрд┐рдпрдд рдмрд┐рдЬреНрдЮрд╛рдкрдирдорд╛  рдорд╛рд╕рд┐рдХ рддрд▓рдм рдорд╛рддреНрд░ рдЙрд▓реНрд▓реЗрдЦ рдЧрд░реНрдиреЗ I  рдмрд┐рджреЗрд╢ рд╕реНрдерд┐рдд рдХрдореНрдкрдиреАрдХреЛ рдирд╛рдо рдЙрддреНрд▓реЗрдЦ рдЧрд░реНрдиреЗ ред  рднрд┐рд╖рд╛ рд╢реБрд▓реНрдХ рдЙрд▓реНрд▓реЗрдЦ рдЧрд░реНрдиреБ рдкрд░реНрдиреЗред рднрд┐рд╖рд╛ рдкреНрд░рд╛рдкреНрдд рдирднрдИ рдЕрдЧреНрд░рд┐рдо рднрдХреНрддрд╛рдиреА рдорд╛рдЧ рдирдЧрд░реНрдиреЗ ред  рд╕рд░рдХрд╛рд░реА Af рддрд┐рд░реНрдиреБ рдкрд░реНрдиреЗ рднрдП рдЙрд▓реНрд▓реЗрдЦ рдкреБрд░реБрд╖ I рдорд╣рд┐рд▓рд╛ рдЧрд░реНрдиреЗ ред E рд╣рд┐  рд╕реНрд╡рд┐рдХреГрддрд┐ рд▓рд┐рдИ рд╢рд╛рдЦрд╛ рдЦреЛрд▓рд┐рдЗрдПрдХреЛрдорд╛ рдмрд╛рд╣реЗрдХ рд╢рд╛рдЦрд╛ рдЦреЛрд▓рд┐рдЗрдПрдХреЛрдорд╛ рдмрд╛рд╣реЗрдХ рд╢рд╛рдЦрд╛ рд░ рдПрдЬреЗрдиреНрдЯрдХреЛ рдХреБрд░рд╛ рдЙрд▓реНрд▓реЗрдЦ рдирдЧрд░реНрдиреЗ ред DR рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐рдХреЛ рд╕рдВрдЦреНрдпрд╛ 150 50 рдбрд┐рдорд╛рдгреНрдб Tex рд░ рдХрд░рд╛рд░рдХрд╛ рдореБрдЦреНрдп рд╢рд░реНрддрд╣рд░реВ рд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдврд╛рдБрдЪрд╛ рдмрдореЛрдЬрд┐рдордХрд╛ рдмрд┐рдмрд░рдгрд╣рд░реБ рдЕрдирд┐рд╡рд╛рд░реНрдп рд░реБрдкрдорд╛ рдмрд┐рдЬреНрдЮрд╛рдкрдирдорд╛ рдЙрд▓реНрд▓реЗрдЦ рд╣реБрдиреБ рдкрд░реНрдиреЗрдЫ рддрдерд╛ рдЕрдиреНрддрд░рд╡рд╛рд░реНрддрд╛рдХреЛ рд▓рд╛рдЧрд┐ рдкреНрд░рддрд┐рдирд┐рдзрд┐ рдорд╛рдЧ рдЧрд░реНрджрд╛ рдкреНрд░рдХрд╛рд╢рд┐рдд рдкрддреНрд░рд┐рдХрд╛рдХреЛ рдорд┐рддрд┐ рд╕рдореЗрдд рдкреНрд░рд╖реНрдЯ рднрдПрдХреЛ рд╕рдХреНрдХрдд рдкрддреНрд░рд┐рдХ рдиреИ рдкреЗрд╢ рдЧрд░реНрдиреБ рдкрд░реНрдиреЗрдЫ I рдЕрдиреНрдпрдерд╛ рдкрдЫрд┐ рдХрд╛рд░рд╡рд╛рд╣рд┐ рдирд╣реБрдиреЗ рд╡реНрдпрд╣реЛрд░рд╛ рдЬрд╛рдирдХрд╛рд░реА рдЧрд░рд╛рдИрдиреНрдЫ I рд╕рд╛рдереИ рд╡реИрджреЗрд╢рд┐рдХ рд░реЛрдЬрдЧрд╛рд░ рдРрди, 2064 рд░ рдирд┐рдпрдорд╡рд╛рд▓рд┐ 2064 рд╡рд┐рдкрд░рд┐рдд рдХреБрдиреИ рдХрд╛рд░реНрдп рдЧрд░реЗрдорд╛ рдпреЛ рдкреВрд░реНрд╡ рд╕рд┐рдХреГрддрд┐ рдЬреБрди рд╕реБрдХреИ рд╕рдордпрдорд╛ рд░рджреНрдж рдЧрд░рд┐рдиреЗ рдЫ I  рдиреЛрдЯ  рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐рдХреЛ рд╡рд┐рдЬреНрдЮрд╛рдкрди рдкреНрд░рдХрд╛рд╢рди рдЧрд░реНрджрд╛ рдиреЗрдкрд╛рд▓ рд╕рд░рдХрд╛рд░рдмрд╛рдЯ 10% рдХреЛрдЯрд╛ рдорд╣рд┐рд▓рд╛, рджрд▓рд┐рдд, рдкрд┐рдЫрдбрд┐рдПрдХреЛ рдХреНрд╖реЗрддреНрд░, рдЖрджреАрдмрд╛рд╕реА рдЬрдирдЬрд╛рддрд┐ рд░ рдордзреЗрд╕реА рд▓рд╛рдИ рдЫреБрдЯреНрдпрд╛рдЗрдПрдХреЛ рднрдиреА рд▓реЗрдЦреА рдкреНрд░рдХрд╛рд╢рди рдЧрд░реНрдиреЗ рдЧрд░рд┐рдПрдХреЛрдорд╛ рд╣рд╛рд▓ рд╕реЛ рдмреНрдпрд╡рд╕реНрдерд╛ рдХрд╛рдпрдо рдирд░рд╣реЗрдХреЛрд▓реЗ рдкреНрд░рдХрд╛рд╢рди рдЧрд░рд┐ рд░рд╛рдЦреНрдиреБ рдирдкрд░реНрдиреЗ ред`;
  
  console.log('ЁЯОп === TESTING SPECIFIC EMPLOYMENT EXTRACTION ===');
  console.log('Test text:', testText);
  
  // Test the specialized extraction function
  const extractedData = extractSpecificEmploymentData(testText);
  console.log('Extracted data:', extractedData);
  
  // Test individual patterns
  console.log('\n--- Individual Pattern Tests ---');
  
  // Chalani test
  const chalaniTest = testText.match(/рдЪрд▓рд╛рдиреА\s*рдирдВ\.?\s*(\d+)/i);
  console.log('Chalani pattern test:', chalaniTest);
  
  // LOT test
  const lotTest = testText.match(/LT\.\s*No\.\s*(\d+)/i);
  console.log('LOT pattern test:', lotTest);
  
  // Date test
  const dateTest = testText.match(/Date\s+(\d{4}\/\d{2}\/\d{2})/i);
  console.log('Date pattern test:', dateTest);
  
  // Company test
  const companyTest = testText.match(/рд╢реНрд░реА\s+([^ред\s]+(?:\s+[^ред\s]+)*?)(?=\s+рдореБрд▓реБрдХрдХреЛ|\s+рд╕реНрдерд┐рдд|\s+UAE\.P\.|$)/i);
  console.log('Company pattern test:', companyTest);
  
  // City test
  const cityTest = testText.match(/рд╕реНрдерд┐рдд\s+([^ред\s]+(?:\s+[^ред\s]+)*?)(?=\s+рдХрдореНрдкрдиреАрдмрд╛рдЯ|\s+ред|$)/i);
  console.log('City pattern test:', cityTest);
  
  alert('Check console for specific extraction test results!');
}

// Test function for country extraction specifically
function testCountryExtraction() {
  console.log('ЁЯМН === TESTING COUNTRY EXTRACTION ===');
  
  // Test with UAE document
  const uaeText = `рд╢реНрд░реА NEW GURKHAS INTERNATIONAL PVT. LTD. UAE рдореБрд▓реБрдХрдХреЛ UAE.P.OB0x:677,1ST FLOORNAD AL SHEBA FIRST MEYDAN.PO рд░рд╛рд╣рд░ рд╕реНрдерд┐рдд FINE FARE FOOD MARKET L.L.C рдХрдореНрдкрдиреАрдмрд╛рдЯ 200 рдЬрдирд╛ рдиреЗрдкрд╛рд▓реА рдХрд╛рдорджрд╛рд░`;
  
  console.log('UAE Test text:', uaeText);
  
  // Test the country extraction patterns
  const pattern1 = uaeText.match(/рдореБрд▓реБрдХрдХреЛ\s+([^ред\s]+(?:\s+[^ред\s]+)*?)(?=\s+UAE\.P\.|\s+рд╕реНрдерд┐рдд|\s+ред|$)/i);
  console.log('Pattern 1 (рдореБрд▓реБрдХрдХреЛ + country):', pattern1);
  
  const pattern2 = uaeText.match(/([^ред\s]+(?:\s+[^ред\s]+)*?)\s+рдореБрд▓реБрдХрдХреЛ/i);
  console.log('Pattern 2 (country + рдореБрд▓реБрдХрдХреЛ):', pattern2);
  
  const pattern3 = uaeText.match(/\bUAE\b/i);
  console.log('Pattern 3 (UAE word boundary):', pattern3);
  
  // Test the specialized extraction
  const extractedData = extractSpecificEmploymentData(uaeText);
  console.log('Extracted country from specialized function:', extractedData.country);
  
  // Test with Japan document
  const japanText = `рд╢реНрд░реА JAPAN COMPANY LTD. Japan рдореБрд▓реБрдХрдХреЛ Tokyo рд╢рд╣рд░ рдХрдореНрдкрдиреАрдмрд╛рдЯ 100 рдЬрдирд╛ рдиреЗрдкрд╛рд▓реА рдХрд╛рдорджрд╛рд░`;
  
  console.log('\nJapan Test text:', japanText);
  
  const japanExtracted = extractSpecificEmploymentData(japanText);
  console.log('Japan extracted data:', japanExtracted);
  
  alert('Check console for country extraction test results!');
}

// Test function for city extraction specifically
function testCityExtraction() {
  console.log('ЁЯПЩя╕П === TESTING CITY EXTRACTION ===');
  
  // Test different city formats
  const testCases = [
    {
      name: 'рд╕реНрдерд┐рдд format',
      text: 'рд░рд╛рд╣рд░ рд╕реНрдерд┐рдд FINE FARE FOOD MARKET L.L.C рдХрдореНрдкрдиреАрдмрд╛рдЯ',
      expected: 'FINE FARE FOOD MARKET L.L.C'
    },
    {
      name: 'рд╢рд╣рд░ format',
      text: 'Tokyo рд╢рд╣рд░ рдХрдореНрдкрдиреАрдмрд╛рдЯ 100 рдЬрдирд╛',
      expected: 'Tokyo'
    },
    {
      name: 'City format',
      text: 'Dubai City рдХрдореНрдкрдиреАрдмрд╛рдЯ 150 рдЬрдирд╛',
      expected: 'Dubai'
    },
    {
      name: 'city + рд╢рд╣рд░ format',
      text: 'Osaka рд╢рд╣рд░ рдХрдореНрдкрдиреАрдмрд╛рдЯ 80 рдЬрдирд╛',
      expected: 'Osaka'
    }
  ];
  
  for (const testCase of testCases) {
    console.log(`\n--- Testing ${testCase.name} ---`);
    console.log('Text:', testCase.text);
    
    const extractedData = extractSpecificEmploymentData(testCase.text);
    console.log('Extracted city:', extractedData.city);
    console.log('Expected:', testCase.expected);
    console.log('Match:', extractedData.city === testCase.expected ? 'тЬЕ' : 'тЭМ');
  }
  
  alert('Check console for city extraction test results!');
}

// Test function for city extraction with real document examples
function testCityExtractionReal() {
  console.log('ЁЯПЩя╕П === TESTING CITY EXTRACTION WITH REAL EXAMPLES ===');
  
  // Test with your actual document formats
  const testCases = [
    {
      name: 'UAE Document (рд╕реНрдерд┐рдд format)',
      text: 'рд░рд╛рд╣рд░ рд╕реНрдерд┐рдд FINE FARE FOOD MARKET L.L.C рдХрдореНрдкрдиреАрдмрд╛рдЯ 200 рдЬрдирд╛ рдиреЗрдкрд╛рд▓реА рдХрд╛рдорджрд╛рд░',
      expected: 'FINE FARE FOOD MARKET L.L.C'
    },
    {
      name: 'Japan Document (рд╢рд╣рд░ format)',
      text: 'Tokyo рд╢рд╣рд░ рдХрдореНрдкрдиреАрдмрд╛рдЯ 100 рдЬрдирд╛ рдиреЗрдкрд╛рд▓реА рдХрд╛рдорджрд╛рд░',
      expected: 'Tokyo'
    },
    {
      name: 'Reverse format (city + рд╢рд╣рд░)',
      text: 'Osaka рд╢рд╣рд░ рдХрдореНрдкрдиреАрдмрд╛рдЯ 80 рдЬрдирд╛ рдиреЗрдкрд╛рд▓реА рдХрд╛рдорджрд╛рд░',
      expected: 'Osaka'
    },
    {
      name: 'English format (City + city)',
      text: 'Dubai City рдХрдореНрдкрдиреАрдмрд╛рдЯ 150 рдЬрдирд╛ рдиреЗрдкрд╛рд▓реА рдХрд╛рдорджрд╛рд░',
      expected: 'Dubai'
    },
    {
      name: 'Context pattern (рд╢рд╣рд░ + city + рдХрдореНрдкрдиреАрдмрд╛рдЯ)',
      text: 'рд╢рд╣рд░ FINE FARE FOOD MARKET L.L.C рдХрдореНрдкрдиреАрдмрд╛рдЯ 200 рдЬрдирд╛ рдиреЗрдкрд╛рд▓реА рдХрд╛рдорджрд╛рд░',
      expected: 'FINE FARE FOOD MARKET L.L.C'
    }
  ];
  
  for (const testCase of testCases) {
    console.log(`\n--- Testing ${testCase.name} ---`);
    console.log('Text:', testCase.text);
    
    const extractedData = intelligentOCRExtraction(testCase.text);
    console.log('Extracted city:', extractedData.city);
    console.log('Expected:', testCase.expected);
    console.log('Match:', extractedData.city === testCase.expected ? 'тЬЕ' : 'тЭМ');
    
    if (extractedData.city !== testCase.expected) {
      console.log('тЭМ City extraction failed for this format');
    }
  }
  
  alert('Check console for real city extraction test results!');
}
// Test function for position and salary extraction
function testPositionSalaryExtraction() {
  console.log('ЁЯТ╝ === TESTING POSITION AND SALARY EXTRACTION ===');
  
  // Test with comprehensive employment letter examples
  const testCases = [
    {
      name: 'UAE Document with Full Details',
      text: `рдкрдж: Helper рддрд▓рдм: 150 KD рдкреБрд░реБрд╖: 5 рдорд╣рд┐рд▓рд╛: 3 рдХрдореНрдкрдиреАрдмрд╛рдЯ 200 рдЬрдирд╛ рдиреЗрдкрд╛рд▓реА рдХрд╛рдорджрд╛рд░`,
      expected: {
        position: 'Helper',
        salary: '150 KD',
        salaryAmount: '150',
        salaryCurrency: 'KWD',
        maleCount: '5',
        femaleCount: '3',
        employeeCount: '200'
      }
    },
    {
      name: 'Japan Document with English',
      text: `Position: Engineer Salary: 200,000 JPY Male: 10 Female: 8 100 рдЬрдирд╛ рдиреЗрдкрд╛рд▓реА рдХрд╛рдорджрд╛рд░`,
      expected: {
        position: 'Engineer',
        salary: '200,000 JPY',
        salaryAmount: '200,000',
        salaryCurrency: 'JPY',
        maleCount: '10',
        femaleCount: '8',
        employeeCount: '100'
      }
    },
    {
      name: 'Mixed Format Document',
      text: `рдкрдж рдмрд┐рдмрд░рдг: Technician Basic Salary: 5000 SAR рдкреБрд░реБрд╖ 15 рдорд╣рд┐рд▓рд╛ 12 150 workers`,
      expected: {
        position: 'Technician',
        salary: '5000 SAR',
        salaryAmount: '5000',
        salaryCurrency: 'SAR',
        maleCount: '15',
        femaleCount: '12',
        employeeCount: '150'
      }
    }
  ];
  
  for (const testCase of testCases) {
    console.log(`\n--- Testing ${testCase.name} ---`);
    console.log('Text:', testCase.text);
    
    const extractedData = intelligentOCRExtraction(testCase.text);
    console.log('Extracted data:', extractedData);
    
    // Check each expected field
    Object.entries(testCase.expected).forEach(([field, expectedValue]) => {
      const actualValue = extractedData[field];
      const match = actualValue === expectedValue;
      console.log(`${field}: ${actualValue} (expected: ${expectedValue}) ${match ? 'тЬЕ' : 'тЭМ'}`);
    });
    
    console.log('---');
  }
  
  alert('Check console for position and salary extraction test results!');
}

// Test function to check if position fields exist in DOM
function checkPositionFields() {
  console.log('ЁЯФН === CHECKING POSITION FIELDS IN DOM ===');
  
  // Check for position-related fields
  const positionFields = [
    'positions-0-position',
    'positions-0-male_count',
    'positions-0-female_count',
    'positions-0-salary_amount',
    'positions-0-salary_currency'
  ];
  
  positionFields.forEach(fieldName => {
    // Try to find by name attribute
    const fieldByName = document.querySelector(`[name="${fieldName}"]`);
    // Try to find by partial name match
    const fieldByPartial = document.querySelector(`[name*="${fieldName.split('-').pop()}"]`);
    
    console.log(`${fieldName}:`);
    console.log(`  By exact name: ${fieldByName ? 'тЬЕ Found' : 'тЭМ Not found'}`);
    console.log(`  By partial name: ${fieldByPartial ? 'тЬЕ Found' : 'тЭМ Not found'}`);
    
    if (fieldByName) {
      console.log(`  Current value: "${fieldByName.value}"`);
      console.log(`  Field type: ${fieldByName.type}`);
    }
  });
  
  // Check for any position forms
  const positionForms = document.querySelectorAll('.position-form');
  console.log(`\nPosition forms found: ${positionForms.length}`);
  
  if (positionForms.length > 0) {
    positionForms.forEach((form, index) => {
      console.log(`\nForm ${index + 1}:`);
      const inputs = form.querySelectorAll('input, select');
      inputs.forEach(input => {
        console.log(`  ${input.name}: ${input.type} = "${input.value}"`);
      });
    });
  }
  
  alert('Check console for position field analysis!');
}

// Test function for your specific document format
function testYourDocumentFormat() {
  console.log('ЁЯУД === TESTING YOUR DOCUMENT FORMAT ===');
  
  // Test with your actual document text
  const yourText = `рдкрдж рдХреЛ рдХрд╛рдорджрд╛рд░рд╣рд░реБрдХреЛ рдЫрдиреМрдЯрдХреЛ рд▓рд╛рдЧрд┐ рдкреНрд░рдЪрд▓рд┐рдд рд╡реИрджреЗрд╢рд┐рдХ рд░реЛрдЬрдЧрд╛рд░ рдРрди, 2064 рдХреЛ рджрдлрд╛ 15(2) рдмрдореЛрдЬрд┐рдо рдорд┐рддрд┐ 2025/08/15 рдХреЛ рдирд┐рд░реНрдгрдпрд╛рдиреБрд╕рд╛рд░ рдкреВрд░реНрд╡ рд╕рд┐рдХреГрддрд┐ рдкреНрд░рджрд╛рди рдЧрд░рд┐рдПрдХреЛ рдЫ`;
  
  console.log('Your document text:', yourText);
  
  // Analyze the structure
  const hasPositionSection = yourText.includes('рдкрдж рдмрд┐рдмрд░рдг') || yourText.includes('Position Details') || yourText.includes('Job Details');
  const hasTableFormat = yourText.includes('рдкрдж') && yourText.includes('рд╕рдВрдЦреНрдпрд╛') && yourText.includes('рддрд▓рдм');
  
  console.log('Has position section:', hasPositionSection);
  console.log('Has table format:', hasTableFormat);
  
  // Test position extraction
  const extractedData = intelligentOCRExtraction(yourText);
  console.log('Extracted data:', extractedData);
  
  // Check what was found
  console.log('\n--- Analysis Results ---');
  console.log('Position found:', extractedData.position ? `тЬЕ ${extractedData.position}` : 'тЭМ Not found');
  console.log('Male count found:', extractedData.maleCount ? `тЬЕ ${extractedData.maleCount}` : 'тЭМ Not found');
  console.log('Female count found:', extractedData.femaleCount ? `тЬЕ ${extractedData.femaleCount}` : 'тЭМ Not found');
  console.log('Salary found:', extractedData.salary ? `тЬЕ ${extractedData.salary}` : 'тЭМ Not found');
  
  alert('Check console for your document format analysis!');
}

// Test function for your specific employment letter format
function testYourEmploymentLetterFormat() {
  console.log('ЁЯУЛ === TESTING YOUR EMPLOYMENT LETTER FORMAT ===');
  
  // Test with your actual document format
  const yourText = `рдкрдж рд╡рд┐рд╡рд░рдг: Helper
рдорд╛рд╕рд┐рдХ рддрд▓рдм: 150 KD
рд╕рдВрдЦреНрдпрд╛: рдкреБрд░реБрд╖ 2, рдорд╣рд┐рд▓рд╛ 0`;
  
  console.log('Your document text:', yourText);
  
  // Test specialized extraction
  const specializedData = extractEmploymentLetterFormat(yourText);
  console.log('Specialized extraction result:', specializedData);
  
  // Test intelligent extraction as fallback
  const intelligentData = intelligentOCRExtraction(yourText);
  console.log('Intelligent extraction result:', intelligentData);
  
  // Check what was found
  console.log('\n--- Specialized Extraction Results ---');
  console.log('Position found:', specializedData.position ? `тЬЕ ${specializedData.position}` : 'тЭМ Not found');
  console.log('Male count found:', specializedData.maleCount ? `тЬЕ ${specializedData.maleCount}` : 'тЭМ Not found');
  console.log('Female count found:', specializedData.femaleCount ? `тЬЕ ${specializedData.femaleCount}` : 'тЭМ Not found');
  console.log('Salary found:', specializedData.salary ? `тЬЕ ${specializedData.salary}` : 'тЭМ Not found');
  console.log('Salary amount found:', specializedData.salaryAmount ? `тЬЕ ${specializedData.salaryAmount}` : 'тЭМ Not found');
  console.log('Salary currency found:', specializedData.salaryCurrency ? `тЬЕ ${specializedData.salaryCurrency}` : 'тЭМ Not found');
  
  alert('Check console for your employment letter format test!');
}

// Test function for the new clean parser
function testCleanParser() {
  console.log('ЁЯз╣ === TESTING CLEAN PARSER ===');
  
  // Test with your actual document format
  const testText = `рд╢реНрд░реА SUCCESS NEPAL MANPOWER AGENCY PVT. LTD.
LT. No. 327122
рдЪрд▓рд╛рдиреА рдирдВ. 60243265
Date 2025/08/17
LOT No. 327122
Japan

Scaffolding 2 0 JPY 177657.00`;
  
  console.log('Test text:', testText);
  
  // Test the new parser
  const parsed = parseFromOCR(testText);
  console.log('Parsed data:', parsed);
  
  // Test applying the data
  console.log('Applying parsed data...');
  applyParsedData(parsed);
  
  alert('Check console for clean parser test results!');
}

// Test function to verify your local trained data is working
async function testLocalTrainedData() {
  console.log('ЁЯФН === TESTING LOCAL TRAINED DATA ===');
  
  // Check if Tesseract is available
  if (typeof Tesseract === 'undefined') {
    console.error('тЭМ Tesseract.js not loaded!');
    alert('тЭМ Tesseract.js library not loaded!');
    return;
  }
  
  console.log('тЬЕ Tesseract.js loaded');
  console.log('TESSDATA_URL (local):', TESSDATA_URL);
  console.log('TESSDATA_CDN (fallback):', TESSDATA_CDN);
  
  // Create a simple test image with Nepali text
  const canvas = document.createElement('canvas');
  canvas.width = 400;
  canvas.height = 100;
  const ctx = canvas.getContext('2d');
  
  // Fill with white background
  ctx.fillStyle = 'white';
  ctx.fillRect(0, 0, 400, 100);
  
  // Add Nepali text
  ctx.fillStyle = 'black';
  ctx.font = '24px Arial';
  ctx.fillText('рдкрдж: Helper', 20, 40);
  ctx.fillText('рдкреБрд░реБрд╖: 5', 20, 70);
  ctx.fillText('рдорд╣рд┐рд▓рд╛: 3', 200, 70);
  
  try {
    // Convert canvas to blob
    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
    
    console.log('ЁЯЦ╝я╕П Created test image with Nepali text');
    console.log('ЁЯФН Testing OCR with local trained data...');
    
    // Test with local trained data first
    const localResult = await Tesseract.recognize(blob, OCR_LANGS, {
      langPath: TESSDATA_URL,
      logger: m => console.log('[LOCAL]', m),
      tessedit_pageseg_mode: 6,
      user_defined_dpi: '300'
    });
    
    console.log('тЬЕ Local trained data result:', localResult.data.text);
    
    // Test with CDN fallback for comparison
    console.log('ЁЯФН Testing OCR with CDN fallback...');
    const cdnResult = await Tesseract.recognize(blob, OCR_LANGS, {
      langPath: TESSDATA_CDN,
      logger: m => console.log('[CDN]', m),
      tessedit_pageseg_mode: 6,
      user_defined_dpi: '300'
    });
    
    console.log('тЬЕ CDN fallback result:', cdnResult.data.text);
    
    // Compare results
    console.log('\nЁЯУК === COMPARISON RESULTS ===');
    console.log('Local trained data:', localResult.data.text);
    console.log('CDN fallback:', cdnResult.data.text);
    
    if (localResult.data.text.includes('рдкрдж') || localResult.data.text.includes('Helper')) {
      console.log('тЬЕ Local trained data is working and recognizing Nepali text!');
      alert('тЬЕ Local trained data is working! Check console for details.');
    } else {
      console.log('тЪая╕П Local trained data might not be working properly');
      alert('тЪая╕П Local trained data might have issues. Check console for details.');
    }
    
  } catch (error) {
    console.error('тЭМ Error testing trained data:', error);
    alert('тЭМ Error testing trained data: ' + error.message);
  }
}

// Check if trained data files are accessible from browser
async function checkTrainedDataAccess() {
  console.log('ЁЯФН === CHECKING TRAINED DATA ACCESS ===');
  
  const files = ['nep.traineddata', 'eng.traineddata'];
  
  for (const file of files) {
    const url = `${TESSDATA_URL}${file}`;
    console.log(`Checking access to: ${url}`);
    
    try {
      const response = await fetch(url, { method: 'HEAD' });
      if (response.ok) {
        console.log(`тЬЕ ${file} is accessible (${response.status})`);
      } else {
        console.log(`тЭМ ${file} not accessible (${response.status})`);
      }
    } catch (error) {
      console.log(`тЭМ ${file} access error:`, error.message);
    }
  }
  
  // Also check the directory listing
  try {
    const dirResponse = await fetch(TESSDATA_URL);
    console.log('Directory response:', dirResponse.status, dirResponse.statusText);
  } catch (error) {
    console.log('Directory access error:', error.message);
  }
  
  alert('Check console for trained data accessibility!');
}

// Test function for intelligent OCR
function testIntelligentOCR() {
  console.log('ЁЯза === TESTING INTELLIGENT OCR ===');
  
  // Test with different document formats
  const testCases = [
    {
      name: 'UAE Employment Letter',
      text: `LT. No. 322862 рдХреЛ рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐ I Date 2025/08/08 рдЪрд▓рд╛рдиреА рдирдВ. 60237432 LT. No. 322862 рд╢реНрд░реА NEW GURKHAS INTERNATIONAL PVT. LTD. UAE рдореБрд▓реБрдХрдХреЛ UAE.P.OB0x 677,1ST FLOORNAD AL SHEBA FIRST MEYDAN.PO рд░рд╛рд╣рд░ рд╕реНрдерд┐рдд FINE FARE FOOD MARKET L.L.C рдХрдореНрдкрдиреАрдмрд╛рдЯ 200 рдЬрдирд╛ рдиреЗрдкрд╛рд▓реА рдХрд╛рдорджрд╛рд░`
    },
    {
      name: 'Japan Employment Letter',
      text: `рд╢реНрд░реА JAPAN COMPANY LTD. Japan рдореБрд▓реБрдХрдХреЛ Tokyo рд╢рд╣рд░ рдХрдореНрдкрдиреАрдмрд╛рдЯ 100 рдЬрдирд╛ рдиреЗрдкрд╛рд▓реА рдХрд╛рдорджрд╛рд░ рдкрдж: Engineer рддрд▓рдм: 200,000 JPY`
    },
    {
      name: 'Saudi Employment Letter',
      text: `Company: SAUDI ARABIA CORP. Country: Saudi Arabia City: Riyadh Chalani No. 12345 LOT No. 67890 Date: 2025/01/15 Position: Technician Salary: 5000 SAR`
    }
  ];
  
  for (const testCase of testCases) {
    console.log(`\n--- Testing ${testCase.name} ---`);
    console.log('Text:', testCase.text);
    
    const extractedData = intelligentOCRExtraction(testCase.text);
    console.log('Intelligently extracted data:', extractedData);
    console.log('---');
  }
  
  alert('Check console for intelligent OCR test results!');
}

// Test function for local trained data
function testLocalTrainedData() {
  console.log('ЁЯУБ === TESTING LOCAL TRAINED DATA ===');
  
  // Check if local trained data files are accessible
  const testFiles = [
    '/static/tessdata/eng.traineddata',
    '/static/tessdata/nep.traineddata'
  ];
  
  console.log('Testing access to local trained data files...');
  
  testFiles.forEach(async (filePath) => {
    try {
      const response = await fetch(filePath, { method: 'HEAD' });
      if (response.ok) {
        console.log(`тЬЕ ${filePath} - Accessible (${response.headers.get('content-length')} bytes)`);
      } else {
        console.log(`тЭМ ${filePath} - Not accessible (${response.status})`);
      }
    } catch (error) {
      console.log(`тЭМ ${filePath} - Error: ${error.message}`);
    }
  });
  
  // Test Tesseract configuration
  console.log('\nTesseract Configuration:');
  console.log('OCR_LANGS:', OCR_LANGS);
  console.log('TESSDATA_URL (local):', TESSDATA_URL);
  console.log('TESSDATA_CDN (fallback):', TESSDATA_CDN);
  console.log('TESS_OPTS:', TESS_OPTS);
  
  alert('Check console for local trained data test results!');
}

// Test function for chalani field specifically
function testChalaniField() {
  console.log('ЁЯФв === TESTING CHALANI FIELD ===');
  
  // Check if field exists
  const chalaniField = document.getElementById('id_chalani_no');
  if (chalaniField) {
    console.log('тЬЕ Chalani field found:', chalaniField);
    console.log('Current value:', chalaniField.value);
    console.log('Field type:', chalaniField.type);
    console.log('Field name:', chalaniField.name);
    
    // Try to set a test value
    const testValue = '12345';
    chalaniField.value = testValue;
    console.log(`тЬЕ Set test value: ${testValue}`);
    console.log('New value:', chalaniField.value);
    
    alert(`Chalani field test successful! Set value: ${testValue}`);
  } else {
    console.log('тЭМ Chalani field not found');
    
    // Look for similar fields
    const similarFields = document.querySelectorAll('[id*="chalani"], [name*="chalani"], [id*="chalani_no"], [name*="chalani_no"]');
    console.log('Similar fields found:', similarFields);
    
    if (similarFields.length > 0) {
      console.log('Available similar fields:');
      similarFields.forEach((field, index) => {
        console.log(`  ${index + 1}. ID: ${field.id}, Name: ${field.name}, Type: ${field.type}`);
      });
    }
    
    alert('Chalani field not found! Check console for details.');
  }
}

function detectCurrency(str='') {
  const L = (str||'').toUpperCase();
  if (/\bKWD\b|\bKD\b|рдХреБрд╡реИрддреА|рджрд┐рдирд╛рд░/.test(L)) return 'KWD';
  if (/\bAED\b|рдпреВрдПрдИ|рджрд┐рд░рд╣рдо/.test(L)) return 'AED';
  if (/\bSAR\b|рд╕рд╛рдЙрджреА|рд░рд┐рдпрд╛рд▓/.test(L)) return 'SAR';
  if (/\bQAR\b|рдХрддрд╛рд░/.test(L)) return 'QAR';
  if (/\bOMR\b|рдУрдорд╛рдиреА/.test(L)) return 'OMR';
  if (/\bBHD\b|рдмрд╣рд░реЗрдиреА/.test(L)) return 'BHD';
  if (/\bUSD\b|рдб[реЛреЛ]рд▓рд░|рдбреЙрд▓рд░/.test(L)) return 'USD';
  if (/\bEUR\b|рдпреБрд░реЛ/.test(L)) return 'EUR';
  if (/\bGBP\b|рдкрд╛рдЙрдиреНрдб|рдкрд╛рдЙрдгреНрдб/.test(L)) return 'GBP';
  if (/\bJPY\b|рдпреЗрди|рдпреЗрдиреН/.test(L)) return 'JPY';
  if (/\bNPR\b|рдиреЗ\.?рд░реБ|рд░реБ\.?/.test(L)) return 'NPR';
  if (/\bKD\b/.test(L)) return 'KWD';
  return '';
}
/* === fill Step-2 main fields === */
function fillMainFieldsFromText(text) {
  // Map OCR labels to actual form field IDs
  const fieldMappings = {
    company: 'id_company_name',
    country: 'id_country', 
    city: 'id_city',
    chalani: 'id_chalani_no',
    lot: 'id_lot_no',
    predate: 'id_pre_approval_date',
    // Position-related fields use different naming convention
    position: 'positions-0-position',
    male_count: 'positions-0-male_count',
    female_count: 'positions-0-female_count',
    salary_amount: 'positions-0-salary_amount',
    salary_currency: 'positions-0-salary_currency',
    employee_count: 'positions-0-employee_count'
  };

  // Helper function to set field values
  const setField = (labelKey, value) => {
    const fieldId = fieldMappings[labelKey];
    if (!fieldId) return;
    
    console.log(`ЁЯФН Trying to set ${labelKey} = "${value}" in field ${fieldId}`);
    
    let field = null;
    
    // Try to find field by ID first
    field = document.getElementById(fieldId);
    
    // If not found by ID, try to find by name (for position fields)
    if (!field && fieldId.includes('positions-')) {
      field = document.querySelector(`[name="${fieldId}"]`);
    }
    
    // If still not found, try to find by partial name match
    if (!field && fieldId.includes('positions-')) {
      const fieldName = fieldId.split('-').pop(); // Get the last part (position, male_count, etc.)
      field = document.querySelector(`[name*="${fieldName}"]`);
    }
    
    if (field) {
      console.log(`тЬЕ Field found: ${fieldId}`);
      if (value) {
        field.value = value;
        console.log(`тЬЕ Set ${labelKey}: ${value} in field ${fieldId}`);
      } else {
        console.log(`тЪая╕П Value is empty for ${labelKey}`);
      }
    } else {
      console.log(`тЭМ Field not found: ${fieldId}`);
      // Try to find similar fields
      if (labelKey.includes('position') || labelKey.includes('male') || labelKey.includes('female') || labelKey.includes('salary')) {
        const similarFields = document.querySelectorAll('[name*="position"], [name*="male"], [name*="female"], [name*="salary"]');
        console.log('Similar position fields found:', similarFields);
      } else {
        const similarFields = document.querySelectorAll(`[id*="${labelKey}"], [name*="${labelKey}"]`);
        console.log('Similar fields found:', similarFields);
      }
    }
  };

                // Use specialized extraction for your employment letter format FIRST
              const specializedData = extractEmploymentLetterFormat(text);
              
              console.log('ЁЯУЛ === SPECIALIZED EXTRACTION RESULTS ===');
              console.log('Specialized extracted data:', specializedData);
              
              // Fallback to intelligent OCR extraction if specialized extraction doesn't find everything
              const intelligentData = intelligentOCRExtraction(text);
              
              console.log('ЁЯза === INTELLIGENT EXTRACTION RESULTS ===');
              console.log('Intelligently extracted data:', intelligentData);
  
                // Set fields from specialized extraction FIRST (your format)
              if (specializedData.position) setField('position', specializedData.position);
              if (specializedData.maleCount) setField('male_count', specializedData.maleCount);
              if (specializedData.femaleCount) setField('female_count', specializedData.femaleCount);
              if (specializedData.salaryAmount) setField('salary_amount', specializedData.salaryAmount);
              if (specializedData.salaryCurrency) setField('salary_currency', specializedData.salaryCurrency);
              if (specializedData.employeeCount) setField('employee_count', specializedData.employeeCount);
              
              // Set fields from intelligent extraction (fallback)
              if (intelligentData.company) setField('company', intelligentData.company);
              if (intelligentData.country) setField('country', intelligentData.country);
              if (intelligentData.city) setField('city', intelligentData.city);
              if (intelligentData.chalani) setField('chalani', intelligentData.chalani);
              if (intelligentData.lot) setField('lot', intelligentData.lot);
              if (intelligentData.date) setField('predate', intelligentData.date);
  
  // Set position-related fields with detailed logging
  console.log('ЁЯФН === SETTING POSITION FIELDS ===');
  console.log('Available intelligent data:', intelligentData);
  
  if (intelligentData.position) {
    console.log('Setting position field:', intelligentData.position);
    setField('position', intelligentData.position);
  }
  if (intelligentData.maleCount) {
    console.log('Setting male_count field:', intelligentData.maleCount);
    setField('male_count', intelligentData.maleCount);
  }
  if (intelligentData.femaleCount) {
    console.log('Setting female_count field:', intelligentData.femaleCount);
    setField('female_count', intelligentData.femaleCount);
  }
  if (intelligentData.salaryAmount) {
    console.log('Setting salary_amount field:', intelligentData.salaryAmount);
    setField('salary_amount', intelligentData.salaryAmount);
  }
  if (intelligentData.salaryCurrency) {
    console.log('Setting salary_currency field:', intelligentData.salaryCurrency);
    setField('salary_currency', intelligentData.salaryCurrency);
  }
  if (intelligentData.employeeCount) {
    console.log('Setting employee_count field:', intelligentData.employeeCount);
    setField('employee_count', intelligentData.employeeCount);
  }
  
  // Fallback to general label extraction for any still missing fields
  if (!intelligentData.company) setField('company', findAfterLabel(text, LABELS.company));
  if (!intelligentData.country) setField('country', findAfterLabel(text, LABELS.country));
  if (!intelligentData.city) setField('city', findAfterLabel(text, LABELS.city));
  if (!intelligentData.chalani) setField('chalani', findAfterLabel(text, LABELS.chalani));
  if (!intelligentData.lot) setField('lot', findAfterLabel(text, LABELS.lot));
  if (!intelligentData.date) setField('predate', findAfterLabel(text, LABELS.predate));
}

/* === fill first position row in Step-3 === */
function fillPositionFromText(text) {
  // Helper function to find and set position form fields
  const setPositionField = (fieldName, value) => {
    // Try multiple selectors to find the field
    const selectors = [
      `[name*="${fieldName}"]`,
      `[name*="positions-0-${fieldName}"]`,
      `input[name*="${fieldName}"]`,
      `select[name*="${fieldName}"]`
    ];
    
    let field = null;
    for (const selector of selectors) {
      field = document.querySelector(selector);
      if (field) break;
    }
    
    if (field && value !== '') {
      field.value = value;
      console.log(`тЬЕ Set position ${fieldName}: ${value}`);
    } else {
      console.log(`тЭМ Could not set position ${fieldName}: ${value} - field not found`);
    }
  };

  // Extract values from OCR text
  const posLine = findAfterLabel(text, LABELS.position);
  const maleLine = findAfterLabel(text, LABELS.male);
  const femaleLine = findAfterLabel(text, LABELS.female);
  const salLine = findAfterLabel(text, LABELS.salary);

  // Set position fields
  setPositionField('position', posLine);
  setPositionField('male_count', firstNumber(maleLine));
  setPositionField('female_count', firstNumber(femaleLine));

  // Handle salary and currency
  const amt = firstNumber(salLine);
  const cur = detectCurrency(salLine) || detectCurrency(text);
  
  setPositionField('salary_amount', amt);
  if (cur) setPositionField('salary_currency', cur);
}

/* === intercept Step-1 form to run OCR in browser === */
function setupOCRForm() {
  const ocrForm = document.getElementById('ocrForm');
  const fileInput = document.getElementById('id_document');
  if (ocrForm && fileInput) {
    ocrForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = fileInput.files?.[0];
      if (!file) return alert('рдХреГрдкрдпрд╛ рдлрд╛рдЗрд▓ рдЫрд╛рдиреНрдиреБрд╣реЛрд╕реНред');
      if (file.type === 'application/pdf') return alert('рдкрд╣рд┐рд▓реЗ JPG/PNG рдкреНрд░рдпреЛрдЧ рдЧрд░реНрдиреБрд╣реЛрд╕реНред');

      try {
        document.getElementById('ocrClientBox').style.display = 'block';
        document.getElementById('ocrPreview').textContent = 'рд▓реЛрдб рд╣реБрдБрджреИ...';

        const prepped = await preprocessImage(file);
        const { data } = await Tesseract.recognize(prepped, OCR_LANGS, TESS_OPTS);
        const text = normalizeText((data.text || '').trim());
        document.getElementById('ocrPreview').textContent = text || '(рдЯреЗрдХреНрд╕реНрдЯ рднреЗрдЯрд┐рдПрди)';

        // тЬЕ NEW: parse тЖТ fill forms тЖТ jump to Step 2
        const parsed = parseFromOCR(text);
        applyParsedData(parsed);
        goToStep(2);
        alert('тЬЕ OCR рдкреВрд░рд╛ рднрдпреЛ (trained data рдкреНрд░рдпреЛрдЧ рдЧрд░реА)!\n\nрднрд░реЗрдХрд╛ рдлрд┐рд▓реНрдб рдЬрд╛рдБрдЪ рдЧрд░реНрдиреБрд╣реЛрд╕реНред');
      } catch (err) {
        console.error(err);
        alert('OCR рддреНрд░реБрдЯрд┐: ' + (err.message || err));
      }
    });
  }
}

// Debug function to show what fields are available and what values are extracted
function debugOCRResults(text) {
  console.log('ЁЯФН === OCR DEBUG RESULTS ===');
  console.log('Raw OCR text:', text);
  
  // Test each label pattern
  Object.entries(LABELS).forEach(([key, patterns]) => {
    const value = findAfterLabel(text, patterns);
    console.log(`${key}: "${value}" (patterns: ${patterns.map(p => p.source).join(', ')})`);
  });
  
  // Show available form fields
  console.log('ЁЯФН === AVAILABLE FORM FIELDS ===');
  const mainFields = ['company_name', 'country', 'city', 'chalani_no', 'lot_no', 'pre_approval_date'];
  mainFields.forEach(fieldId => {
    const field = document.getElementById(`id_${fieldId}`);
    if (field) {
      console.log(`тЬЕ Found: id_${fieldId} (${field.type})`);
    } else {
      console.log(`тЭМ Missing: id_${fieldId}`);
    }
  });
  
  // Show position fields
  console.log('ЁЯФН === POSITION FORM FIELDS ===');
  const positionFields = ['position', 'male_count', 'female_count', 'salary_amount', 'salary_currency'];
  positionFields.forEach(fieldName => {
    const field = document.querySelector(`[name*="${fieldName}"]`);
    if (field) {
      console.log(`тЬЕ Found: ${fieldName} (${field.name})`);
    } else {
      console.log(`тЭМ Missing: ${fieldName}`);
    }
  });
}

/* ==== END BROWSER OCR BLOCK ==== */

/* ====== currency display helpers (no fixed rates needed for OCR) ======
   You already have salary conversion logic. Leaving rates as-is is fine,
   because OCR task here only DETECTS the currency and fills the select.
====================================================================== */

// simple NPR formatting if you still want the preview calc
const exchangeRates = {
  'KD': 378.51, 'USD': 133.45, 'EUR': 145.67, 'GBP': 170.23,
  'SAR': 35.58, 'AED': 36.34, 'QAR': 36.67, 'OMR': 346.78,
  'BHD': 353.45, 'KWD': 378.51, 'NPR': 1.00, 'JPY': 0.92
};

function convertToNPR(amount, currency) {
  if (!amount || !currency || !exchangeRates[currency]) return '';
  const rate = exchangeRates[currency];
  const converted = parseFloat(amount) * rate;
  return formatNepaliCurrency(converted);
}
function formatNepaliCurrency(amount) {
  if (isNaN(amount)) return '';
  const nep = ['реж','рез','реи','рей','рек','рел','рем','рен','рео','реп'];
  const numStr = Math.round(amount).toString();
  let out = '';
  for (const ch of numStr) out += /\d/.test(ch) ? nep[+ch] : ch;
  return `${out}/-`;
}
function handleSalaryConversion(formElement) {
    const salaryAmount = formElement.querySelector('[name*="salary_amount"]');
    const salaryCurrency = formElement.querySelector('[name*="salary_currency"]');
    const salaryNPR = formElement.querySelector('[name*="salary_npr"]');
    if (salaryAmount && salaryCurrency && salaryNPR) {
    const nprAmount = convertToNPR(salaryAmount.value, salaryCurrency.value);
    if (nprAmount) salaryNPR.value = nprAmount;
  }
}

/* ===== interview preview & date listeners (IDs fixed) ===== */
function updateInterviewPreview() {
  const nepaliDate = document.getElementById('id_interview_nepali_date')?.value || '';
  const gregorianDate = document.getElementById('id_interview_gregorian_date')?.value || '';
  const location = document.getElementById('id_interview_location')?.value || '';
  let previewText = 'рдЕрдиреНрддрд░рд╡рд╛рд░реНрддрд╛ ';
  if (nepaliDate) previewText += `рдорд┐рддрд┐ ${nepaliDate} `;
  if (gregorianDate) previewText += `(${gregorianDate}) `;
  if (location) previewText += `${location} рд╣реБрдиреЗрдЫред`;
  const out = document.getElementById('interview_preview');
  if (out) out.textContent = previewText;
}

// rough converters (optional)
function convertNepaliToGregorian(nepaliDate) {
  const parts = (nepaliDate || '').split('/');
  if (parts.length !== 3) return '';
  const gy = parseInt(parts[0],10) - 57;
  return `${gy}-${parts[1]}-${parts[2]}`;
}
function convertGregorianToNepali(gregorianDate) {
  const parts = (gregorianDate || '').split('-');
  if (parts.length !== 3) return '';
  const ny = parseInt(parts[0],10) + 57;
  return `${ny}/${parts[1]}/${parts[2]}`;
}
function setupDateConversion() {
  const nep = document.getElementById('id_interview_nepali_date');
  const gre = document.getElementById('id_interview_gregorian_date');
  if (nep && gre) {
    nep.addEventListener('input', function() {
      if (this.value.includes('/')) gre.value = convertNepaliToGregorian(this.value);
      updateInterviewPreview();
    });
    gre.addEventListener('input', function() {
      if (this.value.includes('-')) nep.value = convertGregorianToNepali(this.value);
      updateInterviewPreview();
    });
  }
}

/* ===== small helpers you already had (kept) ===== */
function convertToNepaliNumbers(input) {
  const map = {'0':'реж','1':'рез','2':'реи','3':'рей','4':'рек','5':'рел','6':'рем','7':'рен','8':'рео','9':'реп'};
  if (!input) return input;
  const first = input.charAt(0);
  return map[first] ? map[first] + input.slice(1) : input;
}
function setupNumberConversion() {
  const nodes = document.querySelectorAll('input[name*="male_count"], input[name*="female_count"], input[name*="hours_per_day"], input[name*="days_per_week"]');
  nodes.forEach(field => {
    field.addEventListener('input', function() {
      if (/^\d+$/.test(this.value)) this.value = convertToNepaliNumbers(this.value);
    });
  });
}

// apply client-side OCR data (new function)
function applyClientOCRData() {
  // Check if we have OCR preview text
  const ocrPreview = document.getElementById('ocrPreview');
  if (!ocrPreview || !ocrPreview.textContent || ocrPreview.textContent === '(рдЯреЗрдХреНрд╕реНрдЯ рднреЗрдЯрд┐рдПрди)') {
    alert('рдХреГрдкрдпрд╛ рдкрд╣рд┐рд▓реЗ OCR рдЪрд▓рд╛рдЙрдиреБрд╣реЛрд╕реН рд░ рдЯреЗрдХреНрд╕реНрдЯ рдирд┐рдХрд╛рд▓реНрдиреБрд╣реЛрд╕реНред');
    return;
  }
  
  const text = ocrPreview.textContent;
  
  // Fill forms from OCR text
  fillMainFieldsFromText(text);
  fillPositionFromText(text);
  
  // Auto-convert salary if available
  const firstForm = document.querySelector('.position-form');
  if (firstForm) handleSalaryConversion(firstForm);
  
  // Move to Step 2
  goToStep(2);
  alert('тЬЕ OCR рдбрд╛рдЯрд╛ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд▓рд╛рдЧреВ рдЧрд░рд┐рдпреЛ! рдЕрдм рддрдкрд╛рдИрдВрд▓реЗ рдореБрдЦреНрдп рдЬрд╛рдирдХрд╛рд░реА рдЪрд░рдгрдорд╛ рдЬрд╛рди рд╕рдХреНрдиреБрд╣реБрдиреНрдЫред');
}

// apply parsed table data (server OCR path) тАФ unchanged
function applyOCRData() {
  const parsedData = {};
  const rows = document.querySelectorAll('#step1 .table tbody tr');
  rows.forEach(row => {
    const tds = row.querySelectorAll('td');
    if (tds.length < 2) return;
    const field = tds[0].textContent.trim();
    const value = tds[1].textContent.trim();
    const map = {
      'рдХрдореНрдкрдиреАрдХреЛ рдирд╛рдо':'company_name','рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐ рдорд┐рддрд┐':'pre_approval_date','рдЪрд▓рд╛рдиреА рдирдВ.':'chalani_no','LOT рдирдВ.':'lot_no',
      'рд╢рд╣рд░':'city','рджреЗрд╢':'country','рдкрдж':'position','рдкреБрд░реБрд╖ рд╕рдВрдЦреНрдпрд╛':'male_count','рдорд╣рд┐рд▓рд╛ рд╕рдВрдЦреНрдпрд╛':'female_count',
      'рддрд▓рдм рд░рдХрдо':'salary_amount','рдореБрджреНрд░рд╛':'salary_currency','рдУрднрд░ рдЯрд╛рдЗрдо':'overtime','рдШрдгреНрдЯрд╛/рджрд┐рди':'hours_per_day',
      'рджрд┐рди/рд╣рдкреНрддрд╛':'days_per_week','рд╡рд╛рд░реНрд╖рд┐рдХ рд╡рд┐рджрд╛':'yearly_leave','рд╢реИрдХреНрд╖рд┐рдХ рдпреЛрдЧреНрдпрддрд╛':'min_qualification',
      'рдЦрд╛рдирд╛':'food_provided','рдмрд╕реЛрдмрд╛рд╕':'housing_provided','рдХрд░рд╛рд░ рдЕрд╡рдзрд┐':'contract_duration'
    };
    const key = map[field];
    if (key && value !== 'рдкрд╛рдЗрдПрди') parsedData[key] = value;
  });

  const setId = (id,val)=>{ const el=document.getElementById('id_'+id); if(el && val) el.value=val; };
  setId('company_name', parsedData.company_name);
  setId('pre_approval_date', parsedData.pre_approval_date);
  setId('chalani_no', parsedData.chalani_no);
  setId('lot_no', parsedData.lot_no);
  setId('city', parsedData.city);
  setId('country', parsedData.country);

  const setName = (name,val)=>{
    const el = document.querySelector(`[name*="${name}"]`);
    if (el && val) el.value = val;
  };
  ['position','male_count','female_count','salary_amount','salary_currency','overtime','hours_per_day','days_per_week','yearly_leave','min_qualification','food_provided','housing_provided','contract_duration']
    .forEach(k => setName(k, parsedData[k]));

  const firstForm = document.querySelector('.position-form');
  if (firstForm && (parsedData.salary_amount || parsedData.salary_currency)) handleSalaryConversion(firstForm);

  alert('OCR рдбрд╛рдЯрд╛ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд▓рд╛рдЧреВ рдЧрд░рд┐рдпреЛ! рдЕрдм рддрдкрд╛рдИрдВрд▓реЗ рдореБрдЦреНрдп рдЬрд╛рдирдХрд╛рд░реА рдЪрд░рдгрдорд╛ рдЬрд╛рди рд╕рдХреНрдиреБрд╣реБрдиреНрдЫред');
  goToStep(2);
}

/* ===== stepper / validation (unchanged) ===== */
function goToStep(step) {
  if (!validateCurrentStep()) return;
  currentStep = step; updateProgress();
  document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('show','active'));
  const target = document.getElementById(`step${step}`);
  if (target) target.classList.add('show','active');
  document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
  const nav = document.getElementById(`step${step}-tab`);
  if (nav) nav.classList.add('active');
  document.getElementById('progressBar').style.width = (step/totalSteps*100) + '%';
}
function validateCurrentStep() {
  const cur = document.querySelector('.tab-pane.active');
  if (!cur) return true;
  const id = cur.id;
  if (id === 'step2') {
    const required = ['id_company_name','id_country','id_pre_approval_date','id_chalani_no','id_lot_no','id_city'];
    const missing = [];
    required.forEach(fid=>{
      const f = document.getElementById(fid);
      if (f && !f.value.trim()) missing.push(f.previousElementSibling?.textContent || fid);
    });
    if (missing.length) { alert('рдХреГрдкрдпрд╛ рдпреА рдЖрд╡рд╢реНрдпрдХ рдлрд┐рд▓реНрдбрд╣рд░реВ рднрд░реНрдиреБрд╣реЛрд╕реН:\n' + missing.join('\n')); return false; }
  } else if (id === 'step3') {
    const forms = document.querySelectorAll('.position-form');
    if (!forms.length) { alert('рдХреГрдкрдпрд╛ рдХрдореНрддрд┐рдорд╛ рдПрдЙрдЯрд╛ рдХрд╛рдорджрд╛рд░рдХреЛ рдкрдж рдердкреНрдиреБрд╣реЛрд╕реНред'); return false; }
    let ok = false;
    forms.forEach(f=>{
      const pos = f.querySelector('input[name*="position"]')?.value.trim();
      const male = f.querySelector('input[name*="male_count"]')?.value.trim();
      const female = f.querySelector('input[name*="female_count"]')?.value.trim();
      const sal = f.querySelector('input[name*="salary_amount"]')?.value.trim();
      if (pos && (male || female) && sal) ok = true;
    });
    if (!ok) { alert('рдХреГрдкрдпрд╛ рдХрдореНрддрд┐рдорд╛ рдПрдЙрдЯрд╛ рдкрджрдХреЛ рдЬрд╛рдирдХрд╛рд░реА рднрд░реНрдиреБрд╣реЛрд╕реНред'); return false; }
  }
  return true;
}
function updateProgress() {
  document.getElementById('progressBar').style.width = (currentStep/totalSteps*100) + '%';
}

/* ===== add/remove positions & other utilities (unchanged from your version) ===== */
function addPosition() {
  const container = document.getElementById('positionsContainer');
  const firstForm = container?.querySelector('.position-form');
  if (!container || !firstForm) return;

  const count = container.querySelectorAll('.position-form').length;
  const totalFormsField = document.querySelector('[name*="TOTAL_FORMS"]');
  const initialFormsField = document.querySelector('[name*="INITIAL_FORMS"]');

  const newForm = firstForm.cloneNode(true);
  newForm.dataset.formIndex = count;
  const title = newForm.querySelector('h6'); if (title) title.textContent = `рдкрдж #${count + 1}`;

  newForm.querySelectorAll('input, select, textarea, label[for]').forEach(node => {
    const attr = node.name ? 'name' : (node.id ? 'id' : (node.getAttribute && node.getAttribute('for') ? 'for' : null));
    if (!attr) return;
    const val = node[attr];
    const m = val && val.match(/positions-(\d+)-/);
    if (m) {
      const rep = val.replace(`positions-${m[1]}-`, `positions-${count}-`);
      if (node.name) node.name = rep;
      else if (node.id) node.id = rep;
      else node.setAttribute('for', rep);
    }
    if (node.tagName === 'INPUT' || node.tagName === 'TEXTAREA') {
      if (node.type !== 'hidden') node.value = '';
    }
    if (node.tagName === 'SELECT') node.value = '';
  });

  const header = newForm.querySelector('.d-flex.justify-content-between');
  if (header) {
    header.querySelector('.btn-danger')?.remove();
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-danger btn-sm';
    removeBtn.onclick = function(){ removePosition(this); };
    removeBtn.innerHTML = 'ЁЯЧСя╕П рд╣рдЯрд╛рдЙрдиреБрд╣реЛрд╕реН';
    header.appendChild(removeBtn);
  }

  container.appendChild(newForm);
  if (totalFormsField) totalFormsField.value = count + 1;
  if (initialFormsField) initialFormsField.value = '0';
  addCurrencyConversionListeners(newForm);
}
function removePosition(button) {
  const form = button.closest('.position-form');
  if (!form) return;
  form.remove();

  const container = document.getElementById('positionsContainer');
  const forms = container.querySelectorAll('.position-form');
  forms.forEach((f, i) => {
    f.dataset.formIndex = i;
    const h = f.querySelector('h6'); if (h) h.textContent = `рдкрдж #${i + 1}`;
    f.querySelectorAll('input, select, textarea, label[for]').forEach(node => {
      const attr = node.name ? 'name' : (node.id ? 'id' : (node.getAttribute && node.getAttribute('for') ? 'for' : null));
      if (!attr) return;
      const val = node[attr];
      const m = val && val.match(/positions-(\d+)-/);
      if (m) {
        const rep = val.replace(`positions-${m[1]}-`, `positions-${i}-`);
        if (node.name) node.name = rep;
        else if (node.id) node.id = rep;
        else node.setAttribute('for', rep);
      }
    });
  });

  const totalFormsField = container.querySelector('[name*="TOTAL_FORMS"]');
  const initialFormsField = container.querySelector('[name*="INITIAL_FORMS"]');
  if (totalFormsField) totalFormsField.value = forms.length;
  if (initialFormsField) initialFormsField.value = '0';
}
function addCurrencyConversionListeners(formElement) {
  const salaryAmount = formElement.querySelector('[name*="salary_amount"]');
  const salaryCurrency = formElement.querySelector('[name*="salary_currency"]');
  if (salaryAmount)  salaryAmount.addEventListener('input', () => handleSalaryConversion(formElement));
  if (salaryCurrency) salaryCurrency.addEventListener('change', () => handleSalaryConversion(formElement));
}
async function updateCurrencyRates() {
  try {
    const res = await fetch('/update-currency-rates/', {
      method: 'POST',
      headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value}
    });
    if (res.ok) {
      const data = await res.json();
      if (data.success) location.reload();
    }
  } catch(e) { console.error(e); }
}

/* ===== on load ===== */
// Global setup tracking to prevent duplicates
const setupTracker = {
  isComplete: false,
  functions: new Set(),
  elements: new Set(),
  eventListeners: new Map() // Track event listeners by element + event type
};

// Function to safely add event listener only once
function addEventListenerOnce(element, event, handler, options) {
  if (!element) return;
  
  // Create a unique key for this element + event combination
  const key = `${element.id || element.name || 'unknown'}_${event}`;
  
  // Check if we already added this exact event listener
  if (setupTracker.eventListeners.has(key)) {
    console.log(`тЪая╕П Event listener already exists: ${event} on ${element.id || element.name || 'unknown'}`);
    return;
  }
  
  // Add the event listener
  element.addEventListener(event, handler, options);
  setupTracker.eventListeners.set(key, true);
  setupTracker.elements.add(element);
  console.log(`тЬЕ Event listener added: ${event} on ${element.id || element.name || 'unknown'}`);
}

// Function to safely setup a function only once
function setupFunctionOnce(funcName, setupFunc) {
  if (setupTracker.functions.has(funcName)) {
    console.log(`тЪая╕П Function ${funcName} already set up, skipping...`);
    return;
  }
  
  setupFunc();
  setupTracker.functions.add(funcName);
  console.log(`тЬЕ Function ${funcName} set up successfully`);
}

// Prevent multiple DOMContentLoaded listeners
if (window.rajdhaniSetupComplete) {
  console.log('тЪая╕П Rajdhani setup already completed, skipping...');
} else {
  document.addEventListener('DOMContentLoaded', function() {
    // Prevent duplicate setup
    if (setupTracker.isComplete) {
      console.log('тЪая╕П Setup already completed, skipping...');
      return;
    }
    
    console.log('ЁЯФД DOMContentLoaded event triggered - SINGLE LISTENER');
    
    // Setup all functions in the correct order with duplicate prevention
    console.log('ЁЯФД Setting up all functions with duplicate prevention...');
    
    // 1. Setup OCR form
    setupFunctionOnce('OCRForm', setupOCRForm);
    
    // 2. Setup progress and currency conversion
    setupFunctionOnce('ProgressAndCurrency', setupProgressAndCurrency);
    
    // 3. Setup automatic interview date
    setupFunctionOnce('AutomaticInterviewDate', setupAutomaticInterviewDate);
    
    // 4. Setup country dropdown
    setupFunctionOnce('CountryDropdown', setupCountryDropdown);
    
    // 5. Setup logo preview
    setupFunctionOnce('LogoPreview', setupLogoPreview);
    
    // 6. Setup interview preview listeners (only once)
    ['id_interview_nepali_date','id_interview_gregorian_date','id_interview_location']
      .forEach(id => { 
        const el = document.getElementById(id); 
        if (el) addEventListenerOnce(el, 'input', updateInterviewPreview); 
      });
    
    // Mark setup as complete
    setupTracker.isComplete = true;
    window.rajdhaniSetupComplete = true;
    console.log('тЬЕ All setup functions called from single DOMContentLoaded listener with duplicate prevention');
  });
}

/* ===== your remaining helpers (unchanged) ===== */
function setupLogoPreview() {
  const logoUpload = document.getElementById('logo-upload');
  const logoPreview = document.getElementById('logo-preview');
  const logoText = document.getElementById('id_company_logo_text');
  
  if (logoUpload) {
    // Use our safe event listener function to prevent duplicates
    addEventListenerOnce(logoUpload, 'change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) return alert('рдХреГрдкрдпрд╛ рдПрдЙрдЯрд╛ рдЗрдореЗрдЬ рдлрд╛рдЗрд▓ рдЫрд╛рдиреНрдиреБрд╣реЛрд╕реНред');
      if (file.size > 2*1024*1024) return alert('рдлрд╛рдЗрд▓ рд╕рд╛рдЗрдЬ 2MB рднрдиреНрджрд╛ рдареВрд▓реЛ рд╣реБрдиреБрд╣реБрдБрджреИрдиред');
      const reader = new FileReader();
      reader.onload = e => { logoPreview.innerHTML = `<img src="${e.target.result}" alt="Company Logo" class="preview-logo">`; };
      reader.readAsDataURL(file);
    });
  }
  
  if (logoText) {
    // Use our safe event listener function to prevent duplicates
    addEventListenerOnce(logoText, 'input', function() {
      if (!logoUpload?.files.length) logoPreview.innerHTML = `<div class="logo-placeholder">${this.value || 'LOGO'}</div>`;
    });
  }
}
function calculateInterviewDate() {
  const pre = document.getElementById('id_pre_approval_date')?.value;
  if (!pre) return alert('рдХреГрдкрдпрд╛ рдкрд╣рд┐рд▓реЗ рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐ рдорд┐рддрд┐ рднрд░реНрдиреБрд╣реЛрд╕реНред');
  try {
    const d = new Date(pre); d.setDate(d.getDate()+8);
    const nep = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
    const eng = d.toLocaleDateString('en-US', { day:'numeric', month:'long', year:'numeric' });
    document.getElementById('id_interview_nepali_date').value = nep;
    document.getElementById('id_interview_gregorian_date').value = eng;
    document.getElementById('preview_nepali_date').textContent = nep;
    document.getElementById('preview_gregorian_date').textContent = eng;
    alert(`рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдорд┐рддрд┐ рдЧрдгрдирд╛ рд╕рдлрд▓: ${nep} (${eng})`);
  } catch { alert('рдорд┐рддрд┐ рдЧрдгрдирд╛рдорд╛ рддреНрд░реБрдЯрд┐ рднрдпреЛред YYYY-MM-DD рдкреНрд░рдпреЛрдЧ рдЧрд░реНрдиреБрд╣реЛрд╕реНред'); }
}
function setupCountryNoticePreview() {
  const countryField = document.getElementById('id_country');
  const extraNotesField = document.getElementById('id_extra_notes');
  const previewDiv = document.getElementById('countryNoticePreview');
  const previewText = document.getElementById('noticePreviewText');
  if (!(countryField && extraNotesField && previewDiv && previewText)) return;
  const update = () => {
    const country = (countryField.value||'').trim().toLowerCase();
    const hasCustom = (extraNotesField.value||'').trim();
    if (!country || hasCustom) { previewDiv.style.display = 'none'; return; }
    let notice = '';
    if (['kuwait','uae','saudi','qatar','oman','bahrain','jordan','lebanon','iraq','iran','syria','yemen'].some(c => country.includes(c))) notice = 'рдмреИрджреЗрд╢рд┐рдХ рд░реЛрдЬрдЧрд╛рд░ рдмрд┐рднрд╛рдЧрдмрд╛рдЯ рдЧрд░рд╛рдЗрдПрдХреЛ рдЬрд╛рдирдХрд╛рд░реА (рдордзреНрдп рдкреВрд░реНрд╡реА рджреЗрд╢рд╣рд░реВрдХреЛ рд▓рд╛рдЧрд┐)';
    else if (country.includes('japan')) notice = 'рдкреНрд░рд╢рд┐рдХреНрд╖рд╛рд░реНрдереАрдХреЛ рдЖрд╡рд╢реНрдпрдХ рдиреНрдпреВрдирддрдо рдпреЛрдЧреНрдпрддрд╛ рд░ рдХрд╛рдо рдЧрд░реЗрдХреЛ рдЕрдиреБрднрд╡ (рдЬрд╛рдкрд╛рдирдХреЛ рд▓рд╛рдЧрд┐)';
    else notice = 'рд╕рд╛рдорд╛рдиреНрдп рд╕реВрдЪрдирд╛ (рдЕрдиреНрдп рджреЗрд╢рд╣рд░реВрдХреЛ рд▓рд╛рдЧрд┐)';
    previewText.textContent = notice;
    previewDiv.style.display = 'block';
    updateCurrencyBasedOnCountry(country);
  };
  countryField.addEventListener('input', update);
  extraNotesField.addEventListener('input', update);
  update();
}
function updateCurrencyBasedOnCountry(country) {
  const fields = document.querySelectorAll('[name*="salary_currency"]');
  if (!fields.length) return;
  let def = 'KWD';
  if (country.includes('kuwait')) def = 'KWD';
  else if (country.includes('uae')) def = 'AED';
  else if (country.includes('saudi')) def = 'SAR';
  else if (country.includes('qatar')) def = 'QAR';
  else if (country.includes('oman')) def = 'OMR';
  else if (country.includes('bahrain')) def = 'BHD';
  else if (country.includes('japan')) def = 'JPY';
  else if (country.includes('usa') || country.includes('united states')) def = 'USD';
  else if (country.includes('europe') || country.includes('eu')) def = 'EUR';
  else if (country.includes('uk') || country.includes('united kingdom')) def = 'GBP';
  fields.forEach(f => { if (!f.value || f.value === 'KD') f.value = def; });
}

/* === forms submit (same as yours) === */
document.getElementById('mainForm')?.addEventListener('submit', function(e){
  e.preventDefault();
  if (!validateCurrentStep()) return;
  const formData = new FormData(this);
  fetch(window.location.href, { method:'POST', body:formData, headers:{'X-Requested-With':'XMLHttpRequest'} })
    .then(r => r.json()).then(d => { if (d.success){ alert('рдореБрдЦреНрдп рдЬрд╛рдирдХрд╛рд░реА рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╕реЗрдн рдЧрд░рд┐рдпреЛ!'); goToStep(3);} else alert('рддреНрд░реБрдЯрд┐: '+d.error); })
    .catch(err => { console.error(err); alert('рддреНрд░реБрдЯрд┐ рднрдпреЛред рдХреГрдкрдпрд╛ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдЧрд░реНрдиреБрд╣реЛрд╕реНред'); });
});
document.getElementById('positionForm')?.addEventListener('submit', function(e){
  e.preventDefault();
  if (!validateCurrentStep()) return;
  const formData = new FormData(this);
  fetch(window.location.href, { method:'POST', body:formData, headers:{'X-Requested-With':'XMLHttpRequest'} })
    .then(r => r.json()).then(d => { if (d.success){ alert('рдкрджрд╣рд░реВ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╕реЗрдн рдЧрд░рд┐рдпреЛ!'); goToStep(4);} else alert('рддреНрд░реБрдЯрд┐: '+d.error); })
    .catch(err => { console.error(err); alert('рддреНрд░реБрдЯрд┐ рднрдпреЛред рдХреГрдкрдпрд╛ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдЧрд░реНрдиреБрд╣реЛрд╕реНред'); });
});

console.log('=== JAVASCRIPT LOADED ===');









// Function to update interview preview
function updateInterviewPreview() {
    const nepaliDate = document.getElementById('id_nepali_date').value;
    const gregorianDate = document.getElementById('id_gregorian_date').value;
    const location = document.getElementById('id_interview_location').value;
    
    let previewText = 'рдЕрдиреНрддрд░рд╡рд╛рд░реНрддрд╛ ';
    if (nepaliDate) previewText += `рдорд┐рддрд┐ ${nepaliDate} `;
    if (gregorianDate) previewText += `(${gregorianDate}) `;
    if (location) previewText += `${location} рд╣реБрдиреЗрдЫред`;
    
    document.getElementById('interview_preview').textContent = previewText;
}

// Auto-convert between Nepali and Gregorian dates
function convertNepaliToGregorian(nepaliDate) {
    // Simple conversion - you can enhance this with proper Nepali calendar logic
    const nepaliYear = parseInt(nepaliDate.split('/')[0]);
    const gregorianYear = nepaliYear - 57; // Approximate conversion
    return `${gregorianYear}-${nepaliDate.split('/')[1]}-${nepaliDate.split('/')[2]}`;
}

function convertGregorianToNepali(gregorianDate) {
    // Simple conversion - you can enhance this with proper Nepali calendar logic
    const gregorianYear = parseInt(gregorianDate.split('-')[0]);
    const nepaliYear = gregorianYear + 57; // Approximate conversion
    return `${nepaliYear}/${gregorianDate.split('-')[1]}/${gregorianDate.split('-')[2]}`;
}





// Country dropdown functionality - show/hide manual input for "Other" and auto-generate title
function setupCountryDropdown() {
    const countryField = document.getElementById('id_country');
    const otherCountryField = document.getElementById('otherCountryField');
    const otherCountryInput = document.getElementById('id_other_country');
    const titleField = document.getElementById('id_title');
    
    if (countryField && otherCountryField && otherCountryInput) {
        // Use our safe event listener function to prevent duplicates
        addEventListenerOnce(countryField, 'change', function() {
            if (this.value === 'Other') {
                otherCountryField.style.display = 'block';
                otherCountryInput.required = true;
                otherCountryInput.focus();
                
                // For "Other" country, set a generic title
                if (titleField) {
                    titleField.value = 'рд╡рд┐рджреЗрд╢рдорд╛ рд░реЛрдЬрдЧрд╛рд░реА';
                    titleField.dispatchEvent(new Event('input', { bubbles: true }));
                    titleField.dispatchEvent(new Event('change', { bubbles: true }));
                }
            } else {
                otherCountryField.style.display = 'none';
                otherCountryInput.required = false;
                otherCountryInput.value = '';
                
                // Auto-generate title based on country selection
                generateTitleFromCountry(this.value, titleField);
            }
        });
        
        // Also handle on page load if "Other" is pre-selected
        if (countryField.value === 'Other') {
            otherCountryField.style.display = 'block';
            otherCountryInput.required = true;
        }
        
        // Generate title on page load if country is already selected
        if (countryField.value && countryField.value !== 'Other') {
            generateTitleFromCountry(countryField.value, titleField);
        }
        
        // Add listener for custom country input to update title
        if (otherCountryInput) {
            addEventListenerOnce(otherCountryInput, 'input', function() {
                if (this.value.trim()) {
                    const customTitle = `${this.value.trim()}рдорд╛ рд░реЛрдЬрдЧрд╛рд░реА`;
                    if (titleField) {
                        titleField.value = customTitle;
                        titleField.dispatchEvent(new Event('input', { bubbles: true }));
                        titleField.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            });
        }
    }
}

// Function to generate title based on country
function generateTitleFromCountry(country, titleField) {
    if (!titleField) return;
    
    let title = '';
    switch (country) {
        case 'Japan':
            title = 'рдЬрд╛рдкрд╛рдирдорд╛ рд░реЛрдЬрдЧрд╛рд░реА';
            break;
        case 'UAE':
            title = 'рдпреВрдПрдИрдорд╛ рд░реЛрдЬрдЧрд╛рд░реА';
            break;
        case 'Kuwait':
            title = 'рдХреБрд╡реЗрддрдорд╛ рд░реЛрдЬрдЧрд╛рд░реА';
            break;
        case 'Qatar':
            title = 'рдХрддрд╛рд░рдорд╛ рд░реЛрдЬрдЧрд╛рд░реА';
            break;
        case 'Saudi Arabia':
            title = 'рд╕рд╛рдЙрджреА рдЕрд░реЗрдмрд┐рдпрд╛рдорд╛ рд░реЛрдЬрдЧрд╛рд░реА';
            break;
        case 'Oman':
            title = 'рдУрдорд╛рдирдорд╛ рд░реЛрдЬрдЧрд╛рд░реА';
            break;
        case 'Bahrain':
            title = 'рдмрд╣рд░реЗрдирдорд╛ рд░реЛрдЬрдЧрд╛рд░реА';
            break;
        case 'Malaysia':
            title = 'рдорд▓реЗрд╕рд┐рдпрд╛рдорд╛ рд░реЛрдЬрдЧрд╛рд░реА';
            break;
        case 'Singapore':
            title = 'рд╕рд┐рдЩреНрдЧрд╛рдкреБрд░рдорд╛ рд░реЛрдЬрдЧрд╛рд░реА';
            break;
        case 'South Korea':
            title = 'рджрдХреНрд╖рд┐рдг рдХреЛрд░рд┐рдпрд╛рдорд╛ рд░реЛрдЬрдЧрд╛рд░реА';
            break;
        default:
            title = 'рд╡рд┐рджреЗрд╢рдорд╛ рд░реЛрдЬрдЧрд╛рд░реА';
            break;
    }
    
    // Only set the title if it's empty or if user hasn't manually typed something
    if (!titleField.value.trim() || titleField.value.trim() === 'рдЬрд╛рдкрд╛рдирдорд╛ рд░реЛрдЬрдЧрд╛рд░реА') {
        titleField.value = title;
        titleField.dispatchEvent(new Event('input', { bubbles: true }));
        titleField.dispatchEvent(new Event('change', { bubbles: true }));
    }
}

// Automatic interview date calculation (8 days after approval date)
function setupAutomaticInterviewDate() {
    console.log('ЁЯФД setupAutomaticInterviewDate called');
    
    const approvalDateField = document.getElementById('id_pre_approval_date');
    const nepaliDateField = document.getElementById('id_interview_nepali_date');
    const gregorianDateField = document.getElementById('id_interview_gregorian_date');
    const previewNepali = document.getElementById('preview_nepali_date');
    const previewGregorian = document.getElementById('preview_gregorian_date');
    
    console.log('ЁЯУЕ Field references:', {
        approvalDateField: approvalDateField,
        nepaliDateField: nepaliDateField,
        gregorianDateField: gregorianDateField,
        previewNepali: previewNepali,
        previewGregorian: previewGregorian
    });
    
    if (approvalDateField && nepaliDateField && gregorianDateField) {
        console.log('тЬЕ All fields found, setting up event listeners');
        
        // Use our safe event listener function to prevent duplicates
        addEventListenerOnce(approvalDateField, 'input', function() {
            console.log('ЁЯУЕ Approval date input event triggered with value:', this.value);
            if (this.value) {
                calculateAndFillInterviewDate(this.value);
            }
        });
        
        addEventListenerOnce(approvalDateField, 'change', function() {
            console.log('ЁЯУЕ Approval date change event triggered with value:', this.value);
            if (this.value) {
                calculateAndFillInterviewDate(this.value);
            }
        });
        
        console.log('тЬЕ Event listeners attached to approval date field');
    } else {
        console.log('тЭМ Some fields not found:', {
            approvalDateField: !!approvalDateField,
            nepaliDateField: !!nepaliDateField,
            gregorianDateField: !!gregorianDateField
        });
    }
    
    function calculateAndFillInterviewDate(approvalDateStr) {
        console.log('ЁЯФД calculateAndFillInterviewDate called with:', approvalDateStr);
        
        try {
            // Parse the approval date (handle both YYYY-MM-DD and YYYY/MM/DD formats)
            let approvalDate;
            if (approvalDateStr.includes('/')) {
                // Handle Nepali date format (YYYY/MM/DD)
                const parts = approvalDateStr.split('/');
                console.log('ЁЯУЕ Parsing Nepali date format, parts:', parts);
                if (parts.length === 3) {
                    const year = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1; // Month is 0-indexed
                    const day = parseInt(parts[2]);
                    approvalDate = new Date(year, month, day);
                    console.log('ЁЯУЕ Created Date object from Nepali format:', approvalDate);
                }
            } else if (approvalDateStr.includes('-')) {
                // Handle Gregorian date format (YYYY-MM-DD)
                approvalDate = new Date(approvalDateStr);
                console.log('ЁЯУЕ Created Date object from Gregorian format:', approvalDate);
            }
            
            if (approvalDate && !isNaN(approvalDate.getTime())) {
                // Calculate interview date (8 days after approval)
                const interviewDate = new Date(approvalDate);
                interviewDate.setDate(approvalDate.getDate() + 8);
                console.log('ЁЯУЕ Interview date calculated (8 days after):', interviewDate);
                
                // Format Nepali date (YYYY/MM/DD)
                const nepaliDate = `${interviewDate.getFullYear()}/${String(interviewDate.getMonth() + 1).padStart(2, '0')}/${String(interviewDate.getDate()).padStart(2, '0')}`;
                
                // Format Gregorian date (DD Month, YYYY)
                const gregorianDate = interviewDate.toLocaleDateString('en-US', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
                
                console.log('ЁЯУЕ Formatted dates - Nepali:', nepaliDate, 'Gregorian:', gregorianDate);
                console.log('ЁЯУЕ Field references - nepaliDateField:', nepaliDateField, 'gregorianDateField:', gregorianDateField);
                
                // Fill the fields
                if (nepaliDateField) {
                    nepaliDateField.value = nepaliDate;
                    console.log('тЬЕ Nepali date field updated');
                } else {
                    console.log('тЭМ Nepali date field not found');
                }
                
                if (gregorianDateField) {
                    gregorianDateField.value = gregorianDate;
                    console.log('тЬЕ Gregorian date field updated');
                } else {
                    console.log('тЭМ Gregorian date field not found');
                }
                
                if (previewNepali) {
                    previewNepali.textContent = nepaliDate;
                    console.log('тЬЕ Nepali preview updated');
                }
                
                if (previewGregorian) {
                    previewGregorian.textContent = gregorianDate;
                    console.log('тЬЕ Gregorian preview updated');
                }
                
                console.log('тЬЕ Interview date automatically calculated:', nepaliDate, '(', gregorianDate, ')');
            } else {
                console.log('тЭМ Invalid approval date or could not parse:', approvalDateStr);
            }
        } catch (error) {
            console.error('тЭМ Error calculating interview date:', error);
        }
    }
}

// Calendar picker functionality for approval date
function openDatePicker() {
    const hiddenPicker = document.getElementById('hidden_date_picker');
    if (hiddenPicker) {
        // Set current date as default
        const today = new Date().toISOString().split('T')[0];
        hiddenPicker.value = today;
        
        // Trigger the date picker
        hiddenPicker.click();
    }
}

function updateApprovalDate(selectedDate) {
    if (selectedDate) {
        const approvalDateField = document.getElementById('id_pre_approval_date');
        if (approvalDateField) {
            // Convert YYYY-MM-DD to Nepali format (YYYY/MM/DD)
            const date = new Date(selectedDate);
            const nepaliDate = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
            
            // Update the approval date field
            approvalDateField.value = nepaliDate;
            
            // Trigger change event to update interview dates
            approvalDateField.dispatchEvent(new Event('change', { bubbles: true }));
            
            console.log('тЬЕ Approval date updated via calendar:', nepaliDate);
        }
    }
}

// Auto-convert English numbers to Nepali numbers (first number only)
function convertToNepaliNumbers(input) {
    const englishToNepali = {
        '0': 'реж', '1': 'рез', '2': 'реи', '3': 'рей', '4': 'рек',
        '5': 'рел', '6': 'рем', '7': 'рен', '8': 'рео', '9': 'реп'
    };
    
    if (!input) return input;
    
    // Convert only the first number to Nepali, keep rest in English
    const firstChar = input.charAt(0);
    if (englishToNepali[firstChar]) {
        return englishToNepali[firstChar] + input.slice(1);
    }
    
    return input;
}



// Function to apply OCR data to forms
function applyOCRData() {
    // Get parsed data from the table
    const parsedData = {};
    
    // Extract data from the OCR results table
    const tableRows = document.querySelectorAll('#step1 .table tbody tr');
    tableRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 2) {
            const field = cells[0].textContent.trim();
            const value = cells[1].textContent.trim();
            
            // Map Nepali field names to form field names
            const fieldMapping = {
                'рдХрдореНрдкрдиреАрдХреЛ рдирд╛рдо': 'company_name',
                'рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐ рдорд┐рддрд┐': 'pre_approval_date',
                'рдЪрд▓рд╛рдиреА рдирдВ.': 'chalani_no',
                'LOT рдирдВ.': 'lot_no',
                'рд╢рд╣рд░': 'city',
                'рджреЗрд╢': 'country',
                'рдкрдж': 'position',
                'рдкреБрд░реБрд╖ рд╕рдВрдЦреНрдпрд╛': 'male_count',
                'рдорд╣рд┐рд▓рд╛ рд╕рдВрдЦреНрдпрд╛': 'female_count',
                'рддрд▓рдм рд░рдХрдо': 'salary_amount',
                'рдореБрджреНрд░рд╛': 'salary_currency',
                'рдУрднрд░ рдЯрд╛рдЗрдо': 'overtime',
                'рдШрдгреНрдЯрд╛/рджрд┐рди': 'hours_per_day',
                'рджрд┐рди/рд╣рдкреНрддрд╛': 'days_per_week',
                'рд╡рд╛рд░реНрд╖рд┐рдХ рд╡рд┐рджрд╛': 'yearly_leave',
                'рд╢реИрдХреНрд╖рд┐рдХ рдпреЛрдЧреНрдпрддрд╛': 'min_qualification',
                'рдЦрд╛рдирд╛': 'food_provided',
                'рдмрд╕реЛрдмрд╛рд╕': 'housing_provided',
                'рдХрд░рд╛рд░ рдЕрд╡рдзрд┐': 'contract_duration'
            };
            
            const formField = fieldMapping[field];
            if (formField && value !== 'рдкрд╛рдЗрдПрди') {
                parsedData[formField] = value;
            }
        }
    });
    
    // Apply data to main form fields
    if (parsedData.company_name) {
        const companyField = document.getElementById('id_company_name');
        if (companyField) companyField.value = parsedData.company_name;
    }
    
    if (parsedData.pre_approval_date) {
        const dateField = document.getElementById('id_pre_approval_date');
        if (dateField) dateField.value = parsedData.pre_approval_date;
    }
    
    if (parsedData.chalani_no) {
        const chalaniField = document.getElementById('id_chalani_no');
        if (chalaniField) chalaniField.value = parsedData.chalani_no;
    }
    
    if (parsedData.lot_no) {
        const lotField = document.getElementById('id_lot_no');
        if (lotField) lotField.value = parsedData.lot_no;
    }
    
    if (parsedData.city) {
        const cityField = document.getElementById('id_city');
        if (cityField) cityField.value = parsedData.city;
    }
    
    if (parsedData.country) {
        const countryField = document.getElementById('id_country');
        if (countryField) countryField.value = parsedData.country;
    }
    
    // Apply data to job position fields
    if (parsedData.position) {
        const positionField = document.querySelector('[name*="position"]');
        if (positionField) positionField.value = parsedData.position;
    }
    
    if (parsedData.male_count) {
        const maleField = document.querySelector('[name*="male_count"]');
        if (maleField) maleField.value = parsedData.male_count;
    }
    
    if (parsedData.female_count) {
        const femaleField = document.querySelector('[name*="female_count"]');
        if (femaleField) femaleField.value = parsedData.female_count;
    }
    
    if (parsedData.salary_amount) {
        const salaryField = document.querySelector('[name*="salary_amount"]');
        if (salaryField) salaryField.value = parsedData.salary_amount;
    }
    
    if (parsedData.salary_currency) {
        const currencyField = document.querySelector('[name*="salary_currency"]');
        if (currencyField) currencyField.value = parsedData.salary_currency;
    }
    
    // Apply other job position fields
    const jobFields = ['overtime', 'hours_per_day', 'days_per_week', 'yearly_leave', 
                      'min_qualification', 'food_provided', 'housing_provided', 'contract_duration'];
    
    jobFields.forEach(field => {
        if (parsedData[field]) {
            const fieldElement = document.querySelector(`[name*="${field}"]`);
            if (fieldElement) fieldElement.value = parsedData[field];
        }
    });
    
    // Trigger currency conversion if salary data was applied
    if (parsedData.salary_amount || parsedData.salary_currency) {
        const positionForm = document.querySelector('.position-form');
        if (positionForm) {
            handleSalaryConversion(positionForm);
        }
    }
    
    alert('OCR рдбрд╛рдЯрд╛ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд▓рд╛рдЧреВ рдЧрд░рд┐рдпреЛ! рдЕрдм рддрдкрд╛рдИрдВрд▓реЗ рдореБрдЦреНрдп рдЬрд╛рдирдХрд╛рд░реА рдЪрд░рдгрдорд╛ рдЬрд╛рди рд╕рдХреНрдиреБрд╣реБрдиреНрдЫред');
    goToStep(2);
}

// Function to go to specific step
function goToStep(step) {
    // Validate current step before proceeding
    if (!validateCurrentStep()) {
        return;
    }
    
    currentStep = step;
    updateProgress();
    
    // Hide all tabs
    document.querySelectorAll('.tab-pane').forEach(tab => {
        tab.classList.remove('show', 'active');
    });
    
    // Show target tab
    const targetTab = document.getElementById(`step${step}`);
    targetTab.classList.add('show', 'active');
    
    // Update navigation
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    document.getElementById(`step${step}-tab`).classList.add('active');
    
    // Update progress bar
    const progress = (step / totalSteps) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
}
// Function to validate current step before proceeding
function validateCurrentStep() {
    const currentStepElement = document.querySelector('.tab-pane.active');
    if (!currentStepElement) return true;
    
    const stepId = currentStepElement.id;
    
    if (stepId === 'step2') {
        // Validate main information fields
        const requiredFields = [
            'id_company_name',
            'id_country',
            'id_pre_approval_date',
            'id_chalani_no',
            'id_lot_no',
            'id_city'
        ];
        
        const missingFields = [];
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field && !field.value.trim()) {
                missingFields.push(field.previousElementSibling?.textContent || fieldId);
            }
        });
        
        if (missingFields.length > 0) {
            alert('рдХреГрдкрдпрд╛ рдпреА рдЖрд╡рд╢реНрдпрдХ рдлрд┐рд▓реНрдбрд╣рд░реВ рднрд░реНрдиреБрд╣реЛрд╕реН:\n' + missingFields.join('\n'));
            return false;
        }
        
    } else if (stepId === 'step3') {
        // Validate job positions
        const positionForms = document.querySelectorAll('.position-form');
        console.log(`Validating Step 3: Found ${positionForms.length} position forms`);
        
        if (positionForms.length === 0) {
            alert('рдХреГрдкрдпрд╛ рдХрдореНрддрд┐рдорд╛ рдПрдЙрдЯрд╛ рдХрд╛рдорджрд╛рд░рдХреЛ рдкрдж рдердкреНрдиреБрд╣реЛрд╕реНред');
            return false;
        }
        
        // Check if at least one form has the minimum required data
        let hasValidForm = false;
        const emptyForms = [];
        
        positionForms.forEach((form, index) => {
            console.log(`\n--- Validating Position Form ${index + 1} ---`);
            
            // Get all input fields in this form
            const positionField = form.querySelector('input[name*="position"]');
            const maleField = form.querySelector('input[name*="male_count"]');
            const femaleField = form.querySelector('input[name*="female_count"]');
            const salaryField = form.querySelector('input[name*="salary_amount"]');
            
            console.log('Fields found:', {
                position: positionField ? `"${positionField.value}"` : 'NOT FOUND',
                male: maleField ? `"${maleField.value}"` : 'NOT FOUND',
                female: femaleField ? `"${femaleField.value}"` : 'NOT FOUND',
                salary: salaryField ? `"${salaryField.value}"` : 'NOT FOUND'
            });
            
            // Check if this form has the minimum required data
            if (positionField && maleField && femaleField && salaryField) {
                const position = positionField.value.trim();
                const male = maleField.value.trim();
                const female = femaleField.value.trim();
                const salary = salaryField.value.trim();
                
                console.log('Field values:', { position, male, female, salary });
                
                // If this form has the essential fields filled, consider it valid
                if (position && (male || female) && salary) {
                    hasValidForm = true;
                    console.log(`Form ${index + 1} has essential data - marking as valid`);
                } else {
                    // This form is empty or incomplete
                    emptyForms.push(index + 1);
                    console.log(`Form ${index + 1} is empty or incomplete`);
                }
            } else {
                console.log(`Form ${index + 1} missing required field elements`);
                emptyForms.push(index + 1);
            }
        });
        
        console.log(`Validation result: hasValidForm=${hasValidForm}, emptyForms=${emptyForms.length}`);
        
        if (!hasValidForm) {
            alert('рдХреГрдкрдпрд╛ рдХрдореНрддрд┐рдорд╛ рдПрдЙрдЯрд╛ рдкрджрдХреЛ рдЬрд╛рдирдХрд╛рд░реА рднрд░реНрдиреБрд╣реЛрд╕реНред');
            return false;
        }
        
        // If we have at least one valid form, that's enough
        // Empty forms are allowed (they will be ignored by Django)
        console.log('Step 3 validation passed - at least one form has data');
        return true;
    }
    
    return true;
}

// Function to add new position
function addPosition() {
    console.log('DEBUG: addPosition() called');
    
    const container = document.getElementById('positionsContainer');
    if (!container) {
        console.error('Positions container not found');
        return;
    }
    
    // Get the first form to clone
    const firstForm = container.querySelector('.position-form');
    if (!firstForm) {
        console.error('No position form found to clone');
        return;
    }
    
    // Count current forms
    const currentForms = container.querySelectorAll('.position-form').length;
    console.log(`DEBUG: Current forms count: ${currentForms}`);
    
    // Get formset management fields
    const totalFormsField = document.querySelector('[name*="TOTAL_FORMS"]');
    const initialFormsField = document.querySelector('[name*="INITIAL_FORMS"]');
    
    if (!totalFormsField) {
        console.error('TOTAL_FORMS field not found');
        return;
    }
    
    console.log(`DEBUG: Before adding - TOTAL_FORMS: ${totalFormsField.value}, INITIAL_FORMS: ${initialFormsField ? initialFormsField.value : 'Not found'}`);
    
    const newForm = firstForm.cloneNode(true);
    
    // Update form index
    newForm.dataset.formIndex = currentForms;
    newForm.querySelector('h6').textContent = `рдкрдж #${currentForms + 1}`;
    
    // Update form field names - handle formset naming
    newForm.querySelectorAll('input, select, textarea').forEach(field => {
        if (field.name) {
            // Replace the form index in the name - handle Django formset naming
            const nameMatch = field.name.match(/positions-(\d+)-/);
            if (nameMatch) {
                const oldIndex = nameMatch[1];
                const newName = field.name.replace(`positions-${oldIndex}-`, `positions-${currentForms}-`);
                console.log(`Updating field name: ${field.name} -> ${newName}`);
                field.name = newName;
                if (field.id) {
                    const newId = field.id.replace(`positions-${oldIndex}-`, `positions-${currentForms}-`);
                    console.log(`Updating field ID: ${field.id} -> ${newId}`);
                    field.id = newId;
                }
            }
        }
    });
    
    // Also update labels and other elements that might reference the form index
    newForm.querySelectorAll('label[for]').forEach(label => {
        const forAttr = label.getAttribute('for');
        if (forAttr) {
            const nameMatch = forAttr.match(/positions-(\d+)-/);
            if (nameMatch) {
                const oldIndex = nameMatch[1];
                const newFor = forAttr.replace(`positions-${oldIndex}-`, `positions-${currentForms}-`);
                console.log(`Updating label for: ${forAttr} -> ${newFor}`);
                label.setAttribute('for', newFor);
            }
        }
    });
    
    // Clear ONLY the new form's values (not the original)
    newForm.querySelectorAll('input, select, textarea').forEach(field => {
        if (field.type !== 'hidden') {
            field.value = '';
        }
    });
    
    // Add remove button
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-danger btn-sm';
    removeBtn.onclick = function() { removePosition(this); };
    removeBtn.innerHTML = 'ЁЯЧСя╕П рд╣рдЯрд╛рдЙрдиреБрд╣реЛрд╕реН';
    
    const header = newForm.querySelector('.d-flex.justify-content-between');
    if (header) {
        // Remove existing remove button if any
        header.querySelector('.btn-danger')?.remove();
        header.appendChild(removeBtn);
    }
    
    // Add to container
    container.appendChild(newForm);
    
    // Update total forms count - ensure it's a number
    totalFormsField.value = currentForms + 1;
    console.log(`Updated TOTAL_FORMS to: ${totalFormsField.value}`);
    
    // Set INITIAL_FORMS to 0 since we're adding new positions
    if (initialFormsField) {
        initialFormsField.value = '0';
        console.log(`Set INITIAL_FORMS to: 0`);
    }
    
    // Add event listeners for currency conversion
    addCurrencyConversionListeners(newForm);
    
    // Debug: Log all field names in the new form
    console.log(`New form field names:`);
    newForm.querySelectorAll('input, select, textarea').forEach(field => {
        console.log(`  ${field.name}: "${field.value}"`);
    });
    
    // Debug: Verify first form still has data
    console.log(`First form data after adding new position:`);
    const firstFormAfter = container.querySelector('.position-form');
    if (firstFormAfter) {
        firstFormAfter.querySelectorAll('input, select, textarea').forEach(field => {
            if (field.name && field.name.includes('positions-0-')) {
                console.log(`  ${field.name}: "${field.value}"`);
            }
        });
    }
    
    console.log(`Added new position form. Total forms: ${totalFormsField.value}`);
}

// Function to remove position
function removePosition(button) {
    const form = button.closest('.position-form');
    if (!form) {
        console.error('Position form not found');
        return;
    }
    
    form.remove();
    
    // Get all remaining forms and reindex them
    const forms = document.querySelectorAll('.position-form');
    const container = document.getElementById('positionsContainer');
    
    if (container) {
        const totalFormsField = container.querySelector('[name*="TOTAL_FORMS"]');
        const initialFormsField = container.querySelector('[name*="INITIAL_FORMS"]');
        
        // Reindex all remaining forms
        forms.forEach((form, index) => {
            // Update form index
            form.dataset.formIndex = index;
            form.querySelector('h6').textContent = `рдкрдж #${index + 1}`;
            
            // Update all field names to match new index
            form.querySelectorAll('input, select, textarea').forEach(field => {
                if (field.name) {
                    const nameMatch = field.name.match(/positions-(\d+)-/);
                    if (nameMatch) {
                        const oldIndex = nameMatch[1];
                        const newName = field.name.replace(`positions-${oldIndex}-`, `positions-${index}-`);
                        console.log(`Reindexing field name: ${field.name} -> ${newName}`);
                        field.name = newName;
                        if (field.id) {
                            const newId = field.id.replace(`positions-${oldIndex}-`, `positions-${index}-`);
                            console.log(`Reindexing field ID: ${field.id} -> ${newId}`);
                            field.id = newId;
                        }
                    }
                }
            });
        });
        
        // Update total forms count
        if (totalFormsField) {
            totalFormsField.value = forms.length;
            console.log(`Removed position form. Total forms: ${totalFormsField.value}`);
        }
        
        // Set INITIAL_FORMS to 0 since we're working with new positions
        if (initialFormsField) {
            initialFormsField.value = '0';
            console.log(`Set INITIAL_FORMS to: 0`);
        }
    }
}

// Function to add currency conversion listeners
function addCurrencyConversionListeners(formElement) {
    const salaryAmount = formElement.querySelector('[name*="salary_amount"]');
    const salaryCurrency = formElement.querySelector('[name*="salary_currency"]');
    
    if (salaryAmount) {
        salaryAmount.addEventListener('input', () => handleSalaryConversion(formElement));
    }
    
    if (salaryCurrency) {
        salaryCurrency.addEventListener('change', () => handleSalaryConversion(formElement));
    }
}

// Function to fetch latest currency rates
async function updateCurrencyRates() {
    try {
        const response = await fetch('/update-currency-rates/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                console.log('Currency rates updated successfully');
                // Refresh the page or update rates in memory
                location.reload();
            }
        }
    } catch (error) {
        console.error('Error updating currency rates:', error);
    }
}

// Update progress on page load
function setupProgressAndCurrency() {
    updateProgress();
    
    // Add currency conversion listeners to existing forms
    document.querySelectorAll('.position-form').forEach(form => {
        addCurrencyConversionListeners(form);
    });
    
    // Add interview preview listeners
    document.getElementById('id_nepali_date')?.addEventListener('input', updateInterviewPreview);
    document.getElementById('id_gregorian_date')?.addEventListener('input', updateInterviewPreview);
    document.getElementById('id_interview_hour')?.addEventListener('input', updateInterviewPreview);
    document.getElementById('id_interview_time')?.addEventListener('input', updateInterviewPreview);
    document.getElementById('id_interview_location')?.addEventListener('input', updateInterviewPreview);
    
    // Setup number conversion
    setupNumberConversion();
    
    // Setup date conversion
    setupDateConversion();

    // Setup country notice preview
    setupCountryNoticePreview();
    
    // Add event delegation for dynamically added forms
    document.getElementById('positionsContainer')?.addEventListener('change', function(e) {
        if (e.target.name && (e.target.name.includes('salary_amount') || e.target.name.includes('salary_currency'))) {
            const formElement = e.target.closest('.position-form');
            if (formElement) {
                handleSalaryConversion(formElement);
            }
        }
    });
}

function updateProgress() {
    const progress = (currentStep / totalSteps) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
}

// Form submission handlers
document.getElementById('mainForm').addEventListener('submit', function(e) {
    console.log('DEBUG: Main form submit event triggered!');
    
    // Debug: Check current step
    const currentStepElement = document.querySelector('.tab-pane.active');
    const stepId = currentStepElement ? currentStepElement.id : 'Unknown Step';
    console.log('DEBUG: Current step:', stepId);
    
    e.preventDefault();
    
    // Validate required fields before submission
    if (!validateCurrentStep()) {
        console.log('DEBUG: Form validation failed');
        return;
    }
    
    console.log('DEBUG: Form validation passed, submitting...');
    
    // Debug: Log form data being sent
    const formData = new FormData(this);
    console.log('DEBUG: Submitting main form with data:');
    for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
    }
    
    // Submit form via AJAX
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('DEBUG: Form submission response:', data);
        if (data.success) {
            alert('рдореБрдЦреНрдп рдЬрд╛рдирдХрд╛рд░реА рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╕реЗрдн рдЧрд░рд┐рдпреЛ!');
            goToStep(3);
        } else {
            alert('рддреНрд░реБрдЯрд┐: ' + data.error);
        }
    })
    .catch(error => {
        console.error('DEBUG: Form submission error:', error);
        alert('рддреНрд░реБрдЯрд┐ рднрдпреЛред рдХреГрдкрдпрд╛ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдЧрд░реНрдиреБрд╣реЛрд╕реНред');
    });
});

document.getElementById('positionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate required fields before submission
    if (!validateCurrentStep()) {
        return;
    }
    
    // Debug: Log form data being sent
    const formData = new FormData(this);
    console.log('Submitting position form with data:');
    for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
    }
    
    // Debug: Check if any position fields have values
    const positionFields = document.querySelectorAll('[name*="position"]');
    const maleCountFields = document.querySelectorAll('[name*="male_count"]');
    const femaleCountFields = document.querySelectorAll('[name*="female_count"]');
    
    console.log('Position fields found:', positionFields.length);
    console.log('Male count fields found:', maleCountFields.length);
    console.log('Female count fields found:', femaleCountFields.length);
    
    // Check values of all positions
    positionFields.forEach((field, index) => {
        console.log(`Position ${index}: "${field.value}"`);
    });
    
    maleCountFields.forEach((field, index) => {
        console.log(`Male Count ${index}: "${field.value}"`);
    });
    
    femaleCountFields.forEach((field, index) => {
        console.log(`Female Count ${index}: "${field.value}"`);
    });
    
    // Debug: Check all forms in the container
    console.log('\n--- All Forms in Container ---');
    const container = document.getElementById('positionsContainer');
    if (container) {
        const allForms = container.querySelectorAll('.position-form');
        allForms.forEach((form, formIndex) => {
            console.log(`\nForm ${formIndex}:`);
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.name && input.name.includes('position')) {
                    console.log(`  ${input.name}: "${input.value}"`);
                }
            });
        });
    }
    
    // Debug: Check formset management form fields
    const totalFormsField = document.querySelector('[name*="TOTAL_FORMS"]');
    const initialFormsField = document.querySelector('[name*="INITIAL_FORMS"]');
    const maxFormsField = document.querySelector('[name*="MAX_NUM_FORMS"]');
    console.log('Formset management fields:');
    console.log('TOTAL_FORMS:', totalFormsField ? totalFormsField.value : 'Not found');
    console.log('INITIAL_FORMS:', initialFormsField ? initialFormsField.value : 'Not found');
    console.log('MAX_NUM_FORMS:', maxFormsField ? maxFormsField.value : 'Not found');
    
    // Submit form via AJAX
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('рдкрджрд╣рд░реВ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╕реЗрдн рдЧрд░рд┐рдпреЛ!');
            goToStep(4);
        } else {
            alert('рддреНрд░реБрдЯрд┐: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('рддреНрд░реБрдЯрд┐ рднрдпреЛред рдХреГрдкрдпрд╛ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдЧрд░реНрдиреБрд╣реЛрд╕реНред');
    });
});


// Debug Validation Function
function debugValidation() {
    const currentStepElement = document.querySelector('.tab-pane.active');
    const stepId = currentStepElement ? currentStepElement.id : 'Unknown Step';
    const currentStepNumber = currentStepElement ? currentStepElement.id.replace('step', '').replace('-tab', '') : 'N/A';
    
    let message = `Current Step: ${currentStepNumber}\n\n`;
    
    if (stepId === 'step2') {
        message += 'Main Information Validation:\n';
        const requiredFields = [
            'id_company_name',
            'id_country',
            'id_pre_approval_date',
            'id_chalani_no',
            'id_lot_no',
            'id_city'
        ];
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            message += `- ${field ? (field.value.trim() ? 'Filled' : 'Empty') : 'Not Found'}: ${field ? field.previousElementSibling?.textContent || fieldId : 'N/A'}\n`;
        });
    } else if (stepId === 'step3') {
        message += 'Job Positions Validation:\n';
        const positionForms = document.querySelectorAll('.position-form');
        if (positionForms.length === 0) {
            message += 'No position forms found.\n';
        } else {
            positionForms.forEach((form, index) => {
                message += `Position Form ${index + 1}:\n`;
                const positionField = form.querySelector('input[name*="position"]');
                const maleField = form.querySelector('input[name*="male_count"]');
                const femaleField = form.querySelector('input[name*="female_count"]');
                const salaryField = form.querySelector('input[name*="salary_amount"]');
                
                message += `  - Position: ${positionField ? (positionField.value.trim() ? 'Filled' : 'Empty') : 'Not Found'}\n`;
                message += `  - Male Count: ${maleField ? (maleField.value.trim() ? 'Filled' : 'Empty') : 'Not Found'}\n`;
                message += `  - Female Count: ${femaleField ? (femaleField.value.trim() ? 'Filled' : 'Empty') : 'Not Found'}\n`;
                message += `  - Salary Amount: ${salaryField ? (salaryField.value.trim() ? 'Filled' : 'Empty') : 'Not Found'}\n`;
            });
        }
    }
    
    alert(message);
}

// Test Add Position Function
function testAddPosition() {
    addPosition();
    alert('Test Add Position button clicked. New position form added.');
}

// Debug function to check form state
function debugFormState() {
    console.log('=== DEBUG FORM STATE ===');
    
    const container = document.getElementById('positionsContainer');
    if (!container) {
        console.log('Container not found');
        return;
    }
    
    const forms = container.querySelectorAll('.position-form');
    console.log(`Total forms found: ${forms.length}`);
    
    // Check formset management fields
    const totalFormsField = document.querySelector('[name*="TOTAL_FORMS"]');
    const initialFormsField = document.querySelector('[name*="INITIAL_FORMS"]');
    const minFormsField = document.querySelector('[name*="MIN_NUM_FORMS"]');
    const maxFormsField = document.querySelector('[name*="MAX_NUM_FORMS"]');
    
    console.log('Formset management fields:');
    console.log(`  TOTAL_FORMS: ${totalFormsField ? totalFormsField.value : 'Not found'}`);
    console.log(`  INITIAL_FORMS: ${initialFormsField ? initialFormsField.value : 'Not found'}`);
    console.log(`  MIN_NUM_FORMS: ${minFormsField ? minFormsField.value : 'Not found'}`);
    console.log(`  MAX_NUM_FORMS: ${maxFormsField ? maxFormsField.value : 'Not found'}`);
    
    // Check each form
    forms.forEach((form, index) => {
        console.log(`\n--- Form ${index + 1} ---`);
        console.log(`  Form index: ${form.dataset.formIndex}`);
        console.log(`  Title: ${form.querySelector('h6').textContent}`);
        
        const inputs = form.querySelectorAll('input, select, textarea');
        console.log(`  Total fields: ${inputs.length}`);
        
        // Check key fields
        const positionField = form.querySelector('[name*="position"]');
        const maleField = form.querySelector('[name*="male_count"]');
        const femaleField = form.querySelector('[name*="female_count"]');
        const salaryField = form.querySelector('[name*="salary_amount"]');
        
        console.log('  Key fields:');
        console.log(`    Position: ${positionField ? `"${positionField.value}" (${positionField.name})` : 'NOT FOUND'}`);
        console.log(`    Male Count: ${maleField ? `"${maleField.value}" (${maleField.name})` : 'NOT FOUND'}`);
        console.log(`    Female Count: ${femaleField ? `"${femaleField.value}" (${femaleField.name})` : 'NOT FOUND'}`);
        console.log(`    Salary: ${salaryField ? `"${salaryField.value}" (${salaryField.name})` : 'NOT FOUND'}`);
    });
    
    console.log('=== END DEBUG ===');
}

// Function to calculate interview date (8 days after pre-approval)
function calculateInterviewDate() {
    const preApprovalDate = document.getElementById('id_pre_approval_date').value;
    if (!preApprovalDate) {
        alert('рдХреГрдкрдпрд╛ рдкрд╣рд┐рд▓реЗ рдкреВрд░реНрд╡ рд╕реНрд╡реАрдХреГрддрд┐ рдорд┐рддрд┐ рднрд░реНрдиреБрд╣реЛрд╕реНред');
        return;
    }
    
    try {
        const date = new Date(preApprovalDate);
        date.setDate(date.getDate() + 8);
        
        // Format Nepali date (you can customize this format)
        const nepaliDate = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
        
        // Format English date
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        const englishDate = date.toLocaleDateString('en-US', options);
        
        // Update the form fields
        document.getElementById('id_interview_nepali_date').value = nepaliDate;
        document.getElementById('id_interview_gregorian_date').value = englishDate;
        
        // Update the preview
        document.getElementById('preview_nepali_date').textContent = nepaliDate;
        document.getElementById('preview_gregorian_date').textContent = englishDate;
        
        alert(`рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдорд┐рддрд┐ рдЧрдгрдирд╛ рд╕рдлрд▓: ${nepaliDate} (${englishDate})`);
    } catch (error) {
        alert('рдорд┐рддрд┐ рдЧрдгрдирд╛рдорд╛ рддреНрд░реБрдЯрд┐ рднрдпреЛред рдХреГрдкрдпрд╛ рд╕рд╣реА рдорд┐рддрд┐ рдлрд░рдореНрдпрд╛рдЯ рдкреНрд░рдпреЛрдЧ рдЧрд░реНрдиреБрд╣реЛрд╕реН (YYYY-MM-DD)ред');
    }
}

// Function to reset corrupted formset management fields
function resetFormsetFields() {
    console.log('=== RESETTING FORMSET FIELDS ===');
    
    const container = document.getElementById('positionsContainer');
    if (!container) {
        console.log('Container not found');
        return;
    }
    
    // Reset management form fields
    const totalFormsField = container.querySelector('[name*="TOTAL_FORMS"]');
    const initialFormsField = container.querySelector('[name*="INITIAL_FORMS"]');
    
    if (totalFormsField) totalFormsField.value = '1';
    if (initialFormsField) initialFormsField.value = '0';
    
    console.log('Management fields reset');
    
    // Remove all forms except the first one
    const forms = container.querySelectorAll('.position-form');
    forms.forEach((form, index) => {
        if (index > 0) {
            form.remove();
        }
    });
    
    console.log('Extra forms removed');
    console.log('=== END RESET ===');
}

// Country Notice Preview Function
function setupCountryNoticePreview() {
    const countryField = document.getElementById('id_country');
    const extraNotesField = document.getElementById('id_extra_notes');
    const previewDiv = document.getElementById('countryNoticePreview');
    const previewText = document.getElementById('noticePreviewText');
    
    if (countryField && extraNotesField && previewDiv && previewText) {
        // Show preview when country changes
        countryField.addEventListener('input', function() {
            updateCountryNoticePreview();
        });
        
        // Hide preview when user types in extra notes
        extraNotesField.addEventListener('input', function() {
            if (this.value.trim()) {
                previewDiv.style.display = 'none';
            } else {
                updateCountryNoticePreview();
            }
        });
        
        // Initial preview
        updateCountryNoticePreview();
    }
}







// Test form submission function
function testFormSubmission() {
    try {
        console.log('=== TESTING FORM SUBMISSION ===');
        alert('Starting testFormSubmission function...');
        
        // Get the form
        const form = document.getElementById('positionForm');
        if (!form) {
            console.log('Form not found');
            alert('Form not found!');
            return;
        }
        
        alert('Form found! Getting form data...');
        
        // Get form data
        const formData = new FormData(form);
        
        console.log('Form data:');
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: ${value}`);
        }
        
        // Check for specific field patterns
        const positionFields = [];
        const maleFields = [];
        const femaleFields = [];
        const salaryFields = [];
        
        for (let [key, value] of formData.entries()) {
            if (key.includes('position')) positionFields.push({key, value});
            if (key.includes('male_count')) maleFields.push({key, value});
            if (key.includes('female_count')) femaleFields.push({key, value});
            if (key.includes('salary_amount')) salaryFields.push({key, value});
        }
        
        console.log('Field analysis:');
        console.log('  Position fields:', positionFields);
        console.log('  Male count fields:', maleFields);
        console.log('  Female count fields:', femaleFields);
        console.log('  Salary fields:', salaryFields);
        
        alert('Form data logged to console! Check console for field analysis.');
        
        // Check if we can submit
        if (validateCurrentStep('step3')) {
            console.log('тЬЕ Validation passed - form can be submitted');
            alert('тЬЕ Validation passed - form can be submitted');
        } else {
            console.log('тЭМ Validation failed - form cannot be submitted');
            alert('тЭМ Validation failed - form cannot be submitted');
        }
        
        console.log('=== END TEST ===');
        
    } catch (error) {
        console.error('Error in testFormSubmission:', error);
        alert('Error: ' + error.message);
    }
}

// Function to show current form values
function showFormValues() {
    try {
        console.log('=== SHOWING FORM VALUES ===');
        alert('Starting showFormValues function...');
        
        const container = document.getElementById('positionsContainer');
        if (!container) {
            console.log('Container not found');
            alert('Container not found!');
            return;
        }
        
        alert(`Container found! Looking for forms...`);
        
        const forms = container.querySelectorAll('.position-form');
        console.log(`Total forms found: ${forms.length}`);
        alert(`Found ${forms.length} forms`);
        
        if (forms.length === 0) {
            alert('No forms found!');
            return;
        }
        
        forms.forEach((form, index) => {
            console.log(`\n--- Form ${index + 1} Values ---`);
            
            // Get all form fields
            const positionField = form.querySelector('[name*="position"]');
            const maleField = form.querySelector('[name*="male_count"]');
            const femaleField = form.querySelector('[name*="female_count"]');
            const salaryField = form.querySelector('[name*="salary_amount"]');
            
            console.log('Field values:');
            console.log(`  Position: ${positionField ? `"${positionField.value}"` : 'NOT FOUND'}`);
            console.log(`  Male Count: ${maleField ? `"${maleField.value}"` : 'NOT FOUND'}`);
            console.log(`  Female Count: ${femaleField ? `"${femaleField.value}"` : 'NOT FOUND'}`);
            console.log(`  Salary: ${salaryField ? `"${salaryField.value}"` : 'NOT FOUND'}`);
            
            // Show all field names and values
            const allFields = form.querySelectorAll('input, select, textarea');
            console.log('All fields in this form:');
            allFields.forEach(field => {
                console.log(`  ${field.name}: "${field.value}"`);
            });
        });
        
        console.log('=== END FORM VALUES ===');
        alert('Form values logged to console!');
        
    } catch (error) {
        console.error('Error in showFormValues:', error);
        alert('Error: ' + error.message);
    }
}

// Test if JavaScript is working
console.log('=== JAVASCRIPT LOADED ===');
console.log('Debug functions should be available');

// Function to show current form values

// Function to submit form manually for testing
function submitFormManually() {
    try {
        console.log('=== MANUAL FORM SUBMISSION ===');
        alert('Starting manual form submission...');
        
        // Get the form
        const form = document.getElementById('positionForm');
        if (!form) {
            console.log('Form not found');
            alert('Form not found!');
            return;
        }
        
        // Get form data
        const formData = new FormData(form);
        
        console.log('Form data being submitted:');
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: ${value}`);
        }
        
        // Check if we have existing position data
        const existingPositionId = formData.get('positions-0-id');
        console.log('Existing position ID:', existingPositionId);
        
        if (existingPositionId) {
            console.log('тЬЕ Found existing position ID, should preserve data');
        } else {
            console.log('тЭМ No existing position ID found, data will be lost');
        }
        
        // Submit the form
        console.log('Submitting form...');
        form.submit();
        
    } catch (error) {
        console.error('Error in manual submission:', error);
        alert('Error: ' + error.message);
    }
}

// Test form submission function
</script>
{% endblock %}