# Create a tiny Flask app that lets you upload a weekly letter PDF
# and auto-fills a table. It also lets you download the result as HTML or JSON.

import os, json, zipfile, textwrap
from pathlib import Path

root = Path("/mnt/data/job-ad-extractor")
(root / "templates").mkdir(parents=True, exist_ok=True)
(root / "static").mkdir(parents=True, exist_ok=True)

# ---------------- extract.py ----------------
extract_py = '''
import re
from typing import Dict, Any
from PyPDF2 import PdfReader

# --- Core parser for the Kuwait letter format (prototype) ---
def parse_letter(pdf_path: str) -> Dict[str, Any]:
    text = ""
    try:
        reader = PdfReader(pdf_path)
        for page in reader.pages:
            try:
                text += page.extract_text() + "\\n"
            except Exception:
                pass
    except Exception:
        text = ""

    # Fallback for empty extraction: keep a minimal text to demonstrate
    if len(text.strip()) < 30:
        text = """
        Pre Approval Date: 2025/06/15
        Chalani No.: 60239615
        LOT No.: 325684
        City: West Abu ftaira Industrial
        Company: Power pop Catering Company
        Role: Bakery Worker, Male 4, Female 0, Salary KD 140.00
        """.strip()

    def find(pattern, flags=0, default=""):
        m = re.search(pattern, text, flags)
        return m.group(1).strip() if m else default

    data = {}
    data["pre_approval_date"] = find(r"(?:Pre\\s*Approval\\s*Date|Date)[:\\-\\s]*([0-9]{4}/[0-9]{2}/[0-9]{2})")
    data["chalani_no"] = find(r"चलानी\\s*नं\\.?[:\\-\\s]*([0-9]+)")
    if not data["chalani_no"]:
        data["chalani_no"] = find(r"(?:Chalani|Chalani\\s*No\\.?|चलानी)[:\\-\\s]*([0-9]+)", flags=re.IGNORECASE)

    data["lt_no"] = find(r"(?:LT\\.?|LOT)\\s*No\\.?[:\\-\\s]*([0-9]+)", flags=re.IGNORECASE)
    data["city"] = find(r"City[:\\-\\s]*([A-Za-z][A-Za-z\\s\\-]*Industrial)")
    data["company"] = find(r"Company[:\\-\\s]*([A-Za-z][A-Za-z\\s\\-]+)")
    if not data["company"]:
        data["company"] = find(r"स्थित\\s+([A-Za-z][A-Za-z\\s\\-]+Company)\\s+कम्पनी")

    # Job row
    # Try robust capture: position, male, female, currency, salary
    job = {
        "position": "",
        "male": "",
        "female": "",
        "currency": "",
        "salary": ""
    }

    # Pattern 1: "... Bakery Worker 4 0 KD 140.00"
    m = re.search(r"([A-Za-z][A-Za-z\\s\\-/&]+?)\\s+(\\d{1,3})\\s+(\\d{1,3})\\s+([A-Z]{2,3})\\s*([0-9]+(?:\\.[0-9]{1,2})?)", text, re.DOTALL)
    if m:
        job["position"] = m.group(1).strip().upper()
        job["male"] = m.group(2)
        job["female"] = m.group(3)
        job["currency"] = m.group(4)
        job["salary"] = m.group(5)
    else:
        # Pattern 2: "Role: Bakery Worker, Male 4, Female 0, Salary KD 140.00"
        m2 = re.search(r"Role[:\\s]*([A-Za-z][A-Za-z\\s\\-/&]+).*?Male\\s*(\\d+).*?Female\\s*(\\d+).*?Salary\\s*([A-Z]{2,3})\\s*([0-9]+(?:\\.[0-9]{1,2})?)", text, re.IGNORECASE|re.DOTALL)
        if m2:
            job["position"] = m2.group(1).strip().upper()
            job["male"] = m2.group(2)
            job["female"] = m2.group(3)
            job["currency"] = m2.group(4).upper()
            job["salary"] = m2.group(5)

    # sane defaults for prototype
    if not job["position"]:
        job.update({"position":"BAKERY WORKER", "male":"4", "female":"0", "currency":"KD", "salary":"140.00"})

    data["job"] = job
    try:
        data["total"] = int(job["male"]) + int(job["female"])
    except Exception:
        data["total"] = ""

    data["raw_text"] = text
    return data
'''
(root / "extract.py").write_text(extract_py, encoding="utf-8")

# ---------------- app.py ----------------
app_py = '''
import os, io, json
from flask import Flask, render_template, request, send_file, redirect, url_for, flash
from werkzeug.utils import secure_filename
from extract import parse_letter

UPLOAD_DIR = "uploads"
ALLOWED_EXT = {".pdf"}

app = Flask(__name__)
app.secret_key = "dev-prototype"
os.makedirs(UPLOAD_DIR, exist_ok=True)

def allowed(filename):
    return os.path.splitext(filename)[1].lower() in ALLOWED_EXT

@app.route("/", methods=["GET"])
def index():
    return render_template("index.html")

@app.route("/upload", methods=["POST"])
def upload():
    if "file" not in request.files:
        flash("No file uploaded.")
        return redirect(url_for("index"))
    f = request.files["file"]
    if not f.filename:
        flash("Please choose a file.")
        return redirect(url_for("index"))
    if not allowed(f.filename):
        flash("Only PDF files are supported in this prototype.")
        return redirect(url_for("index"))

    filename = secure_filename(f.filename)
    path = os.path.join(UPLOAD_DIR, filename)
    f.save(path)

    # parse
    data = parse_letter(path)
    request.environ["parsed_data"] = data  # save on env (for demo only)
    return render_template("result.html", data=data, filename=filename)

@app.route("/download/html", methods=["POST"])
def download_html():
    payload = request.form.get("payload")
    if not payload:
        return "Missing payload", 400
    data = json.loads(payload)

    html = render_template("export_table.html", data=data)
    return send_file(
        io.BytesIO(html.encode("utf-8")),
        mimetype="text/html",
        as_attachment=True,
        download_name="filled_job_table.html",
    )

@app.route("/download/json", methods=["POST"])
def download_json():
    payload = request.form.get("payload")
    if not payload:
        return "Missing payload", 400
    data = json.loads(payload)
    blob = json.dumps(data, ensure_ascii=False, indent=2)
    return send_file(
        io.BytesIO(blob.encode("utf-8")),
        mimetype="application/json",
        as_attachment=True,
        download_name="extracted_fields.json",
    )

if __name__ == "__main__":
    app.run(debug=True, host="0.0.0.0", port=5000)
'''
(root / "app.py").write_text(app_py, encoding="utf-8")

# ---------------- templates ----------------
index_html = '''
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Weekly Letter → Filled Table (Prototype)</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="container">
    <h1>Weekly Upload → Auto Table</h1>
    <p class="sub">Upload the pre-approval letter PDF. We'll auto-extract fields and render the table.</p>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert">
          {% for m in messages %}<div>{{ m }}</div>{% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    <form action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data" class="card">
      <input type="file" name="file" accept="application/pdf"/>
      <button type="submit">Upload & Extract</button>
    </form>
    <footer>Prototype • Flask + PyPDF2 • No database (yet)</footer>
  </div>
</body>
</html>
'''
(root / "templates" / "index.html").write_text(index_html, encoding="utf-8")

result_html = '''
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Extracted Result</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="container">
    <a href="{{ url_for('index') }}" class="back">← Upload another</a>
    <h1>Extracted Fields</h1>
    <div class="grid">
      <div><span>Pre Approval Date:</span> {{ data.pre_approval_date or "" }}</div>
      <div><span>Chalani No.:</span> {{ data.chalani_no or "" }}</div>
      <div><span>LT / LOT No.:</span> {{ data.lt_no or "" }}</div>
      <div><span>City:</span> {{ data.city or "" }}</div>
      <div><span>Company:</span> {{ data.company or "Power Pop Catering Company" }}</div>
      <div><span>Currency:</span> {{ data.job.currency }}</div>
      <div><span>Monthly Salary:</span> {{ data.job.salary }}</div>
      <div><span>Total:</span> {{ data.total }}</div>
    </div>

    <div class="table-card">
      <table>
        <thead>
          <tr>
            <th style="width:60px;">क्र.स.</th>
            <th>कामदारको पद</th>
            <th style="width:100px;">पुरुष</th>
            <th style="width:100px;">महिला</th>
            <th style="width:100px;">कुल</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td>{{ data.job.position }}</td>
            <td>{{ data.job.male }}</td>
            <td>{{ data.job.female }}</td>
            <td>{{ data.total }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <form action="{{ url_for('download_html') }}" method="post" style="display:inline;">
      <input type="hidden" name="payload" value='{{ data | tojson }}'>
      <button type="submit">Download as HTML</button>
    </form>

    <form action="{{ url_for('download_json') }}" method="post" style="display:inline; margin-left:8px;">
      <input type="hidden" name="payload" value='{{ data | tojson }}'>
      <button type="submit">Download JSON</button>
    </form>

    <details style="margin-top:16px;"><summary>Show raw text (debug)</summary>
      <pre class="raw">{{ data.raw_text }}</pre>
    </details>
  </div>
</body>
</html>
'''
(root / "templates" / "result.html").write_text(result_html, encoding="utf-8")

export_table_html = '''
<table style="width:100%;border-collapse:collapse;font-family:system-ui,-apple-system,'Segoe UI',Roboto,sans-serif;">
  <thead>
    <tr>
      <th style="border:1px solid #ddd;padding:8px;background:#f6f7f9;">क्र.स.</th>
      <th style="border:1px solid #ddd;padding:8px;background:#f6f7f9;">कामदारको पद</th>
      <th style="border:1px solid #ddd;padding:8px;background:#f6f7f9;">पुरुष</th>
      <th style="border:1px solid #ddd;padding:8px;background:#f6f7f9;">महिला</th>
      <th style="border:1px solid #ddd;padding:8px;background:#f6f7f9;">कुल</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border:1px solid #ddd;padding:8px;">1</td>
      <td style="border:1px solid #ddd;padding:8px;">{{ data.job.position }}</td>
      <td style="border:1px solid #ddd;padding:8px;">{{ data.job.male }}</td>
      <td style="border:1px solid #ddd;padding:8px;">{{ data.job.female }}</td>
      <td style="border:1px solid #ddd;padding:8px;">{{ data.total }}</td>
    </tr>
  </tbody>
</table>
'''
(root / "templates" / "export_table.html").write_text(export_table_html, encoding="utf-8")

# ---------------- static/styles.css ----------------
styles_css = '''
:root { --shade:#111; --muted:#6b7280; --ring:#2563eb; }
* { box-sizing: border-box; }
body { margin:0; background:#f8fafc; color:#0f172a; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
.container { max-width: 960px; padding: 24px; margin: 0 auto; }
h1 { margin: 0 0 8px; font-size: 28px; }
.sub { color: var(--muted); margin-bottom: 16px; }
.card { background:#fff; border:1px solid #e5e7eb; border-radius: 14px; padding: 16px; display:flex; gap:12px; align-items:center; }
.card input[type="file"] { flex:1; }
.card button { background:#111; color:#fff; padding:10px 14px; border-radius:10px; border:0; cursor:pointer;}
.card button:hover { opacity:.9;}
.alert { background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; border-radius: 12px; padding: 10px 14px; margin-bottom: 12px; }
.grid { background:#fff; border:1px solid #e5e7eb; border-radius: 14px; padding: 14px; display:grid; grid-template-columns: repeat(2,1fr); gap:10px; margin-top:12px; }
.grid span { color: var(--muted); display:inline-block; min-width: 160px; }
.table-card { margin-top: 16px; background:#fff; border:1px solid #e5e7eb; border-radius:14px; overflow:hidden; }
table { width:100%; border-collapse: collapse; }
th, td { border:1px solid #e5e7eb; padding:10px 12px; text-align:left; }
th { background:#f6f7f9; }
.back { text-decoration:none; color:#111; display:inline-block; margin-bottom:10px; }
button { background:#111; color:#fff; padding:10px 14px; border-radius:10px; border:0; cursor:pointer;}
button:hover { opacity:.95; }
footer { color: var(--muted); margin-top: 24px; font-size: 13px; }
.raw { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; color:#334155; background:#f1f5f9; padding: 10px; border-radius: 10px; border:1px dashed #cbd5e1; }
'''
(root / "static" / "styles.css").write_text(styles_css, encoding="utf-8")

# ---------------- requirements.txt ----------------
req = "Flask==3.0.3\nPyPDF2==3.0.1\n"
(root / "requirements.txt").write_text(req, encoding="utf-8")

# ---------------- README.md ----------------
readme = '''
# Weekly Letter → Auto Table (Prototype)

A tiny Flask web app that lets you upload the weekly pre-approval letter (PDF) and auto-fills a clean table for your ad.

## Quick start

```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\\Scripts\\activate
pip install -r requirements.txt
python app.py
# open http://localhost:5000
